<!DOCTYPE html>
<html lang="en">



<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <!-- Allow pinning of website on windows -->
    <meta name="application-name" content="Erlang.org">
    <meta name="msapplication-tooltip" content="The official home of the Erlang Programming Language">
    <meta name="msapplication-starturl" content="/" >

    <!-- Make the site look nicer on facebook -->
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="Erlang.org">
    <meta property="og:title" content="Welcome to Erlang.org">
    <meta property="og:description" content="The official home of the Erlang Programming Language">
    <meta property="og:image" content="https://beta.erlang.org/assets/img/erlang-228x200.png">
    <meta property="og:image:secure_url" content="https://beta.erlang.org/assets/img/erlang-228x200.png">
    <meta property="og:url" content="https://beta.erlang.org/">

    <!-- Twitter metadata -->
    <meta name="twitter:card" content="summary" />
    <meta property="twitter:title" content="Index" />
    <meta name="twitter:site" content="@erlang_org" />

    <!-- Rich data for google search -->
    <script type="application/ld+json">
{"@type":"WebSite","url":"https://erlang.org/","headline":"Eep 0038 - Erlang/OTP","name":"Erlang.org","sameAs":["https://twitter.com/erlang_org","https://github.com/erlang/otp"],"@context":"https://schema.org"}</script>

    <title>Eep 0038 - Erlang/OTP</title>

    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- tells iOS browsers to not show telephone numbers as links -->
    <meta name="format-detection" content="telephone=no">

    <meta name="application-name" content="Erlang.org">
    <meta name="description" content="The official home of the Erlang Programming Language">
    <meta name="keywords" content="Erlang programming language functional parallel distributed documentation download community">
    <!-- https://www.rssboard.org/rss-autodiscovery -->
    <link rel="alternate" type="application/atom+xml" title="News Atom Feed" href="https://beta.erlang.org/news.xml" />
    <link rel="alternate" type="application/atom+xml" title="Blog Atom Feed" href="https://beta.erlang.org/blog.xml" />
    
    <link rel="stylesheet" href="/assets/css/main.css">
</head>

<body>
    <header class="navbar navbar-expand-lg navbar-light bg-body">
        <nav class="container">
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-bs-toggle="collapse"
                data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false"
                aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <a class="navbar-brand" href="/"><img
                    src="/assets/img/erlang.png" class="img-fluid" width="60" alt="Erlang.org main page"/></a>
            <div class="collapse navbar-collapse fw-bold" id="navbarSupportedContent">
                <ul class="navbar-nav text-uppercase me-auto mb-2 mb-lg-0">
                    <li class="nav-item"><a class="nav-link" href="/downloads">Download</a></li>
                    <li class="nav-item"><a class="nav-link" href="/docs">Documentation</a></li>
                    <li class="nav-item"><a class="nav-link" href="/community">Community</a></li>
                    <li class="nav-item"><a class="nav-link" href="/news">News</a></li>
                    <li class="nav-item"><a class="nav-link" href="/blog">Blog</a></li>
                    <li class="nav-item"><a class="nav-link" href="/eep">EEP</a></li>
                    <li class="nav-item"><a class="nav-link" href="/about">About</a></li>
                </ul>
                <form class="d-flex" role="search" method="get" action="https://duckduckgo.com/">
                    <input type="hidden" name="sites" value="erlang.org">
                    <input class="form-control me-2" id="searchfield" name="q" type="search" placeholder="Search erlang.org"
                        aria-label="Search">
                    <button class="btn btn-outline-primary" type="submit">Search</button>
                </form>
            </div>
        </nav>
    </header>
    <div class="container border-top pt-4">
    <div class="row-lg">
        <div class="col-lg-10 offset-lg-1">
            <div class="card">
                <div class="card-body">
                    <dl class="mb-0 dl-single">
                        <dt>Author:</dt>
                        <dd>
                            Richard A. O&#39;Keefe &lt;ok(at)cs(dot)otago(dot)ac(dot)nz&gt;
                            
                            
                        </dd>
                        
                        <dt>Status:</dt>
                        <dd>Draft </dd>
                        <dt>Type:</dt>
                        <dd>Standards Track</dd>
                        
                        
                        <dt>Created:</dt>
                        <dd>27-May-2011</dd>
                        
                        <dt>Erlang-Version:</dt>
                        <dd>R14B04</dd>
                        
                        
                        
                        
                    </dl>
                </div>
            </div>
            <div class="border-top mt-4">
                
                <h2 id="eep-38--discontiguous-directive">
        
        
          EEP 38: -discontiguous directive <a href="#eep-38--discontiguous-directive">#</a>
        
        
      </h2>
    
      <h1 id="abstract">
        
        
          Abstract <a href="#abstract">#</a>
        
        
      </h1>
    

<p>A <code>-discontiguous</code> directive is to be added so that specified
functions may be presented as more than one group of clauses,
possibly separated by other directives and function clause
groups.</p>
      <h1 id="specification">
        
        
          Specification <a href="#specification">#</a>
        
        
      </h1>
    

<p>A new directive</p>

<pre><code class="language-erlang">-discontiguous( Name_And_Arity_List ).
</code></pre>

<p>is added.  Each function named in such a list must have at
least one clause group in that module, and may have more.
It remains an error for any function not named in such a
list to have more than one clause group.</p>

<p>A function named in a <code>-discontiguous</code> directive need not
have more than one clause group.  If it does, it is if
the clause groups were moved together without reordering
and the full stop of each group but the last changed to
a semicolon.  The compiler should make no comment about
the existence of multiple clause groups or their fusion
into single clause groups.</p>

<p>The parser stage would do the regrouping and would not
include any representation of the <code>-discontiguous</code> directive
in its output, so that downstream tools would never know
that <code>-discontiguous</code> had been there.</p>
      <h1 id="motivation">
        
        
          Motivation <a href="#motivation">#</a>
        
        
      </h1>
    

<p>There are three problems which a single mechanism can solve.</p>

<p>The first is that Erlang has conditional compilation, but
there is no really satisfactory to use it to select some
but not all of the clauses of a function.</p>

<p>The <code>-discontiguous</code> directive allows you to write</p>

<pre><code class="language-erlang">-discontiguous([f/3]).

f(a, X, Y) -&gt; .... .
-if(Cond).
f(b, X, Y) -&gt; .... .
-endif.
f(c, X, T) -&gt; .... .
</code></pre>

<p>The second may be called “topic-oriented programming”.
It relates to human structuring of code around the
data values computed on rather than the code they compute.
I have found this in dealing with a virtual machine:  I’ve
wanted to place the code that assembles an instruction,
the code that peephole optimises it, the code that encodes
it into memory, and the code that interprets it into one
place (involving different function), rather than organising
it by function, thus scattering related information the
length and breadth of the module.</p>

<p>It may be clearest to start with an example.  The code
in <code>erl_syntax.erl</code> reads:</p>

<pre><code class="language-erlang">-type syntaxTree() :: #tree{} | #wrapper{} | tuple().

%% All `erl_parse' tree nodes are represented by tuples
%% whose second field is the position information (usually
%% an integer), *with the exceptions of*
%% `{error, ...}' (type `error_marker') and
%% `{warning, ...}' (type `warning_marker'),
%% which only contain the associated line number *of the
%% error descriptor*; this is all handled transparently
%% by `get_pos' and `set_pos'.

get_pos(#tree{attr = Attr}) -&gt;
    Attr#attr.pos;
get_pos(#wrapper{attr = Attr}) -&gt;
    Attr#attr.pos;
get_pos({error, {Pos, _, _}}) -&gt;
    Pos;
get_pos({warning, {Pos, _, _}}) -&gt;
    Pos;
get_pos(Node) -&gt;
    %% Here, we assume that we have an `erl_parse' node
    %% with position information in element 2.
    element(2, Node).

set_pos(Node, Pos) -&gt;
    case Node of
        #tree{attr = Attr} -&gt;
            Node#tree{attr = Attr#attr{pos = Pos}};
        #wrapper{attr = Attr} -&gt;
            Node#wrapper{attr = Attr#attr{pos = Pos}};
        _ -&gt;
            %% We then assume we have an `erl_parse' node,
            %% and create a wrapper around it to make
            %% things more uniform.
            set_pos(wrap(Node), Pos)
    end.
</code></pre>

<p>The type here is a little vague.  The additional tuples appear
to be <code>{error,{Pos,_,_}}, {warning,{Pos,_,_}}</code>, and the
<code>{Tag,Pos...}</code> tuples returned by <code>erl_parse</code>.  The thing here is
that there are five different cases.  For some purposes,
it would be better to write</p>

<pre><code class="language-erlang">-discontiguous([get_pos/1,set_pos/2]).

get_pos(#tree{attr = Attr}) -&gt; Attr#attr.pos.
set_pos(#tree{attr = Attr} = Node, Pos) -&gt;
    Node#tree{attr = Attr#attr{pos = Pos}}.

get_pos(#wrapper{attr = Attr}) -&gt; Attr#attr.pos.
set_pos(#wrapper{attr = Attr} = Node, Pos) -&gt;
    Node#wrapper{attr = Attr#attr{pos = Pos}}.

get_pos({error, {Pos,_,_}}) -&gt; Pos.
% What should set_pos/2 do in this case?

get_pos({warning, {Pos,_,_}}) -&gt; Pos.
% What should set_pos/2 do in this case?

get_pos(Node) -&gt; element(2, Node).  % assume erl_parse node
set_pos(Node, Pos) -&gt;               % assume erl_parse node
    set_pos(wrap(Node), Pos).       % wrap it for uniformity
</code></pre>

<p>This brings out the parallel between the two functions,
and the way the parallel fails, more clearly than any other
possible layout.  It nags at you to either finish the
parallel with the obvious</p>

<pre><code class="language-erlang">set_pos({error, {_,X,Y}}, Pos) -&gt;
    {error, {Pos,X,Y}}.
</code></pre>
<p>and</p>

<pre><code class="language-erlang">set_pos({warning, {_,X,Y}), Pos) -&gt;
    {warning, {Pos,X,Y}}.
</code></pre>

<p>clauses or to at least change the comments to</p>

<pre><code class="language-erlang">% set_pos/2 falls through to the last case.
</code></pre>

<p>comments.</p>

<p>We have the same pattern, without the failure of parallelism,
in two more functions from that file:</p>

<pre><code class="language-erlang">get_com(#tree{attr = Attr}) -&gt; Attr#attr.com;
get_com(#wrapper{attr = Attr}) -&gt; Attr#attr.com;
get_com(_) -&gt; none.

set_com(Node, Com) -&gt;
    case Node of
        #tree{attr = Attr} -&gt;
            Node#tree{attr = Attr#attr{com = Com}};
        #wrapper{attr = Attr} -&gt;
            Node#wrapper{attr = Attr#attr{com = Com}};
        _ -&gt;
            set_com(wrap(Node), Com)
    end.
</code></pre>

<p>These could be</p>

<pre><code class="language-erlang">-discontiguous([get_com/1,set_com/1]).

get_com(#tree{attr = Attr}) -&gt; Attr#attr.com.
set_com(#tree{attr = Attr} = Node, Com) -&gt;
    Node#tree{attr = Attr#attr{com = Com}}.

get_com(#wrapper{attr = Attr}) -&gt; Attr#attr.com.
set_com(#wrapper{attr = Attr} = Node, Com) -&gt;
    Node#wrapper{attr = Attr#attr{com = Com}}.

get_com(_) -&gt; none.  % error, warning, erl_parse.
set_com(Node, Com) -&gt;
    set_com(wrap(Node), Com).
</code></pre>

<p>Well, once again the parallel is not quite perfect.
The documentation for <code>wrap/1</code> says that it assumes
its argument is a class <code>erl_parse</code> tuple, which here
means that it appears that it should NOT be an error
or warning.</p>

<p>The point of interest here is that just looking at the
existing functions didn’t ring any alarms; it was not
until I said “these seem to be about the same data
structure; I wonder if interleaving can make the
connection clearer and make it easier to ensure that
getters and setters are properly related?” that my
attention was properly drawn to the differences.</p>

<p>It’s particularly interesting that the very first Erlang/OTP
source file I looked at provided examples.
The third is like the second, but relates to code
written by a computer, not a human.  For example, if
generating a functional representation of some sort
of state machine, it can be convenient to organise
the output around the states, but the present scheme
requires it to be organised around the functions that
deal with the states.</p>
      <h1 id="rationale">
        
        
          Rationale <a href="#rationale">#</a>
        
        
      </h1>
    

<p>Prolog systems have supported a <code>:- discontiguous</code> declaration
for 20+ years.  The approach is a proven one.  It is a simple
generalisation of the language which can be hidden from all
“downstream” tools.  Only tools that try to deal with Erlang
syntax without fully parsing it could notice the difference,
and they should largely ignore it.</p>
      <h1 id="backwards-compatibility">
        
        
          Backwards Compatibility <a href="#backwards-compatibility">#</a>
        
        
      </h1>
    

<p>All existing Erlang code remains acceptable with unchanged
semantics.  Existing language-processing tools are unaffected
if they rely on <code>erl_parse</code>.</p>
      <h1 id="reference-implementation">
        
        
          Reference Implementation <a href="#reference-implementation">#</a>
        
        
      </h1>
    

<p>None in this draft.</p>
      <h1 id="references">
        
        
          References <a href="#references">#</a>
        
        
      </h1>
    

<p>None.</p>
      <h1 id="copyright">
        
        
          Copyright <a href="#copyright">#</a>
        
        
      </h1>
    

<p>This document has been placed in the public domain.</p>

            </div>
        </div>
    </div>
</div>
<script src="/assets/js/prismjs/prism.js"></script>
<script src="/assets/js/prismjs/components/prism-erlang.js"></script>
    <footer class="container-fluid footer text-center border-top border-bottom">
        <div>
            <a href="/downloads.html" title="DOWNLOAD"><img src="/assets/img/download.png" alt="Download Erlang/OTP"></a>
        </div>
        <div>
            <a href="http://www.github.com/erlang/otp"><img
                    src="/assets/img/GitHub-Mark-32px.png" alt="Erlang/OTP on Github"></a>
        </div>
        
        <div>
            <a href="http://www.twitter.com/erlang_org"><img src="/assets/img/twitter.png"
                    width="32" alt="Erlang/OTP twitter"></a>
        </div>
    </footer>
    <script src="/assets/js/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>