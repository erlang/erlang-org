<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html xmlns:erl="http://erlang.org" xmlns:fn="http://www.w3.org/2005/02/xpath-functions">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<link rel="stylesheet" href="../../otp_doc.css" type="text/css">
<title>Erlang -- Getting Started</title>
</head>
<body>
<div id="container">
<script id="js" type="text/javascript" language="JavaScript" src="../../js/flipmenu/flipmenu.js"></script><script id="js2" type="text/javascript" src="../../js/erlresolvelinks.js"></script><script language="JavaScript" type="text/javascript">
            <!--
              function getWinHeight() {
                var myHeight = 0;
                if( typeof( window.innerHeight ) == 'number' ) {
                  //Non-IE
                  myHeight = window.innerHeight;
                } else if( document.documentElement && ( document.documentElement.clientWidth ||
                                                         document.documentElement.clientHeight ) ) {
                  //IE 6+ in 'standards compliant mode'
                  myHeight = document.documentElement.clientHeight;
                } else if( document.body && ( document.body.clientWidth || document.body.clientHeight ) ) {
                  //IE 4 compatible
                  myHeight = document.body.clientHeight;
                }
                return myHeight;
              }

              function setscrollpos() {
                var objf=document.getElementById('loadscrollpos');
                 document.getElementById("leftnav").scrollTop = objf.offsetTop - getWinHeight()/2;
              }

              function addEvent(obj, evType, fn){
                if (obj.addEventListener){
                obj.addEventListener(evType, fn, true);
                return true;
              } else if (obj.attachEvent){
                var r = obj.attachEvent("on"+evType, fn);
                return r;
              } else {
                return false;
              }
             }

             addEvent(window, 'load', setscrollpos);

             //--></script><div id="leftnav"><div class="innertube">
<div class="erlang-logo-wrapper"><a href="../../index.html"><img alt="Erlang Logo" src="../../erlang-logo.png" class="erlang-logo"></a></div>
<p class="section-title">SSH</p>
<p class="section-subtitle">User's Guide</p>
<p class="section-version">Version 4.9.1.5</p>
<ul class="panel-sections">
<li><a href="users_guide.html">User's Guide</a></li>
<li><a href="index.html">Reference Manual</a></li>
<li><a href="release_notes.html">Release Notes</a></li>
<li><a href="ssh.pdf">PDF</a></li>
<li><a href="../../index.html">Top</a></li>
</ul>
<ul class="expand-collapse-items">
<li><a href="javascript:openAllFlips()">Expand All</a></li>
<li><a href="javascript:closeAllFlips()">Contract All</a></li>
</ul>
<h3>Chapters</h3>
<ul class="flipMenu" imagePath="../../js/flipmenu">
<li id="no" title="Introduction" expanded="false">Introduction<ul>
<li><a href="introduction.html">
              Top of chapter
            </a></li>
<li title="Scope and Purpose"><a href="introduction.html#scope-and-purpose">Scope and Purpose</a></li>
<li title="Prerequisites"><a href="introduction.html#prerequisites">Prerequisites</a></li>
<li title="SSH Protocol Overview"><a href="introduction.html#ssh-protocol-overview">SSH Protocol Overview</a></li>
<li title="Where to Find More Information"><a href="introduction.html#where-to-find-more-information">Where to Find More Information</a></li>
</ul>
</li>
<li id="loadscrollpos" title="Getting Started" expanded="true">Getting Started<ul>
<li><a href="using_ssh.html">
              Top of chapter
            </a></li>
<li title="General Information"><a href="using_ssh.html#general-information">General Information</a></li>
<li title="Using the Erlang ssh Terminal Client"><a href="using_ssh.html#using-the-erlang-ssh-terminal-client">Using the Erlang ssh Terminal Client</a></li>
<li title="Running an Erlang ssh Daemon"><a href="using_ssh.html#running-an-erlang-ssh-daemon">Running an Erlang ssh Daemon</a></li>
<li title="One-Time Execution"><a href="using_ssh.html#one-time-execution">One-Time Execution</a></li>
<li title="SFTP Server"><a href="using_ssh.html#sftp-server">SFTP Server</a></li>
<li title="SFTP Client"><a href="using_ssh.html#sftp-client">SFTP Client</a></li>
<li title="SFTP Client with TAR Compression"><a href="using_ssh.html#sftp-client-with-tar-compression">SFTP Client with TAR Compression</a></li>
<li title="Creating a Subsystem"><a href="using_ssh.html#creating-a-subsystem">Creating a Subsystem</a></li>
</ul>
</li>
<li id="no" title="Terminology" expanded="false">Terminology<ul>
<li><a href="terminology.html">
              Top of chapter
            </a></li>
<li title="General Information"><a href="terminology.html#general-information">General Information</a></li>
<li title='The term "user"'><a href="terminology.html#the-term--user-">The term "user"</a></li>
</ul>
</li>
<li id="no" title="Configuring algorithms in SSH" expanded="false">Configuring algorithms in SSH<ul>
<li><a href="configure_algos.html">
              Top of chapter
            </a></li>
<li title="Introduction"><a href="configure_algos.html#introduction">Introduction</a></li>
<li title="Replacing the default set: preferred_algorithms"><a href="configure_algos.html#replacing-the-default-set--preferred_algorithms">Replacing the default set: preferred_algorithms</a></li>
<li title="Modifying the default set: modify_algorithms"><a href="configure_algos.html#modifying-the-default-set--modify_algorithms">Modifying the default set: modify_algorithms</a></li>
</ul>
</li>
</ul>
</div></div>
<div id="content">
<div class="innertube">
<h1>2 Getting Started</h1>
  

  <h3><span onMouseOver="document.getElementById('ghlink-general-information-idm149').style.visibility = 'visible';" onMouseOut="document.getElementById('ghlink-general-information-idm149').style.visibility = 'hidden';"><span id="ghlink-general-information-idm149" class="ghlink"><a href="https://github.com/erlang/otp/edit/maint/lib/ssh/doc/src/using_ssh.xml#L35" title="Found an issue with the documentation? Fix it by clicking here!"><span class="pencil"></span></a></span><a class="title_link" name="general-information" href="#general-information">2.1 
          General Information</a></span></h3>
    
    <p>The following examples use the utility function
    <span class="bold_code bc-15"><a href="../../man/ssh.html#start-0">ssh:start/0</a></span> to start
    all needed applications (<span class="code">crypto</span>, <span class="code">public_key</span>, and <span class="code">ssh</span>).
    All examples are run in an Erlang shell, or in a bash shell, using <strong>openssh</strong>
    to illustrate how the <span class="code">ssh</span> application can be used. The
    examples are run as the user <span class="code">otptest</span> on a local network where the
    user is authorized to log in over <span class="code">ssh</span> to the host <strong>tarlop</strong>.
    </p>
    <p>If nothing else is stated, it is presumed that the <span class="code">otptest</span> user
    has an entry in the <strong>authorized_keys</strong> file of <strong>tarlop</strong>
    (allowed to log in over <span class="code">ssh</span> without entering a password).
    Also, <strong>tarlop</strong> is a known host in the <span class="code">known_hosts</span>
    file of the user <span class="code">otptest</span>. This means that host-verification
    can be done without user-interaction.
    </p>
  

  <h3><span onMouseOver="document.getElementById('ghlink-using-the-erlang-ssh-terminal-client-idm169').style.visibility = 'visible';" onMouseOut="document.getElementById('ghlink-using-the-erlang-ssh-terminal-client-idm169').style.visibility = 'hidden';"><span id="ghlink-using-the-erlang-ssh-terminal-client-idm169" class="ghlink"><a href="https://github.com/erlang/otp/edit/maint/lib/ssh/doc/src/using_ssh.xml#L54" title="Found an issue with the documentation? Fix it by clicking here!"><span class="pencil"></span></a></span><a class="title_link" name="using-the-erlang-ssh-terminal-client" href="#using-the-erlang-ssh-terminal-client">2.2 
          Using the Erlang ssh Terminal Client</a></span></h3>
    

    <p>The user <span class="code">otptest</span>, which has bash as default shell, uses the
    <span class="code">ssh:shell/1</span> client to connect to the <strong>openssh</strong> daemon running on a
    host called <strong>tarlop</strong>:</p>

    <div class="example"><pre>
1&gt; <span class="bold_code bc-12">ssh:start().</span>
ok
2&gt; <span class="bold_code bc-12">{ok, S} = ssh:shell("tarlop").</span>
otptest@tarlop:&gt; <span class="bold_code bc-12">pwd</span>
/home/otptest
otptest@tarlop:&gt; <span class="bold_code bc-12">exit</span>
logout
3&gt; </pre></div>
  

  <h3>
<a name="Running%20an%20Erlang%20ssh%20Daemon"></a><span onMouseOver="document.getElementById('ghlink-running-an-erlang-ssh-daemon-idm181').style.visibility = 'visible';" onMouseOut="document.getElementById('ghlink-running-an-erlang-ssh-daemon-idm181').style.visibility = 'hidden';"><span id="ghlink-running-an-erlang-ssh-daemon-idm181" class="ghlink"><a href="https://github.com/erlang/otp/edit/maint/lib/ssh/doc/src/using_ssh.xml#L72" title="Found an issue with the documentation? Fix it by clicking here!"><span class="pencil"></span></a></span><a class="title_link" name="running-an-erlang-ssh-daemon" href="#running-an-erlang-ssh-daemon">2.3 
          Running an Erlang ssh Daemon</a></span>
</h3>
    
    

    <p>The
    <span class="bold_code bc-15"><a href="../../man/ssh_file.html#type-system_dir_daemon_option"><span class="code">system_dir</span></a></span>
    option must be a directory containing a host key file and it defaults to <span class="code">/etc/ssh</span>.
    For details, see Section Configuration Files in <span class="bold_code bc-19"><a href="../../man/SSH_app.html">ssh(6)</a></span>.
    </p>

    <div class="note">
<div class="label">Note</div>
<div class="content"><p><p>Normally, the <span class="code">/etc/ssh</span> directory is only readable by root.</p>
    </p></div>
</div>

    <p>The option <span class="bold_code bc-15"><a href="../../man/ssh_file.html#type-user_dir_common_option"><span class="code">user_dir</span></a></span>
    defaults to directory <span class="code">users ~/.ssh</span>.</p>

    <p><strong>Step 1.</strong> To run the example without root privileges,
    generate new keys and host keys:</p>

    <div class="example"><pre>
$bash&gt; <span class="bold_code bc-12">ssh-keygen -t rsa -f /tmp/ssh_daemon/ssh_host_rsa_key</span>
[...]
$bash&gt; <span class="bold_code bc-12">ssh-keygen -t rsa -f /tmp/otptest_user/.ssh/id_rsa</span>
[...]  </pre></div>

    <p><strong>Step 2.</strong> Create the file <span class="code">/tmp/otptest_user/.ssh/authorized_keys</span>
    and add the content of <span class="code">/tmp/otptest_user/.ssh/id_rsa.pub</span>.</p>

    <a name="start-daemon-step3"></a>
    <p><strong>Step 3.</strong> Start the Erlang <span class="code">ssh</span> daemon:</p>

    <div class="example"><pre>
1&gt; <span class="bold_code bc-12">ssh:start().</span>
ok
2&gt; <span class="bold_code bc-12">{ok, Sshd} = ssh:daemon(8989, [{system_dir, "/tmp/ssh_daemon"},
                                  {user_dir, "/tmp/otptest_user/.ssh"}]).</span>
{ok,&lt;0.54.0&gt;}
3&gt; </pre></div>

    <p><strong>Step 4.</strong> Use the <strong>openssh</strong> client from a shell to connect
    to the Erlang <span class="code">ssh</span> daemon:</p>

    <div class="example"><pre>
$bash&gt; <span class="bold_code bc-12">ssh tarlop -p 8989  -i /tmp/otptest_user/.ssh/id_rsa \
                  -o UserKnownHostsFile=/tmp/otptest_user/.ssh/known_hosts</span>
The authenticity of host 'tarlop' can't be established.
RSA key fingerprint is 14:81:80:50:b1:1f:57:dd:93:a8:2d:2f:dd:90:ae:a8.
Are you sure you want to continue connecting (yes/no)? <span class="bold_code bc-12">yes</span>
Warning: Permanently added 'tarlop' (RSA) to the list of known hosts.
Eshell V5.10  (abort with ^G)
1&gt;   </pre></div>

    <p>There are two ways of shutting down an <span class="code">ssh</span> daemon,
    see <strong>Step 5a</strong> and <strong>Step 5b</strong>.</p>

    <p><strong>Step 5a.</strong> Shut down the Erlang <span class="code">ssh</span> daemon so that it
    stops the listener but leaves existing connections, started by the listener,
    operational:</p>

    <div class="example"><pre>
3&gt; <span class="bold_code bc-12">ssh:stop_listener(Sshd).</span>
ok
4&gt; </pre></div>

    <p><strong>Step 5b.</strong> Shut down the Erlang <span class="code">ssh</span> daemon so that it
    stops the listener and all connections started by the listener:</p>

    <div class="example"><pre>
3&gt; <span class="bold_code bc-12">ssh:stop_daemon(Sshd).</span>
ok
4&gt; </pre></div>
  

  <h3><span onMouseOver="document.getElementById('ghlink-one-time-execution-idm233').style.visibility = 'visible';" onMouseOut="document.getElementById('ghlink-one-time-execution-idm233').style.visibility = 'hidden';"><span id="ghlink-one-time-execution-idm233" class="ghlink"><a href="https://github.com/erlang/otp/edit/maint/lib/ssh/doc/src/using_ssh.xml#L145" title="Found an issue with the documentation? Fix it by clicking here!"><span class="pencil"></span></a></span><a class="title_link" name="one-time-execution" href="#one-time-execution">2.4 
          One-Time Execution</a></span></h3>
    

    <h4>
<a name="simple-client-example"></a><span onMouseOver="document.getElementById('ghlink-erlang-client-contacting-os-standard-ssh-server-idm235').style.visibility = 'visible';" onMouseOut="document.getElementById('ghlink-erlang-client-contacting-os-standard-ssh-server-idm235').style.visibility = 'hidden';"><span id="ghlink-erlang-client-contacting-os-standard-ssh-server-idm235" class="ghlink"><a href="https://github.com/erlang/otp/edit/maint/lib/ssh/doc/src/using_ssh.xml#L148" title="Found an issue with the documentation? Fix it by clicking here!"><span class="pencil"></span></a></span><a class="title_link" name="erlang-client-contacting-os-standard-ssh-server" href="#erlang-client-contacting-os-standard-ssh-server">Erlang client contacting OS standard ssh server</a></span>
</h4>
      
      
    <p>In the following example, the Erlang shell is the client process
    that receives the channel replies as Erlang messages.</p>

    <p>Do an one-time execution of a remote OS command ("pwd") over <span class="code">ssh</span> to the
    ssh server of the OS at the host "tarlop":</p>

    <div class="example"><pre>
1&gt; <span class="bold_code bc-12">ssh:start().</span>
ok
2&gt; <span class="bold_code bc-12">{ok, ConnectionRef} = ssh:connect("tarlop", 22, []).</span>
{ok,&lt;0.57.0&gt;}
3&gt; <span class="bold_code bc-12">{ok, ChannelId} = ssh_connection:session_channel(ConnectionRef, infinity).</span>
{ok,0}
4&gt; <span class="bold_code bc-12">success = ssh_connection:exec(ConnectionRef, ChannelId, "pwd", infinity).</span>
5&gt; <span class="bold_code bc-12">flush().</span> % Get all pending messages. NOTE: ordering may vary!
Shell got {ssh_cm,&lt;0.57.0&gt;,{data,0,0,&lt;&lt;"/home/otptest\n"&gt;&gt;}}
Shell got {ssh_cm,&lt;0.57.0&gt;,{eof,0}}
Shell got {ssh_cm,&lt;0.57.0&gt;,{exit_status,0,0}}
Shell got {ssh_cm,&lt;0.57.0&gt;,{closed,0}}
ok
6&gt; <span class="bold_code bc-12">ssh:connection_info(ConnectionRef, channels).</span>
{channels,[]}
7&gt;</pre></div>

    <p>See <span class="bold_code bc-15"><a href="../../man/ssh_connection.html#description">ssh_connection</a></span> and
    <span class="bold_code bc-15"><a href="../../man/ssh_connection.html#exec-4">ssh_connection:exec/4</a></span>
    for finding documentation of the channel messages.</p>

    <p>To collect the channel messages in a program, use <span class="code">receive...end</span> instead of <span class="code">flush/1</span>:</p>
    <div class="example"><pre>
5&gt; <span class="bold_code bc-12">receive</span>
5&gt; <span class="bold_code bc-12">    {ssh_cm, ConnectionRef, {data, ChannelId, Type, Result}} when Type == 0 -&gt;</span>
5&gt; <span class="bold_code bc-12">        {ok,Result}</span>
5&gt; <span class="bold_code bc-12">    {ssh_cm, ConnectionRef, {data, ChannelId, Type, Result}} when Type == 1 -&gt;</span>
5&gt; <span class="bold_code bc-12">        {error,Result}</span>
5&gt; <span class="bold_code bc-12">end.</span>
{ok,&lt;&lt;"/home/otptest\n"&gt;&gt;}
6&gt;</pre></div>


    <p>Note that only the exec channel is closed after the one-time execution.
    The connection is still up and can handle previously opened channels. It is also
    possible to open a new channel:</p>

    <div class="example"><pre>
% try to open a new channel to check if the ConnectionRef is still open
7&gt; <span class="bold_code bc-12">{ok, NewChannelId} = ssh_connection:session_channel(ConnectionRef, infinity).</span>
{ok,1}
8&gt;</pre></div>

    <p>To close the connection, call the function <span class="bold_code bc-15"><a href="../../man/ssh.html#close-1"><span class="code">ssh:close(ConnectionRef)</span></a></span>.
    As an alternative, set the option
    <span class="bold_code bc-15"><a href="../../man/ssh.html#type-max_idle_time_common_option"><span class="code">{idle_time, 1}</span></a></span>
    when opening the connection. This will cause the connection to be closed automaticaly when there are
    no channels open for the specified time period, in this case 1 ms.
    </p>
    
    
    <h4><span onMouseOver="document.getElementById('ghlink-os-standard-client-and-erlang-daemon--server--idm269').style.visibility = 'visible';" onMouseOut="document.getElementById('ghlink-os-standard-client-and-erlang-daemon--server--idm269').style.visibility = 'hidden';"><span id="ghlink-os-standard-client-and-erlang-daemon--server--idm269" class="ghlink"><a href="https://github.com/erlang/otp/edit/maint/lib/ssh/doc/src/using_ssh.xml#L209" title="Found an issue with the documentation? Fix it by clicking here!"><span class="pencil"></span></a></span><a class="title_link" name="os-standard-client-and-erlang-daemon--server-" href="#os-standard-client-and-erlang-daemon--server-">OS standard client and Erlang daemon (server)</a></span></h4>
      
      <p>An Erlang SSH daemon could be called for one-time execution of a "command". The "command" must be
      as if entered into the erlang shell, that is a sequence of Erlang
      <span class="bold_code bc-18"><a href="../../reference_manual/expressions.html">expressions</a></span> ended by a period (.).
      Variables bound in that sequence will keep their bindings throughout the expression sequence.
      The bindings are disposed when the result is returned.</p>
      <p>Here is an example of a suitable expression sequence:</p>
      <div class="example"><pre>
A=1, B=2, 3 == (A + B).</pre></div>
      <p>It evaluates to <span class="code">true</span> if submitted to the Erlang daemon started in
      <span class="bold_code bc-17"><a href="#start-daemon-step3">Step 3</a></span> above:</p>
      <div class="example"><pre>
$bash&gt; <span class="bold_code bc-12">ssh tarlop -p 8989 "A=1, B=2, 3 == (A + B)."</span>
true
$bash&gt;</pre></div>

      <p>The same example but now using the Erlang ssh client to contact the Erlang server:</p>
      <div class="example"><pre>
1&gt; <span class="bold_code bc-12">{ok, ConnectionRef} = ssh:connect("tarlop", 8989, []).</span>
{ok,&lt;0.216.0&gt;}
2&gt; <span class="bold_code bc-12">{ok, ChannelId} = ssh_connection:session_channel(ConnectionRef, infinity).</span>
{ok,0}
3&gt; <span class="bold_code bc-12">success = ssh_connection:exec(ConnectionRef, ChannelId,
                                 "A=1, B=2, 3 == (A + B).",
                                 infinity).</span>
success
4&gt; <span class="bold_code bc-12">flush().</span>
Shell got {ssh_cm,&lt;0.216.0&gt;,{data,0,0,&lt;&lt;"true"&gt;&gt;}}
Shell got {ssh_cm,&lt;0.216.0&gt;,{exit_status,0,0}}
Shell got {ssh_cm,&lt;0.216.0&gt;,{eof,0}}
Shell got {ssh_cm,&lt;0.216.0&gt;,{closed,0}}
ok
5&gt;</pre></div>
      
      <p>Note that Erlang shell specific functions and control sequences like for example
      <span class="code">h().</span> are not supported.
      </p>
    

    <h4><span onMouseOver="document.getElementById('ghlink-i-o-from-a-function-called-in-an-erlang-ssh-daemon-idm288').style.visibility = 'visible';" onMouseOut="document.getElementById('ghlink-i-o-from-a-function-called-in-an-erlang-ssh-daemon-idm288').style.visibility = 'hidden';"><span id="ghlink-i-o-from-a-function-called-in-an-erlang-ssh-daemon-idm288" class="ghlink"><a href="https://github.com/erlang/otp/edit/maint/lib/ssh/doc/src/using_ssh.xml#L249" title="Found an issue with the documentation? Fix it by clicking here!"><span class="pencil"></span></a></span><a class="title_link" name="i-o-from-a-function-called-in-an-erlang-ssh-daemon" href="#i-o-from-a-function-called-in-an-erlang-ssh-daemon">I/O from a function called in an Erlang ssh daemon</a></span></h4>
      
      
      <p>Output to stdout on the server side is also displayed as well as the resulting term
      from the function call:</p>
      <div class="example"><pre>
$bash&gt; <span class="bold_code bc-12">ssh tarlop -p 8989 'io:format("Hello!~n~nHow are ~p?~n",[you]).'</span>
Hello!
 
How are you?
ok
$bash&gt;</pre></div>

      <p>And similar for reading from stdin. As an example we use
      <span class="bold_code bc-13"><a href="../../man/io.html#read-1">io:read/1</a></span> which 
      displays the argument as a prompt on stdout, reads a term from stdin and returns it
      in an ok-tuple:</p>
      <div class="example"><pre>
$bash&gt; <span class="bold_code bc-12">ssh tarlop -p 8989 'io:read("write something: ").'</span>
write something: <span class="bold_code bc-12">[a,b,c].</span>
{ok,[a,b,c]}
$bash&gt;</pre></div>

      <p>The same example but using the Erlang ssh client:</p>
      <div class="example"><pre>	
Eshell V10.5.2  (abort with ^G)
1&gt; <span class="bold_code bc-12">ssh:start().</span>
ok
2&gt; <span class="bold_code bc-12">{ok, ConnectionRef} = ssh:connect(loopback, 8989, []).</span>
{ok,&lt;0.92.0&gt;}
3&gt; <span class="bold_code bc-12">{ok, ChannelId} = ssh_connection:session_channel(ConnectionRef, infinity).</span>
{ok,0}
4&gt; <span class="bold_code bc-12">success = ssh_connection:exec(ConnectionRef, ChannelId,
                                 "io:read(\"write something: \").",
                                 infinity).</span>
success
5&gt; <span class="bold_code bc-12">flush().</span>
Shell got {ssh_cm,&lt;0.92.0&gt;,{data,0,0,&lt;&lt;"write something: "&gt;&gt;}}
ok
% All data is sent as binaries with string contents:
6&gt; <span class="bold_code bc-12">ok = ssh_connection:send(ConnectionRef, ChannelId, &lt;&lt;"[a,b,c]."&gt;&gt;).</span>
ok
7&gt; <span class="bold_code bc-12">flush().</span>
ok
%% Nothing is received, because the io:read/1
%% requires the input line to end with a newline.

%% Send a newline (it could have been included in the last send):
8&gt; <span class="bold_code bc-12">ssh_connection:send(ConnectionRef, ChannelId, &lt;&lt;"\n"&gt;&gt;).</span>
ok
9&gt; <span class="bold_code bc-12">flush().</span>
Shell got {ssh_cm,&lt;0.92.0&gt;,{data,0,0,&lt;&lt;"{ok,[a,b,c]}"&gt;&gt;}}
Shell got {ssh_cm,&lt;0.92.0&gt;,{exit_status,0,0}}
Shell got {ssh_cm,&lt;0.92.0&gt;,{eof,0}}
Shell got {ssh_cm,&lt;0.92.0&gt;,{closed,0}}
ok
10&gt;</pre></div>
    
    
    <h4><span onMouseOver="document.getElementById('ghlink-configuring-the-server's--daemon's--command-execution-idm309').style.visibility = 'visible';" onMouseOut="document.getElementById('ghlink-configuring-the-server's--daemon's--command-execution-idm309').style.visibility = 'hidden';"><span id="ghlink-configuring-the-server's--daemon's--command-execution-idm309" class="ghlink"><a href="https://github.com/erlang/otp/edit/maint/lib/ssh/doc/src/using_ssh.xml#L308" title="Found an issue with the documentation? Fix it by clicking here!"><span class="pencil"></span></a></span><a class="title_link" name="configuring-the-server's--daemon's--command-execution" href="#configuring-the-server's--daemon's--command-execution">Configuring the server's (daemon's) command execution</a></span></h4>
      
      <p>Every time a daemon <span class="bold_code bc-17"><a href="#running-an-erlang-ssh-daemon">is started</a></span>, it enables
      one-time execution of commands as described in the
      <span class="bold_code bc-17"><a href="#simple-client-example">previous section</a></span> unless explicitly disabled.
      </p>

      <p>There is often a need to configure some other exec evaluator to tailor the input language or
      restrict the possible functions to call. There are two ways of doing this which will be shown with examples
      below. See <span class="bold_code bc-15"><a href="../../man/ssh.html#daemon-2">ssh:daemon/2,3</a></span> and
      <span class="bold_code bc-15"><a href="../../man/ssh.html#type-exec_daemon_option">exec_daemon_option()</a></span>) for details.</p>
      <p>Examples of the two ways to configure the exec evaluator:</p>
      <ul>
	<li>Disable one-time execution.<br>
	To modify the daemon start example above to reject one-time execution requests,
	we change <span class="bold_code bc-17"><a href="#start-daemon-step3">Step 3</a></span> by adding the option
	<span class="code">{exec, disabled}</span>
	to:
	<div class="example"><pre>
1&gt; <span class="bold_code bc-12">ssh:start().</span>
ok
2&gt; <span class="bold_code bc-12">{ok, Sshd} = ssh:daemon(8989, [{system_dir, "/tmp/ssh_daemon"},
                                  {user_dir, "/tmp/otptest_user/.ssh"},
                                  {exec, disabled}
                                 ]).</span>
{ok,&lt;0.54.0&gt;}
3&gt;	</pre></div>
	<p>A call to that daemon will return the text "Prohibited." on stderr (depending on the client and OS),
	and the exit status 255:</p>
	<div class="example"><pre>
$bash&gt; <span class="bold_code bc-12">ssh tarlop -p 8989 "test."</span>
Prohibited.
$bash&gt; <span class="bold_code bc-12">echo $?</span>
255
$bash&gt;	</pre></div>
	<p>And the Erlang client library also returns the text "Prohibited." on data type 1 instead of the normal 0
	and exit status 255:</p>
	<div class="example"><pre>
2&gt; <span class="bold_code bc-12">{ok, ConnectionRef} = ssh:connect(loopback, 8989, []).</span>
{ok,&lt;0.92.0&gt;}
3&gt; <span class="bold_code bc-12">{ok, ChannelId} = ssh_connection:session_channel(ConnectionRef, infinity).</span>
{ok,0}
4&gt; <span class="bold_code bc-12">success = ssh_connection:exec(ConnectionRef, ChannelId, "test."</span>
success
5&gt; <span class="bold_code bc-12">flush().</span>
Shell got {ssh_cm,&lt;0.106.0&gt;,{data,0,1,&lt;&lt;"Prohibited."&gt;&gt;}}
Shell got {ssh_cm,&lt;0.106.0&gt;,{exit_status,0,255}}
Shell got {ssh_cm,&lt;0.106.0&gt;,{eof,0}}
Shell got {ssh_cm,&lt;0.106.0&gt;,{closed,0}}
ok
6&gt;</pre></div>
	</li>
	
	<li>Install an alternative evaluator.<br>
	Start the damon with a reference to a <span class="code">fun()</span> that handles the evaluation:
	<div class="example"><pre>
1&gt; <span class="bold_code bc-12">ssh:start().</span>
ok
2&gt; <span class="bold_code bc-12">MyEvaluator = fun("1") -&gt; {ok, some_value};
                    ("2") -&gt; {ok, some_other_value};
                    ("3") -&gt; {ok, V} = io:read("input erlang term&gt;&gt; "),
                             {ok, V};
                    (Err) -&gt; {error,{bad_input,Err}}
                 end.</span>
3&gt; <span class="bold_code bc-12">{ok, Sshd} = ssh:daemon(1234, [{system_dir, "/tmp/ssh_daemon"},
                                  {user_dir, "/tmp/otptest_user/.ssh"},
                                  {exec, {direct,MyEvaluator}}
                                 ]).</span>
{ok,&lt;0.275.0&gt;}
4&gt;</pre></div>
	and call it:
	<div class="example"><pre>
$bash&gt; <span class="bold_code bc-12">ssh localhost -p 1234 1</span>
some_value
$bash&gt; <span class="bold_code bc-12">ssh localhost -p 1234 2</span>
some_other_value
# I/O works:
$bash&gt; <span class="bold_code bc-12">ssh localhost -p 1234 3</span>
input erlang term&gt;&gt; <span class="bold_code bc-12">abc.</span>
abc
# Check that Erlang evaluation is disabled:
$bash&gt; <span class="bold_code bc-12">ssh localhost -p 1234 1+ 2.</span>
**Error** {bad_input,"1+ 2."}
$bash&gt; 	</pre></div>
	Note that spaces are preserved and that no point (.) is needed at the end - that was required
	by the default evaluator.
	<p>The error return in the Erlang client (The text as data type 1 and exit_status 255):</p>
	<div class="example"><pre>
2&gt; <span class="bold_code bc-12">{ok, ConnectionRef} = ssh:connect(loopback, 1234, []).</span>
{ok,&lt;0.92.0&gt;}
3&gt; <span class="bold_code bc-12">{ok, ChannelId} = ssh_connection:session_channel(ConnectionRef, infinity).</span>
{ok,0}
4&gt; <span class="bold_code bc-12">success = ssh_connection:exec(ConnectionRef, ChannelId, "1+ 2."</span>
success
5&gt; <span class="bold_code bc-12">flush().</span>
Shell got {ssh_cm,&lt;0.106.0&gt;,{data,0,1,&lt;&lt;"**Error** {bad_input,\"1+ 2.\"}"&gt;&gt;}}
Shell got {ssh_cm,&lt;0.106.0&gt;,{exit_status,0,255}}
Shell got {ssh_cm,&lt;0.106.0&gt;,{eof,0}}
Shell got {ssh_cm,&lt;0.106.0&gt;,{closed,0}}
ok
6&gt;</pre></div>
	<p>The <span class="code">fun()</span> in the exec option could take up to three arguments
	(<span class="code">Cmd</span>, <span class="code">User</span> and <span class="code">ClientAddress</span>). See
	the <span class="bold_code bc-15"><a href="../../man/ssh.html#type-exec_daemon_option">exec_daemon_option()</a></span> for the details.</p>
	</li>
      </ul>


      <div class="note">
<div class="label">Note</div>
<div class="content"><p><p>An old, discouraged and undocumented way of installing an alternative evaluator exists.</p>
      <p>It still works, but lacks
      for example I/O possibility. It is because of that compatibility we need
      the <span class="code">{direct,...}</span>	construction.
      </p>
      </p></div>
</div>
    

  

  <h3><span onMouseOver="document.getElementById('ghlink-sftp-server-idm365').style.visibility = 'visible';" onMouseOut="document.getElementById('ghlink-sftp-server-idm365').style.visibility = 'hidden';"><span id="ghlink-sftp-server-idm365" class="ghlink"><a href="https://github.com/erlang/otp/edit/maint/lib/ssh/doc/src/using_ssh.xml#L426" title="Found an issue with the documentation? Fix it by clicking here!"><span class="pencil"></span></a></span><a class="title_link" name="sftp-server" href="#sftp-server">2.5 
          SFTP Server</a></span></h3>
    

    <p>Start the Erlang <span class="code">ssh</span> daemon with the SFTP subsystem:</p>

    <div class="example"><pre>
1&gt; <span class="bold_code bc-12">ssh:start().</span>
ok
2&gt; <span class="bold_code bc-12">ssh:daemon(8989, [{system_dir, "/tmp/ssh_daemon"},
                     {user_dir, "/tmp/otptest_user/.ssh"},
                     {subsystems, [ssh_sftpd:subsystem_spec(
                                            [{cwd, "/tmp/sftp/example"}])
                                  ]}]).</span>
{ok,&lt;0.54.0&gt;}
3&gt; </pre></div>

    <p>Run the OpenSSH SFTP client:</p>

    <div class="example"><pre>
$bash&gt; <span class="bold_code bc-12">sftp -oPort=8989 -o IdentityFile=/tmp/otptest_user/.ssh/id_rsa \
            -o UserKnownHostsFile=/tmp/otptest_user/.ssh/known_hosts tarlop</span>
Connecting to tarlop...
sftp&gt; <span class="bold_code bc-12">pwd</span>
Remote working directory: /tmp/sftp/example
sftp&gt; </pre></div>
  

  <h3><span onMouseOver="document.getElementById('ghlink-sftp-client-idm376').style.visibility = 'visible';" onMouseOut="document.getElementById('ghlink-sftp-client-idm376').style.visibility = 'hidden';"><span id="ghlink-sftp-client-idm376" class="ghlink"><a href="https://github.com/erlang/otp/edit/maint/lib/ssh/doc/src/using_ssh.xml#L453" title="Found an issue with the documentation? Fix it by clicking here!"><span class="pencil"></span></a></span><a class="title_link" name="sftp-client" href="#sftp-client">2.6 
          SFTP Client</a></span></h3>
    

    <p>Fetch a file with the Erlang SFTP client:</p>

    <div class="example"><pre>
1&gt; <span class="bold_code bc-12">ssh:start().</span>
ok
2&gt; <span class="bold_code bc-12">{ok, ChannelPid, Connection} = ssh_sftp:start_channel("tarlop", []).</span>
{ok,&lt;0.57.0&gt;,&lt;0.51.0&gt;}
3&gt; <span class="bold_code bc-12">ssh_sftp:read_file(ChannelPid, "/home/otptest/test.txt").</span>
{ok,&lt;&lt;"This is a test file\n"&gt;&gt;} </pre></div>
  

  <h3><span onMouseOver="document.getElementById('ghlink-sftp-client-with-tar-compression-idm383').style.visibility = 'visible';" onMouseOut="document.getElementById('ghlink-sftp-client-with-tar-compression-idm383').style.visibility = 'hidden';"><span id="ghlink-sftp-client-with-tar-compression-idm383" class="ghlink"><a href="https://github.com/erlang/otp/edit/maint/lib/ssh/doc/src/using_ssh.xml#L467" title="Found an issue with the documentation? Fix it by clicking here!"><span class="pencil"></span></a></span><a class="title_link" name="sftp-client-with-tar-compression" href="#sftp-client-with-tar-compression">2.7 
          SFTP Client with TAR Compression</a></span></h3>
    
    <h4><span onMouseOver="document.getElementById('ghlink-basic-example-idm385').style.visibility = 'visible';" onMouseOut="document.getElementById('ghlink-basic-example-idm385').style.visibility = 'hidden';"><span id="ghlink-basic-example-idm385" class="ghlink"><a href="https://github.com/erlang/otp/edit/maint/lib/ssh/doc/src/using_ssh.xml#L469" title="Found an issue with the documentation? Fix it by clicking here!"><span class="pencil"></span></a></span><a class="title_link" name="basic-example" href="#basic-example">Basic example</a></span></h4>
      
    <p>This is an example of writing and then reading a tar file:</p>
    <div class="example example-erl"><pre>{ok,HandleWrite} = ssh_sftp:open_tar(ChannelPid, ?tar_file_name, [write]),
ok = erl_tar:add(HandleWrite, .... ),
ok = erl_tar:add(HandleWrite, .... ),
...
ok = erl_tar:add(HandleWrite, .... ),
ok = erl_tar:close(HandleWrite),

%% And for reading
{ok,HandleRead} = ssh_sftp:open_tar(ChannelPid, ?tar_file_name, [read]),
{ok,NameValueList} = erl_tar:extract(HandleRead,[memory]),
ok = erl_tar:close(HandleRead),</pre></div>
  

  <h4><span onMouseOver="document.getElementById('ghlink-example-with-encryption-idm389').style.visibility = 'visible';" onMouseOut="document.getElementById('ghlink-example-with-encryption-idm389').style.visibility = 'hidden';"><span id="ghlink-example-with-encryption-idm389" class="ghlink"><a href="https://github.com/erlang/otp/edit/maint/lib/ssh/doc/src/using_ssh.xml#L487" title="Found an issue with the documentation? Fix it by clicking here!"><span class="pencil"></span></a></span><a class="title_link" name="example-with-encryption" href="#example-with-encryption">Example with encryption</a></span></h4>
    
    <p>The previous <span class="bold_code bc-15"><a href="using_ssh.html#basic-example">Basic example</a></span>
    can be extended with encryption and decryption as follows:</p>
    <div class="example example-erl"><pre>%% First three parameters depending on which crypto type we select:
Key = &lt;&lt;"This is a 256 bit key. abcdefghi"&gt;&gt;,
Ivec0 = crypto:strong_rand_bytes(16),
DataSize = 1024,  % DataSize rem 16 = 0 for aes_cbc

%% Initialization of the CryptoState, in this case it is the Ivector.
InitFun = fun() -&gt; {ok, Ivec0, DataSize} end,

%% How to encrypt:
EncryptFun =
    fun(PlainBin,Ivec) -&gt;
        EncryptedBin = crypto:block_encrypt(aes_cbc256, Key, Ivec, PlainBin),
        {ok, EncryptedBin, crypto:next_iv(aes_cbc,EncryptedBin)}
    end,

%% What to do with the very last block:
CloseFun =
    fun(PlainBin, Ivec) -&gt;
        EncryptedBin = crypto:block_encrypt(aes_cbc256, Key, Ivec,
                                            pad(16,PlainBin) %% Last chunk
                                           ),
       {ok, EncryptedBin}
    end,

Cw = {InitFun,EncryptFun,CloseFun},
{ok,HandleWrite} = ssh_sftp:open_tar(ChannelPid, ?tar_file_name, [write,{crypto,Cw}]),
ok = erl_tar:add(HandleWrite, .... ),
ok = erl_tar:add(HandleWrite, .... ),
...
ok = erl_tar:add(HandleWrite, .... ),
ok = erl_tar:close(HandleWrite),

%% And for decryption (in this crypto example we could use the same InitFun
%% as for encryption):
DecryptFun =
    fun(EncryptedBin,Ivec) -&gt;
        PlainBin = crypto:block_decrypt(aes_cbc256, Key, Ivec, EncryptedBin),
       {ok, PlainBin, crypto:next_iv(aes_cbc,EncryptedBin)}
    end,

Cr = {InitFun,DecryptFun},
{ok,HandleRead} = ssh_sftp:open_tar(ChannelPid, ?tar_file_name, [read,{crypto,Cw}]),
{ok,NameValueList} = erl_tar:extract(HandleRead,[memory]),
ok = erl_tar:close(HandleRead),</pre></div>
  
  

  <h3>
<a name="usersguide_creating_a_subsystem"></a><span onMouseOver="document.getElementById('ghlink-creating-a-subsystem-idm394').style.visibility = 'visible';" onMouseOut="document.getElementById('ghlink-creating-a-subsystem-idm394').style.visibility = 'hidden';"><span id="ghlink-creating-a-subsystem-idm394" class="ghlink"><a href="https://github.com/erlang/otp/edit/maint/lib/ssh/doc/src/using_ssh.xml#L540" title="Found an issue with the documentation? Fix it by clicking here!"><span class="pencil"></span></a></span><a class="title_link" name="creating-a-subsystem" href="#creating-a-subsystem">2.8 
          Creating a Subsystem</a></span>
</h3>
    
    

    <p>A small <span class="code">ssh</span> subsystem that echoes N bytes can be implemented as shown
    in the following example:</p>

    <div class="example example-erl"><pre>-module(ssh_echo_server).
-behaviour(ssh_server_channel). % replaces ssh_daemon_channel
-record(state, {
	  n,
	  id,
	  cm
	 }).
-export([init/1, handle_msg/2, handle_ssh_msg/2, terminate/2]).

init([N]) -&gt;
    {ok, #state{n = N}}.

handle_msg({ssh_channel_up, ChannelId, ConnectionManager}, State) -&gt;
    {ok, State#state{id = ChannelId,
		     cm = ConnectionManager}}.

handle_ssh_msg({ssh_cm, CM, {data, ChannelId, 0, Data}}, #state{n = N} = State) -&gt;
    M = N - size(Data),
    case M &gt; 0 of
	true -&gt;
	   ssh_connection:send(CM, ChannelId, Data),
	   {ok, State#state{n = M}};
	false -&gt;
	   &lt;&lt;SendData:N/binary, _/binary&gt;&gt; = Data,
           ssh_connection:send(CM, ChannelId, SendData),
           ssh_connection:send_eof(CM, ChannelId),
	   {stop, ChannelId, State}
    end;
handle_ssh_msg({ssh_cm, _ConnectionManager,
		{data, _ChannelId, 1, Data}}, State) -&gt;
    error_logger:format(standard_error, " ~p~n", [binary_to_list(Data)]),
    {ok, State};

handle_ssh_msg({ssh_cm, _ConnectionManager, {eof, _ChannelId}}, State) -&gt;
    {ok, State};

handle_ssh_msg({ssh_cm, _, {signal, _, _}}, State) -&gt;
    %% Ignore signals according to RFC 4254 section 6.9.
    {ok, State};

handle_ssh_msg({ssh_cm, _, {exit_signal, ChannelId, _, _Error, _}},
	       State) -&gt;
    {stop, ChannelId,  State};

handle_ssh_msg({ssh_cm, _, {exit_status, ChannelId, _Status}}, State) -&gt;
    {stop, ChannelId, State}.

terminate(_Reason, _State) -&gt;
    ok.</pre></div>

 <p>The subsystem can be run on the host <strong>tarlop</strong> with the generated keys,
 as described in Section <span class="bold_code bc-17"><a href="#Running%20an%20Erlang%20ssh%20Daemon">Running an Erlang ssh Daemon</a></span>:</p>

 <div class="example"><pre>
1&gt; <span class="bold_code bc-12">ssh:start().</span>
ok
2&gt; <span class="bold_code bc-12">ssh:daemon(8989, [{system_dir, "/tmp/ssh_daemon"},
                     {user_dir, "/tmp/otptest_user/.ssh"}
                     {subsystems, [{"echo_n", {ssh_echo_server, [10]}}]}]).</span>
{ok,&lt;0.54.0&gt;}
3&gt; </pre></div>

 <div class="example"><pre>
1&gt; <span class="bold_code bc-12">ssh:start().</span>
ok
2&gt; <span class="bold_code bc-12">{ok, ConnectionRef} = ssh:connect("tarlop", 8989,
                                    [{user_dir, "/tmp/otptest_user/.ssh"}]).</span>
 {ok,&lt;0.57.0&gt;}
3&gt; <span class="bold_code bc-12">{ok, ChannelId} = ssh_connection:session_channel(ConnectionRef, infinity).</span>
4&gt; <span class="bold_code bc-12">success = ssh_connection:subsystem(ConnectionRef, ChannelId, "echo_n", infinity).</span>
5&gt; <span class="bold_code bc-12">ok = ssh_connection:send(ConnectionRef, ChannelId, "0123456789", infinity).</span>
6&gt; <span class="bold_code bc-12">flush().</span>
{ssh_msg, &lt;0.57.0&gt;, {data, 0, 1, "0123456789"}}
{ssh_msg, &lt;0.57.0&gt;, {eof, 0}}
{ssh_msg, &lt;0.57.0&gt;, {closed, 0}}
7&gt; <span class="bold_code bc-12">{error, closed} = ssh_connection:send(ConnectionRef, ChannelId, "10", infinity).</span> </pre></div>
 
<p>See also <span class="bold_code bc-19"><a href="../../man/ssh_client_channel.html">ssh_client_channel(3)</a></span> (replaces ssh_channel(3)).</p>



</div>
<div class="footer">
<hr>
<p>Copyright © 2005-2024 Ericsson AB. All Rights Reserved.</p>
</div>
</div>
</div>
<script type="text/javascript">window.__otpTopDocDir = '../../js/';</script><script type="text/javascript" src="../../js/highlight.js"></script>
</body>
</html>
