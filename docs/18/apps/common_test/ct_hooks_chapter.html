<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html xmlns:fn="http://www.w3.org/2005/02/xpath-functions">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<link rel="stylesheet" href="../../otp_doc.css" type="text/css">
<title>Erlang -- Common Test Hooks</title>
</head>
<body bgcolor="white" text="#000000" link="#0000ff" vlink="#ff00ff" alink="#ff0000"><div id="container">
<script id="js" type="text/javascript" language="JavaScript" src="../../js/flipmenu/flipmenu.js"></script><script id="js2" type="text/javascript" src="../../js/erlresolvelinks.js"></script><script language="JavaScript" type="text/javascript">
            <!--
              function getWinHeight() {
                var myHeight = 0;
                if( typeof( window.innerHeight ) == 'number' ) {
                  //Non-IE
                  myHeight = window.innerHeight;
                } else if( document.documentElement && ( document.documentElement.clientWidth ||
                                                         document.documentElement.clientHeight ) ) {
                  //IE 6+ in 'standards compliant mode'
                  myHeight = document.documentElement.clientHeight;
                } else if( document.body && ( document.body.clientWidth || document.body.clientHeight ) ) {
                  //IE 4 compatible
                  myHeight = document.body.clientHeight;
                }
                return myHeight;
              }

              function setscrollpos() {
                var objf=document.getElementById('loadscrollpos');
                 document.getElementById("leftnav").scrollTop = objf.offsetTop - getWinHeight()/2;
              }

              function addEvent(obj, evType, fn){
                if (obj.addEventListener){
                obj.addEventListener(evType, fn, true);
                return true;
              } else if (obj.attachEvent){
                var r = obj.attachEvent("on"+evType, fn);
                return r;
              } else {
                return false;
              }
             }

             addEvent(window, 'load', setscrollpos);

             //--></script><div id="leftnav"><div class="innertube">
<img alt="Erlang logo" src="../../erlang-logo.png"><br><small><a href="users_guide.html">User's Guide</a><br><a href="index.html">Reference Manual</a><br><a href="release_notes.html">Release Notes</a><br><a href="common_test.pdf">PDF</a><br><a href="../../index.html">Top</a></small><p><strong>Common Test</strong><br><strong>User's Guide</strong><br><small>Version 1.12</small></p>
<br><a href="javascript:openAllFlips()">Expand All</a><br><a href="javascript:closeAllFlips()">Contract All</a><p><small><strong>Chapters</strong></small></p>
<ul class="flipMenu" imagePath="../../js/flipmenu">
<li id="no" title="Introduction" expanded="false">Introduction<ul>
<li><a href="introduction.html">
              Top of chapter
            </a></li>
<li title="Scope"><a href="introduction.html#id61477">Scope</a></li>
<li title="Prerequisites"><a href="introduction.html#id61932">Prerequisites</a></li>
</ul>
</li>
<li id="no" title="Common Test Basics" expanded="false">Common Test Basics<ul>
<li><a href="basics_chapter.html">
              Top of chapter
            </a></li>
<li title="General"><a href="basics_chapter.html#id56619">General</a></li>
<li title="Test Suite Organisation"><a href="basics_chapter.html#id59157">Test Suite Organisation</a></li>
<li title="Support Libraries"><a href="basics_chapter.html#id67513">Support Libraries</a></li>
<li title="Suites and Test Cases"><a href="basics_chapter.html#id56610">Suites and Test Cases</a></li>
<li title="External Interfaces"><a href="basics_chapter.html#id64806">External Interfaces</a></li>
</ul>
</li>
<li id="no" title="Getting Started" expanded="false">Getting Started<ul>
<li><a href="getting_started_chapter.html">
              Top of chapter
            </a></li>
<li title="Introduction for Newcomers"><a href="getting_started_chapter.html#id63529">Introduction for Newcomers</a></li>
<li title="Test Case Execution"><a href="getting_started_chapter.html#id69403">Test Case Execution</a></li>
<li title="A Simple Test Suite"><a href="getting_started_chapter.html#id64054">A Simple Test Suite</a></li>
<li title="A Test Suite with Configuration Functions"><a href="getting_started_chapter.html#id62519">A Test Suite with Configuration Functions</a></li>
<li title="Questions and Answers"><a href="getting_started_chapter.html#id69030">Questions and Answers</a></li>
</ul>
</li>
<li id="no" title="Installation" expanded="false">Installation<ul>
<li><a href="install_chapter.html">
              Top of chapter
            </a></li>
<li title="General Information"><a href="install_chapter.html#id75238">General Information</a></li>
</ul>
</li>
<li id="no" title="Writing Test Suites" expanded="false">Writing Test Suites<ul>
<li><a href="write_test_chapter.html">
              Top of chapter
            </a></li>
<li title="Support for Test Suite Authors"><a href="write_test_chapter.html#id68804">Support for Test Suite Authors</a></li>
<li title="Test Suites"><a href="write_test_chapter.html#id68868">Test Suites</a></li>
<li title="Init and End per Suite"><a href="write_test_chapter.html#id68917">Init and End per Suite</a></li>
<li title="Init and End per Test Case"><a href="write_test_chapter.html#id74324">Init and End per Test Case</a></li>
<li title="Test Cases"><a href="write_test_chapter.html#id74622">Test Cases</a></li>
<li title="Test Case Information Function"><a href="write_test_chapter.html#id74809">Test Case Information Function</a></li>
<li title="Test Suite Information Function"><a href="write_test_chapter.html#id75006">Test Suite Information Function</a></li>
<li title="Test Case Groups"><a href="write_test_chapter.html#id76177">Test Case Groups</a></li>
<li title="Parallel Property and Nested Groups"><a href="write_test_chapter.html#id76612">Parallel Property and Nested Groups</a></li>
<li title="Parallel Test Cases and I/O"><a href="write_test_chapter.html#id76648">Parallel Test Cases and I/O</a></li>
<li title="Repeated Groups"><a href="write_test_chapter.html#id76702">Repeated Groups</a></li>
<li title="Shuffled Test Case Order"><a href="write_test_chapter.html#id76856">Shuffled Test Case Order</a></li>
<li title="Group Information Function"><a href="write_test_chapter.html#id76921">Group Information Function</a></li>
<li title="Information Functions for Init- and End-Configuration"><a href="write_test_chapter.html#id76963">Information Functions for Init- and End-Configuration</a></li>
<li title="Data and Private Directories"><a href="write_test_chapter.html#id77038">Data and Private Directories</a></li>
<li title="Execution Environment"><a href="write_test_chapter.html#id77195">Execution Environment</a></li>
<li title="Timetrap Time-Outs"><a href="write_test_chapter.html#id77232">Timetrap Time-Outs</a></li>
<li title="Logging - Categories and Verbosity Levels"><a href="write_test_chapter.html#id77433">Logging - Categories and Verbosity Levels</a></li>
<li title="Illegal Dependencies"><a href="write_test_chapter.html#id77745">Illegal Dependencies</a></li>
</ul>
</li>
<li id="no" title="Test Structure" expanded="false">Test Structure<ul>
<li><a href="test_structure_chapter.html">
              Top of chapter
            </a></li>
<li title="General"><a href="test_structure_chapter.html#id77938">General</a></li>
<li title="Skipping Test Cases"><a href="test_structure_chapter.html#id77957">Skipping Test Cases</a></li>
<li title="Definition of Terms"><a href="test_structure_chapter.html#id78036">Definition of Terms</a></li>
</ul>
</li>
<li id="no" title="Examples and Templates" expanded="false">Examples and Templates<ul>
<li><a href="example_chapter.html">
              Top of chapter
            </a></li>
<li title="Test Suite Example"><a href="example_chapter.html#id78347">Test Suite Example</a></li>
<li title="Test Suite Templates"><a href="example_chapter.html#id78400">Test Suite Templates</a></li>
</ul>
</li>
<li id="no" title="Running Tests and Analyzing Results" expanded="false">Running Tests and Analyzing Results<ul>
<li><a href="run_test_chapter.html">
              Top of chapter
            </a></li>
<li title="Using the Common Test Framework"><a href="run_test_chapter.html#id78595">Using the Common Test Framework</a></li>
<li title="Automatic Compilation of Test Suites and Help Modules"><a href="run_test_chapter.html#id78638">Automatic Compilation of Test Suites and Help Modules</a></li>
<li title="Running Tests from the OS Command Line"><a href="run_test_chapter.html#id78832">Running Tests from the OS Command Line</a></li>
<li title="Running Tests from the Erlang Shell or from an Erlang Program"><a href="run_test_chapter.html#id79514">Running Tests from the Erlang Shell or from an Erlang Program</a></li>
<li title="Test Case Group Execution"><a href="run_test_chapter.html#id79690">Test Case Group Execution</a></li>
<li title="Running the Interactive Shell Mode"><a href="run_test_chapter.html#id80196">Running the Interactive Shell Mode</a></li>
<li title="Step-by-Step Execution of Test Cases with the Erlang Debugger"><a href="run_test_chapter.html#id80419">Step-by-Step Execution of Test Cases with the Erlang Debugger</a></li>
<li title="Test Specifications"><a href="run_test_chapter.html#id80547">Test Specifications</a></li>
<li title="Running Tests from the Web-Based GUI"><a href="run_test_chapter.html#id81528">Running Tests from the Web-Based GUI</a></li>
<li title="Log Files"><a href="run_test_chapter.html#id81639">Log Files</a></li>
<li title="HTML Style Sheets"><a href="run_test_chapter.html#id82115">HTML Style Sheets</a></li>
<li title="Repeating Tests"><a href="run_test_chapter.html#id82293">Repeating Tests</a></li>
<li title="Silent Connections"><a href="run_test_chapter.html#id82658">Silent Connections</a></li>
</ul>
</li>
<li id="no" title="External Configuration Data" expanded="false">External Configuration Data<ul>
<li><a href="config_file_chapter.html">
              Top of chapter
            </a></li>
<li title="General"><a href="config_file_chapter.html#id82894">General</a></li>
<li title="Syntax"><a href="config_file_chapter.html#id82937">Syntax</a></li>
<li title="Requiring and Reading Configuration Data"><a href="config_file_chapter.html#id82961">Requiring and Reading Configuration Data</a></li>
<li title="Using Configuration Variables Defined in Multiple Files"><a href="config_file_chapter.html#id83093">Using Configuration Variables Defined in Multiple Files</a></li>
<li title="Encrypted Configuration Files"><a href="config_file_chapter.html#id83118">Encrypted Configuration Files</a></li>
<li title="Opening Connections Using Configuration Data"><a href="config_file_chapter.html#id83181">Opening Connections Using Configuration Data</a></li>
<li title="User-Specific Configuration Data Formats"><a href="config_file_chapter.html#id83252">User-Specific Configuration Data Formats</a></li>
<li title="Examples of Configuration Data Handling"><a href="config_file_chapter.html#id83469">Examples of Configuration Data Handling</a></li>
<li title="Example of User-Specific Configuration Handler"><a href="config_file_chapter.html#id83524">Example of User-Specific Configuration Handler</a></li>
</ul>
</li>
<li id="no" title="Code Coverage Analysis" expanded="false">Code Coverage Analysis<ul>
<li><a href="cover_chapter.html">
              Top of chapter
            </a></li>
<li title="General"><a href="cover_chapter.html#id83651">General</a></li>
<li title="Use"><a href="cover_chapter.html#id83685">Use</a></li>
<li title="Stopping the Cover Tool When Tests Are Completed"><a href="cover_chapter.html#id83800">Stopping the Cover Tool When Tests Are Completed</a></li>
<li title="The Cover Specification File"><a href="cover_chapter.html#id83861">The Cover Specification File</a></li>
<li title="Cross Cover Analysis"><a href="cover_chapter.html#id83925">Cross Cover Analysis</a></li>
<li title="Logging"><a href="cover_chapter.html#id84152">Logging</a></li>
</ul>
</li>
<li id="no" title="Using Common Test for Large-Scale Testing" expanded="false">Using Common Test for Large-Scale Testing<ul>
<li><a href="ct_master_chapter.html">
              Top of chapter
            </a></li>
<li title="General"><a href="ct_master_chapter.html#id84240">General</a></li>
<li title="Use"><a href="ct_master_chapter.html#id84318">Use</a></li>
<li title="Test Specifications"><a href="ct_master_chapter.html#id84511">Test Specifications</a></li>
<li title="Automatic Startup of Test Target Nodes"><a href="ct_master_chapter.html#id84762">Automatic Startup of Test Target Nodes</a></li>
</ul>
</li>
<li id="no" title="Event Handling" expanded="false">Event Handling<ul>
<li><a href="event_handler_chapter.html">
              Top of chapter
            </a></li>
<li title="General"><a href="event_handler_chapter.html#id84972">General</a></li>
<li title="Use"><a href="event_handler_chapter.html#id85113">Use</a></li>
</ul>
</li>
<li id="no" title="Dependencies between Test Cases and Suites" expanded="false">Dependencies between Test Cases and Suites<ul>
<li><a href="dependencies_chapter.html">
              Top of chapter
            </a></li>
<li title="General"><a href="dependencies_chapter.html#id86232">General</a></li>
<li title="Saving Configuration Data"><a href="dependencies_chapter.html#id86369">Saving Configuration Data</a></li>
<li title="Sequences"><a href="dependencies_chapter.html#id86542">Sequences</a></li>
</ul>
</li>
<li id="loadscrollpos" title="Common Test Hooks" expanded="true">Common Test Hooks<ul>
<li><a href="ct_hooks_chapter.html">
              Top of chapter
            </a></li>
<li title="General"><a href="ct_hooks_chapter.html#id86749">General</a></li>
<li title="Installing a CTH"><a href="ct_hooks_chapter.html#id86809">Installing a CTH</a></li>
<li title="CTH Scope"><a href="ct_hooks_chapter.html#id86991">CTH Scope</a></li>
<li title="Manipulating Tests"><a href="ct_hooks_chapter.html#id87353">Manipulating Tests</a></li>
<li title="Synchronizing External User Applications with Common Test"><a href="ct_hooks_chapter.html#id87717">Synchronizing External User Applications with Common Test</a></li>
<li title="Example CTH"><a href="ct_hooks_chapter.html#id87794">Example CTH</a></li>
<li title="Built-In CTHs"><a href="ct_hooks_chapter.html#id87855">Built-In CTHs</a></li>
</ul>
</li>
<li id="no" title="Some Thoughts about Testing" expanded="false">Some Thoughts about Testing<ul>
<li><a href="why_test_chapter.html">
              Top of chapter
            </a></li>
<li title="Goals"><a href="why_test_chapter.html#id88055">Goals</a></li>
<li title="What to Test"><a href="why_test_chapter.html#id88075">What to Test</a></li>
</ul>
</li>
</ul>
</div></div>
<div id="content">
<div class="innertube">
<h1>14 Common Test Hooks</h1>
  

  <h3><a name="id86749">14.1 
        General</a></h3>
    <a name="general"></a>
    
    <p>
      The <strong>Common Test Hook (CTH)</strong> framework allows 
      extensions of the default behavior of <span class="code">Common Test</span> using hooks 
      before and after all test suite calls. CTHs allow advanced <span class="code">Common Test</span>
      users to abstract out behavior that is common to multiple test suites
      without littering all test suites with library calls. this can be used 
      for logging, starting, and monitoring external systems, 
      building C files needed by the tests, and so on.</p>

    <p>In brief, CTH allows you to do the following:</p>

    <ul>
      <li>Manipulate the runtime configuration before each suite 
      configuration call.</li>
      <li>Manipulate the return of all suite configuration calls, and in 
      extension, the result of the tests themselves.</li>
    </ul>
    
    <p>The following sections describe how to use CTHs, when they are run,
      and how to manipulate the test results in a CTH.</p>

    <div class="warning">
<div class="label">Warning</div>
<div class="content"><p><p>When executing within a CTH, all timetraps are shut off. So
	if your CTH never returns, the entire test run is stalled.</p>
    </p></div>
</div>

  
  
  <h3><a name="id86809">14.2 
        Installing a CTH</a></h3>
    <a name="installing"></a>
    
    <p>A CTH can be installed in multiple ways in your test run. You can do it
      for all tests in a run, for specific test suites, and for specific groups 
      within a test suite. If you want a CTH to be present in all test suites 
      within your test run, there are three ways to accomplish that, as follows:
    </p>

    <ul>
      <li>Add <span class="code">-ct_hooks</span> as an argument to 
      <span class="bold_code"><a href="run_test_chapter.html#ct_run">ct_run</a></span>. 
      To add multiple CTHs using this method, append them to each other
      using the keyword <span class="code">and</span>, that is, 
      <span class="code">ct_run -ct_hooks cth1 [{debug,true}] and cth2 ...</span>.</li>
      <li>Add tag <span class="code">ct_hooks</span> to your 
      <span class="bold_code"><a href="run_test_chapter.html#test_specifications">
      Test Specification</a></span>.</li>
      <li>Add tag <span class="code">ct_hooks</span> to your call to 
      <span class="bold_code"><a href="../../man/ct.html#run_test-1">ct:run_test/1</a></span>.</li>
    </ul>

    <p>CTHs can also be added within a test suite. This is done by returning
    <span class="code">{ct_hooks,[CTH]}</span> in the configuration list from 
    <span class="bold_code"><a href="../../man/common_test.html#Module:suite-0">suite/0</a></span>,
    <span class="bold_code"><a href="../../man/common_test.html#Module:init_per_suite-1">
      init_per_suite/1</a></span>, or
      <span class="bold_code"><a href="../../man/common_test.html#Module:init_per_group-2">
    init_per_group/2</a></span>.</p>

    <p>In this case, <span class="code">CTH</span> can either be only the module name of the CTH 
    or a tuple with the module name and the initial arguments, and optionally 
    the hook priority of the CTH. For example, one of the following:</p>
    <ul>
    <li><span class="code">{ct_hooks,[my_cth_module]}</span></li> 
    <li><span class="code">{ct_hooks,[{my_cth_module,[{debug,true}]}]}</span></li>
    <li><span class="code">{ct_hooks,[{my_cth_module,[{debug,true}],500}]}</span></li>
    </ul>

    <h4>Overriding CTHs</h4>
      
      <p>By default, each installation of a CTH causes a new instance of it
	to be activated. This can cause problems if you want to override 
	CTHs in test specifications while still having them in the
	suite information function. The 
	<span class="bold_code"><a href="../../man/ct_hooks.html#Module:id-1">id/1</a></span>
	callback exists to address this problem. By returning the same
	<span class="code">id</span> in both places, <span class="code">Common Test</span> knows that this CTH
	is already installed and does not try to install it again.</p>
    
   
    <h4>CTH Execution Order</h4>
      
      <p>By default, each CTH installed is executed in the order that
      they are installed for init calls, and then reversed for end calls.
      This is not always desired, so <span class="code">Common Test</span> allows
      the user to specify a priority for each hook. The priority can either
      be specified in the CTH function 
      <span class="bold_code"><a href="../../man/ct_hooks.html#Module:init-2">init/2</a></span> or when 
      installing the hook. The priority specified at installation overrides the 
      priority returned by the CTH.</p>
    
  

  <h3><a name="id86991">14.3 
        CTH Scope</a></h3>
    <a name="scope"></a>
    
    <p>Once the CTH is installed into a certain test run it remains there until
      its scope is expired. The scope of a CTH depends on when it is 
      installed, see the following table.
      Function <span class="bold_code"><a href="../../man/ct_hooks.html#Module:init-2">init/2</a></span> is 
      called at the beginning of the scope and function
      <span class="bold_code"><a href="../../man/ct_hooks.html#Module:terminate-1">terminate/1</a></span> 
      is called when the scope ends.</p>
    <table border="1" cellpadding="2" cellspacing="0">
<tr>
	<td align="left" valign="middle"><strong>CTH installed in</strong></td>
	<td align="left" valign="middle"><strong>CTH scope begins before</strong></td>
	<td align="left" valign="middle"><strong>CTH scope ends after</strong></td>
      </tr>
<tr>
	<td align="left" valign="middle"><span class="bold_code"><a href="run_test_chapter.html#ct_run">ct_run</a></span></td>
	<td align="left" valign="middle">the first test suite is to be run</td>
	<td align="left" valign="middle">the last test suite has been run</td>
      </tr>
<tr>
	<td align="left" valign="middle"><span class="bold_code"><a href="../../man/ct.html#run_test-1">ct:run_test</a></span></td>
	<td align="left" valign="middle">the first test suite is run</td>
	<td align="left" valign="middle">the last test suite has been run</td>
      </tr>
<tr>
	<td align="left" valign="middle"><span class="bold_code"><a href="run_test_chapter.html#test_specifications">
	  Test Specification</a></span></td>
	<td align="left" valign="middle">the first test suite is run</td>
	<td align="left" valign="middle">the last test suite has been run</td>
      </tr>
<tr>
	<td align="left" valign="middle"><span class="bold_code"><a href="../../man/common_test.html#Module:suite-0">suite/0
	</a></span></td>
	<td align="left" valign="middle">
<span class="bold_code"><a href="../../man/ct_hooks.html#Module:pre_init_per_suite-3">
	    pre_init_per_suite/3</a></span> is called</td>
	<td align="left" valign="middle">
<span class="bold_code"><a href="../../man/ct_hooks.html#Module:post_end_per_suite-4">
	  post_end_per_suite/4</a></span> has been called for that test suite</td>
      </tr>
<tr>
	<td align="left" valign="middle"><span class="bold_code"><a href="../../man/common_test.html#Module:init_per_suite-1">
	  init_per_suite/1</a></span></td>
	<td align="left" valign="middle">
<span class="bold_code"><a href="../../man/ct_hooks.html#Module:post_init_per_suite-4">
	    post_init_per_suite/4</a></span> is called</td>
	<td align="left" valign="middle">
<span class="bold_code"><a href="../../man/ct_hooks.html#Module:post_end_per_suite-4">
	  post_end_per_suite/4</a></span> has been called for that test suite</td>
      </tr>
<tr>
	<td align="left" valign="middle"><span class="bold_code"><a href="../../man/common_test.html#Module:init_per_group-2">
	  init_per_group/2</a></span></td>
	<td align="left" valign="middle">
<span class="bold_code"><a href="../../man/ct_hooks.html#Module:post_init_per_group-4">
	    post_init_per_group/4</a></span> is called</td>
	<td align="left" valign="middle">
<span class="bold_code"><a href="../../man/ct_hooks.html#Module:post_end_per_suite-4">
	  post_end_per_group/4</a></span> has been called for that group</td>
      </tr>
</table>
<em>Table
        14.1:
         
        Scope of a CTH</em>
    
    <h4>CTH Processes and Tables</h4>
      
      <p>CTHs are run with the same process scoping as normal test suites,
	that is, a different process executes the <span class="code">init_per_suite</span> hooks then the
	<span class="code">init_per_group</span> or <span class="code">per_testcase</span> hooks. So if you want to spawn a 
	process in the CTH, you cannot link with the CTH process, as it exits 
	after the post hook ends. Also, if you for some reason need an ETS 
	table with your CTH, you must spawn a process that handles it.</p>
    
    
    <h4>External Configuration Data and Logging</h4>
      
      <p>Configuration data values in the CTH can be read
	by calling 
	<span class="bold_code"><a href="../../man/ct.html#get_config-1"><span class="code">ct:get_config/1,2,3</span></a></span> 
	(as explained in section
	<span class="bold_code"><a href="config_file_chapter.html#require_config_data">Requiring and Reading Configuration Data</a></span>).
	The configuration variables in question must, as always, first have been
	required by a suite-, group-, or test case information function,
	or by function <span class="bold_code"><a href="../../man/ct.html#require-1"><span class="code">ct:require/1/2</span></a></span>.
	The latter can also be used in CT hook functions.</p>
      <p>The CT hook functions can call any logging function
	in the <span class="code">ct</span> interface to print information to the log files, or to
	add comments in the suite overview page.
      </p>
        

  

  <h3><a name="id87353">14.4 
        Manipulating Tests</a></h3>
     <a name="manipulating"></a>
    
    <p>Through CTHs the results of tests and configuration functions can be manipulated. 
    The main purpose to do this with CTHs is to allow common 
    patterns to be abstracted out from test suites and applied to
    multiple test suites without duplicating any code. All the callback
    functions for a CTH follow a common interface described hereafter.</p>

    <p><span class="code">Common Test</span> always calls all available hook functions, even pre- 
      and post hooks for configuration functions that are not implemented in the suite.
      For example, <span class="code">pre_init_per_suite(x_SUITE, ...)</span> and
      <span class="code">post_init_per_suite(x_SUITE, ...)</span> are called for test suite
      <span class="code">x_SUITE</span>, even if it does not export <span class="code">init_per_suite/1</span>. 
      With this feature hooks can be used as configuration fallbacks, and all
      configuration functions can be replaced with hook functions.</p>

    <h4>Pre Hooks</h4>
      <a name="pre"></a>
      
      <p>
	In a CTH, the behavior can be hooked in before the following functions:</p>

     <ul>
       <li><span class="bold_code"><a href="../../man/common_test.html#Module:init_per_suite-1"><span class="code">init_per_suite</span></a></span></li>
       <li><span class="bold_code"><a href="../../man/common_test.html#Module:init_per_group-2"><span class="code">init_per_group</span></a></span></li>
       <li><span class="bold_code"><a href="../../man/common_test.html#Module:init_per_testcase-2"><span class="code">init_per_testcase</span></a></span></li>
       <li><span class="bold_code"><a href="../../man/common_test.html#Module:end_per_testcase-2"><span class="code">end_per_testcase</span></a></span></li>
       <li><span class="bold_code"><a href="../../man/common_test.html#Module:end_per_group-2"><span class="code">end_per_group</span></a></span></li>
       <li><span class="bold_code"><a href="../../man/common_test.html#Module:end_per_suite-1"><span class="code">end_per_suite</span></a></span></li>
     </ul>

        <p>
	This is done in the CTH functions called pre_&lt;name of function&gt;.
	These functions take the same three arguments, <span class="code">Name</span>, 
	<span class="code">Config</span>, and <span class="code">CTHState</span>. The return value of the CTH function
	is always a combination of a result for the suite/group/test and an 
	updated <span class="code">CTHState</span>.</p>

	<p>To let the test suite continue on executing, return the configuration 
	list that you want the test to use as the result. To skip or 
	fail the test, return a tuple with <span class="code">skip</span> or <span class="code">fail</span>, and a reason 
	as the result.</p>

	<p><strong>Example:</strong></p>
	<div class="example"><pre>
 pre_init_per_suite(SuiteName, Config, CTHState) -&gt;
   case db:connect() of
     {error,_Reason} -&gt;
       {{fail, "Could not connect to DB"}, CTHState};
     {ok, Handle} -&gt;
       {[{db_handle, Handle} | Config], CTHState#state{ handle = Handle }}
   end.</pre></div>

  <div class="note">
<div class="label">Note</div>
<div class="content"><p><p>If you use multiple CTHs, the first part of the return tuple is
  used as input for the next CTH. So in the previous example the next CTH can
  get <span class="code">{fail,Reason}</span> as the second parameter. If you have many CTHs
  interacting, do not let each CTH return <span class="code">fail</span> or <span class="code">skip</span>. 
  Instead, return that an action is to be taken through the <span class="code">Config</span> 
  list and implement a CTH that, at the end, takes the correct action.</p></p></div>
</div>
	
    
    
    <h4>Post Hooks</h4>
      <a name="post"></a>
      
      <p>In a CTH, behavior can be hooked in after the following functions:</p>
      <ul>
       <li><span class="bold_code"><a href="../../man/common_test.html#Module:init_per_suite-1"><span class="code">init_per_suite</span></a></span></li>
       <li><span class="bold_code"><a href="../../man/common_test.html#Module:init_per_group-2"><span class="code">init_per_group</span></a></span></li>
       <li><span class="bold_code"><a href="../../man/common_test.html#Module:init_per_testcase-2"><span class="code">init_per_testcase</span></a></span></li>
       <li><span class="bold_code"><a href="../../man/common_test.html#Module:end_per_testcase-2"><span class="code">end_per_testcase</span></a></span></li>
       <li><span class="bold_code"><a href="../../man/common_test.html#Module:end_per_group-2"><span class="code">end_per_group</span></a></span></li>
       <li><span class="bold_code"><a href="../../man/common_test.html#Module:end_per_suite-1"><span class="code">end_per_suite</span></a></span></li>
     </ul>

     <p>
      This is done in the CTH functions called <span class="code">post_&lt;name of function&gt;</span>. 
      These functions take the same four arguments, <span class="code">Name</span>, 
      <span class="code">Config</span>, <span class="code">Return</span>, and <span class="code">CTHState</span>. <span class="code">Config</span> in this
      case is the same <span class="code">Config</span> as the testcase is called with. 
      <span class="code">Return</span> is the value returned by the testcase. If the testcase 
      fails by crashing, <span class="code">Return</span> is
      <span class="code">{'EXIT',{{Error,Reason},Stacktrace}}</span>.</p>
      
      <p>The return value of the CTH function is always a combination of a
	result for the suite/group/test and an updated <span class="code">CTHState</span>. If
	you do not want the callback to affect the outcome of the test,
	return the <span class="code">Return</span> data as it is given to the CTH. You can also
	modify the test result. By returning the <span class="code">Config</span> list
	with element <span class="code">tc_status</span> removed, you can recover from a test 
	failure. As in all the pre hooks, it is also possible to fail/skip
	the test case in the post hook.</p>
	
	<p><strong>Example:</strong></p>
	<div class="example"><pre>
 post_end_per_testcase(_TC, Config, {'EXIT',{_,_}}, CTHState) -&gt;
   case db:check_consistency() of
     true -&gt;
       %% DB is good, pass the test.
       {proplists:delete(tc_status, Config), CTHState};
     false -&gt;
       %% DB is not good, mark as skipped instead of failing
       {{skip, "DB is inconsisten!"}, CTHState}
   end;
 post_end_per_testcase(_TC, Config, Return, CTHState) -&gt;
   %% Do nothing if tc does not crash.
   {Return, CTHState}.</pre></div>

      <div class="note">
<div class="label">Note</div>
<div class="content"><p><p>Do recover from a testcase failure using CTHs only a last resort. 
      If used wrongly, it can be very difficult to determine which tests that 
      pass or fail in a test run.</p></p></div>
</div>
  
    

    <h4>Skip and Fail Hooks</h4>
      
      <p>
	After any post hook has been executed for all installed CTHs, 
	<span class="bold_code"><a href="../../man/ct_hooks.html#Module:on_tc_fail-3">on_tc_fail</a></span>
	or <span class="bold_code"><a href="../../man/ct_hooks.html#Module:on_tc_skip-3">on_tc_skip</a></span> 
	is called if the testcase failed or was skipped, respectively. 
	You cannot affect the outcome of the tests any further at this point. 
      </p>
    

  

  <h3><a name="id87717">14.5 
        Synchronizing External User Applications with Common Test</a></h3>
     <a name="synchronizing"></a>
    
    <p>CTHs can be used to synchronize test runs with external user applications.
    The init function can, for example, start and/or communicate with an application that
    has the purpose of preparing the SUT for an upcoming test run, or 
    initialize a database for saving test data to during the test run. The
    terminate function can similarly order such an application to reset the SUT
    after the test run, and/or tell the application to finish active sessions
    and terminate.
    Any system error- or progress reports generated during the init- or
    termination stage are saved in the 
    <span class="bold_code"><a href="run_test_chapter.html#pre_post_test_io_log">Pre- and Post Test I/O Log</a></span>. 
    (This is also true for any printouts made
    with <span class="code">ct:log/2</span> and <span class="code">ct:pal/2</span>).</p>

    <p>To ensure that <span class="code">Common Test</span> does not start executing tests, or
    closes its log files and shuts down, before the external application
    is ready for it, <span class="code">Common Test</span> can be synchronized with the application. 
    During startup and shutdown, <span class="code">Common Test</span> can be suspended, simply by
    having a CTH evaluate a <span class="code">receive</span> expression in the init- or terminate
    function. The macros <span class="code">?CT_HOOK_INIT_PROCESS</span> (the process executing the hook
    init function) and <span class="code">?CT_HOOK_TERMINATE_PROCESS</span> (the process executing
    the hook terminate function) each specifies the name of the correct <span class="code">Common Test</span>
    process to send a message to. This is done to return from the <span class="code">receive</span>.
    These macros are defined in <span class="code">ct.hrl</span>.
    </p>
  

  <h3><a name="id87794">14.6 
        Example CTH</a></h3>
    <a name="example"></a>
     
     <p>The following CTH logs information about a test run into a format 
       parseable by <span class="bold_code"><a href="../../man/file.html#consult-1">file:consult/1</a></span> 
       (in <span class="code">Kernel</span>):
     </p>
     <div class="example"><pre>
 %%% @doc Common Test Example Common Test Hook module.
 -module(example_cth).

 %% Callbacks
 -export([id/1]).
 -export([init/2]).

 -export([pre_init_per_suite/3]).
 -export([post_init_per_suite/4]).
 -export([pre_end_per_suite/3]).
 -export([post_end_per_suite/4]).

 -export([pre_init_per_group/3]).
 -export([post_init_per_group/4]).
 -export([pre_end_per_group/3]).
 -export([post_end_per_group/4]).

 -export([pre_init_per_testcase/3]).
 -export([post_init_per_testcase/4]).
 -export([pre_end_per_testcase/3]).
 -export([post_end_per_testcase/4]).

 -export([on_tc_fail/3]).
 -export([on_tc_skip/3]).

 -export([terminate/1]).

 -record(state, { file_handle, total, suite_total, ts, tcs, data }).

 %% @doc Return a unique id for this CTH.
 id(Opts) -&gt;
   proplists:get_value(filename, Opts, "/tmp/file.log").

 %% @doc Always called before any other callback function. Use this to initiate
 %% any common state. 
 init(Id, Opts) -&gt;
     {ok,D} = file:open(Id,[write]),
     {ok, #state{ file_handle = D, total = 0, data = [] }}.

 %% @doc Called before init_per_suite is called. 
 pre_init_per_suite(Suite,Config,State) -&gt;
     {Config, State#state{ suite_total = 0, tcs = [] }}.

 %% @doc Called after init_per_suite.
 post_init_per_suite(Suite,Config,Return,State) -&gt;
     {Return, State}.

 %% @doc Called before end_per_suite. 
 pre_end_per_suite(Suite,Config,State) -&gt;
     {Config, State}.

 %% @doc Called after end_per_suite. 
 post_end_per_suite(Suite,Config,Return,State) -&gt;
     Data = {suites, Suite, State#state.suite_total, lists:reverse(State#state.tcs)},
     {Return, State#state{ data = [Data | State#state.data] ,
                           total = State#state.total + State#state.suite_total } }.

 %% @doc Called before each init_per_group.
 pre_init_per_group(Group,Config,State) -&gt;
     {Config, State}.

 %% @doc Called after each init_per_group.
 post_init_per_group(Group,Config,Return,State) -&gt;
     {Return, State}.

 %% @doc Called before each end_per_group. 
 pre_end_per_group(Group,Config,State) -&gt;
     {Config, State}.

 %% @doc Called after each end_per_group. 
 post_end_per_group(Group,Config,Return,State) -&gt;
     {Return, State}.

 %% @doc Called before each init_per_testcase.
 pre_init_per_testcase(TC,Config,State) -&gt;
     {Config, State#state{ ts = now(), total = State#state.suite_total + 1 } }.

 %% Called after each init_per_testcase (immediately before the test case).
 post_init_per_testcase(TC,Config,Return,State) -&gt;
     {Return, State}

%% @doc Called before each end_per_testcase (immediately after the test case).
 pre_end_per_testcase(TC,Config,State) -&gt;
     {Config, State}.

 %% @doc Called after each end_per_testcase.
 post_end_per_testcase(TC,Config,Return,State) -&gt;
     TCInfo = {testcase, TC, Return, timer:now_diff(now(), State#state.ts)},
     {Return, State#state{ ts = undefined, tcs = [TCInfo | State#state.tcs] } }.

 %% @doc Called after post_init_per_suite, post_end_per_suite, post_init_per_group,
 %% post_end_per_group and post_end_per_testcase if the suite, group or test case failed.
 on_tc_fail(TC, Reason, State) -&gt;
     State.

 %% @doc Called when a test case is skipped by either user action
 %% or due to an init function failing.  
 on_tc_skip(TC, Reason, State) -&gt;
     State.

 %% @doc Called when the scope of the CTH is done
 terminate(State) -&gt;
     io:format(State#state.file_handle, "~p.~n",
                [{test_run, State#state.total, State#state.data}]),
     file:close(State#state.file_handle),
     ok.</pre></div>
  

  <h3><a name="id87855">14.7 
        Built-In CTHs</a></h3>
     <a name="builtin_cths"></a>
    
    <p><span class="code">Common Test</span> is delivered with some general-purpose CTHs that
    can be enabled by the user to provide generic testing functionality.
    Some of these CTHs are enabled by default when <span class="code">common_test</span> is started to run.
    They can be disabled by setting <span class="code">enable_builtin_hooks</span> to
    <span class="code">false</span> on the command line or in the test specification. The following
    two CTHs are delivered with <span class="code">Common Test</span>:</p>

    <dl>
       <dt><strong><span class="code">cth_log_redirect</span></strong></dt>
       <dd>
       <p>Built-in</p>
       <p>Captures all <span class="code">error_logger</span> and <span class="code">SASL</span> logging 
	events and prints them to the current test case log. If an event cannot be 
	associated with a test case, it is printed in the <span class="code">Common Test</span> framework log. 
	This happens for test cases running in parallel and events occuring
	in-between test cases. You can configure the level of
	<span class="bold_code"><a href="../../man/sasl_app.html"><span class="code">SASL</span></a></span> events report
	using the normal <span class="code">SASL</span> mechanisms.</p>
       </dd>
       <dt><strong><span class="code">cth_surefire</span></strong></dt>
       <dd>
       <p>Not built-in</p>
       <p>Captures all test results and outputs them as surefire
	XML into a file. The created file is by default
	called <span class="code">junit_report.xml</span>. The file name can be changed by
	setting option <span class="code">path</span> for this hook, for example:</p>

	<p><span class="code">-ct_hooks cth_surefire [{path,"/tmp/report.xml"}]</span></p>

	<p>If option <span class="code">url_base</span> is set, an extra
	attribute named <span class="code">url</span> is added to each
	<span class="code">testsuite</span> and <span class="code">testcase</span> XML element. The value
	is constructed from <span class="code">url_base</span> and a relative path
	to the test suite or test case log, respectively, for example:</p>

	<p><span class="code">-ct_hooks cth_surefire [{url_base, "http://myserver.com/"}]</span></p>

	<p>gives an URL attribute value similar to</p>

	<p><span class="code">"http://myserver.com/ct_run.ct@myhost.2012-12-12_11.19.39/
x86_64-unknown-linux-gnu.my_test.logs/run.2012-12-12_11.19.39/suite.log.html"</span></p>

	<p>Surefire XML can, for example, be used by Jenkins to display test
	results.</p>
       </dd>
     </dl>

  

</div>
<div class="footer">
<hr>
<p>Copyright © 2003-2016 Ericsson AB. All Rights Reserved.</p>
</div>
</div>
</div></body>
</html>
