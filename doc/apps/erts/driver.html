<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="ExDoc v0.38.1">
    <meta name="project" content="erts v16.1.2">


<meta name="major-vsn" content="28">
<meta name="exdoc:full-text-search-url" content="/doc/search.html?v=28&q=">
<link rel="canonical" href="https://www.erlang.org/doc/apps/erts/driver.html" />
    <title>How to Implement a Driver â€” erts v16.1.2</title>

    <link rel="stylesheet" href="dist/html-erlang-ZK43ZOAC.css" />

    <script defer src="dist/sidebar_items-E03DE236.js"></script>
    <script defer src="docs_config.js"></script>
    <script defer src="dist/html-DPJLHKSM.js"></script>

  </head>
  <body>
    <script>(()=>{var t="ex_doc:settings",e="dark";var o="dark",s="light";var E="sidebar_state",n="closed";var r="sidebar_width";var a="sidebar-open";var i=new URLSearchParams(window.location.search),S=i.get("theme")||JSON.parse(localStorage.getItem(t)||"{}").theme;(S===o||S!==s&&window.matchMedia("(prefers-color-scheme: dark)").matches)&&document.body.classList.add(e);var d=sessionStorage.getItem(E),A=d!==n&&!window.matchMedia(`screen and (max-width: ${768}px)`).matches;document.body.classList.toggle(a,A);var c=sessionStorage.getItem(r);c&&document.body.style.setProperty("--sidebarWidth",`${c}px`);var p=/(Macintosh|iPhone|iPad|iPod)/.test(window.navigator.userAgent);document.documentElement.classList.toggle("apple-os",p);})();
</script>

<div class="body-wrapper">

<button id="sidebar-menu" class="sidebar-button sidebar-toggle" aria-label="toggle sidebar" aria-controls="sidebar">
  <i class="ri-menu-line ri-lg" title="Collapse/expand sidebar"></i>
</button>

<nav id="sidebar" class="sidebar">

  <div class="sidebar-header">
    <div class="sidebar-projectInfo">

        <a href="../../index.html" class="sidebar-projectImage">
          <img src="assets/logo.png" alt="erts" />
        </a>

      <div>
        <a href="../../index.html" class="sidebar-projectName" translate="no">
erts
        </a>
        <div class="sidebar-projectVersion" translate="no">
          v16.1.2
        </div>
      </div>
    </div>
    <ul id="sidebar-list-nav" class="sidebar-list-nav" role="tablist" data-extras=""></ul>
  </div>
</nav>

<output role="status" id="toast"></output>

<main class="content page-extra" id="main" data-type="extras">
  <div id="content" class="content-inner">
    <div class="top-search">
      <div class="search-settings">
        <form class="search-bar" action="search.html">
          <label class="search-label">
            <span class="sr-only">Search documentation of erts</span>
            <input name="q" type="text" class="search-input" placeholder="Press / to search" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" />
          </label>
          <button type="submit" class="search-button" aria-label="Submit Search" tabindex="-1">
            <i class="ri-search-2-line ri-lg" aria-hidden="true"></i>
          </button>
          <button type="button" tabindex="-1" class="search-close-button" aria-hidden="true">
            <i class="ri-close-line ri-lg" title="Cancel search"></i>
          </button>
        </form>
        <div class="autocomplete">
        </div>
        <button class="icon-settings display-settings">
          <i class="ri-settings-3-line"></i>
          <span class="sr-only">Settings</span>
        </button>
      </div>
    </div>

<div id="top-content">
  <div class="heading-with-actions top-heading">
    <h1>How to Implement a Driver</h1>


      <a href="https://github.com/erlang/otp/blob/OTP-28.2/erts/doc/guides/driver.md#L1" title="View Source" class="icon-action" rel="help">
        <i class="ri-code-s-slash-line" aria-hidden="true"></i>
        <span class="sr-only">View Source</span>
      </a>

  </div>


<section role="note" class="admonition info"><h4 class="admonition-title info">Note</h4><p>This section was written a long time ago. Most of it is still valid, as it
explains important concepts, but this was written for an older driver
interface so the examples do not work anymore. The reader is encouraged to
read the <a href="erl_driver.html"><code class="inline">erl_driver</code></a> and <a href="driver_entry.html"><code class="inline">driver_entry</code></a>
documentation also.</p></section><h2 id="introduction" class="section-heading"><a href="#introduction" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Introduction</span></h2><p>This section describes how to build your own driver for Erlang.</p><p>A driver in Erlang is a library written in C, which is linked to the Erlang
emulator and called from Erlang. Drivers can be used when C is more suitable
than Erlang, to speed up things, or to provide access to OS resources not
directly accessible from Erlang.</p><p>A driver can be dynamically loaded, as a shared library (known as a DLL on
Windows), or statically loaded, linked with the emulator when it is compiled and
linked. Only dynamically loaded drivers are described here, statically linked
drivers are beyond the scope of this section.</p><section role="note" class="admonition warning"><h4 class="admonition-title warning">Warning</h4><p>When a driver is loaded it is executed in the context of the emulator, shares
the same memory and the same thread. This means that all operations in the
driver must be non-blocking, and that any crash in the driver brings the whole
emulator down. In short, be careful.</p></section><h2 id="sample-driver" class="section-heading"><a href="#sample-driver" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Sample Driver</span></h2><p>This section describes a simple driver for accessing a postgres database using
the libpq C client library. Postgres is used because it is free and open source.
For information on postgres, see <a href="http://www.postgres.org">www.postgres.org</a>.</p><p>The driver is synchronous, it uses the synchronous calls of the client library.
This is only for simplicity, but not good, as it halts the emulator while
waiting for the database. This is improved below with an asynchronous sample
driver.</p><p>The code is straightforward: all communication between Erlang and the driver is
done with <a href="erlang.html#port_control/3"><code class="inline">port_control/3</code></a>, and the driver returns data back
using the <code class="inline">rbuf</code>.</p><p>An Erlang driver only exports one function: the driver entry function. This is
defined with a macro, <code class="inline">DRIVER_INIT</code>, which returns a pointer to a C <code class="inline">struct</code>
containing the entry points that are called from the emulator. The <code class="inline">struct</code>
defines the entries that the emulator calls to call the driver, with a <code class="inline">NULL</code>
pointer for entries that are not defined and used by the driver.</p><p>The <code class="inline">start</code> entry is called when the driver is opened as a port with
<a href="erlang.html#open_port/2"><code class="inline">open_port/2</code></a>. Here we allocate memory for a user data
structure. This user data is passed every time the emulator calls us. First we
store the driver handle, as it is needed in later calls. We allocate memory for
the connection handle that is used by LibPQ. We also set the port to return
allocated driver binaries, by setting flag <code class="inline">PORT_CONTROL_FLAG_BINARY</code>, calling
<code class="inline">set_port_control_flags</code>. (This is because we do not know if our data will fit
in the result buffer of <code class="inline">control</code>, which has a default size, 64 bytes, set up by
the emulator.)</p><p>An entry <code class="inline">init</code> is called when the driver is loaded. However, we do not use
this, as it is executed only once, and we want to have the possibility of
several instances of the driver.</p><p>The <code class="inline">stop</code> entry is called when the port is closed.</p><p>The <code class="inline">control</code> entry is called from the emulator when the Erlang code calls
<a href="erlang.html#port_control/3"><code class="inline">port_control/3</code></a>, to do the actual work. We have defined a
simple set of commands: <code class="inline">connect</code> to log in to the database, <code class="inline">disconnect</code> to log
out, and <code class="inline">select</code> to send a SQL-query and get the result. All results are
returned through <code class="inline">rbuf</code>. The library <a href="../../apps/erl_interface/ei.html" title=""><code class="inline">ei</code></a> in <a href="../../apps/erl_interface/index.html"><code class="inline">erl_interface</code></a>
is used to encode data in binary term format. The result is returned to the emulator as binary
terms, so <code class="inline">binary_to_term</code> is called in Erlang to convert the result to term
form.</p><p>The code is available in <code class="inline">pg_sync.c</code> in the <code class="inline">sample</code> directory of <code class="inline">erts</code>.</p><p>The driver entry contains the functions that will be called by the emulator. In
this example, only <a href="../../apps/erts/driver_entry.html#start" title=""><code class="inline">start</code></a>, <a href="../../apps/erts/driver_entry.html#stop" title=""><code class="inline">stop</code></a>, and <a href="../../apps/erts/driver_entry.html#control" title=""><code class="inline">control</code></a> are provided:</p><pre><code class="makeup c" translate="no"><span class="cm">/* Driver interface declarations */</span><span class="w">
</span><span class="k">static</span><span class="w"> </span><span class="no">ErlDrvData</span><span class="w"> </span><span class="nf">start</span><span class="p" data-group-id="9304901955-1">(</span><span class="no">ErlDrvPort</span><span class="w"> </span><span class="n">port</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">command</span><span class="p" data-group-id="9304901955-1">)</span><span class="p">;</span><span class="w">
</span><span class="k">static</span><span class="w"> </span><span class="kc">void</span><span class="w"> </span><span class="nf">stop</span><span class="p" data-group-id="9304901955-2">(</span><span class="no">ErlDrvData</span><span class="w"> </span><span class="n">drv_data</span><span class="p" data-group-id="9304901955-2">)</span><span class="p">;</span><span class="w">
</span><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">control</span><span class="p" data-group-id="9304901955-3">(</span><span class="no">ErlDrvData</span><span class="w"> </span><span class="n">drv_data</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">command</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="p">,</span><span class="w">
                   </span><span class="kt">int</span><span class="w"> </span><span class="n">len</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="o">*</span><span class="n">rbuf</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">rlen</span><span class="p" data-group-id="9304901955-3">)</span><span class="p">;</span><span class="w">

</span><span class="k">static</span><span class="w"> </span><span class="no">ErlDrvEntry</span><span class="w"> </span><span class="n">pq_driver_entry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="9304901955-4">{</span><span class="w">
    </span><span class="no">NULL</span><span class="p">,</span><span class="w">                        </span><span class="cm">/* init */</span><span class="w">
    </span><span class="n">start</span><span class="p">,</span><span class="w">
    </span><span class="n">stop</span><span class="p">,</span><span class="w">
    </span><span class="no">NULL</span><span class="p">,</span><span class="w">                        </span><span class="cm">/* output */</span><span class="w">
    </span><span class="no">NULL</span><span class="p">,</span><span class="w">                        </span><span class="cm">/* ready_input */</span><span class="w">
    </span><span class="no">NULL</span><span class="p">,</span><span class="w">                        </span><span class="cm">/* ready_output */</span><span class="w">
    </span><span class="s">&quot;pg_sync&quot;</span><span class="p">,</span><span class="w">                   </span><span class="cm">/* the name of the driver */</span><span class="w">
    </span><span class="no">NULL</span><span class="p">,</span><span class="w">                        </span><span class="cm">/* finish */</span><span class="w">
    </span><span class="no">NULL</span><span class="p">,</span><span class="w">                        </span><span class="cm">/* handle */</span><span class="w">
    </span><span class="n">control</span><span class="p">,</span><span class="w">
    </span><span class="no">NULL</span><span class="p">,</span><span class="w">                        </span><span class="cm">/* timeout */</span><span class="w">
    </span><span class="no">NULL</span><span class="p">,</span><span class="w">                        </span><span class="cm">/* outputv */</span><span class="w">
    </span><span class="no">NULL</span><span class="p">,</span><span class="w">                        </span><span class="cm">/* ready_async */</span><span class="w">
    </span><span class="no">NULL</span><span class="p">,</span><span class="w">                        </span><span class="cm">/* flush */</span><span class="w">
    </span><span class="no">NULL</span><span class="p">,</span><span class="w">                        </span><span class="cm">/* call */</span><span class="w">
    </span><span class="no">NULL</span><span class="w">                         </span><span class="cm">/* event */</span><span class="w">
</span><span class="p" data-group-id="9304901955-4">}</span><span class="p">;</span></code></pre><p>We have a structure to store state needed by the driver, in this case we only
need to keep the database connection:</p><pre><code class="makeup c" translate="no"><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="n">our_data_s</span><span class="w"> </span><span class="p" data-group-id="7802905696-1">{</span><span class="w">
    </span><span class="no">PGconn</span><span class="o">*</span><span class="w"> </span><span class="n">conn</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="7802905696-1">}</span><span class="w"> </span><span class="n">our_data_t</span><span class="p">;</span></code></pre><p>The control codes that we have defined are as follows:</p><pre><code class="makeup c" translate="no"><span class="cm">/* Keep the following definitions in alignment with the
 * defines in erl_pq_sync.erl
 */</span><span class="w">

</span><span class="kp">#define</span><span class="w"> </span><span class="no">DRV_CONNECT</span><span class="w">             </span><span class="err">&#39;</span><span class="no">C</span><span class="err">&#39;</span><span class="w">
</span><span class="kp">#define</span><span class="w"> </span><span class="no">DRV_DISCONNECT</span><span class="w">          </span><span class="err">&#39;</span><span class="no">D</span><span class="err">&#39;</span><span class="w">
</span><span class="kp">#define</span><span class="w"> </span><span class="no">DRV_SELECT</span><span class="w">              </span><span class="err">&#39;</span><span class="no">S</span><span class="err">&#39;</span></code></pre><p>This returns the driver structure. The macro <a href="../../apps/erts/driver_entry.html#DRIVER_INIT" title=""><code class="inline">DRIVER_INIT</code></a> defines the only
exported function. All the other functions are static, and will not be exported
from the library.</p><pre><code class="makeup c" translate="no"><span class="cm">/* INITIALIZATION AFTER LOADING */</span><span class="w">

</span><span class="cm">/*
 * This is the init function called after this driver has been loaded.
 * It must *not* be declared static. Must return the address to
 * the driver entry.
 */</span><span class="w">

</span><span class="no">DRIVER_INIT</span><span class="p" data-group-id="3925274826-1">(</span><span class="n">pq_drv</span><span class="p" data-group-id="3925274826-1">)</span><span class="w">
</span><span class="p" data-group-id="3925274826-2">{</span><span class="w">
    </span><span class="k">return</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pq_driver_entry</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="3925274826-2">}</span></code></pre><p>Here some initialization is done, <a href="../../apps/erts/driver_entry.html#start" title=""><code class="inline">start</code></a> is called from <a href="erlang.html#open_port/2"><code class="inline">open_port/2</code></a>. The data
will be passed to <a href="../../apps/erts/driver_entry.html#control" title=""><code class="inline">control</code></a> and <a href="../../apps/erts/driver_entry.html#stop" title=""><code class="inline">stop</code></a>.</p><pre><code class="makeup c" translate="no"><span class="cm">/* DRIVER INTERFACE */</span><span class="w">
</span><span class="k">static</span><span class="w"> </span><span class="no">ErlDrvData</span><span class="w"> </span><span class="nf">start</span><span class="p" data-group-id="6807212994-1">(</span><span class="no">ErlDrvPort</span><span class="w"> </span><span class="n">port</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">command</span><span class="p" data-group-id="6807212994-1">)</span><span class="w">
</span><span class="p" data-group-id="6807212994-2">{</span><span class="w">
    </span><span class="n">our_data_t</span><span class="o">*</span><span class="w"> </span><span class="n">data</span><span class="p">;</span><span class="w">

    </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="6807212994-3">(</span><span class="n">our_data_t</span><span class="o">*</span><span class="p" data-group-id="6807212994-3">)</span><span class="nf">driver_alloc</span><span class="p" data-group-id="6807212994-4">(</span><span class="nf">sizeof</span><span class="p" data-group-id="6807212994-5">(</span><span class="n">our_data_t</span><span class="p" data-group-id="6807212994-5">)</span><span class="p" data-group-id="6807212994-4">)</span><span class="p">;</span><span class="w">
    </span><span class="n">data</span><span class="o">-&gt;</span><span class="n">conn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">NULL</span><span class="p">;</span><span class="w">
    </span><span class="nf">set_port_control_flags</span><span class="p" data-group-id="6807212994-6">(</span><span class="n">port</span><span class="p">,</span><span class="w"> </span><span class="no">PORT_CONTROL_FLAG_BINARY</span><span class="p" data-group-id="6807212994-6">)</span><span class="p">;</span><span class="w">
    </span><span class="k">return</span><span class="w"> </span><span class="p" data-group-id="6807212994-7">(</span><span class="no">ErlDrvData</span><span class="p" data-group-id="6807212994-7">)</span><span class="n">data</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="6807212994-2">}</span></code></pre><p>We call disconnect to log out from the database. (This should have been done
from Erlang, but just in case.)</p><pre><code class="makeup c" translate="no"><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">do_disconnect</span><span class="p" data-group-id="8603939525-1">(</span><span class="n">our_data_t</span><span class="o">*</span><span class="w"> </span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">ei_x_buff</span><span class="o">*</span><span class="w"> </span><span class="n">x</span><span class="p" data-group-id="8603939525-1">)</span><span class="p">;</span><span class="w">

</span><span class="k">static</span><span class="w"> </span><span class="kc">void</span><span class="w"> </span><span class="nf">stop</span><span class="p" data-group-id="8603939525-2">(</span><span class="no">ErlDrvData</span><span class="w"> </span><span class="n">drv_data</span><span class="p" data-group-id="8603939525-2">)</span><span class="w">
</span><span class="p" data-group-id="8603939525-3">{</span><span class="w">
    </span><span class="n">our_data_t</span><span class="o">*</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="8603939525-4">(</span><span class="n">our_data_t</span><span class="o">*</span><span class="p" data-group-id="8603939525-4">)</span><span class="n">drv_data</span><span class="p">;</span><span class="w">

    </span><span class="nf">do_disconnect</span><span class="p" data-group-id="8603939525-5">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="no">NULL</span><span class="p" data-group-id="8603939525-5">)</span><span class="p">;</span><span class="w">
    </span><span class="nf">driver_free</span><span class="p" data-group-id="8603939525-6">(</span><span class="n">data</span><span class="p" data-group-id="8603939525-6">)</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="8603939525-3">}</span></code></pre><p>We use the binary format only to return data to the emulator; input data is a
string parameter for <code class="inline">connect</code> and <code class="inline">select</code>. The returned data consists of
Erlang terms.</p><p>The functions <code class="inline">get_s</code> and <code class="inline">ei_x_to_new_binary</code> are utilities that are used to
make the code shorter. <code class="inline">get_s</code> duplicates the string and zero-terminates it, as
the postgres client library wants that. <code class="inline">ei_x_to_new_binary</code> takes an
<code class="inline">ei_x_buff</code> buffer, allocates a binary, and copies the data there. This binary
is returned in <code class="inline">*rbuf</code>. (Notice that this binary is freed by the emulator, not
by us.)</p><pre><code class="makeup c" translate="no"><span class="k">static</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="nf">get_s</span><span class="p" data-group-id="1405810361-1">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">len</span><span class="p" data-group-id="1405810361-1">)</span><span class="p">;</span><span class="w">
</span><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">do_connect</span><span class="p" data-group-id="1405810361-2">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">our_data_t</span><span class="o">*</span><span class="w"> </span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">ei_x_buff</span><span class="o">*</span><span class="w"> </span><span class="n">x</span><span class="p" data-group-id="1405810361-2">)</span><span class="p">;</span><span class="w">
</span><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">do_select</span><span class="p" data-group-id="1405810361-3">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">our_data_t</span><span class="o">*</span><span class="w"> </span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">ei_x_buff</span><span class="o">*</span><span class="w"> </span><span class="n">x</span><span class="p" data-group-id="1405810361-3">)</span><span class="p">;</span><span class="w">

</span><span class="cm">/* As we are operating in binary mode, the return value from control
 * is irrelevant, as long as it is not negative.
 */</span><span class="w">
</span><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">control</span><span class="p" data-group-id="1405810361-4">(</span><span class="no">ErlDrvData</span><span class="w"> </span><span class="n">drv_data</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">command</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="p">,</span><span class="w">
                   </span><span class="kt">int</span><span class="w"> </span><span class="n">len</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="o">*</span><span class="n">rbuf</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">rlen</span><span class="p" data-group-id="1405810361-4">)</span><span class="w">
</span><span class="p" data-group-id="1405810361-5">{</span><span class="w">
    </span><span class="kt">int</span><span class="w"> </span><span class="n">r</span><span class="p">;</span><span class="w">
    </span><span class="n">ei_x_buff</span><span class="w"> </span><span class="n">x</span><span class="p">;</span><span class="w">
    </span><span class="n">our_data_t</span><span class="o">*</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="1405810361-6">(</span><span class="n">our_data_t</span><span class="o">*</span><span class="p" data-group-id="1405810361-6">)</span><span class="n">drv_data</span><span class="p">;</span><span class="w">
    </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">get_s</span><span class="p" data-group-id="1405810361-7">(</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="n">len</span><span class="p" data-group-id="1405810361-7">)</span><span class="p">;</span><span class="w">
    </span><span class="nf">ei_x_new_with_version</span><span class="p" data-group-id="1405810361-8">(</span><span class="o">&amp;</span><span class="n">x</span><span class="p" data-group-id="1405810361-8">)</span><span class="p">;</span><span class="w">
    </span><span class="k">switch</span><span class="w"> </span><span class="p" data-group-id="1405810361-9">(</span><span class="n">command</span><span class="p" data-group-id="1405810361-9">)</span><span class="w"> </span><span class="p" data-group-id="1405810361-10">{</span><span class="w">
        </span><span class="k">case</span><span class="w"> </span><span class="ss">DRV_CONNECT</span><span class="p">:</span><span class="w">    </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">do_connect</span><span class="p" data-group-id="1405810361-11">(</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">x</span><span class="p" data-group-id="1405810361-11">)</span><span class="p">;</span><span class="w">  </span><span class="k">break</span><span class="p">;</span><span class="w">
        </span><span class="k">case</span><span class="w"> </span><span class="ss">DRV_DISCONNECT</span><span class="p">:</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">do_disconnect</span><span class="p" data-group-id="1405810361-12">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">x</span><span class="p" data-group-id="1405810361-12">)</span><span class="p">;</span><span class="w">  </span><span class="k">break</span><span class="p">;</span><span class="w">
        </span><span class="k">case</span><span class="w"> </span><span class="ss">DRV_SELECT</span><span class="p">:</span><span class="w">     </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">do_select</span><span class="p" data-group-id="1405810361-13">(</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">x</span><span class="p" data-group-id="1405810361-13">)</span><span class="p">;</span><span class="w">   </span><span class="k">break</span><span class="p">;</span><span class="w">
        </span><span class="ss">default</span><span class="p">:</span><span class="w">             </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">;</span><span class="w">        </span><span class="k">break</span><span class="p">;</span><span class="w">
    </span><span class="p" data-group-id="1405810361-10">}</span><span class="w">
    </span><span class="o">*</span><span class="n">rbuf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="1405810361-14">(</span><span class="kt">char</span><span class="o">*</span><span class="p" data-group-id="1405810361-14">)</span><span class="nf">ei_x_to_new_binary</span><span class="p" data-group-id="1405810361-15">(</span><span class="o">&amp;</span><span class="n">x</span><span class="p" data-group-id="1405810361-15">)</span><span class="p">;</span><span class="w">
    </span><span class="nf">ei_x_free</span><span class="p" data-group-id="1405810361-16">(</span><span class="o">&amp;</span><span class="n">x</span><span class="p" data-group-id="1405810361-16">)</span><span class="p">;</span><span class="w">
    </span><span class="nf">driver_free</span><span class="p" data-group-id="1405810361-17">(</span><span class="n">s</span><span class="p" data-group-id="1405810361-17">)</span><span class="p">;</span><span class="w">
    </span><span class="k">return</span><span class="w"> </span><span class="n">r</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="1405810361-5">}</span></code></pre><p><code class="inline">do_connect</code> is where we log in to the database. If the connection was
successful, we store the connection handle in the driver data, and return
<code class="inline">'ok'</code>. Otherwise, we return the error message from postgres and store <code class="inline">NULL</code> in
the driver data.</p><pre><code class="makeup c" translate="no"><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">do_connect</span><span class="p" data-group-id="7866679216-1">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">our_data_t</span><span class="o">*</span><span class="w"> </span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">ei_x_buff</span><span class="o">*</span><span class="w"> </span><span class="n">x</span><span class="p" data-group-id="7866679216-1">)</span><span class="w">
</span><span class="p" data-group-id="7866679216-2">{</span><span class="w">
    </span><span class="no">PGconn</span><span class="o">*</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">PQconnectdb</span><span class="p" data-group-id="7866679216-3">(</span><span class="n">s</span><span class="p" data-group-id="7866679216-3">)</span><span class="p">;</span><span class="w">
    </span><span class="k">if</span><span class="w"> </span><span class="p" data-group-id="7866679216-4">(</span><span class="no">PQstatus</span><span class="p" data-group-id="7866679216-5">(</span><span class="n">conn</span><span class="p" data-group-id="7866679216-5">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="no">CONNECTION_OK</span><span class="p" data-group-id="7866679216-4">)</span><span class="w"> </span><span class="p" data-group-id="7866679216-6">{</span><span class="w">
        </span><span class="nf">encode_error</span><span class="p" data-group-id="7866679216-7">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">conn</span><span class="p" data-group-id="7866679216-7">)</span><span class="p">;</span><span class="w">
        </span><span class="no">PQfinish</span><span class="p" data-group-id="7866679216-8">(</span><span class="n">conn</span><span class="p" data-group-id="7866679216-8">)</span><span class="p">;</span><span class="w">
        </span><span class="n">conn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">NULL</span><span class="p">;</span><span class="w">
    </span><span class="p" data-group-id="7866679216-6">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p" data-group-id="7866679216-9">{</span><span class="w">
        </span><span class="nf">encode_ok</span><span class="p" data-group-id="7866679216-10">(</span><span class="n">x</span><span class="p" data-group-id="7866679216-10">)</span><span class="p">;</span><span class="w">
    </span><span class="p" data-group-id="7866679216-9">}</span><span class="w">
    </span><span class="n">data</span><span class="o">-&gt;</span><span class="n">conn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">conn</span><span class="p">;</span><span class="w">
    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="7866679216-2">}</span></code></pre><p>If we are connected (and if the connection handle is not <code class="inline">NULL</code>), we log out
from the database. We need to check if we should encode an <code class="inline">'ok'</code>, as we can get
here from function <a href="../../apps/erts/driver_entry.html#stop" title=""><code class="inline">stop</code></a>, which does not return data to the emulator:</p><pre><code class="makeup c" translate="no"><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">do_disconnect</span><span class="p" data-group-id="6720191734-1">(</span><span class="n">our_data_t</span><span class="o">*</span><span class="w"> </span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">ei_x_buff</span><span class="o">*</span><span class="w"> </span><span class="n">x</span><span class="p" data-group-id="6720191734-1">)</span><span class="w">
</span><span class="p" data-group-id="6720191734-2">{</span><span class="w">
    </span><span class="k">if</span><span class="w"> </span><span class="p" data-group-id="6720191734-3">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">conn</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="no">NULL</span><span class="p" data-group-id="6720191734-3">)</span><span class="w">
        </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">
    </span><span class="no">PQfinish</span><span class="p" data-group-id="6720191734-4">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">conn</span><span class="p" data-group-id="6720191734-4">)</span><span class="p">;</span><span class="w">
    </span><span class="n">data</span><span class="o">-&gt;</span><span class="n">conn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">NULL</span><span class="p">;</span><span class="w">
    </span><span class="k">if</span><span class="w"> </span><span class="p" data-group-id="6720191734-5">(</span><span class="n">x</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="no">NULL</span><span class="p" data-group-id="6720191734-5">)</span><span class="w">
        </span><span class="nf">encode_ok</span><span class="p" data-group-id="6720191734-6">(</span><span class="n">x</span><span class="p" data-group-id="6720191734-6">)</span><span class="p">;</span><span class="w">
    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="6720191734-2">}</span></code></pre><p>We execute a query and encode the result. Encoding is done in another C module,
<code class="inline">pg_encode.c</code>, which is also provided as sample code.</p><pre><code class="makeup c" translate="no"><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">do_select</span><span class="p" data-group-id="5759509984-1">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">our_data_t</span><span class="o">*</span><span class="w"> </span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">ei_x_buff</span><span class="o">*</span><span class="w"> </span><span class="n">x</span><span class="p" data-group-id="5759509984-1">)</span><span class="w">
</span><span class="p" data-group-id="5759509984-2">{</span><span class="w">
   </span><span class="no">PGresult</span><span class="o">*</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">PQexec</span><span class="p" data-group-id="5759509984-3">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="p" data-group-id="5759509984-3">)</span><span class="p">;</span><span class="w">
    </span><span class="nf">encode_result</span><span class="p" data-group-id="5759509984-4">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">res</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="o">-&gt;</span><span class="n">conn</span><span class="p" data-group-id="5759509984-4">)</span><span class="p">;</span><span class="w">
    </span><span class="no">PQclear</span><span class="p" data-group-id="5759509984-5">(</span><span class="n">res</span><span class="p" data-group-id="5759509984-5">)</span><span class="p">;</span><span class="w">
    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="5759509984-2">}</span></code></pre><p>Here we check the result from postgres. If it is data, we encode it as lists of
lists with column data. Everything from postgres is C strings, so we use
<a href="../../apps/erl_interface/ei.html#ei_x_encode_string" title=""><code class="inline">ei_x_encode_string</code></a> to send the result as strings to Erlang. (The head of the
list contains the column names.)</p><pre><code class="makeup c" translate="no"><span class="kc">void</span><span class="w"> </span><span class="nf">encode_result</span><span class="p" data-group-id="0032109724-1">(</span><span class="n">ei_x_buff</span><span class="o">*</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="no">PGresult</span><span class="o">*</span><span class="w"> </span><span class="n">res</span><span class="p">,</span><span class="w"> </span><span class="no">PGconn</span><span class="o">*</span><span class="w"> </span><span class="n">conn</span><span class="p" data-group-id="0032109724-1">)</span><span class="w">
</span><span class="p" data-group-id="0032109724-2">{</span><span class="w">
    </span><span class="kt">int</span><span class="w"> </span><span class="n">row</span><span class="p">,</span><span class="w"> </span><span class="n">n_rows</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="p">,</span><span class="w"> </span><span class="n">n_cols</span><span class="p">;</span><span class="w">
    </span><span class="k">switch</span><span class="w"> </span><span class="p" data-group-id="0032109724-3">(</span><span class="no">PQresultStatus</span><span class="p" data-group-id="0032109724-4">(</span><span class="n">res</span><span class="p" data-group-id="0032109724-4">)</span><span class="p" data-group-id="0032109724-3">)</span><span class="w"> </span><span class="p" data-group-id="0032109724-5">{</span><span class="w">
    </span><span class="k">case</span><span class="w"> </span><span class="ss">PGRES_TUPLES_OK</span><span class="p">:</span><span class="w">
        </span><span class="n">n_rows</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">PQntuples</span><span class="p" data-group-id="0032109724-6">(</span><span class="n">res</span><span class="p" data-group-id="0032109724-6">)</span><span class="p">;</span><span class="w">
        </span><span class="n">n_cols</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">PQnfields</span><span class="p" data-group-id="0032109724-7">(</span><span class="n">res</span><span class="p" data-group-id="0032109724-7">)</span><span class="p">;</span><span class="w">
        </span><span class="nf">ei_x_encode_tuple_header</span><span class="p" data-group-id="0032109724-8">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p" data-group-id="0032109724-8">)</span><span class="p">;</span><span class="w">
        </span><span class="nf">encode_ok</span><span class="p" data-group-id="0032109724-9">(</span><span class="n">x</span><span class="p" data-group-id="0032109724-9">)</span><span class="p">;</span><span class="w">
        </span><span class="nf">ei_x_encode_list_header</span><span class="p" data-group-id="0032109724-10">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">n_rows</span><span class="o">+</span><span class="mi">1</span><span class="p" data-group-id="0032109724-10">)</span><span class="p">;</span><span class="w">
        </span><span class="nf">ei_x_encode_list_header</span><span class="p" data-group-id="0032109724-11">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">n_cols</span><span class="p" data-group-id="0032109724-11">)</span><span class="p">;</span><span class="w">
        </span><span class="k">for</span><span class="w"> </span><span class="p" data-group-id="0032109724-12">(</span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n_cols</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">col</span><span class="p" data-group-id="0032109724-12">)</span><span class="w"> </span><span class="p" data-group-id="0032109724-13">{</span><span class="w">
            </span><span class="nf">ei_x_encode_string</span><span class="p" data-group-id="0032109724-14">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="no">PQfname</span><span class="p" data-group-id="0032109724-15">(</span><span class="n">res</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="p" data-group-id="0032109724-15">)</span><span class="p" data-group-id="0032109724-14">)</span><span class="p">;</span><span class="w">
        </span><span class="p" data-group-id="0032109724-13">}</span><span class="w">
        </span><span class="nf">ei_x_encode_empty_list</span><span class="p" data-group-id="0032109724-16">(</span><span class="n">x</span><span class="p" data-group-id="0032109724-16">)</span><span class="p">;</span><span class="w">
        </span><span class="k">for</span><span class="w"> </span><span class="p" data-group-id="0032109724-17">(</span><span class="n">row</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">row</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n_rows</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">row</span><span class="p" data-group-id="0032109724-17">)</span><span class="w"> </span><span class="p" data-group-id="0032109724-18">{</span><span class="w">
            </span><span class="nf">ei_x_encode_list_header</span><span class="p" data-group-id="0032109724-19">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">n_cols</span><span class="p" data-group-id="0032109724-19">)</span><span class="p">;</span><span class="w">
            </span><span class="k">for</span><span class="w"> </span><span class="p" data-group-id="0032109724-20">(</span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n_cols</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">col</span><span class="p" data-group-id="0032109724-20">)</span><span class="w"> </span><span class="p" data-group-id="0032109724-21">{</span><span class="w">
                </span><span class="nf">ei_x_encode_string</span><span class="p" data-group-id="0032109724-22">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="no">PQgetvalue</span><span class="p" data-group-id="0032109724-23">(</span><span class="n">res</span><span class="p">,</span><span class="w"> </span><span class="n">row</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="p" data-group-id="0032109724-23">)</span><span class="p" data-group-id="0032109724-22">)</span><span class="p">;</span><span class="w">
            </span><span class="p" data-group-id="0032109724-21">}</span><span class="w">
            </span><span class="nf">ei_x_encode_empty_list</span><span class="p" data-group-id="0032109724-24">(</span><span class="n">x</span><span class="p" data-group-id="0032109724-24">)</span><span class="p">;</span><span class="w">
        </span><span class="p" data-group-id="0032109724-18">}</span><span class="w">
        </span><span class="nf">ei_x_encode_empty_list</span><span class="p" data-group-id="0032109724-25">(</span><span class="n">x</span><span class="p" data-group-id="0032109724-25">)</span><span class="p">;</span><span class="w">
        </span><span class="k">break</span><span class="p">;</span><span class="w">
    </span><span class="k">case</span><span class="w"> </span><span class="ss">PGRES_COMMAND_OK</span><span class="p">:</span><span class="w">
        </span><span class="nf">ei_x_encode_tuple_header</span><span class="p" data-group-id="0032109724-26">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p" data-group-id="0032109724-26">)</span><span class="p">;</span><span class="w">
        </span><span class="nf">encode_ok</span><span class="p" data-group-id="0032109724-27">(</span><span class="n">x</span><span class="p" data-group-id="0032109724-27">)</span><span class="p">;</span><span class="w">
        </span><span class="nf">ei_x_encode_string</span><span class="p" data-group-id="0032109724-28">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="no">PQcmdTuples</span><span class="p" data-group-id="0032109724-29">(</span><span class="n">res</span><span class="p" data-group-id="0032109724-29">)</span><span class="p" data-group-id="0032109724-28">)</span><span class="p">;</span><span class="w">
        </span><span class="k">break</span><span class="p">;</span><span class="w">
    </span><span class="ss">default</span><span class="p">:</span><span class="w">
        </span><span class="nf">encode_error</span><span class="p" data-group-id="0032109724-30">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">conn</span><span class="p" data-group-id="0032109724-30">)</span><span class="p">;</span><span class="w">
        </span><span class="k">break</span><span class="p">;</span><span class="w">
    </span><span class="p" data-group-id="0032109724-5">}</span><span class="w">
</span><span class="p" data-group-id="0032109724-2">}</span></code></pre><h2 id="compiling-and-linking-the-sample-driver" class="section-heading"><a href="#compiling-and-linking-the-sample-driver" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Compiling and Linking the Sample Driver</span></h2><p>The driver is to be compiled and linked to a shared library (DLL on Windows).
With gcc, this is done with link flags <code class="inline">-shared</code> and <code class="inline">-fpic</code>. As we use the <a href="../../apps/erl_interface/ei.html" title=""><code class="inline">ei</code></a>
library, we should include it too. There are several versions of <a href="../../apps/erl_interface/ei.html" title=""><code class="inline">ei</code></a>, compiled
for debug or non-debug and multi-threaded or single-threaded. In the makefile
for the samples, the <code class="inline">obj</code> directory is used for the <a href="../../apps/erl_interface/ei.html" title=""><code class="inline">ei</code></a> library, meaning that
we use the non-debug, single-threaded version.</p><h2 id="calling-a-driver-as-a-port-in-erlang" class="section-heading"><a href="#calling-a-driver-as-a-port-in-erlang" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Calling a Driver as a Port in Erlang</span></h2><p>Before a driver can be called from Erlang, it must be loaded and opened. Loading
is done using the <a href="../../apps/kernel/erl_ddll.html"><code class="inline">erl_ddll</code></a> module (the <a href="../../apps/kernel/erl_ddll.html"><code class="inline">erl_ddll</code></a> driver that loads dynamic
driver is actually a driver itself). If loading is successful, the port can be
opened with <a href="erlang.html#open_port/2"><code class="inline">open_port/2</code></a>. The port name must match the name of
the shared library and the name in the driver entry structure.</p><p>When the port has been opened, the driver can be called. In the <code class="inline">pg_sync</code>
example, we do not have any data from the port, only the return value from the
<a href="erlang.html#port_control/3"><code class="inline">port_control/3</code></a>.</p><p>The following code is the Erlang part of the synchronous postgres driver,
<code class="inline">pg_sync.erl</code>:</p><pre><code class="makeup erlang" translate="no"><span class="p">-</span><span class="na">module</span><span class="p" data-group-id="7241448944-1">(</span><span class="ss">pg_sync</span><span class="p" data-group-id="7241448944-1">)</span><span class="p">.</span><span class="w">
</span><span class="w">
</span><span class="p">-</span><span class="na">define</span><span class="p" data-group-id="7241448944-2">(</span><span class="n">DRV_CONNECT</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p" data-group-id="7241448944-2">)</span><span class="p">.</span><span class="w">
</span><span class="p">-</span><span class="na">define</span><span class="p" data-group-id="7241448944-3">(</span><span class="n">DRV_DISCONNECT</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p" data-group-id="7241448944-3">)</span><span class="p">.</span><span class="w">
</span><span class="p">-</span><span class="na">define</span><span class="p" data-group-id="7241448944-4">(</span><span class="n">DRV_SELECT</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p" data-group-id="7241448944-4">)</span><span class="p">.</span><span class="w">
</span><span class="w">
</span><span class="p">-</span><span class="na">export</span><span class="p" data-group-id="7241448944-5">(</span><span class="p" data-group-id="7241448944-6">[</span><span class="ss">connect</span><span class="p">/</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="ss">disconnect</span><span class="p">/</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="ss">select</span><span class="p">/</span><span class="mi">2</span><span class="p" data-group-id="7241448944-6">]</span><span class="p" data-group-id="7241448944-5">)</span><span class="p">.</span><span class="w">

</span><span class="nf">connect</span><span class="p" data-group-id="7241448944-7">(</span><span class="n">ConnectStr</span><span class="p" data-group-id="7241448944-7">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="k">case</span><span class="w"> </span><span class="nc">erl_ddll</span><span class="p">:</span><span class="nf">load_driver</span><span class="p" data-group-id="7241448944-8">(</span><span class="s">&quot;.&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;pg_sync&quot;</span><span class="p" data-group-id="7241448944-8">)</span><span class="w"> </span><span class="k">of</span><span class="w">
        </span><span class="ss">ok</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="ss">ok</span><span class="p">;</span><span class="w">
        </span><span class="p" data-group-id="7241448944-9">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="ss">already_loaded</span><span class="p" data-group-id="7241448944-9">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="ss">ok</span><span class="p">;</span><span class="w">
        </span><span class="n">E</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nf">exit</span><span class="p" data-group-id="7241448944-10">(</span><span class="p" data-group-id="7241448944-11">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="p" data-group-id="7241448944-11">}</span><span class="p" data-group-id="7241448944-10">)</span><span class="w">
    </span><span class="k">end</span><span class="p">,</span><span class="w">
    </span><span class="n">Port</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">open_port</span><span class="p" data-group-id="7241448944-12">(</span><span class="p" data-group-id="7241448944-13">{</span><span class="nb">spawn</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="n">MODULE</span><span class="p" data-group-id="7241448944-13">}</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="7241448944-14">[</span><span class="p" data-group-id="7241448944-14">]</span><span class="p" data-group-id="7241448944-12">)</span><span class="p">,</span><span class="w">
    </span><span class="k">case</span><span class="w"> </span><span class="nf">binary_to_term</span><span class="p" data-group-id="7241448944-15">(</span><span class="nf">port_control</span><span class="p" data-group-id="7241448944-16">(</span><span class="n">Port</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="n">DRV_CONNECT</span><span class="p">,</span><span class="w"> </span><span class="n">ConnectStr</span><span class="p" data-group-id="7241448944-16">)</span><span class="p" data-group-id="7241448944-15">)</span><span class="w"> </span><span class="k">of</span><span class="w">
        </span><span class="ss">ok</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="p" data-group-id="7241448944-17">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Port</span><span class="p" data-group-id="7241448944-17">}</span><span class="p">;</span><span class="w">
        </span><span class="n">Error</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="n">Error</span><span class="w">
    </span><span class="k">end</span><span class="p">.</span><span class="w">

</span><span class="nf">disconnect</span><span class="p" data-group-id="7241448944-18">(</span><span class="n">Port</span><span class="p" data-group-id="7241448944-18">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="n">R</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">binary_to_term</span><span class="p" data-group-id="7241448944-19">(</span><span class="nf">port_control</span><span class="p" data-group-id="7241448944-20">(</span><span class="n">Port</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="n">DRV_DISCONNECT</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p" data-group-id="7241448944-20">)</span><span class="p" data-group-id="7241448944-19">)</span><span class="p">,</span><span class="w">
    </span><span class="nf">port_close</span><span class="p" data-group-id="7241448944-21">(</span><span class="n">Port</span><span class="p" data-group-id="7241448944-21">)</span><span class="p">,</span><span class="w">
    </span><span class="n">R</span><span class="p">.</span><span class="w">

</span><span class="nf">select</span><span class="p" data-group-id="7241448944-22">(</span><span class="n">Port</span><span class="p">,</span><span class="w"> </span><span class="n">Query</span><span class="p" data-group-id="7241448944-22">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="nf">binary_to_term</span><span class="p" data-group-id="7241448944-23">(</span><span class="nf">port_control</span><span class="p" data-group-id="7241448944-24">(</span><span class="n">Port</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="n">DRV_SELECT</span><span class="p">,</span><span class="w"> </span><span class="n">Query</span><span class="p" data-group-id="7241448944-24">)</span><span class="p" data-group-id="7241448944-23">)</span><span class="p">.</span></code></pre><p>The API is simple:</p><ul><li><code class="inline">connect/1</code> loads the driver, opens it, and logs on to the database, returning
the Erlang port if successful.</li><li><code class="inline">select/2</code> sends a query to the driver and returns the result.</li><li><code class="inline">disconnect/1</code> closes the database connection and the driver. (However, it
does not unload it.)</li></ul><p>The connection string is to be a connection string for postgres.</p><p>The driver is loaded with <a href="../../apps/kernel/erl_ddll.html#load_driver/2"><code class="inline">erl_ddll:load_driver/2</code></a>. If this is successful, or if
it is already loaded, it is opened. This will call the <code class="inline">start</code> function in the
driver.</p><p>We use the <a href="erlang.html#port_control/3"><code class="inline">port_control/3</code></a> function for all calls into the
driver. The result from the driver is returned immediately and converted to
terms by calling <a href="erlang.html#binary_to_term/1"><code class="inline">binary_to_term/1</code></a>. (We trust that the
terms returned from the driver are well-formed, otherwise the <a href="erlang.html#binary_to_term/1"><code class="inline">binary_to_term/1</code></a>
calls could be contained in a <code class="inline">catch</code>.)</p><h2 id="sample-asynchronous-driver" class="section-heading"><a href="#sample-asynchronous-driver" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Sample Asynchronous Driver</span></h2><p>Sometimes database queries can take a long time to complete, in our <code class="inline">pg_sync</code>
driver, the emulator halts while the driver is doing its job. This is often not
acceptable, as no other Erlang process gets a chance to do anything. To improve
on our postgres driver, we re-implement it using the asynchronous calls in
LibPQ.</p><p>The asynchronous version of the driver is in the sample files <code class="inline">pg_async.c</code> and
<code class="inline">pg_asyng.erl</code>.</p><pre><code class="makeup c" translate="no"><span class="cm">/* Driver interface declarations */</span><span class="w">
</span><span class="k">static</span><span class="w"> </span><span class="no">ErlDrvData</span><span class="w"> </span><span class="nf">start</span><span class="p" data-group-id="5890776543-1">(</span><span class="no">ErlDrvPort</span><span class="w"> </span><span class="n">port</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">command</span><span class="p" data-group-id="5890776543-1">)</span><span class="p">;</span><span class="w">
</span><span class="k">static</span><span class="w"> </span><span class="kc">void</span><span class="w"> </span><span class="nf">stop</span><span class="p" data-group-id="5890776543-2">(</span><span class="no">ErlDrvData</span><span class="w"> </span><span class="n">drv_data</span><span class="p" data-group-id="5890776543-2">)</span><span class="p">;</span><span class="w">
</span><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">control</span><span class="p" data-group-id="5890776543-3">(</span><span class="no">ErlDrvData</span><span class="w"> </span><span class="n">drv_data</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">command</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="p">,</span><span class="w">
                   </span><span class="kt">int</span><span class="w"> </span><span class="n">len</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="o">*</span><span class="n">rbuf</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">rlen</span><span class="p" data-group-id="5890776543-3">)</span><span class="p">;</span><span class="w">
</span><span class="k">static</span><span class="w"> </span><span class="kc">void</span><span class="w"> </span><span class="nf">ready_io</span><span class="p" data-group-id="5890776543-4">(</span><span class="no">ErlDrvData</span><span class="w"> </span><span class="n">drv_data</span><span class="p">,</span><span class="w"> </span><span class="no">ErlDrvEvent</span><span class="w"> </span><span class="n">event</span><span class="p" data-group-id="5890776543-4">)</span><span class="p">;</span><span class="w">

</span><span class="k">static</span><span class="w"> </span><span class="no">ErlDrvEntry</span><span class="w"> </span><span class="n">pq_driver_entry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="5890776543-5">{</span><span class="w">
    </span><span class="no">NULL</span><span class="p">,</span><span class="w">                     </span><span class="cm">/* init */</span><span class="w">
    </span><span class="n">start</span><span class="p">,</span><span class="w">
    </span><span class="n">stop</span><span class="p">,</span><span class="w">
    </span><span class="no">NULL</span><span class="p">,</span><span class="w">                     </span><span class="cm">/* output */</span><span class="w">
    </span><span class="n">ready_io</span><span class="p">,</span><span class="w">                 </span><span class="cm">/* ready_input */</span><span class="w">
    </span><span class="n">ready_io</span><span class="p">,</span><span class="w">                 </span><span class="cm">/* ready_output */</span><span class="w">
    </span><span class="s">&quot;pg_async&quot;</span><span class="p">,</span><span class="w">               </span><span class="cm">/* the name of the driver */</span><span class="w">
    </span><span class="no">NULL</span><span class="p">,</span><span class="w">                     </span><span class="cm">/* finish */</span><span class="w">
    </span><span class="no">NULL</span><span class="p">,</span><span class="w">                     </span><span class="cm">/* handle */</span><span class="w">
    </span><span class="n">control</span><span class="p">,</span><span class="w">
    </span><span class="no">NULL</span><span class="p">,</span><span class="w">                     </span><span class="cm">/* timeout */</span><span class="w">
    </span><span class="no">NULL</span><span class="p">,</span><span class="w">                     </span><span class="cm">/* outputv */</span><span class="w">
    </span><span class="no">NULL</span><span class="p">,</span><span class="w">                     </span><span class="cm">/* ready_async */</span><span class="w">
    </span><span class="no">NULL</span><span class="p">,</span><span class="w">                     </span><span class="cm">/* flush */</span><span class="w">
    </span><span class="no">NULL</span><span class="p">,</span><span class="w">                     </span><span class="cm">/* call */</span><span class="w">
    </span><span class="no">NULL</span><span class="w">                      </span><span class="cm">/* event */</span><span class="w">
</span><span class="p" data-group-id="5890776543-5">}</span><span class="p">;</span><span class="w">

</span><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="n">our_data_t</span><span class="w"> </span><span class="p" data-group-id="5890776543-6">{</span><span class="w">
    </span><span class="no">PGconn</span><span class="o">*</span><span class="w"> </span><span class="n">conn</span><span class="p">;</span><span class="w">
    </span><span class="no">ErlDrvPort</span><span class="w"> </span><span class="n">port</span><span class="p">;</span><span class="w">
    </span><span class="kt">int</span><span class="w"> </span><span class="n">socket</span><span class="p">;</span><span class="w">
    </span><span class="kt">int</span><span class="w"> </span><span class="n">connecting</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="5890776543-6">}</span><span class="w"> </span><span class="n">our_data_t</span><span class="p">;</span></code></pre><p>Some things have changed from <code class="inline">pg_sync.c</code>: we use the entry <code class="inline">ready_io</code> for
<a href="../../apps/erts/driver_entry.html#ready_input" title=""><code class="inline">ready_input</code></a> and <a href="../../apps/erts/driver_entry.html#ready_output" title=""><code class="inline">ready_output</code></a>, which is called from the emulator only when
there is input to be read from the socket. (Actually, the socket is used in a
<code class="inline">select</code> function inside the emulator, and when the socket is signaled,
indicating there is data to read, the <a href="../../apps/erts/driver_entry.html#ready_input" title=""><code class="inline">ready_input</code></a> entry is called. More about
this below.)</p><p>Our driver data is also extended, we keep track of the socket used for
communication with postgres, and also the port, which is needed when we send
data to the port with <a href="../../apps/erts/erl_driver.html#driver_output" title=""><code class="inline">driver_output</code></a>. We have a flag <code class="inline">connecting</code> to tell
whether the driver is waiting for a connection or waiting for the result of a
query. (This is needed, as the entry <code class="inline">ready_io</code> is called both when connecting
and when there is a query result.)</p><pre><code class="makeup c" translate="no"><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">do_connect</span><span class="p" data-group-id="2044739356-1">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">our_data_t</span><span class="o">*</span><span class="w"> </span><span class="n">data</span><span class="p" data-group-id="2044739356-1">)</span><span class="w">
</span><span class="p" data-group-id="2044739356-2">{</span><span class="w">
    </span><span class="no">PGconn</span><span class="o">*</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">PQconnectStart</span><span class="p" data-group-id="2044739356-3">(</span><span class="n">s</span><span class="p" data-group-id="2044739356-3">)</span><span class="p">;</span><span class="w">
    </span><span class="k">if</span><span class="w"> </span><span class="p" data-group-id="2044739356-4">(</span><span class="no">PQstatus</span><span class="p" data-group-id="2044739356-5">(</span><span class="n">conn</span><span class="p" data-group-id="2044739356-5">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="no">CONNECTION_BAD</span><span class="p" data-group-id="2044739356-4">)</span><span class="w"> </span><span class="p" data-group-id="2044739356-6">{</span><span class="w">
        </span><span class="n">ei_x_buff</span><span class="w"> </span><span class="n">x</span><span class="p">;</span><span class="w">
        </span><span class="nf">ei_x_new_with_version</span><span class="p" data-group-id="2044739356-7">(</span><span class="o">&amp;</span><span class="n">x</span><span class="p" data-group-id="2044739356-7">)</span><span class="p">;</span><span class="w">
        </span><span class="nf">encode_error</span><span class="p" data-group-id="2044739356-8">(</span><span class="o">&amp;</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">conn</span><span class="p" data-group-id="2044739356-8">)</span><span class="p">;</span><span class="w">
        </span><span class="no">PQfinish</span><span class="p" data-group-id="2044739356-9">(</span><span class="n">conn</span><span class="p" data-group-id="2044739356-9">)</span><span class="p">;</span><span class="w">
        </span><span class="n">conn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">NULL</span><span class="p">;</span><span class="w">
        </span><span class="nf">driver_output</span><span class="p" data-group-id="2044739356-10">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="n">buff</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="n">index</span><span class="p" data-group-id="2044739356-10">)</span><span class="p">;</span><span class="w">
        </span><span class="nf">ei_x_free</span><span class="p" data-group-id="2044739356-11">(</span><span class="o">&amp;</span><span class="n">x</span><span class="p" data-group-id="2044739356-11">)</span><span class="p">;</span><span class="w">
    </span><span class="p" data-group-id="2044739356-6">}</span><span class="w">
    </span><span class="no">PQconnectPoll</span><span class="p" data-group-id="2044739356-12">(</span><span class="n">conn</span><span class="p" data-group-id="2044739356-12">)</span><span class="p">;</span><span class="w">
    </span><span class="kt">int</span><span class="w"> </span><span class="n">socket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">PQsocket</span><span class="p" data-group-id="2044739356-13">(</span><span class="n">conn</span><span class="p" data-group-id="2044739356-13">)</span><span class="p">;</span><span class="w">
    </span><span class="n">data</span><span class="o">-&gt;</span><span class="n">socket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">socket</span><span class="p">;</span><span class="w">
    </span><span class="nf">driver_select</span><span class="p" data-group-id="2044739356-14">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2044739356-15">(</span><span class="no">ErlDrvEvent</span><span class="p" data-group-id="2044739356-15">)</span><span class="n">socket</span><span class="p">,</span><span class="w"> </span><span class="no">DO_READ</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p" data-group-id="2044739356-14">)</span><span class="p">;</span><span class="w">
    </span><span class="nf">driver_select</span><span class="p" data-group-id="2044739356-16">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2044739356-17">(</span><span class="no">ErlDrvEvent</span><span class="p" data-group-id="2044739356-17">)</span><span class="n">socket</span><span class="p">,</span><span class="w"> </span><span class="no">DO_WRITE</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p" data-group-id="2044739356-16">)</span><span class="p">;</span><span class="w">
    </span><span class="n">data</span><span class="o">-&gt;</span><span class="n">conn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">conn</span><span class="p">;</span><span class="w">
    </span><span class="n">data</span><span class="o">-&gt;</span><span class="n">connecting</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">
    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="2044739356-2">}</span></code></pre><p>The <code class="inline">connect</code> function looks a bit different too. We connect using the
asynchronous <code class="inline">PQconnectStart</code> function. After the connection is started, we
retrieve the socket for the connection with <code class="inline">PQsocket</code>. This socket is used with
the <a href="../../apps/erts/erl_driver.html#driver_select" title=""><code class="inline">driver_select</code></a> function to wait for connection. When the socket is ready
for input or for output, the <code class="inline">ready_io</code> function is called.</p><p>Notice that we only return data (with <a href="../../apps/erts/erl_driver.html#driver_output" title=""><code class="inline">driver_output</code></a>) if there is an error
here, otherwise we wait for the connection to be completed, in which case our
<code class="inline">ready_io</code> function is called.</p><pre><code class="makeup c" translate="no"><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">do_select</span><span class="p" data-group-id="4269760903-1">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">our_data_t</span><span class="o">*</span><span class="w"> </span><span class="n">data</span><span class="p" data-group-id="4269760903-1">)</span><span class="w">
</span><span class="p" data-group-id="4269760903-2">{</span><span class="w">
    </span><span class="n">data</span><span class="o">-&gt;</span><span class="n">connecting</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">
    </span><span class="no">PGconn</span><span class="o">*</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="o">-&gt;</span><span class="n">conn</span><span class="p">;</span><span class="w">
    </span><span class="cm">/* if there&#39;s an error return it now */</span><span class="w">
    </span><span class="k">if</span><span class="w"> </span><span class="p" data-group-id="4269760903-3">(</span><span class="no">PQsendQuery</span><span class="p" data-group-id="4269760903-4">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="p" data-group-id="4269760903-4">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p" data-group-id="4269760903-3">)</span><span class="w"> </span><span class="p" data-group-id="4269760903-5">{</span><span class="w">
        </span><span class="n">ei_x_buff</span><span class="w"> </span><span class="n">x</span><span class="p">;</span><span class="w">
        </span><span class="nf">ei_x_new_with_version</span><span class="p" data-group-id="4269760903-6">(</span><span class="o">&amp;</span><span class="n">x</span><span class="p" data-group-id="4269760903-6">)</span><span class="p">;</span><span class="w">
        </span><span class="nf">encode_error</span><span class="p" data-group-id="4269760903-7">(</span><span class="o">&amp;</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">conn</span><span class="p" data-group-id="4269760903-7">)</span><span class="p">;</span><span class="w">
        </span><span class="nf">driver_output</span><span class="p" data-group-id="4269760903-8">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="n">buff</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="n">index</span><span class="p" data-group-id="4269760903-8">)</span><span class="p">;</span><span class="w">
        </span><span class="nf">ei_x_free</span><span class="p" data-group-id="4269760903-9">(</span><span class="o">&amp;</span><span class="n">x</span><span class="p" data-group-id="4269760903-9">)</span><span class="p">;</span><span class="w">
    </span><span class="p" data-group-id="4269760903-5">}</span><span class="w">
    </span><span class="cm">/* else wait for ready_output to get results */</span><span class="w">
    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="4269760903-2">}</span></code></pre><p>The <code class="inline">do_select</code> function initiates a select, and returns if there is no
immediate error. The result is returned when <code class="inline">ready_io</code> is called.</p><pre><code class="makeup c" translate="no"><span class="k">static</span><span class="w"> </span><span class="kc">void</span><span class="w"> </span><span class="nf">ready_io</span><span class="p" data-group-id="8812627183-1">(</span><span class="no">ErlDrvData</span><span class="w"> </span><span class="n">drv_data</span><span class="p">,</span><span class="w"> </span><span class="no">ErlDrvEvent</span><span class="w"> </span><span class="n">event</span><span class="p" data-group-id="8812627183-1">)</span><span class="w">
</span><span class="p" data-group-id="8812627183-2">{</span><span class="w">
    </span><span class="no">PGresult</span><span class="o">*</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">NULL</span><span class="p">;</span><span class="w">
    </span><span class="n">our_data_t</span><span class="o">*</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="8812627183-3">(</span><span class="n">our_data_t</span><span class="o">*</span><span class="p" data-group-id="8812627183-3">)</span><span class="n">drv_data</span><span class="p">;</span><span class="w">
    </span><span class="no">PGconn</span><span class="o">*</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="o">-&gt;</span><span class="n">conn</span><span class="p">;</span><span class="w">
    </span><span class="n">ei_x_buff</span><span class="w"> </span><span class="n">x</span><span class="p">;</span><span class="w">
    </span><span class="nf">ei_x_new_with_version</span><span class="p" data-group-id="8812627183-4">(</span><span class="o">&amp;</span><span class="n">x</span><span class="p" data-group-id="8812627183-4">)</span><span class="p">;</span><span class="w">
    </span><span class="k">if</span><span class="w"> </span><span class="p" data-group-id="8812627183-5">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">connecting</span><span class="p" data-group-id="8812627183-5">)</span><span class="w"> </span><span class="p" data-group-id="8812627183-6">{</span><span class="w">
        </span><span class="no">ConnStatusType</span><span class="w"> </span><span class="n">status</span><span class="p">;</span><span class="w">
        </span><span class="no">PQconnectPoll</span><span class="p" data-group-id="8812627183-7">(</span><span class="n">conn</span><span class="p" data-group-id="8812627183-7">)</span><span class="p">;</span><span class="w">
        </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">PQstatus</span><span class="p" data-group-id="8812627183-8">(</span><span class="n">conn</span><span class="p" data-group-id="8812627183-8">)</span><span class="p">;</span><span class="w">
        </span><span class="k">if</span><span class="w"> </span><span class="p" data-group-id="8812627183-9">(</span><span class="n">status</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="no">CONNECTION_OK</span><span class="p" data-group-id="8812627183-9">)</span><span class="w">
            </span><span class="nf">encode_ok</span><span class="p" data-group-id="8812627183-10">(</span><span class="o">&amp;</span><span class="n">x</span><span class="p" data-group-id="8812627183-10">)</span><span class="p">;</span><span class="w">
        </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p" data-group-id="8812627183-11">(</span><span class="n">status</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="no">CONNECTION_BAD</span><span class="p" data-group-id="8812627183-11">)</span><span class="w">
            </span><span class="nf">encode_error</span><span class="p" data-group-id="8812627183-12">(</span><span class="o">&amp;</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">conn</span><span class="p" data-group-id="8812627183-12">)</span><span class="p">;</span><span class="w">
    </span><span class="p" data-group-id="8812627183-6">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p" data-group-id="8812627183-13">{</span><span class="w">
        </span><span class="no">PQconsumeInput</span><span class="p" data-group-id="8812627183-14">(</span><span class="n">conn</span><span class="p" data-group-id="8812627183-14">)</span><span class="p">;</span><span class="w">
        </span><span class="k">if</span><span class="w"> </span><span class="p" data-group-id="8812627183-15">(</span><span class="no">PQisBusy</span><span class="p" data-group-id="8812627183-16">(</span><span class="n">conn</span><span class="p" data-group-id="8812627183-16">)</span><span class="p" data-group-id="8812627183-15">)</span><span class="w">
            </span><span class="k">return</span><span class="p">;</span><span class="w">
        </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">PQgetResult</span><span class="p" data-group-id="8812627183-17">(</span><span class="n">conn</span><span class="p" data-group-id="8812627183-17">)</span><span class="p">;</span><span class="w">
        </span><span class="nf">encode_result</span><span class="p" data-group-id="8812627183-18">(</span><span class="o">&amp;</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">res</span><span class="p">,</span><span class="w"> </span><span class="n">conn</span><span class="p" data-group-id="8812627183-18">)</span><span class="p">;</span><span class="w">
        </span><span class="no">PQclear</span><span class="p" data-group-id="8812627183-19">(</span><span class="n">res</span><span class="p" data-group-id="8812627183-19">)</span><span class="p">;</span><span class="w">
        </span><span class="k">for</span><span class="w"> </span><span class="p" data-group-id="8812627183-20">(</span><span class="p">;</span><span class="p">;</span><span class="p" data-group-id="8812627183-20">)</span><span class="w"> </span><span class="p" data-group-id="8812627183-21">{</span><span class="w">
            </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">PQgetResult</span><span class="p" data-group-id="8812627183-22">(</span><span class="n">conn</span><span class="p" data-group-id="8812627183-22">)</span><span class="p">;</span><span class="w">
            </span><span class="k">if</span><span class="w"> </span><span class="p" data-group-id="8812627183-23">(</span><span class="n">res</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="no">NULL</span><span class="p" data-group-id="8812627183-23">)</span><span class="w">
                </span><span class="k">break</span><span class="p">;</span><span class="w">
            </span><span class="no">PQclear</span><span class="p" data-group-id="8812627183-24">(</span><span class="n">res</span><span class="p" data-group-id="8812627183-24">)</span><span class="p">;</span><span class="w">
        </span><span class="p" data-group-id="8812627183-21">}</span><span class="w">
    </span><span class="p" data-group-id="8812627183-13">}</span><span class="w">
    </span><span class="k">if</span><span class="w"> </span><span class="p" data-group-id="8812627183-25">(</span><span class="n">x</span><span class="p">.</span><span class="n">index</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="p" data-group-id="8812627183-25">)</span><span class="w"> </span><span class="p" data-group-id="8812627183-26">{</span><span class="w">
        </span><span class="nf">driver_output</span><span class="p" data-group-id="8812627183-27">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="n">buff</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="n">index</span><span class="p" data-group-id="8812627183-27">)</span><span class="p">;</span><span class="w">
        </span><span class="k">if</span><span class="w"> </span><span class="p" data-group-id="8812627183-28">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">connecting</span><span class="p" data-group-id="8812627183-28">)</span><span class="w">
            </span><span class="nf">driver_select</span><span class="p" data-group-id="8812627183-29">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="8812627183-30">(</span><span class="no">ErlDrvEvent</span><span class="p" data-group-id="8812627183-30">)</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">socket</span><span class="p">,</span><span class="w"> </span><span class="no">DO_WRITE</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p" data-group-id="8812627183-29">)</span><span class="p">;</span><span class="w">
    </span><span class="p" data-group-id="8812627183-26">}</span><span class="w">
    </span><span class="nf">ei_x_free</span><span class="p" data-group-id="8812627183-31">(</span><span class="o">&amp;</span><span class="n">x</span><span class="p" data-group-id="8812627183-31">)</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="8812627183-2">}</span></code></pre><p>The <code class="inline">ready_io</code> function is called when the socket we got from postgres is ready
for input or output. Here we first check if we are connecting to the database.
In that case, we check connection status and return OK if the connection is
successful, or error if it is not. If the connection is not yet established, we
simply return; <code class="inline">ready_io</code> is called again.</p><p>If we have a result from a connect, indicated by having data in the <code class="inline">x</code> buffer,
we no longer need to select on output (<a href="../../apps/erts/driver_entry.html#ready_output" title=""><code class="inline">ready_output</code></a>), so we remove this by
calling <a href="../../apps/erts/erl_driver.html#driver_select" title=""><code class="inline">driver_select</code></a>.</p><p>If we are not connecting, we wait for results from a <code class="inline">PQsendQuery</code>, so we get
the result and return it. The encoding is done with the same functions as in the
earlier example.</p><p>Error handling is to be added here, for example, checking that the socket is
still open, but this is only a simple example.</p><p>The Erlang part of the asynchronous driver consists of the sample file
<code class="inline">pg_async.erl</code>.</p><pre><code class="makeup erlang" translate="no"><span class="p">-</span><span class="na">module</span><span class="p" data-group-id="5281105401-1">(</span><span class="ss">pg_async</span><span class="p" data-group-id="5281105401-1">)</span><span class="p">.</span><span class="w">
</span><span class="w">
</span><span class="p">-</span><span class="na">define</span><span class="p" data-group-id="5281105401-2">(</span><span class="n">DRV_CONNECT</span><span class="p">,</span><span class="w"> </span><span class="sc">$C</span><span class="p" data-group-id="5281105401-2">)</span><span class="p">.</span><span class="w">
</span><span class="p">-</span><span class="na">define</span><span class="p" data-group-id="5281105401-3">(</span><span class="n">DRV_DISCONNECT</span><span class="p">,</span><span class="w"> </span><span class="sc">$D</span><span class="p" data-group-id="5281105401-3">)</span><span class="p">.</span><span class="w">
</span><span class="p">-</span><span class="na">define</span><span class="p" data-group-id="5281105401-4">(</span><span class="n">DRV_SELECT</span><span class="p">,</span><span class="w"> </span><span class="sc">$S</span><span class="p" data-group-id="5281105401-4">)</span><span class="p">.</span><span class="w">
</span><span class="w">
</span><span class="p">-</span><span class="na">export</span><span class="p" data-group-id="5281105401-5">(</span><span class="p" data-group-id="5281105401-6">[</span><span class="ss">connect</span><span class="p">/</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="ss">disconnect</span><span class="p">/</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="ss">select</span><span class="p">/</span><span class="mi">2</span><span class="p" data-group-id="5281105401-6">]</span><span class="p" data-group-id="5281105401-5">)</span><span class="p">.</span><span class="w">

</span><span class="nf">connect</span><span class="p" data-group-id="5281105401-7">(</span><span class="n">ConnectStr</span><span class="p" data-group-id="5281105401-7">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="k">case</span><span class="w"> </span><span class="nc">erl_ddll</span><span class="p">:</span><span class="nf">load_driver</span><span class="p" data-group-id="5281105401-8">(</span><span class="s">&quot;.&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;pg_async&quot;</span><span class="p" data-group-id="5281105401-8">)</span><span class="w"> </span><span class="k">of</span><span class="w">
        </span><span class="ss">ok</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="ss">ok</span><span class="p">;</span><span class="w">
        </span><span class="p" data-group-id="5281105401-9">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="ss">already_loaded</span><span class="p" data-group-id="5281105401-9">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="ss">ok</span><span class="p">;</span><span class="w">
        </span><span class="p">_</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nf">exit</span><span class="p" data-group-id="5281105401-10">(</span><span class="p" data-group-id="5281105401-11">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="ss">could_not_load_driver</span><span class="p" data-group-id="5281105401-11">}</span><span class="p" data-group-id="5281105401-10">)</span><span class="w">
    </span><span class="k">end</span><span class="p">,</span><span class="w">
    </span><span class="n">Port</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">open_port</span><span class="p" data-group-id="5281105401-12">(</span><span class="p" data-group-id="5281105401-13">{</span><span class="nb">spawn</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="n">MODULE</span><span class="p" data-group-id="5281105401-13">}</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="5281105401-14">[</span><span class="ss">binary</span><span class="p" data-group-id="5281105401-14">]</span><span class="p" data-group-id="5281105401-12">)</span><span class="p">,</span><span class="w">
    </span><span class="nf">port_control</span><span class="p" data-group-id="5281105401-15">(</span><span class="n">Port</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="n">DRV_CONNECT</span><span class="p">,</span><span class="w"> </span><span class="n">ConnectStr</span><span class="p" data-group-id="5281105401-15">)</span><span class="p">,</span><span class="w">
    </span><span class="k">case</span><span class="w"> </span><span class="nf">return_port_data</span><span class="p" data-group-id="5281105401-16">(</span><span class="n">Port</span><span class="p" data-group-id="5281105401-16">)</span><span class="w"> </span><span class="k">of</span><span class="w">
        </span><span class="ss">ok</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="p" data-group-id="5281105401-17">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Port</span><span class="p" data-group-id="5281105401-17">}</span><span class="p">;</span><span class="w">
        </span><span class="n">Error</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="n">Error</span><span class="w">
    </span><span class="k">end</span><span class="p">.</span><span class="w">

</span><span class="nf">disconnect</span><span class="p" data-group-id="5281105401-18">(</span><span class="n">Port</span><span class="p" data-group-id="5281105401-18">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="nf">port_control</span><span class="p" data-group-id="5281105401-19">(</span><span class="n">Port</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="n">DRV_DISCONNECT</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p" data-group-id="5281105401-19">)</span><span class="p">,</span><span class="w">
    </span><span class="n">R</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">return_port_data</span><span class="p" data-group-id="5281105401-20">(</span><span class="n">Port</span><span class="p" data-group-id="5281105401-20">)</span><span class="p">,</span><span class="w">
    </span><span class="nf">port_close</span><span class="p" data-group-id="5281105401-21">(</span><span class="n">Port</span><span class="p" data-group-id="5281105401-21">)</span><span class="p">,</span><span class="w">
    </span><span class="n">R</span><span class="p">.</span><span class="w">

</span><span class="nf">select</span><span class="p" data-group-id="5281105401-22">(</span><span class="n">Port</span><span class="p">,</span><span class="w"> </span><span class="n">Query</span><span class="p" data-group-id="5281105401-22">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="nf">port_control</span><span class="p" data-group-id="5281105401-23">(</span><span class="n">Port</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="n">DRV_SELECT</span><span class="p">,</span><span class="w"> </span><span class="n">Query</span><span class="p" data-group-id="5281105401-23">)</span><span class="p">,</span><span class="w">
    </span><span class="nf">return_port_data</span><span class="p" data-group-id="5281105401-24">(</span><span class="n">Port</span><span class="p" data-group-id="5281105401-24">)</span><span class="p">.</span><span class="w">

</span><span class="nf">return_port_data</span><span class="p" data-group-id="5281105401-25">(</span><span class="n">Port</span><span class="p" data-group-id="5281105401-25">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="k">receive</span><span class="w">
        </span><span class="p" data-group-id="5281105401-26">{</span><span class="n">Port</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="5281105401-27">{</span><span class="ss">data</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="5281105401-27">}</span><span class="p" data-group-id="5281105401-26">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="nf">binary_to_term</span><span class="p" data-group-id="5281105401-28">(</span><span class="n">Data</span><span class="p" data-group-id="5281105401-28">)</span><span class="w">
    </span><span class="k">end</span><span class="p">.</span></code></pre><p>The Erlang code is slightly different, as we do not return the result
synchronously from <a href="erlang.html#port_control/3"><code class="inline">port_control/3</code></a>, instead we get it from <a href="../../apps/erts/erl_driver.html#driver_output" title=""><code class="inline">driver_output</code></a> as
data in the message queue. The function <code class="inline">return_port_data</code> above receives data
from the port. As the data is in binary format, we use
<a href="erlang.html#binary_to_term/1"><code class="inline">binary_to_term/1</code></a> to convert it to an Erlang term. Notice
that the driver is opened in binary mode (<a href="erlang.html#open_port/2"><code class="inline">open_port/2</code></a> is
called with option <code class="inline">[binary]</code>). This means that data sent from the driver to the
emulator is sent as binaries. Without option <code class="inline">binary</code>, they would have been
lists of integers.</p><h2 id="an-asynchronous-driver-using-driver_async" class="section-heading"><a href="#an-asynchronous-driver-using-driver_async" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">An Asynchronous Driver Using driver_async</span></h2><p>As a final example we demonstrate the use of <a href="../../apps/erts/erl_driver.html#driver_async" title=""><code class="inline">driver_async</code></a>. We also use the
driver term interface. The driver is written in C++. This enables us to use an
algorithm from STL. We use the <code class="inline">next_permutation</code> algorithm to get the next
permutation of a list of integers. For large lists (&gt; 100,000 elements), this
takes some time, so we perform this as an asynchronous task.</p><p>The asynchronous API for drivers is complicated. First, the work must be
prepared. In the example, this is done in <a href="../../apps/erts/driver_entry.html#output" title=""><code class="inline">output</code></a>. We could have used
<a href="../../apps/erts/driver_entry.html#control" title=""><code class="inline">control</code></a>, but we want some variation in the examples. In our driver, we
allocate a structure that contains anything that is needed for the asynchronous
task to do the work. This is done in the main emulator thread. Then the
asynchronous function is called from a driver thread, separate from the main
emulator thread. Notice that the driver functions are not re-entrant, so they
are not to be used. Finally, after the function is completed, the driver
callback <a href="../../apps/erts/driver_entry.html#ready_async" title=""><code class="inline">ready_async</code></a> is called from the main emulator thread, this is where we
return the result to Erlang. (We cannot return the result from within the
asynchronous function, as we cannot call the driver functions.)</p><p>The following code is from the sample file <code class="inline">next_perm.cc</code>. The driver entry
looks like before, but also contains the callback <a href="../../apps/erts/driver_entry.html#ready_async" title=""><code class="inline">ready_async</code></a>.</p><pre><code class="makeup c" translate="no"><span class="k">static</span><span class="w"> </span><span class="no">ErlDrvEntry</span><span class="w"> </span><span class="n">next_perm_driver_entry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="0033503206-1">{</span><span class="w">
    </span><span class="no">NULL</span><span class="p">,</span><span class="w">                        </span><span class="cm">/* init */</span><span class="w">
    </span><span class="n">start</span><span class="p">,</span><span class="w">
    </span><span class="no">NULL</span><span class="p">,</span><span class="w">                        </span><span class="cm">/* stop */</span><span class="w">
    </span><span class="n">output</span><span class="p">,</span><span class="w">
    </span><span class="no">NULL</span><span class="p">,</span><span class="w">                        </span><span class="cm">/* ready_input */</span><span class="w">
    </span><span class="no">NULL</span><span class="p">,</span><span class="w">                        </span><span class="cm">/* ready_output */</span><span class="w">
    </span><span class="s">&quot;next_perm&quot;</span><span class="p">,</span><span class="w">                 </span><span class="cm">/* the name of the driver */</span><span class="w">
    </span><span class="no">NULL</span><span class="p">,</span><span class="w">                        </span><span class="cm">/* finish */</span><span class="w">
    </span><span class="no">NULL</span><span class="p">,</span><span class="w">                        </span><span class="cm">/* handle */</span><span class="w">
    </span><span class="no">NULL</span><span class="p">,</span><span class="w">                        </span><span class="cm">/* control */</span><span class="w">
    </span><span class="no">NULL</span><span class="p">,</span><span class="w">                        </span><span class="cm">/* timeout */</span><span class="w">
    </span><span class="no">NULL</span><span class="p">,</span><span class="w">                        </span><span class="cm">/* outputv */</span><span class="w">
    </span><span class="n">ready_async</span><span class="p">,</span><span class="w">
    </span><span class="no">NULL</span><span class="p">,</span><span class="w">                        </span><span class="cm">/* flush */</span><span class="w">
    </span><span class="no">NULL</span><span class="p">,</span><span class="w">                        </span><span class="cm">/* call */</span><span class="w">
    </span><span class="no">NULL</span><span class="w">                         </span><span class="cm">/* event */</span><span class="w">
</span><span class="p" data-group-id="0033503206-1">}</span><span class="p">;</span></code></pre><p>The <code class="inline">output</code> function allocates the work area of the asynchronous function. As
we use C++, we use a struct, and stuff the data in it. We must copy the original
data, it is not valid after we have returned from the <code class="inline">output</code> function, and the
<code class="inline">do_perm</code> function is called later, and from another thread. We return no data
here, instead it is sent later from the <a href="../../apps/erts/driver_entry.html#ready_async" title=""><code class="inline">ready_async</code></a> callback.</p><p>The <code class="inline">async_data</code> is passed to the <code class="inline">do_perm</code> function. We do not use a
<code class="inline">async_free</code> function (the last argument to <a href="../../apps/erts/erl_driver.html#driver_async" title=""><code class="inline">driver_async</code></a>), it is only used if
the task is cancelled programmatically.</p><pre><code class="makeup c" translate="no"><span class="k">struct</span><span class="w"> </span><span class="n">our_async_data</span><span class="w"> </span><span class="p" data-group-id="0497092573-1">{</span><span class="w">
    </span><span class="kt">bool</span><span class="w"> </span><span class="n">prev</span><span class="p">;</span><span class="w">
    </span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="w"> </span><span class="n">data</span><span class="p">;</span><span class="w">
    </span><span class="nf">our_async_data</span><span class="p" data-group-id="0497092573-2">(</span><span class="no">ErlDrvPort</span><span class="w"> </span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">command</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">len</span><span class="p" data-group-id="0497092573-2">)</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="0497092573-1">}</span><span class="p">;</span><span class="w">

</span><span class="n">our_async_data</span><span class="o">:</span><span class="o">:</span><span class="nf">our_async_data</span><span class="p" data-group-id="0497092573-3">(</span><span class="no">ErlDrvPort</span><span class="w"> </span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">command</span><span class="p">,</span><span class="w">
                               </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">len</span><span class="p" data-group-id="0497092573-3">)</span><span class="w">
    </span><span class="o">:</span><span class="w"> </span><span class="nf">prev</span><span class="p" data-group-id="0497092573-4">(</span><span class="n">command</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="p" data-group-id="0497092573-4">)</span><span class="p">,</span><span class="w">
      </span><span class="nf">data</span><span class="p" data-group-id="0497092573-5">(</span><span class="p" data-group-id="0497092573-6">(</span><span class="kt">int</span><span class="o">*</span><span class="p" data-group-id="0497092573-6">)</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="0497092573-7">(</span><span class="kt">int</span><span class="o">*</span><span class="p" data-group-id="0497092573-7">)</span><span class="n">buf</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">len</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nf">sizeof</span><span class="p" data-group-id="0497092573-8">(</span><span class="kt">int</span><span class="p" data-group-id="0497092573-8">)</span><span class="p" data-group-id="0497092573-5">)</span><span class="w">
</span><span class="p" data-group-id="0497092573-9">{</span><span class="w">
</span><span class="p" data-group-id="0497092573-9">}</span><span class="w">

</span><span class="k">static</span><span class="w"> </span><span class="kc">void</span><span class="w"> </span><span class="nf">do_perm</span><span class="p" data-group-id="0497092573-10">(</span><span class="kc">void</span><span class="o">*</span><span class="w"> </span><span class="n">async_data</span><span class="p" data-group-id="0497092573-10">)</span><span class="p">;</span><span class="w">

</span><span class="k">static</span><span class="w"> </span><span class="kc">void</span><span class="w"> </span><span class="nf">output</span><span class="p" data-group-id="0497092573-11">(</span><span class="no">ErlDrvData</span><span class="w"> </span><span class="n">drv_data</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">len</span><span class="p" data-group-id="0497092573-11">)</span><span class="w">
</span><span class="p" data-group-id="0497092573-12">{</span><span class="w">
    </span><span class="k">if</span><span class="w"> </span><span class="p" data-group-id="0497092573-13">(</span><span class="o">*</span><span class="n">buf</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">2</span><span class="p" data-group-id="0497092573-13">)</span><span class="w"> </span><span class="k">return</span><span class="p">;</span><span class="w">
    </span><span class="no">ErlDrvPort</span><span class="w"> </span><span class="n">port</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="no">ErlDrvPort</span><span class="o">&gt;</span><span class="p" data-group-id="0497092573-14">(</span><span class="n">drv_data</span><span class="p" data-group-id="0497092573-14">)</span><span class="p">;</span><span class="w">
    </span><span class="kc">void</span><span class="o">*</span><span class="w"> </span><span class="n">async_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nf">our_async_data</span><span class="p" data-group-id="0497092573-15">(</span><span class="n">port</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="n">buf</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">len</span><span class="p" data-group-id="0497092573-15">)</span><span class="p">;</span><span class="w">
    </span><span class="nf">driver_async</span><span class="p" data-group-id="0497092573-16">(</span><span class="n">port</span><span class="p">,</span><span class="w"> </span><span class="no">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">do_perm</span><span class="p">,</span><span class="w"> </span><span class="n">async_data</span><span class="p">,</span><span class="w"> </span><span class="n">do_free</span><span class="p" data-group-id="0497092573-16">)</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="0497092573-12">}</span></code></pre><p>In the <code class="inline">do_perm</code> we do the work, operating on the structure that was allocated
in <code class="inline">output</code>.</p><pre><code class="makeup c" translate="no"><span class="k">static</span><span class="w"> </span><span class="kc">void</span><span class="w"> </span><span class="nf">do_perm</span><span class="p" data-group-id="4764111398-1">(</span><span class="kc">void</span><span class="o">*</span><span class="w"> </span><span class="n">async_data</span><span class="p" data-group-id="4764111398-1">)</span><span class="w">
</span><span class="p" data-group-id="4764111398-2">{</span><span class="w">
    </span><span class="n">our_async_data</span><span class="o">*</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">our_async_data</span><span class="o">*</span><span class="o">&gt;</span><span class="p" data-group-id="4764111398-3">(</span><span class="n">async_data</span><span class="p" data-group-id="4764111398-3">)</span><span class="p">;</span><span class="w">
    </span><span class="k">if</span><span class="w"> </span><span class="p" data-group-id="4764111398-4">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p" data-group-id="4764111398-4">)</span><span class="w">
        </span><span class="nf">prev_permutation</span><span class="p" data-group-id="4764111398-5">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="nf">begin</span><span class="p" data-group-id="4764111398-6">(</span><span class="p" data-group-id="4764111398-6">)</span><span class="p">,</span><span class="w"> </span><span class="n">d</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="nf">end</span><span class="p" data-group-id="4764111398-7">(</span><span class="p" data-group-id="4764111398-7">)</span><span class="p" data-group-id="4764111398-5">)</span><span class="p">;</span><span class="w">
    </span><span class="k">else</span><span class="w">
        </span><span class="nf">next_permutation</span><span class="p" data-group-id="4764111398-8">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="nf">begin</span><span class="p" data-group-id="4764111398-9">(</span><span class="p" data-group-id="4764111398-9">)</span><span class="p">,</span><span class="w"> </span><span class="n">d</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="nf">end</span><span class="p" data-group-id="4764111398-10">(</span><span class="p" data-group-id="4764111398-10">)</span><span class="p" data-group-id="4764111398-8">)</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="4764111398-2">}</span></code></pre><p>In the <code class="inline">ready_async</code> function the output is sent back to the emulator. We use
the driver term format instead of <a href="../../apps/erl_interface/ei.html" title=""><code class="inline">ei</code></a>. This is the only way to send Erlang
terms directly to a driver, without having the Erlang code to call
<a href="erlang.html#binary_to_term/1"><code class="inline">binary_to_term/1</code></a>. In the simple example this works well,
and we do not need to use <a href="../../apps/erl_interface/ei.html" title=""><code class="inline">ei</code></a> to handle the binary term format.</p><p>When the data is returned, we deallocate our data.</p><pre><code class="makeup c" translate="no"><span class="k">static</span><span class="w"> </span><span class="kc">void</span><span class="w"> </span><span class="nf">ready_async</span><span class="p" data-group-id="6507463890-1">(</span><span class="no">ErlDrvData</span><span class="w"> </span><span class="n">drv_data</span><span class="p">,</span><span class="w"> </span><span class="no">ErlDrvThreadData</span><span class="w"> </span><span class="n">async_data</span><span class="p" data-group-id="6507463890-1">)</span><span class="w">
</span><span class="p" data-group-id="6507463890-2">{</span><span class="w">
    </span><span class="no">ErlDrvPort</span><span class="w"> </span><span class="n">port</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="no">ErlDrvPort</span><span class="o">&gt;</span><span class="p" data-group-id="6507463890-3">(</span><span class="n">drv_data</span><span class="p" data-group-id="6507463890-3">)</span><span class="p">;</span><span class="w">
    </span><span class="n">our_async_data</span><span class="o">*</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">our_async_data</span><span class="o">*</span><span class="o">&gt;</span><span class="p" data-group-id="6507463890-4">(</span><span class="n">async_data</span><span class="p" data-group-id="6507463890-4">)</span><span class="p">;</span><span class="w">
    </span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">d</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="nf">size</span><span class="p" data-group-id="6507463890-5">(</span><span class="p" data-group-id="6507463890-5">)</span><span class="p">,</span><span class="w"> </span><span class="n">result_n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n</span><span class="o">*</span><span class="mi">2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span><span class="w">
    </span><span class="no">ErlDrvTermData</span><span class="w"> </span><span class="o">*</span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="no">ErlDrvTermData</span><span class="p" data-group-id="6507463890-6">[</span><span class="n">result_n</span><span class="p" data-group-id="6507463890-6">]</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">rp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">result</span><span class="p">;</span><span class="w">
    </span><span class="k">for</span><span class="w"> </span><span class="p" data-group-id="6507463890-7">(</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="o">:</span><span class="o">:</span><span class="n">iterator</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">d</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="nf">begin</span><span class="p" data-group-id="6507463890-8">(</span><span class="p" data-group-id="6507463890-8">)</span><span class="p">;</span><span class="w">
         </span><span class="n">i</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">d</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="nf">end</span><span class="p" data-group-id="6507463890-9">(</span><span class="p" data-group-id="6507463890-9">)</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p" data-group-id="6507463890-7">)</span><span class="w"> </span><span class="p" data-group-id="6507463890-10">{</span><span class="w">
        </span><span class="o">*</span><span class="n">rp</span><span class="o">++</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">ERL_DRV_INT</span><span class="p">;</span><span class="w">
        </span><span class="o">*</span><span class="n">rp</span><span class="o">++</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">i</span><span class="p">;</span><span class="w">
    </span><span class="p" data-group-id="6507463890-10">}</span><span class="w">
    </span><span class="o">*</span><span class="n">rp</span><span class="o">++</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">ERL_DRV_NIL</span><span class="p">;</span><span class="w">
    </span><span class="o">*</span><span class="n">rp</span><span class="o">++</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">ERL_DRV_LIST</span><span class="p">;</span><span class="w">
    </span><span class="o">*</span><span class="n">rp</span><span class="o">++</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span><span class="w">
    </span><span class="nf">driver_output_term</span><span class="p" data-group-id="6507463890-11">(</span><span class="n">port</span><span class="p">,</span><span class="w"> </span><span class="n">result</span><span class="p">,</span><span class="w"> </span><span class="n">result_n</span><span class="p" data-group-id="6507463890-11">)</span><span class="p">;</span><span class="w">
    </span><span class="k">delete</span><span class="p" data-group-id="6507463890-12">[</span><span class="p" data-group-id="6507463890-12">]</span><span class="w"> </span><span class="n">result</span><span class="p">;</span><span class="w">
    </span><span class="k">delete</span><span class="w"> </span><span class="n">d</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="6507463890-2">}</span></code></pre><p>This driver is called like the others from Erlang. However, as we use
<a href="../../apps/erts/erl_driver.html#driver_output_term" title=""><code class="inline">driver_output_term</code></a>, there is no need to call <a href="erlang.html#binary_to_term/1"><code class="inline">binary_to_term/1</code></a>. The Erlang code
is in the sample file <code class="inline">next_perm.erl</code>.</p><p>The input is changed into a list of integers and sent to the driver.</p><pre><code class="makeup erlang" translate="no"><span class="p">-</span><span class="na">module</span><span class="p" data-group-id="6638126073-1">(</span><span class="ss">next_perm</span><span class="p" data-group-id="6638126073-1">)</span><span class="p">.</span><span class="w">
</span><span class="w">
</span><span class="p">-</span><span class="na">export</span><span class="p" data-group-id="6638126073-2">(</span><span class="p" data-group-id="6638126073-3">[</span><span class="ss">next_perm</span><span class="p">/</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="ss">prev_perm</span><span class="p">/</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="ss">load</span><span class="p">/</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="ss">all_perm</span><span class="p">/</span><span class="mi">1</span><span class="p" data-group-id="6638126073-3">]</span><span class="p" data-group-id="6638126073-2">)</span><span class="p">.</span><span class="w">

</span><span class="nf">load</span><span class="p" data-group-id="6638126073-4">(</span><span class="p" data-group-id="6638126073-4">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="k">case</span><span class="w"> </span><span class="nf">whereis</span><span class="p" data-group-id="6638126073-5">(</span><span class="ss">next_perm</span><span class="p" data-group-id="6638126073-5">)</span><span class="w"> </span><span class="k">of</span><span class="w">
        </span><span class="ss">undefined</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="k">case</span><span class="w"> </span><span class="nc">erl_ddll</span><span class="p">:</span><span class="nf">load_driver</span><span class="p" data-group-id="6638126073-6">(</span><span class="s">&quot;.&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;next_perm&quot;</span><span class="p" data-group-id="6638126073-6">)</span><span class="w"> </span><span class="k">of</span><span class="w">
                </span><span class="ss">ok</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="ss">ok</span><span class="p">;</span><span class="w">
                </span><span class="p" data-group-id="6638126073-7">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="ss">already_loaded</span><span class="p" data-group-id="6638126073-7">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="ss">ok</span><span class="p">;</span><span class="w">
                </span><span class="n">E</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nf">exit</span><span class="p" data-group-id="6638126073-8">(</span><span class="n">E</span><span class="p" data-group-id="6638126073-8">)</span><span class="w">
            </span><span class="k">end</span><span class="p">,</span><span class="w">
            </span><span class="n">Port</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">open_port</span><span class="p" data-group-id="6638126073-9">(</span><span class="p" data-group-id="6638126073-10">{</span><span class="nb">spawn</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;next_perm&quot;</span><span class="p" data-group-id="6638126073-10">}</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="6638126073-11">[</span><span class="p" data-group-id="6638126073-11">]</span><span class="p" data-group-id="6638126073-9">)</span><span class="p">,</span><span class="w">
            </span><span class="nf">register</span><span class="p" data-group-id="6638126073-12">(</span><span class="ss">next_perm</span><span class="p">,</span><span class="w"> </span><span class="n">Port</span><span class="p" data-group-id="6638126073-12">)</span><span class="p">;</span><span class="w">
        </span><span class="p">_</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="ss">ok</span><span class="w">
    </span><span class="k">end</span><span class="p">.</span><span class="w">

</span><span class="nf">list_to_integer_binaries</span><span class="p" data-group-id="6638126073-13">(</span><span class="n">L</span><span class="p" data-group-id="6638126073-13">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="p" data-group-id="6638126073-14">[</span><span class="p" data-group-id="6638126073-15">&lt;&lt;</span><span class="n">I</span><span class="p">:</span><span class="mi">32</span><span class="o">/</span><span class="ss">integer</span><span class="o">-</span><span class="ss">native</span><span class="p" data-group-id="6638126073-15">&gt;&gt;</span><span class="w"> </span><span class="p">||</span><span class="w"> </span><span class="n">I</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">L</span><span class="p" data-group-id="6638126073-14">]</span><span class="p">.</span><span class="w">

</span><span class="nf">next_perm</span><span class="p" data-group-id="6638126073-16">(</span><span class="n">L</span><span class="p" data-group-id="6638126073-16">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="nf">next_perm</span><span class="p" data-group-id="6638126073-17">(</span><span class="n">L</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p" data-group-id="6638126073-17">)</span><span class="p">.</span><span class="w">

</span><span class="nf">prev_perm</span><span class="p" data-group-id="6638126073-18">(</span><span class="n">L</span><span class="p" data-group-id="6638126073-18">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="nf">next_perm</span><span class="p" data-group-id="6638126073-19">(</span><span class="n">L</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p" data-group-id="6638126073-19">)</span><span class="p">.</span><span class="w">

</span><span class="nf">next_perm</span><span class="p" data-group-id="6638126073-20">(</span><span class="n">L</span><span class="p">,</span><span class="w"> </span><span class="n">Nxt</span><span class="p" data-group-id="6638126073-20">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="nf">load</span><span class="p" data-group-id="6638126073-21">(</span><span class="p" data-group-id="6638126073-21">)</span><span class="p">,</span><span class="w">
    </span><span class="n">B</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">list_to_integer_binaries</span><span class="p" data-group-id="6638126073-22">(</span><span class="n">L</span><span class="p" data-group-id="6638126073-22">)</span><span class="p">,</span><span class="w">
    </span><span class="nf">port_control</span><span class="p" data-group-id="6638126073-23">(</span><span class="ss">next_perm</span><span class="p">,</span><span class="w"> </span><span class="n">Nxt</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="p" data-group-id="6638126073-23">)</span><span class="p">,</span><span class="w">
    </span><span class="k">receive</span><span class="w">
        </span><span class="n">Result</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="n">Result</span><span class="w">
    </span><span class="k">end</span><span class="p">.</span><span class="w">

</span><span class="nf">all_perm</span><span class="p" data-group-id="6638126073-24">(</span><span class="n">L</span><span class="p" data-group-id="6638126073-24">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="n">New</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">prev_perm</span><span class="p" data-group-id="6638126073-25">(</span><span class="n">L</span><span class="p" data-group-id="6638126073-25">)</span><span class="p">,</span><span class="w">
    </span><span class="nf">all_perm</span><span class="p" data-group-id="6638126073-26">(</span><span class="n">New</span><span class="p">,</span><span class="w"> </span><span class="n">L</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="6638126073-27">[</span><span class="n">New</span><span class="p" data-group-id="6638126073-27">]</span><span class="p" data-group-id="6638126073-26">)</span><span class="p">.</span><span class="w">

</span><span class="nf">all_perm</span><span class="p" data-group-id="6638126073-28">(</span><span class="n">L</span><span class="p">,</span><span class="w"> </span><span class="n">L</span><span class="p">,</span><span class="w"> </span><span class="n">Acc</span><span class="p" data-group-id="6638126073-28">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="n">Acc</span><span class="p">;</span><span class="w">
</span><span class="nf">all_perm</span><span class="p" data-group-id="6638126073-29">(</span><span class="n">L</span><span class="p">,</span><span class="w"> </span><span class="n">Orig</span><span class="p">,</span><span class="w"> </span><span class="n">Acc</span><span class="p" data-group-id="6638126073-29">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="n">New</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">prev_perm</span><span class="p" data-group-id="6638126073-30">(</span><span class="n">L</span><span class="p" data-group-id="6638126073-30">)</span><span class="p">,</span><span class="w">
    </span><span class="nf">all_perm</span><span class="p" data-group-id="6638126073-31">(</span><span class="n">New</span><span class="p">,</span><span class="w"> </span><span class="n">Orig</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="6638126073-32">[</span><span class="n">New</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="n">Acc</span><span class="p" data-group-id="6638126073-32">]</span><span class="p" data-group-id="6638126073-31">)</span><span class="p">.</span></code></pre>

</div>

<div class="bottom-actions" id="bottom-actions">
  <div class="bottom-actions-item">

      <a href="tty.html" class="bottom-actions-button" rel="prev">
        <span class="subheader">
          â† Previous Page
        </span>
        <span class="title">
tty - A Command-Line Interface
        </span>
      </a>

  </div>
  <div class="bottom-actions-item">

      <a href="inet_cfg.html" class="bottom-actions-button" rel="next">
        <span class="subheader">
          Next Page â†’
        </span>
        <span class="title">
Inet Configuration
        </span>
      </a>

  </div>
</div>
    <footer class="footer">
      <p>

        <span class="line">
          <button class="a-main footer-button display-quick-switch" title="Search HexDocs packages">
            Search HexDocs
          </button>

        </span>
      </p>

      <p class="built-using">
        Built using
        <a href="https://github.com/elixir-lang/ex_doc" title="ExDoc" target="_blank" rel="help noopener" translate="no">ExDoc</a> (v0.38.1) for the

          <a href="https://erlang.org" title="Erlang" target="_blank" translate="no">Erlang programming language</a>

      </p>
<p>Copyright Â© 1996-2025 <a href="https://www.ericsson.com">Ericsson AB</a></p>
    </footer>
  </div>
</main>
</div>
  <script defer src="https://cdn.jsdelivr.net/npm/mermaid@11.4.1/dist/mermaid.min.js"></script>
  <script>
  let initialized = false;

  window.addEventListener("exdoc:loaded", () => {
      if (!initialized) {
      mermaid.initialize({
          startOnLoad: false,
          theme: document.body.className.includes("dark") ? "dark" : "default"
      });
      initialized = true;
      }

      let id = 0;
      for (const codeEl of document.querySelectorAll("pre code.mermaid")) {
      const preEl = codeEl.parentElement;
      const graphDefinition = codeEl.textContent;
      const graphEl = document.createElement("div");
      const graphId = "mermaid-graph-" + id++;
      mermaid.render(graphId, graphDefinition).then(({svg, bindFunctions}) => {
          graphEl.innerHTML = svg;
          bindFunctions?.(graphEl);
          preEl.insertAdjacentElement("afterend", graphEl);
          preEl.remove();
      });
      }
  });
  </script>

  </body>
</html>
