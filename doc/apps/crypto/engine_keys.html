<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html xmlns:erl="http://erlang.org" xmlns:fn="http://www.w3.org/2005/02/xpath-functions">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta charset="utf-8">
<link rel="stylesheet" href="../../otp_doc.css" type="text/css">
<title>Erlang -- Engine Stored Keys</title>
</head>
<body>
<div id="container">
<script id="js" type="text/javascript" language="JavaScript" src="../../js/flipmenu/flipmenu.js"></script><script id="js2" type="text/javascript" src="../../js/erlresolvelinks.js"></script><script id="js3" type="text/javascript" src="../../../../doc/js/topbar.js"></script><script language="JavaScript" type="text/javascript">
            <!--
              function setscrollpos() {
                var objf = document.getElementById('loadscrollpos');
                if (objf) {
                  document.getElementById("leftnav").firstChild.scrollTop = objf.offsetTop - 10;
                }
              }

              function addEvent(obj, evType, fn){
                if (obj.addEventListener){
                obj.addEventListener(evType, fn, true);
                return true;
              } else if (obj.attachEvent){
                var r = obj.attachEvent("on"+evType, fn);
                return r;
              } else {
                return false;
              }
             }

             addEvent(window, 'load', setscrollpos);

             //-->
</script><div class="topbar">
<div class="topbar-expand "><button onclick="toggleDisplay();"><svg xmlns="http://www.w3.org/2000/svg" version="1.1" id="Capa_1" viewBox="0 0 54 54" width="24" height="24"><g><path style="fill:#000000;" d="M27,54c-0.552,0-1-0.448-1-1V8c0-0.552,0.448-1,1-1s1,0.448,1,1v45C28,53.552,27.552,54,27,54z"></path><path style="fill:#000000;" d="M11,25c-0.256,0-0.512-0.098-0.707-0.293c-0.391-0.391-0.391-1.023,0-1.414l16-16                                      c0.391-0.391,1.023-0.391,1.414,0s0.391,1.023,0,1.414l-16,16C11.512,24.902,11.256,25,11,25z"></path><path style="fill:#000000;" d="M43,25c-0.256,0-0.512-0.098-0.707-0.293l-16-16c-0.391-0.391-0.391-1.023,0-1.414                                      s1.023-0.391,1.414,0l16,16c0.391,0.391,0.391,1.023,0,1.414C43.512,24.902,43.256,25,43,25z"></path><path style="fill:#000000;" d="M43,2H11c-0.552,0-1-0.448-1-1s0.448-1,1-1h32c0.552,0,1,0.448,1,1S43.552,2,43,2z"></path></g></svg></button></div>
<div class="topbar-title"><h1 id="Engine Stored Keys">4 
                Engine Stored Keys</h1></div>
<div class="search-expand ">        <button id="docsearch-mobile">
            <svg fill="#000000" xmlns="http://www.w3.org/2000/svg"  viewBox="0 0 50 50" width="24" height="24"><path d="M 21 3 C 11.621094 3 4 10.621094 4 20 C 4 29.378906 11.621094 37 21 37 C 24.710938 37 28.140625 35.804688 30.9375 33.78125 L 44.09375 46.90625 L 46.90625 44.09375 L 33.90625 31.0625 C 36.460938 28.085938 38 24.222656 38 20 C 38 10.621094 30.378906 3 21 3 Z M 21 5 C 29.296875 5 36 11.703125 36 20 C 36 28.296875 29.296875 35 21 35 C 12.703125 35 6 28.296875 6 20 C 6 11.703125 12.703125 5 21 5 Z"/></svg>
        </button>
</div>
</div>
<aside class="hide-mobile" id="leftnav"><nav class="leftnav-tube"><div class="erlang-logo-wrapper"><a href="../../index.html"><img alt="Erlang Logo" src="../../erlang-logo.png" class="erlang-logo"></a></div>
<p class="section-title">crypto</p>
<p class="section-subtitle">User's Guide</p>
<p class="section-version">Version 5.0.4</p>
<ul class="panel-sections">
<li><a href="users_guide.html">User's Guide</a></li>
<li><a href="index.html">Reference Manual</a></li>
<li><a href="notes.html">Release Notes</a></li>
<li><a href="crypto.pdf">PDF</a></li>
<li><a href="../../index.html">Top</a></li>
</ul>
<div id="docsearch"></div>
<ul class="expand-collapse-items">
<li><a href="javascript:openAllFlips()">Expand All</a></li>
<li><a href="javascript:closeAllFlips()">Contract All</a></li>
</ul>
<h3 id="chapters">Chapters</h3>
<ul class="flipMenu" imagePath="../../js/flipmenu">
<li id="no" title="Licenses" expanded="false">Licenses<ul>
<li><a href="licenses.html">
              Top of chapter
            </a></li>
<li title="OpenSSL License"><a href="licenses.html#openssl-license">OpenSSL License</a></li>
<li title="SSLeay License"><a href="licenses.html#ssleay-license">SSLeay License</a></li>
</ul>
</li>
<li id="no" title="FIPS mode" expanded="false">FIPS mode<ul>
<li><a href="fips.html">
              Top of chapter
            </a></li>
<li title="Background"><a href="fips.html#background">Background</a></li>
<li title="Enabling FIPS mode"><a href="fips.html#enabling-fips-mode">Enabling FIPS mode</a></li>
<li title="Incompatibilities with regular builds"><a href="fips.html#incompatibilities-with-regular-builds">Incompatibilities with regular builds</a></li>
<li title="Common caveats"><a href="fips.html#common-caveats">Common caveats</a></li>
</ul>
</li>
<li id="no" title="Engine Load" expanded="false">Engine Load<ul>
<li><a href="engine_load.html">
              Top of chapter
            </a></li>
<li title="Background"><a href="engine_load.html#background">Background</a></li>
<li title="Use Cases"><a href="engine_load.html#use-cases">Use Cases</a></li>
</ul>
</li>
<li id="loadscrollpos" title="Engine Stored Keys" expanded="true">Engine Stored Keys<ul>
<li><a href="engine_keys.html">
              Top of chapter
            </a></li>
<li title="Background"><a href="engine_keys.html#background">Background</a></li>
<li title="Use Cases"><a href="engine_keys.html#use-cases">Use Cases</a></li>
</ul>
</li>
<li id="no" title="Algorithm Details" expanded="false">Algorithm Details<ul>
<li><a href="algorithm_details.html">
              Top of chapter
            </a></li>
<li title="Ciphers"><a href="algorithm_details.html#ciphers">Ciphers</a></li>
<li title="Message Authentication Codes (MACs)"><a href="algorithm_details.html#message-authentication-codes--macs-">Message Authentication Codes (MACs)</a></li>
<li title="Hash"><a href="algorithm_details.html#hash">Hash</a></li>
<li title="Public Key Cryptography"><a href="algorithm_details.html#public-key-cryptography">Public Key Cryptography</a></li>
</ul>
</li>
<li id="no" title="New and Old API" expanded="false">New and Old API<ul>
<li><a href="new_api.html">
              Top of chapter
            </a></li>
<li title="Background"><a href="new_api.html#background">Background</a></li>
<li title="The old API"><a href="new_api.html#the-old-api">The old API</a></li>
<li title="The new API"><a href="new_api.html#the-new-api">The new API</a></li>
<li title="Examples of the new api"><a href="new_api.html#examples-of-the-new-api">Examples of the new api</a></li>
<li title="Retired cipher names"><a href="new_api.html#retired-cipher-names">Retired cipher names</a></li>
</ul>
</li>
</ul></nav></aside><div id="content">
<div class="innertube">
<h1 id="Engine Stored Keys">4 Engine Stored Keys</h1>
  
  <p>
    <a name="engine_key"></a>
    This chapter describes the support in the crypto application for using public and private keys stored in encryption engines.
  </p>

  <h3 id="background" class="title-link" onMouseOver="document.getElementById('ghlink-background-idm218').style.visibility = 'visible';" onMouseOut="document.getElementById('ghlink-background-idm218').style.visibility = 'hidden';">
<div class="title-name">4.1 
        Background</div>
<div class="title-anchors"><span id="ghlink-background-idm218" class="ghlink-after"><a href="#background" title="Link to this place!"><span class="paperclip-after"></span></a><a href="https://github.com/erlang/otp/edit/maint/lib/crypto/doc/src/engine_keys.xml#L32" title="Found an issue with the documentation? Fix it by clicking here!"><span class="pencil-after"></span></a></span></div>
</h3>
    
    <p>
      <span class="bold_code bc-20"><a href="https://www.openssl.org/">OpenSSL</a></span> exposes an Engine API, which makes 
      it possible to plug in alternative implementations for some of the cryptographic
      operations implemented by OpenSSL.
      See the chapter <span class="bold_code bc-13"><a href="engine_load.html#engine_load">Engine Load</a></span>
      for details and how to load an Engine.
    </p>
    <p>
      An engine could among other tasks provide a storage for
      private or public keys. Such a storage could be made safer than the normal file system. Those techniques are not
      described in this User's Guide.  Here we concentrate on how to use private or public keys stored in
      such an engine.
    </p>
    <p>
      The storage engine must call <span class="code">ENGINE_set_load_privkey_function</span> and <span class="code">ENGINE_set_load_pubkey_function</span>.
      See the OpenSSL cryptolib's <span class="bold_code bc-20"><a href="https://www.openssl.org/docs/manpages.html">manpages</a></span>.
    </p>
    <p>
      OTP/Crypto requires that the user provides two or three items of information about the key. The application used
      by the user is usually on a higher level, for example in
      <span class="bold_code bc-13"><a href="../../man/ssl.html#type-key">SSL</a></span>. If using
      the crypto application directly, it is required that:
    </p>
    <ul>
      <li>an Engine is loaded, see the chapter on <span class="bold_code bc-13"><a href="engine_load.html#engine_load">Engine Load</a></span>
      or the <span class="bold_code bc-13"><a href="../../man/crypto.html#engine_load-3">Reference Manual</a></span>
      </li>
      <li>a reference to a key in the Engine is available. This should be an Erlang string or binary and depends
      on the Engine loaded
      </li>
      <li>an Erlang map is constructed with the Engine reference, the key reference and possibly a key passphrase if
      needed by the Engine. See the <span class="bold_code bc-13"><a href="../../man/crypto.html#type-engine_key_ref">Reference Manual</a></span> for
      details of the map.
      </li>
    </ul>
  

  <h3 id="use-cases" class="title-link" onMouseOver="document.getElementById('ghlink-use-cases-idm237').style.visibility = 'visible';" onMouseOut="document.getElementById('ghlink-use-cases-idm237').style.visibility = 'hidden';">
<div class="title-name">4.2 
        Use Cases</div>
<div class="title-anchors"><span id="ghlink-use-cases-idm237" class="ghlink-after"><a href="#use-cases" title="Link to this place!"><span class="paperclip-after"></span></a><a href="https://github.com/erlang/otp/edit/maint/lib/crypto/doc/src/engine_keys.xml#L71" title="Found an issue with the documentation? Fix it by clicking here!"><span class="pencil-after"></span></a></span></div>
</h3>
    
    <h4 id="sign-with-an-engine-stored-private-key" class="title-link" onMouseOver="document.getElementById('ghlink-sign-with-an-engine-stored-private-key-idm239').style.visibility = 'visible';" onMouseOut="document.getElementById('ghlink-sign-with-an-engine-stored-private-key-idm239').style.visibility = 'hidden';">
<div class="title-name">Sign with an engine stored private key</div>
<div class="title-anchors"><span id="ghlink-sign-with-an-engine-stored-private-key-idm239" class="ghlink-after"><a href="#sign-with-an-engine-stored-private-key" title="Link to this place!"><span class="paperclip-after"></span></a><a href="https://github.com/erlang/otp/edit/maint/lib/crypto/doc/src/engine_keys.xml#L73" title="Found an issue with the documentation? Fix it by clicking here!"><span class="pencil-after"></span></a></span></div>
</h4>
      
      <p>
	This example shows how to construct a key reference that is used in a sign operation.
	The actual key is stored in the engine that is loaded at prompt 1.
      </p>
      <div class="example example-none"><pre>1&gt; {ok, EngineRef} = crypto:engine_load(....).
...
{ok,#Ref&lt;0.2399045421.3028942852.173962&gt;}
2&gt; PrivKey = #{engine =&gt; EngineRef,
               key_id =&gt; "id of the private key in Engine"}.
...
3&gt; Signature = crypto:sign(rsa, sha, &lt;&lt;"The message"&gt;&gt;, PrivKey).
&lt;&lt;65,6,125,254,54,233,84,77,83,63,168,28,169,214,121,76,
  207,177,124,183,156,185,160,243,36,79,125,230,231,...&gt;&gt;</pre></div>
    

    <h4 id="verify-with-an-engine-stored-public-key" class="title-link" onMouseOver="document.getElementById('ghlink-verify-with-an-engine-stored-public-key-idm243').style.visibility = 'visible';" onMouseOut="document.getElementById('ghlink-verify-with-an-engine-stored-public-key-idm243').style.visibility = 'hidden';">
<div class="title-name">Verify with an engine stored public key</div>
<div class="title-anchors"><span id="ghlink-verify-with-an-engine-stored-public-key-idm243" class="ghlink-after"><a href="#verify-with-an-engine-stored-public-key" title="Link to this place!"><span class="paperclip-after"></span></a><a href="https://github.com/erlang/otp/edit/maint/lib/crypto/doc/src/engine_keys.xml#L92" title="Found an issue with the documentation? Fix it by clicking here!"><span class="pencil-after"></span></a></span></div>
</h4>
      
      <p>
	Here the signature and message in the last example is verifyed using the public key.
	The public key is stored in an engine, only to exemplify that it is possible. The public
	key could of course be handled openly as usual.
      </p>
      <div class="example example-none"><pre>4&gt; PublicKey = #{engine =&gt; EngineRef,
                 key_id =&gt; "id of the public key in Engine"}.
...
5&gt; crypto:verify(rsa, sha, &lt;&lt;"The message"&gt;&gt;, Signature, PublicKey).
true
6&gt; </pre></div>
    

    <h4 id="using-a-password-protected-private-key" class="title-link" onMouseOver="document.getElementById('ghlink-using-a-password-protected-private-key-idm247').style.visibility = 'visible';" onMouseOut="document.getElementById('ghlink-using-a-password-protected-private-key-idm247').style.visibility = 'hidden';">
<div class="title-name">Using a password protected private key</div>
<div class="title-anchors"><span id="ghlink-using-a-password-protected-private-key-idm247" class="ghlink-after"><a href="#using-a-password-protected-private-key" title="Link to this place!"><span class="paperclip-after"></span></a><a href="https://github.com/erlang/otp/edit/maint/lib/crypto/doc/src/engine_keys.xml#L109" title="Found an issue with the documentation? Fix it by clicking here!"><span class="pencil-after"></span></a></span></div>
</h4>
      
      <p>
	The same example as the first sign example, except that a password protects the key down in the Engine.
      </p>
      <div class="example example-none"><pre>6&gt; PrivKeyPwd = #{engine =&gt; EngineRef,
                  key_id =&gt; "id of the pwd protected private key in Engine",
		  password =&gt; "password"}.
...
7&gt; crypto:sign(rsa, sha, &lt;&lt;"The message"&gt;&gt;, PrivKeyPwd).
&lt;&lt;140,80,168,101,234,211,146,183,231,190,160,82,85,163,
  175,106,77,241,141,120,72,149,181,181,194,154,175,76,
  223,...&gt;&gt;
8&gt; </pre></div>

    

  
</div>
<div class="footer">
<hr>
<p>Copyright © 1999-2021 Ericsson AB. All Rights Reserved.</p>
</div>
</div>
</div>
<script type="text/javascript">window.__otpTopDocDir = '../../js/';</script><script type="text/javascript" src="../../js/highlight.js"></script>
<script src="/assets/js/doc-search.bundle.js"></script>
</body>
</html>
