<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html xmlns:erl="http://erlang.org" xmlns:fn="http://www.w3.org/2005/02/xpath-functions">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta charset="utf-8">
<link rel="stylesheet" href="../otp_doc.css" type="text/css">
<meta name="major-vsn" content="24">
<title>Erlang -- Processes</title>
</head>
<body>
<div id="container">
<script id="js" type="text/javascript" language="JavaScript" src="../js/flipmenu/flipmenu.js"></script><script id="js2" type="text/javascript" src="../js/erlresolvelinks.js"></script><script id="js3" type="text/javascript" src="../js/topbar.js"></script><script language="JavaScript" type="text/javascript">
            <!--
              function setscrollpos() {
                var objf = document.getElementById('loadscrollpos');
                if (objf) {
                  document.getElementById("leftnav").firstChild.scrollTop = objf.offsetTop - 10;
                }
              }

              function addEvent(obj, evType, fn){
                if (obj.addEventListener){
                obj.addEventListener(evType, fn, true);
                return true;
              } else if (obj.attachEvent){
                var r = obj.attachEvent("on"+evType, fn);
                return r;
              } else {
                return false;
              }
             }

             addEvent(window, 'load', setscrollpos);

             //-->
</script><div class="topbar">
<div class="topbar-expand "><button onclick="toggleDisplay();"><svg xmlns="http://www.w3.org/2000/svg" version="1.1" id="Capa_1" viewBox="0 0 54 54" width="24" height="24"><g><path style="fill:#000000;" d="M27,54c-0.552,0-1-0.448-1-1V8c0-0.552,0.448-1,1-1s1,0.448,1,1v45C28,53.552,27.552,54,27,54z"></path><path style="fill:#000000;" d="M11,25c-0.256,0-0.512-0.098-0.707-0.293c-0.391-0.391-0.391-1.023,0-1.414l16-16                                      c0.391-0.391,1.023-0.391,1.414,0s0.391,1.023,0,1.414l-16,16C11.512,24.902,11.256,25,11,25z"></path><path style="fill:#000000;" d="M43,25c-0.256,0-0.512-0.098-0.707-0.293l-16-16c-0.391-0.391-0.391-1.023,0-1.414                                      s1.023-0.391,1.414,0l16,16c0.391,0.391,0.391,1.023,0,1.414C43.512,24.902,43.256,25,43,25z"></path><path style="fill:#000000;" d="M43,2H11c-0.552,0-1-0.448-1-1s0.448-1,1-1h32c0.552,0,1,0.448,1,1S43.552,2,43,2z"></path></g></svg></button></div>
<div class="topbar-title"><h1 id="Processes">9Â 
                Processes</h1></div>
<div class="search-expand ">        <button id="docsearch-mobile">
            <svg fill="#000000" xmlns="http://www.w3.org/2000/svg"  viewBox="0 0 50 50" width="24" height="24"><path d="M 21 3 C 11.621094 3 4 10.621094 4 20 C 4 29.378906 11.621094 37 21 37 C 24.710938 37 28.140625 35.804688 30.9375 33.78125 L 44.09375 46.90625 L 46.90625 44.09375 L 33.90625 31.0625 C 36.460938 28.085938 38 24.222656 38 20 C 38 10.621094 30.378906 3 21 3 Z M 21 5 C 29.296875 5 36 11.703125 36 20 C 36 28.296875 29.296875 35 21 35 C 12.703125 35 6 28.296875 6 20 C 6 11.703125 12.703125 5 21 5 Z"/></svg>
        </button>
</div>
</div>
<aside class="hide-mobile" id="leftnav"><nav class="leftnav-tube"><div class="erlang-logo-wrapper"><a href="../index.html"><img alt="Erlang Logo" src="../erlang-logo.png" class="erlang-logo"></a></div>
<p class="section-title">Efficiency Guide</p>
<p class="section-subtitle">User's Guide</p>
<p class="section-version">Version 12.3.2.17</p>
<ul class="panel-sections">
<li><a href="users_guide.html">User's Guide</a></li>
<li><a href="../pdf/otp-system-documentation.pdf">PDF</a></li>
<li><a href="../index.html">Top</a></li>
</ul>
<div id="docsearch"></div>
<div style="padding-left: 1rem; padding-top: 0.1rem;"><a href="/doc/search?v=24">Paginated Search</a></div>
<ul class="expand-collapse-items">
<li><a href="javascript:openAllFlips()">Expand All</a></li>
<li><a href="javascript:closeAllFlips()">Contract All</a></li>
</ul>
<h3 id="chapters">Chapters</h3>
<ul class="flipMenu" imagePath="../js/flipmenu">
<li id="no" title="Introduction" expanded="false">Introduction<ul>
<li><a href="introduction.html">
              Top of chapter
            </a></li>
<li title="Purpose"><a href="introduction.html#purpose">Purpose</a></li>
<li title="Prerequisites"><a href="introduction.html#prerequisites">Prerequisites</a></li>
</ul>
</li>
<li id="no" title="The Seven Myths of Erlang Performance" expanded="false">The Seven Myths of Erlang Performance<ul>
<li><a href="myths.html">
              Top of chapter
            </a></li>
<li title="Myth: Tail-Recursive Functions are Much Faster
    Than Recursive Functions"><a href="myths.html#myth--tail-recursive-functions-are-much-faster-----than-recursive-functions">Myth: Tail-Recursive Functions are Much Faster
    Than Recursive Functions</a></li>
<li title='Myth: Operator "++" is Always Bad'><a href="myths.html#myth--operator--++--is-always-bad">Myth: Operator "++" is Always Bad</a></li>
<li title="Myth: Strings are Slow"><a href="myths.html#myth--strings-are-slow">Myth: Strings are Slow</a></li>
<li title="Myth: Repairing a Dets File is Very Slow"><a href="myths.html#myth--repairing-a-dets-file-is-very-slow">Myth: Repairing a Dets File is Very Slow</a></li>
<li title="Myth: BEAM is a Stack-Based Byte-Code Virtual Machine
    (and Therefore Slow)"><a href="myths.html#myth--beam-is-a-stack-based-byte-code-virtual-machine------and-therefore-slow-">Myth: BEAM is a Stack-Based Byte-Code Virtual Machine
    (and Therefore Slow)</a></li>
<li title='Myth: Use "_" to Speed Up Your Program When a Variable
    is Not Used'><a href="myths.html#myth--use--_--to-speed-up-your-program-when-a-variable-----is-not-used">Myth: Use "_" to Speed Up Your Program When a Variable
    is Not Used</a></li>
<li title="Myth: A NIF Always Speeds Up Your Program"><a href="myths.html#myth--a-nif-always-speeds-up-your-program">Myth: A NIF Always Speeds Up Your Program</a></li>
</ul>
</li>
<li id="no" title="Common Caveats" expanded="false">Common Caveats<ul>
<li><a href="commoncaveats.html">
              Top of chapter
            </a></li>
<li title="Timer Module"><a href="commoncaveats.html#timer-module">Timer Module</a></li>
<li title="Accidental Copying and Loss of Sharing"><a href="commoncaveats.html#accidental-copying-and-loss-of-sharing">Accidental Copying and Loss of Sharing</a></li>
<li title="list_to_atom/1"><a href="commoncaveats.html#list_to_atom-1">list_to_atom/1</a></li>
<li title="length/1"><a href="commoncaveats.html#length-1">length/1</a></li>
<li title="setelement/3"><a href="commoncaveats.html#setelement-3">setelement/3</a></li>
<li title="size/1"><a href="commoncaveats.html#size-1">size/1</a></li>
<li title="split_binary/2"><a href="commoncaveats.html#split_binary-2">split_binary/2</a></li>
</ul>
</li>
<li id="no" title="Constructing and Matching Binaries" expanded="false">Constructing and Matching Binaries<ul>
<li><a href="binaryhandling.html">
              Top of chapter
            </a></li>
<li title="How Binaries are Implemented"><a href="binaryhandling.html#how-binaries-are-implemented">How Binaries are Implemented</a></li>
<li title="Constructing Binaries"><a href="binaryhandling.html#constructing-binaries">Constructing Binaries</a></li>
<li title="Matching Binaries"><a href="binaryhandling.html#matching-binaries">Matching Binaries</a></li>
<li title="Historical Note"><a href="binaryhandling.html#historical-note">Historical Note</a></li>
</ul>
</li>
<li id="no" title="Maps" expanded="false">Maps<ul>
<li><a href="maps.html">
              Top of chapter
            </a></li>
<li title="Maps or Records?"><a href="maps.html#maps-or-records-">Maps or Records?</a></li>
<li title="Using Maps as an Alternative to Records"><a href="maps.html#using-maps-as-an-alternative-to-records">Using Maps as an Alternative to Records</a></li>
<li title="Using Maps as Dictionaries"><a href="maps.html#using-maps-as-dictionaries">Using Maps as Dictionaries</a></li>
<li title="Using Maps as Sets"><a href="maps.html#using-maps-as-sets">Using Maps as Sets</a></li>
<li title="How Maps are Implemented"><a href="maps.html#how-maps-are-implemented">How Maps are Implemented</a></li>
<li title="Using the Map Syntax"><a href="maps.html#using-the-map-syntax">Using the Map Syntax</a></li>
<li title="Using the Functions in the maps Module"><a href="maps.html#using-the-functions-in-the-maps-module">Using the Functions in the maps Module</a></li>
</ul>
</li>
<li id="no" title="List Handling" expanded="false">List Handling<ul>
<li><a href="listHandling.html">
              Top of chapter
            </a></li>
<li title="Creating a List"><a href="listHandling.html#creating-a-list">Creating a List</a></li>
<li title="List Comprehensions"><a href="listHandling.html#list-comprehensions">List Comprehensions</a></li>
<li title="Deep and Flat Lists"><a href="listHandling.html#deep-and-flat-lists">Deep and Flat Lists</a></li>
<li title="Recursive List Functions"><a href="listHandling.html#recursive-list-functions">Recursive List Functions</a></li>
</ul>
</li>
<li id="no" title="Functions" expanded="false">Functions<ul>
<li><a href="functions.html">
              Top of chapter
            </a></li>
<li title="Pattern Matching"><a href="functions.html#pattern-matching">Pattern Matching</a></li>
<li title="Function Calls"><a href="functions.html#function-calls">Function Calls</a></li>
<li title="Memory Usage in Recursion"><a href="functions.html#memory-usage-in-recursion">Memory Usage in Recursion</a></li>
</ul>
</li>
<li id="no" title="Tables and Databases" expanded="false">Tables and Databases<ul>
<li><a href="tablesDatabases.html">
              Top of chapter
            </a></li>
<li title="Ets, Dets, and Mnesia"><a href="tablesDatabases.html#ets,-dets,-and-mnesia">Ets, Dets, and Mnesia</a></li>
<li title="Ets-Specific"><a href="tablesDatabases.html#ets-specific">Ets-Specific</a></li>
<li title="Mnesia-Specific"><a href="tablesDatabases.html#mnesia-specific">Mnesia-Specific</a></li>
</ul>
</li>
<li id="loadscrollpos" title="Processes" expanded="true">Processes<ul>
<li><a href="processes.html">
              Top of chapter
            </a></li>
<li title="Creating an Erlang Process"><a href="processes.html#creating-an-erlang-process">Creating an Erlang Process</a></li>
<li title="Sending Messages"><a href="processes.html#sending-messages">Sending Messages</a></li>
<li title="Receiving messages"><a href="processes.html#receiving-messages">Receiving messages</a></li>
<li title="Literal Pool"><a href="processes.html#literal-pool">Literal Pool</a></li>
<li title="Loss of Sharing"><a href="processes.html#loss-of-sharing">Loss of Sharing</a></li>
<li title="SMP Emulator"><a href="processes.html#smp-emulator">SMP Emulator</a></li>
</ul>
</li>
<li id="no" title="Drivers" expanded="false">Drivers<ul>
<li><a href="drivers.html">
              Top of chapter
            </a></li>
<li title="Drivers and Concurrency"><a href="drivers.html#drivers-and-concurrency">Drivers and Concurrency</a></li>
<li title="Avoiding Copying Binaries When Calling a Driver"><a href="drivers.html#avoiding-copying-binaries-when-calling-a-driver">Avoiding Copying Binaries When Calling a Driver</a></li>
<li title="Returning Small Binaries from a Driver"><a href="drivers.html#returning-small-binaries-from-a-driver">Returning Small Binaries from a Driver</a></li>
<li title="Returning Large Binaries without Copying from a Driver"><a href="drivers.html#returning-large-binaries-without-copying-from-a-driver">Returning Large Binaries without Copying from a Driver</a></li>
</ul>
</li>
<li id="no" title="Advanced" expanded="false">Advanced<ul>
<li><a href="advanced.html">
              Top of chapter
            </a></li>
<li title="Memory"><a href="advanced.html#memory">Memory</a></li>
<li title="System Limits"><a href="advanced.html#system-limits">System Limits</a></li>
</ul>
</li>
<li id="no" title="Profiling" expanded="false">Profiling<ul>
<li><a href="profiling.html">
              Top of chapter
            </a></li>
<li title="Do Not Guess About Performance - Profile"><a href="profiling.html#do-not-guess-about-performance---profile">Do Not Guess About Performance - Profile</a></li>
<li title="Memory profiling"><a href="profiling.html#memory-profiling">Memory profiling</a></li>
<li title="Large Systems"><a href="profiling.html#large-systems">Large Systems</a></li>
<li title="What to Look For"><a href="profiling.html#what-to-look-for">What to Look For</a></li>
<li title="Tools"><a href="profiling.html#tools">Tools</a></li>
<li title="Benchmarking"><a href="profiling.html#benchmarking">Benchmarking</a></li>
</ul>
</li>
<li id="no" title="Retired Myths" expanded="false">Retired Myths<ul>
<li><a href="retired_myths.html">
              Top of chapter
            </a></li>
<li title="Myth: Funs are Slow"><a href="retired_myths.html#myth--funs-are-slow">Myth: Funs are Slow</a></li>
<li title="Myth: List Comprehensions are Slow"><a href="retired_myths.html#myth--list-comprehensions-are-slow">Myth: List Comprehensions are Slow</a></li>
<li title='Myth: List subtraction ("--" operator) is slow'><a href="retired_myths.html#myth--list-subtraction-------operator--is-slow">Myth: List subtraction ("--" operator) is slow</a></li>
</ul>
</li>
</ul></nav></aside><div id="content">
<div class="innertube">
<h1 id="Processes">9Â Processes</h1>
  

  <h3 id="creating-an-erlang-process" class="title-link" onMouseOver="document.getElementById('ghlink-creating-an-erlang-process-idm1235').style.visibility = 'visible';" onMouseOut="document.getElementById('ghlink-creating-an-erlang-process-idm1235').style.visibility = 'hidden';">
<div class="title-name">9.1Â 
        Creating an Erlang Process</div>
<div class="title-anchors"><span id="ghlink-creating-an-erlang-process-idm1235" class="ghlink-after"><a href="#creating-an-erlang-process" title="Link to this place!"><span class="paperclip-after"></span></a><a href="https://github.com/erlang/otp/edit/maint/system/doc/efficiency_guide/processes.xmlsrc#L33" title="Found an issue with the documentation? Fix it by clicking here!"><span class="pencil-after"></span></a></span></div>
</h3>
    

    <p>An Erlang process is lightweight compared to threads and
    processes in operating systems.</p>

    <p>A newly spawned Erlang process uses 326 words of memory. The size can
    be found as follows:</p>

    <div class="example"><pre>
Erlang/OTP 24 [erts-12.0] [64-bit] [smp:8:8] [ds:8:8:10] [async-threads:1] [jit]

Eshell V5.6  (abort with ^G)
1&gt; <span class="bold_code bc-12">Fun = fun() -&gt; receive after infinity -&gt; ok end end.</span>
#Fun&lt;...&gt;
2&gt; <span class="bold_code bc-12">{_,Bytes} = process_info(spawn(Fun), memory).</span>
{memory,1232}
3&gt; <span class="bold_code bc-12">Bytes div erlang:system_info(wordsize).</span>
309</pre></div>

    <p>The size includes 233 words for the heap area (which includes the
    stack). The garbage collector increases the heap as needed.</p>

    <p>The main (outer) loop for a process <strong>must</strong> be tail-recursive.
    Otherwise, the stack grows until the process terminates.</p>

    <p><strong>DO NOT</strong></p>
    <div class="example example-erl"><pre>loop() -&gt;
  receive
     {sys, Msg} -&gt;
         handle_sys_msg(Msg),
         loop();
     {From, Msg} -&gt;
          Reply = handle_msg(Msg),
          From ! Reply,
          loop()
  end,
  io:format("Message is processed~n", []).</pre></div>

    <p>The call to <span class="code">io:format/2</span> will never be executed, but a
    return address will still be pushed to the stack each time
    <span class="code">loop/0</span> is called recursively. The correct tail-recursive
    version of the function looks as follows:</p>

    <p><strong>DO</strong></p>
<div class="example example-erl"><pre>   loop() -&gt;
      receive
         {sys, Msg} -&gt;
            handle_sys_msg(Msg),
            loop();
         {From, Msg} -&gt;
            Reply = handle_msg(Msg),
            From ! Reply,
            loop()
    end.</pre></div>

    <h4 id="initial-heap-size" class="title-link" onMouseOver="document.getElementById('ghlink-initial-heap-size-idm1255').style.visibility = 'visible';" onMouseOut="document.getElementById('ghlink-initial-heap-size-idm1255').style.visibility = 'hidden';">
<div class="title-name">Initial Heap Size</div>
<div class="title-anchors"><span id="ghlink-initial-heap-size-idm1255" class="ghlink-after"><a href="#initial-heap-size" title="Link to this place!"><span class="paperclip-after"></span></a><a href="https://github.com/erlang/otp/edit/maint/system/doc/efficiency_guide/processes.xmlsrc#L91" title="Found an issue with the documentation? Fix it by clicking here!"><span class="pencil-after"></span></a></span></div>
</h4>
      

      <p>The default initial heap size of 233 words is quite conservative
      to support Erlang systems with hundreds of thousands or
      even millions of processes. The garbage collector grows and
      shrinks the heap as needed.</p>

      <p>In a system that use comparatively few processes, performance
      <strong>might</strong> be improved by increasing the minimum heap size
      using either the <span class="code">+h</span> option for
      <span class="bold_code bc-18"><a href="../man/erl.html">erl</a></span> or on a process-per-process
      basis using the <span class="code">min_heap_size</span> option for
      <span class="bold_code bc-13"><a href="../man/erlang.html#spawn_opt-4">spawn_opt/4</a></span>.</p>

      <p>The gain is twofold:</p>
      <ul>
	<li>Although the garbage collector grows the heap, it grows it
	step-by-step, which is more costly than directly establishing a
	larger heap when the process is spawned.</li>
	<li>The garbage collector can also shrink the heap if it is
	much larger than the amount of data stored on it;
	setting the minimum heap size prevents that.</li>
      </ul>

      <div class="warning">
<div class="label">Warning</div>
<div class="content"><p><p>The emulator probably uses more memory, and because garbage
      collections occur less frequently, huge binaries can be
      kept much longer.</p></p></div>
</div>

      <p>In systems with many processes, computation tasks that run
      for a short time can be spawned off into a new process with
      a higher minimum heap size. When the process is done, it sends
      the result of the computation to another process and terminates.
      If the minimum heap size is calculated properly, the process might
      not have to do any garbage collections at all.
      <strong>This optimization is not to be attempted
      without proper measurements.</strong></p>
    
  

  <h3 id="sending-messages" class="title-link" onMouseOver="document.getElementById('ghlink-sending-messages-idm1272').style.visibility = 'visible';" onMouseOut="document.getElementById('ghlink-sending-messages-idm1272').style.visibility = 'hidden';">
<div class="title-name">9.2Â 
        Sending Messages</div>
<div class="title-anchors"><span id="ghlink-sending-messages-idm1272" class="ghlink-after"><a href="#sending-messages" title="Link to this place!"><span class="paperclip-after"></span></a><a href="https://github.com/erlang/otp/edit/maint/system/doc/efficiency_guide/processes.xmlsrc#L131" title="Found an issue with the documentation? Fix it by clicking here!"><span class="pencil-after"></span></a></span></div>
</h3>
    

    <p>All data in messages sent between Erlang processes is copied,
    except for <span class="bold_code bc-15"><a href="binaryhandling.html#refc_binary">refc
    binaries</a></span> and <span class="bold_code bc-17"><a href="#literal-pool">literals</a></span> on the same Erlang
    node.</p>

    <p>When a message is sent to a process on another Erlang node,
    it is first encoded to the Erlang External Format before
    being sent through a TCP/IP socket. The receiving Erlang node decodes
    the message and distributes it to the correct process.</p>
  

  <a name="receiving-messages"></a><h3 id="receiving-messages" class="title-link" onMouseOver="document.getElementById('ghlink-receiving-messages-idm1278').style.visibility = 'visible';" onMouseOut="document.getElementById('ghlink-receiving-messages-idm1278').style.visibility = 'hidden';">
<div class="title-name">9.3Â 
        Receiving messages</div>
<div class="title-anchors"><span id="ghlink-receiving-messages-idm1278" class="ghlink-after"><a href="#receiving-messages" title="Link to this place!"><span class="paperclip-after"></span></a><a href="https://github.com/erlang/otp/edit/maint/system/doc/efficiency_guide/processes.xmlsrc#L146" title="Found an issue with the documentation? Fix it by clicking here!"><span class="pencil-after"></span></a></span></div>
</h3>
    
    

    <p>The cost of receiving messages depends on how complicated the
    <span class="code">receive</span> expression is. A simple expression that matches any
    message is very cheap because it retrieves the first message in the
    message queue:</p>

    <p><strong>DO</strong></p>
    <div class="example example-erl"><pre>receive
    Message -&gt; handle_msg(Message)
end.</pre></div>

    <p>However, this is not always convenient: we can receive a message that
    we do not know how to handle at this point, so it is common to
    only match the messages we expect:</p>

    <div class="example example-erl"><pre>receive
    {Tag, Message} -&gt; handle_msg(Message)
end.</pre></div>

    <p>While this is convenient it means that the entire message queue must
    be searched until it finds a matching message. This is very expensive
    for processes with long message queues, so we have added an
    optimization for the common case of sending a request and waiting for a
    response shortly after:</p>

    <p><strong>DO</strong></p>
    <div class="example example-erl"><pre>MRef = monitor(process, Process),
Process ! {self(), MRef, Request},
receive
    {MRef, Reply} -&gt;
        erlang:demonitor(MRef, [flush]),
        handle_reply(Reply);
    {'DOWN', MRef, _, _, Reason} -&gt;
        handle_error(Reason)
end.</pre></div>

    <p>Since the compiler knows that the reference created by <span class="code">monitor/2</span>
    cannot exist before the call (since it is a globally unique identifier),
    and that the <span class="code">receive</span> only matches messages that contain said
    reference, it will tell the emulator to search only the messages that
    arrived after the call to <span class="code">monitor/2</span>.</p>

    <p>The above is a simple example where one is but guaranteed that the
    optimization will take, but what about more complicated code?</p>

    <a name="recv_opt_info"></a><h4 id="option-recv_opt_info" class="title-link" onMouseOver="document.getElementById('ghlink-option-recv_opt_info-idm1297').style.visibility = 'visible';" onMouseOut="document.getElementById('ghlink-option-recv_opt_info-idm1297').style.visibility = 'hidden';">
<div class="title-name">Option recv_opt_info</div>
<div class="title-anchors"><span id="ghlink-option-recv_opt_info-idm1297" class="ghlink-after"><a href="#option-recv_opt_info" title="Link to this place!"><span class="paperclip-after"></span></a><a href="https://github.com/erlang/otp/edit/maint/system/doc/efficiency_guide/processes.xmlsrc#L197" title="Found an issue with the documentation? Fix it by clicking here!"><span class="pencil-after"></span></a></span></div>
</h4>
      
      

      <p>Use the <span class="code">recv_opt_info</span> option to have the compiler print
      information about receive optimizations. It can be given either to
      the compiler or <span class="code">erlc</span>:</p>

      <div class="example example-erl"><pre>erlc +recv_opt_info Mod.erl</pre></div>

      <p>or passed through an environment variable:</p>

      <div class="example example-erl"><pre>export ERL_COMPILER_OPTIONS=recv_opt_info</pre></div>

      <p>Notice that <span class="code">recv_opt_info</span> is not meant to be a permanent
      option added to your <span class="code">Makefile</span>s, because all messages that it
      generates cannot be eliminated. Therefore, passing the option through
      the environment is in most cases the most practical approach.</p>

      <p>The warnings look as follows:</p>

      <div class="example example-erl"><pre>efficiency_guide.erl:194: Warning: INFO: receive matches any message, this is always fast
efficiency_guide.erl:200: Warning: NOT OPTIMIZED: all clauses do not match a suitable reference
efficiency_guide.erl:206: Warning: OPTIMIZED: reference used to mark a message queue position
efficiency_guide.erl:208: Warning: OPTIMIZED: all clauses match reference created by monitor/2 at efficiency_guide.erl:206
efficiency_guide.erl:219: Warning: INFO: passing reference created by make_ref/0 at efficiency_guide.erl:218
efficiency_guide.erl:222: Warning: OPTIMIZED: all clauses match reference in function parameter 1</pre></div>

      <p>To make it clearer exactly what code the warnings refer to, the
      warnings in the following examples are inserted as comments
      after the clause they refer to, for example:</p>

      <div class="example example-erl"><pre>%% DO
simple_receive() -&gt;
%% efficiency_guide.erl:194: Warning: INFO: not a selective receive, this is always fast
receive
    Message -&gt; handle_msg(Message)
end.

%% DO NOT, unless Tag is known to be a suitable reference: see
%% cross_function_receive/0 further down.
selective_receive(Tag, Message) -&gt;
%% efficiency_guide.erl:200: Warning: NOT OPTIMIZED: all clauses do not match a suitable reference
receive
    {Tag, Message} -&gt; handle_msg(Message)
end.

%% DO
optimized_receive(Process, Request) -&gt;
%% efficiency_guide.erl:206: Warning: OPTIMIZED: reference used to mark a message queue position
    MRef = monitor(process, Process),
    Process ! {self(), MRef, Request},
    %% efficiency_guide.erl:208: Warning: OPTIMIZED: matches reference created by monitor/2 at efficiency_guide.erl:206
    receive
        {MRef, Reply} -&gt;
        erlang:demonitor(MRef, [flush]),
        handle_reply(Reply);
    {'DOWN', MRef, _, _, Reason} -&gt;
    handle_error(Reason)
    end.

%% DO
cross_function_receive() -&gt;
    %% efficiency_guide.erl:218: Warning: OPTIMIZED: reference used to mark a message queue position
    Ref = make_ref(),
    %% efficiency_guide.erl:219: Warning: INFO: passing reference created by make_ref/0 at efficiency_guide.erl:218
    cross_function_receive(Ref).

cross_function_receive(Ref) -&gt;
    %% efficiency_guide.erl:222: Warning: OPTIMIZED: all clauses match reference in function parameter 1
    receive
        {Ref, Message} -&gt; handle_msg(Message)
    end.</pre></div>
    
  

  <a name="literal-pool"></a><h3 id="literal-pool" class="title-link" onMouseOver="document.getElementById('ghlink-literal-pool-idm1313').style.visibility = 'visible';" onMouseOut="document.getElementById('ghlink-literal-pool-idm1313').style.visibility = 'hidden';">
<div class="title-name">9.4Â 
        Literal Pool</div>
<div class="title-anchors"><span id="ghlink-literal-pool-idm1313" class="ghlink-after"><a href="#literal-pool" title="Link to this place!"><span class="paperclip-after"></span></a><a href="https://github.com/erlang/otp/edit/maint/system/doc/efficiency_guide/processes.xmlsrc#L277" title="Found an issue with the documentation? Fix it by clicking here!"><span class="pencil-after"></span></a></span></div>
</h3>
    
    

    <p>Constant Erlang terms (hereafter called <strong>literals</strong>) are
    kept in <strong>literal pools</strong>; each loaded module has its own pool.
    The following function does not build the tuple every time
    it is called (only to have it discarded the next time the garbage
    collector was run), but the tuple is located in the module's
    literal pool:</p>

    <p><strong>DO</strong></p>
    <div class="example example-erl"><pre>days_in_month(M) -&gt;
    element(M, {31,28,31,30,31,30,31,31,30,31,30,31}).</pre></div>

    <p>If a literal, or a term that contains a literal, is inserted
    into an Ets table, it is <strong>copied</strong>. The reason is that the
    module containing the literal can be unloaded in the future.</p>

    <p>When a literal is sent to another process, it is <strong>not</strong>
    copied. When a module holding a literal is unloaded, the literal
    will be copied to the heap of all processes that hold references
    to that literal.</p>

    <p>There also exists a global literal pool that is managed by the
    <span class="bold_code bc-18"><a href="../man/persistent_term.html">persistent_term</a></span>
    module.</p>

    <p>By default, 1 GB of virtual address space is reserved for all
    literal pools (in BEAM code and persistent terms). The amount of
    virtual address space reserved for literals can be changed by
    using the <span class="bold_code bc-13"><a href="../man/erts_alloc.html#MIscs"><span class="code">+MIscs
    option</span></a></span> when starting the emulator.</p>

    <p>Here is an example how the reserved virtual address space for
    literals can be raised to 2 GB (2048 MB):</p>

    <div class="example"><pre>
    erl +MIscs 2048</pre></div>
  

  <a name="loss-of-sharing"></a><h3 id="loss-of-sharing" class="title-link" onMouseOver="document.getElementById('ghlink-loss-of-sharing-idm1333').style.visibility = 'visible';" onMouseOut="document.getElementById('ghlink-loss-of-sharing-idm1333').style.visibility = 'hidden';">
<div class="title-name">9.5Â 
        Loss of Sharing</div>
<div class="title-anchors"><span id="ghlink-loss-of-sharing-idm1333" class="ghlink-after"><a href="#loss-of-sharing" title="Link to this place!"><span class="paperclip-after"></span></a><a href="https://github.com/erlang/otp/edit/maint/system/doc/efficiency_guide/processes.xmlsrc#L319" title="Found an issue with the documentation? Fix it by clicking here!"><span class="pencil-after"></span></a></span></div>
</h3>
    
    

    <p>An Erlang term can have shared subterms. Here is a simple
    example:</p>

    <div class="example example-erl"><pre>{SubTerm, SubTerm}</pre></div>

    <p>Shared subterms are <strong>not</strong> preserved in the following
    cases:</p>
    <ul>
      <li>When a term is sent to another process</li>
      <li>When a term is passed as the initial process arguments in
      the <span class="code">spawn</span> call</li>
      <li>When a term is stored in an Ets table</li>
    </ul>
    <p>That is an optimization. Most applications do not send messages
    with shared subterms.</p>

    <p>The following example shows how a shared subterm can be created:</p>

<div class="example example-erl"><pre>kilo_byte() -&gt;
    kilo_byte(10, [42]).

kilo_byte(0, Acc) -&gt;
    Acc;
kilo_byte(N, Acc) -&gt;
    kilo_byte(N-1, [Acc|Acc]).</pre></div>

    <p><span class="code">kilo_byte/1</span> creates a deep list.
    If <span class="code">list_to_binary/1</span> is called, the deep list can be
    converted to a binary of 1024 bytes:</p>

    <div class="example"><pre>
1&gt; <span class="bold_code bc-12">byte_size(list_to_binary(efficiency_guide:kilo_byte())).</span>
1024</pre></div>

    <p>Using the <span class="code">erts_debug:size/1</span> BIF, it can be seen that the
    deep list only requires 22 words of heap space:</p>

    <div class="example"><pre>
2&gt; <span class="bold_code bc-12">erts_debug:size(efficiency_guide:kilo_byte()).</span>
22</pre></div>

    <p>Using the <span class="code">erts_debug:flat_size/1</span> BIF, the size of the
    deep list can be calculated if sharing is ignored. It becomes
    the size of the list when it has been sent to another process
    or stored in an Ets table:</p>

    <div class="example"><pre>
3&gt; <span class="bold_code bc-12">erts_debug:flat_size(efficiency_guide:kilo_byte()).</span>
4094</pre></div>

    <p>It can be verified that sharing will be lost if the data is
    inserted into an Ets table:</p>

    <div class="example"><pre>
4&gt; <span class="bold_code bc-12">T = ets:new(tab, []).</span>
#Ref&lt;0.1662103692.2407923716.214181&gt;
5&gt; <span class="bold_code bc-12">ets:insert(T, {key,efficiency_guide:kilo_byte()}).</span>
true
6&gt; <span class="bold_code bc-12">erts_debug:size(element(2, hd(ets:lookup(T, key)))).</span>
4094
7&gt; <span class="bold_code bc-12">erts_debug:flat_size(element(2, hd(ets:lookup(T, key)))).</span>
4094</pre></div>

    <p>When the data has passed through an Ets table,
    <span class="code">erts_debug:size/1</span> and <span class="code">erts_debug:flat_size/1</span>
    return the same value. Sharing has been lost.</p>

    <p>It is possible to build an <strong>experimental</strong> variant of the
    runtime system that will preserve sharing when copying terms by
    giving the <span class="code">--enable-sharing-preserving</span> option to the
    <span class="code">configure</span> script.</p>
  

  <h3 id="smp-emulator" class="title-link" onMouseOver="document.getElementById('ghlink-smp-emulator-idm1374').style.visibility = 'visible';" onMouseOut="document.getElementById('ghlink-smp-emulator-idm1374').style.visibility = 'hidden';">
<div class="title-name">9.6Â 
        SMP Emulator</div>
<div class="title-anchors"><span id="ghlink-smp-emulator-idm1374" class="ghlink-after"><a href="#smp-emulator" title="Link to this place!"><span class="paperclip-after"></span></a><a href="https://github.com/erlang/otp/edit/maint/system/doc/efficiency_guide/processes.xmlsrc#L391" title="Found an issue with the documentation? Fix it by clicking here!"><span class="pencil-after"></span></a></span></div>
</h3>
    

    <p>The emulator takes advantage of a multi-core or multi-CPU
    computer by running several Erlang scheduler
    threads (typically, the same as the number of cores).</p>

    <p>To gain performance from a multi-core computer, your application
    <strong>must have more than one runnable Erlang process</strong> most of the time.
    Otherwise, the Erlang emulator can still only run one Erlang process
    at the time.</p>

    <p>Benchmarks that appear to be concurrent are often sequential.
    The estone benchmark, for example, is entirely sequential. So is
    the most common implementation of the "ring benchmark"; usually one process
    is active, while the others wait in a <span class="code">receive</span> statement.</p>
  
</div>
<div class="footer">
<hr>
<p>Copyright Â© 2001-2024 Ericsson AB. All Rights Reserved.</p>
</div>
</div>
</div>
<script type="text/javascript">window.__otpTopDocDir = '../js/';</script><script type="text/javascript" src="../js/highlight.js"></script>
<script type="text/javascript">
_docsearch_version = "24";
</script> 
<script src="/assets/js/doc-search.bundle.js"></script>
</body>
</html>
