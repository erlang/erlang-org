<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html xmlns:erl="http://erlang.org" xmlns:fn="http://www.w3.org/2005/02/xpath-functions">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta charset="utf-8">
<link rel="stylesheet" href="../../otp_doc.css" type="text/css">
<meta name="major-vsn" content="26">
<title>Erlang -- Invariants on the Structure and Format of BEAM SSA</title>
</head>
<body>
<div id="container">
<script id="js" type="text/javascript" language="JavaScript" src="../../js/flipmenu/flipmenu.js"></script><script id="js2" type="text/javascript" src="../../js/erlresolvelinks.js"></script><script id="js3" type="text/javascript" src="../../../../doc/js/topbar.js"></script><script language="JavaScript" type="text/javascript">
            <!--
              function setscrollpos() {
                var objf = document.getElementById('loadscrollpos');
                if (objf) {
                  document.getElementById("leftnav").firstChild.scrollTop = objf.offsetTop - 10;
                }
              }

              function addEvent(obj, evType, fn){
                if (obj.addEventListener){
                obj.addEventListener(evType, fn, true);
                return true;
              } else if (obj.attachEvent){
                var r = obj.attachEvent("on"+evType, fn);
                return r;
              } else {
                return false;
              }
             }

             addEvent(window, 'load', setscrollpos);

             //-->
</script><div class="topbar">
<div class="topbar-expand "><button onclick="toggleDisplay();"><svg xmlns="http://www.w3.org/2000/svg" version="1.1" id="Capa_1" viewBox="0 0 54 54" width="24" height="24"><g><path style="fill:#000000;" d="M27,54c-0.552,0-1-0.448-1-1V8c0-0.552,0.448-1,1-1s1,0.448,1,1v45C28,53.552,27.552,54,27,54z"></path><path style="fill:#000000;" d="M11,25c-0.256,0-0.512-0.098-0.707-0.293c-0.391-0.391-0.391-1.023,0-1.414l16-16                                      c0.391-0.391,1.023-0.391,1.414,0s0.391,1.023,0,1.414l-16,16C11.512,24.902,11.256,25,11,25z"></path><path style="fill:#000000;" d="M43,25c-0.256,0-0.512-0.098-0.707-0.293l-16-16c-0.391-0.391-0.391-1.023,0-1.414                                      s1.023-0.391,1.414,0l16,16c0.391,0.391,0.391,1.023,0,1.414C43.512,24.902,43.256,25,43,25z"></path><path style="fill:#000000;" d="M43,2H11c-0.552,0-1-0.448-1-1s0.448-1,1-1h32c0.552,0,1,0.448,1,1S43.552,2,43,2z"></path></g></svg></button></div>
<div class="topbar-title"><h1 id="Invariants on the Structure and Format of BEAM SSA">1 
                Invariants on the Structure and Format of BEAM SSA</h1></div>
<div class="search-expand ">        <button id="docsearch-mobile">
            <svg fill="#000000" xmlns="http://www.w3.org/2000/svg"  viewBox="0 0 50 50" width="24" height="24"><path d="M 21 3 C 11.621094 3 4 10.621094 4 20 C 4 29.378906 11.621094 37 21 37 C 24.710938 37 28.140625 35.804688 30.9375 33.78125 L 44.09375 46.90625 L 46.90625 44.09375 L 33.90625 31.0625 C 36.460938 28.085938 38 24.222656 38 20 C 38 10.621094 30.378906 3 21 3 Z M 21 5 C 29.296875 5 36 11.703125 36 20 C 36 28.296875 29.296875 35 21 35 C 12.703125 35 6 28.296875 6 20 C 6 11.703125 12.703125 5 21 5 Z"/></svg>
        </button>
</div>
</div>
<aside class="hide-mobile" id="leftnav"><nav class="leftnav-tube"><div class="erlang-logo-wrapper"><a href="../../index.html"><img alt="Erlang Logo" src="../../erlang-logo.png" class="erlang-logo"></a></div>
<p class="section-title">Compiler</p>
<p class="section-subtitle">Internal Documentation</p>
<p class="section-version">Version 8.4.3.3</p>
<ul class="panel-sections">
<li><a href="index.html">Reference Manual</a></li>
<li><a href="internal_docs.html">Internal Documentation</a></li>
<li><a href="notes.html">Release Notes</a></li>
<li><a href="compiler.pdf">PDF</a></li>
<li><a href="../../index.html">Top</a></li>
</ul>
<div id="docsearch"></div>
<div style="padding-left: 1rem; padding-top: 0.1rem;"><a href="/doc/search?v=26">Paginated Search</a></div>
<ul class="expand-collapse-items">
<li><a href="javascript:openAllFlips()">Expand All</a></li>
<li><a href="javascript:closeAllFlips()">Contract All</a></li>
</ul>
<h3 id="chapters">Chapters</h3>
<ul class="flipMenu" imagePath="../../js/flipmenu">
<li id="loadscrollpos" title="Invariants on the Structure and Format of BEAM SSA" expanded="true">Invariants on the Structure and Format of BEAM SSA<ul>
<li><a href="beam_ssa.html">
              Top of chapter
            </a></li>
<li title="Exception Handling"><a href="beam_ssa.html#exception-handling">Exception Handling</a></li>
<li title="Exception Re-issuing"><a href="beam_ssa.html#exception-re-issuing">Exception Re-issuing</a></li>
<li title="Function Calls"><a href="beam_ssa.html#function-calls">Function Calls</a></li>
<li title="Variable Naming"><a href="beam_ssa.html#variable-naming">Variable Naming</a></li>
</ul>
</li>
<li id="no" title="BEAM SSA Checks" expanded="false">BEAM SSA Checks<ul>
<li><a href="ssa_checks.html">
              Top of chapter
            </a></li>
<li title="Syntax"><a href="ssa_checks.html#syntax">Syntax</a></li>
<li title="Semantics"><a href="ssa_checks.html#semantics">Semantics</a></li>
<li title="Compiler integration"><a href="ssa_checks.html#compiler-integration">Compiler integration</a></li>
<li title="Limitations"><a href="ssa_checks.html#limitations">Limitations</a></li>
</ul>
</li>
</ul></nav></aside><div id="content">
<div class="innertube">
<h1 id="Invariants on the Structure and Format of BEAM SSA">1 Invariants on the Structure and Format of BEAM SSA</h1>


<a name="Exception-Handling"></a><h3 id="exception-handling" class="title-link" onMouseOver="document.getElementById('ghlink-exception-handling-id312').style.visibility = 'visible';" onMouseOut="document.getElementById('ghlink-exception-handling-id312').style.visibility = 'hidden';">
<div class="title-name">1.1 
        Exception Handling</div>
<div class="title-anchors"><span id="ghlink-exception-handling-id312" class="ghlink-after"><a href="#exception-handling" title="Link to this place!"><span class="paperclip-after"></span></a></span></div>
</h3>



<p>
The translation of a <span class="code">try</span>-<span class="code">catch</span> expression into BEAM SSA has the
following structure:
</p>

<div class="example example-none"><pre>@tag = new_try_tag `try`
br @tag, ^protected_block0, ^landing_pad_block

protected_block0:
  @success0 = ... % Something that could raise an exception
  br @success0, ^protected_block1, ^landing_pad_block

...

protected_blockN:
  % The end of the protected code
  @ignored0 = kill_try_tag @tag
  br ^after_try_catch

landing_pad_block:
  @aggregate = landingpad try, @tag
  @class  = extract @aggregate, `0` % The error class
  @reason = extract @aggregate, `1` % The reason
  @stk    = extract @aggregate, `2` % The stack trace
  @ignored1 = kill_try_tag @tag
  %% Pattern matching on @class, @reason, and @stk is done here
  %% to send control to the appropriate catch clause
  br ^after_try_catch

after_try_catch:
  % Normal execution continues</pre></div>
<p>
The following invariants must hold for the SSA:
</p>

<ul>
<li>
All code that can cause an exception in one of the protected blocks
must have explicit control flow edges to the landing pad block. If
there are no edges to the landing pad block except from the block
containing the <span class="code">new_try_tag</span>, the compiler will remove the
redundant exception handler.

</li>
<li>
The extraction of the class, reason and stack trace from the result
of the <span class="code">landingpad</span> instruction must be done in that
order. Omitting the extraction of elements which are unused is
allowed.

</li>
<li>
Both the landing pad block and the final protected block must end
with a <span class="code">kill_try_tag</span> instruction. Trying to share the
<span class="code">kill_try_tag</span> epilogue between the last protected block and the
landing pad is unlikely to work.

</li>
</ul>
<p>
The translation of an old-style <span class="code">catch</span> expression into BEAM SSA has
the following structure:
</p>

<div class="example example-none"><pre>@tag = new_try_tag `try`
br @tag, ^protected_block0, ^landing_pad_block

protected_block0:
  @success0 = ... % Something that could raise an exception
  br @success0, ^protected_block1, ^landing_pad_block

...

protected_blockN:
  % The end of the protected code
  @successful_result = .... % The result of a successful computation
  br ^common_end_of_catch

landing_pad_block:
   @aggregate = landingpad catch, @tag
   @catched_val = extract @ssa_agg, `0`
   br ^common_end_of_catch

common_end_of_catch:
  @tmp = phi { @catched_val, ^landing_pad_block },
             { @successful_result, ^protected_blockN }
  @result_of_catch_expr = catch_end @tag, @tmp</pre></div>
<p>
Just as for a <span class="code">try</span>-<span class="code">catch</span> expression all code that can cause an
exception in one of the protected blocks must have explicit control
flow edges to the landing pad block.
</p>



<a name="Exception-Reissuing"></a><h3 id="exception-re-issuing" class="title-link" onMouseOver="document.getElementById('ghlink-exception-re-issuing-id313').style.visibility = 'visible';" onMouseOut="document.getElementById('ghlink-exception-re-issuing-id313').style.visibility = 'hidden';">
<div class="title-name">1.2 
        Exception Re-issuing</div>
<div class="title-anchors"><span id="ghlink-exception-re-issuing-id313" class="ghlink-after"><a href="#exception-re-issuing" title="Link to this place!"><span class="paperclip-after"></span></a></span></div>
</h3>



<p>
A typical user-written <span class="code">try</span>-<span class="code">catch</span> expression will catch a subset of
all possible exception classes and reasons and leave unhandled
exceptions to a handler further up the call stack. Re-issuing an
exception is done with the <span class="code">resume</span> instruction. The <span class="code">resume</span> must
come after the <span class="code">kill_try_tag</span> instruction in the program flow. For
example, if the <span class="bold_code bc-17"><a href="#Exception-Handling">example in the Exception Handling Section</a></span>
was to only handle user <span class="code">throws</span>, the relevant blocks would look like this:
</p>

<div class="example example-none"><pre>landing_pad_block:
  @aggregate = landingpad `try`, @tag
  @class  = extract @aggregate, `0` % The error class
  @reason = extract @aggregate, `1` % The reason
  @stk    = extract @aggregate, `2` % The stack trace
  @ignored1 = kill_try_tag @tag
  @is_throw = bif:'=:=' @class, `throw`
  br @is_throw ^first_block_of_throw_handler, ^reissue

first_block_of_throw_handler:
  %% Handle the user-defined throw

reissue:
  @tmp = resume @stk, @reason
  ret @tmp</pre></div>


<a name="Function-Calls"></a><h3 id="function-calls" class="title-link" onMouseOver="document.getElementById('ghlink-function-calls-id314').style.visibility = 'visible';" onMouseOut="document.getElementById('ghlink-function-calls-id314').style.visibility = 'hidden';">
<div class="title-name">1.3 
        Function Calls</div>
<div class="title-anchors"><span id="ghlink-function-calls-id314" class="ghlink-after"><a href="#function-calls" title="Link to this place!"><span class="paperclip-after"></span></a></span></div>
</h3>



<p>
All function calls not in a tail call position must be followed by a
succeeded:body-instruction unless one of the following exceptions
apply:
</p>

<ul>
<li>
<p>The function call can statically be proven to always fail.
</p>

</li>
<li>
<p>The function call is to the <span class="code">erlang</span>-module and can statically be
proven to always succeed or fail.
</p>
</li>
</ul>


<a name="Variable-Naming"></a><h3 id="variable-naming" class="title-link" onMouseOver="document.getElementById('ghlink-variable-naming-id315').style.visibility = 'visible';" onMouseOut="document.getElementById('ghlink-variable-naming-id315').style.visibility = 'hidden';">
<div class="title-name">1.4 
        Variable Naming</div>
<div class="title-anchors"><span id="ghlink-variable-naming-id315" class="ghlink-after"><a href="#variable-naming" title="Link to this place!"><span class="paperclip-after"></span></a></span></div>
</h3>



<p>
A variable name in BEAM SSA is either an atom, a non-negative integer
or a tuple: <span class="code">atom() | non_neg_integer() | {atom() | non_neg_integer(),
non_neg_integer()}</span>. In order to generate fresh unused variable names,
all compiler transforms maintain a counter, the <span class="code">cnt</span>-field in the
<span class="code">opt_st</span>-record, which is incremented each time a new variable or
label is created. In the following description the value of the
<span class="code">cnt</span>-field is called <span class="code">Cnt</span>.
</p>

<p>
Due to peculiarities in the BEAM SSA code generator, a compiler
transformation unfortunately cannot just use the <span class="code">cnt</span>-value directly
as a fresh name. There are three basic strategies for creating fresh
variable names which can by used by a compiler pass:
</p>

<p>
1) A name can be derived from an existing name of the form <span class="code">V ::
  atom() | non_neg_integer()</span> by selecting an atom, which is unique to
  the compiler pass, to form a new name <span class="code">{A, V}</span>. The same <span class="code">A</span> cannot
  be used by strategy 3) below.
</p>

<p>
2) A name can be derived from an existing name of the form <span class="code">V ::
  non_neg_integer()</span> by combining it with the <span class="code">cnt</span>-field into <span class="code">{V,
  Cnt}</span>.
</p>

<p>
3) A fresh name can be created by selecting an atom <span class="code">A</span>, which is
  unique to the compiler pass, to form the new name <span class="code">{A, Cnt}</span>. The
  same <span class="code">A</span> cannot be used by strategy 1) above.
</p>


</div>
<div class="footer">
<hr>
<p>Copyright © 1997-2025 Ericsson AB. All Rights Reserved.</p>
</div>
</div>
</div>
<script type="text/javascript">window.__otpTopDocDir = '../../js/';</script><script type="text/javascript" src="../../js/highlight.js"></script>
<script type="text/javascript">
_docsearch_version = "26";
</script> 
<script src="/assets/js/doc-search.bundle.js"></script>
</body>
</html>
