<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="ExDoc v0.37.3">
    <meta name="project" content="erts v15.2.7">


<meta name="exdoc:full-text-search-url" content="/doc/search.html?v=27&q=">
<meta name="major-vsn" content="27">
<link rel="canonical" href="https://www.erlang.org/docs/27/apps/erts/alt_dist.html" />
    <title>How to Implement an Alternative Carrier for the Erlang Distribution — erts v15.2.7</title>

    <link rel="stylesheet" href="dist/html-erlang-FDBURIED.css" />

    <script defer src="dist/sidebar_items-EAF8F760.js"></script>
    <script defer src="docs_config.js"></script>
    <script defer src="dist/html-ALU6OERS.js"></script>

  </head>
  <body>
    <script>(()=>{var t="ex_doc:settings",e="dark";var o="dark",s="light";var E="sidebar_state",n="closed";var r="sidebar_width";var a="sidebar-open";var i=new URLSearchParams(window.location.search),S=i.get("theme")||JSON.parse(localStorage.getItem(t)||"{}").theme;(S===o||S!==s&&window.matchMedia("(prefers-color-scheme: dark)").matches)&&document.body.classList.add(e);var d=sessionStorage.getItem(E),A=d!==n&&!window.matchMedia(`screen and (max-width: ${768}px)`).matches;document.body.classList.toggle(a,A);var c=sessionStorage.getItem(r);c&&document.body.style.setProperty("--sidebarWidth",`${c}px`);var p=/(Macintosh|iPhone|iPad|iPod)/.test(window.navigator.userAgent);document.documentElement.classList.toggle("apple-os",p);})();
</script>

<div class="body-wrapper">

<button id="sidebar-menu" class="sidebar-button sidebar-toggle" aria-label="toggle sidebar" aria-controls="sidebar">
  <i class="ri-menu-line ri-lg" title="Collapse/expand sidebar"></i>
</button>

<nav id="sidebar" class="sidebar">

  <div class="sidebar-header">
    <div class="sidebar-projectInfo">

        <a href="../../index.html" class="sidebar-projectImage">
          <img src="assets/logo.png" alt="erts" />
        </a>

      <div>
        <a href="../../index.html" class="sidebar-projectName" translate="no">
erts
        </a>
        <div class="sidebar-projectVersion" translate="no">
          v15.2.7
        </div>
      </div>
    </div>
    <ul id="sidebar-list-nav" class="sidebar-list-nav" role="tablist" data-extras=""></ul>
  </div>
</nav>

<output role="status" id="toast"></output>

<main class="content page-extra" id="main" data-type="extras">
  <div id="content" class="content-inner">
    <div class="top-search">
      <div class="search-settings">
        <form class="search-bar" action="search.html">
          <label class="search-label">
            <span class="sr-only">Search documentation of erts</span>
            <input name="q" type="text" class="search-input" placeholder="Press / to search" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" />
          </label>
          <button type="submit" class="search-button" aria-label="Submit Search" tabindex="-1">
            <i class="ri-search-2-line ri-lg" aria-hidden="true"></i>
          </button>
          <button type="button" tabindex="-1" class="search-close-button" aria-hidden="true">
            <i class="ri-close-line ri-lg" title="Cancel search"></i>
          </button>
        </form>
        <div class="autocomplete">
        </div>
        <button class="icon-settings display-settings">
          <i class="ri-settings-3-line"></i>
          <span class="sr-only">Settings</span>
        </button>
      </div>
    </div>

<div id="top-content">
  <div class="heading-with-actions top-heading">
    <h1>How to Implement an Alternative Carrier for the Erlang Distribution</h1>


      <a href="https://github.com/garazdawi/otp/blob/OTP-27.3.4.1/erts/doc/guides/alt_dist.md#L1" title="View Source" class="icon-action" rel="help">
        <i class="ri-code-s-slash-line" aria-hidden="true"></i>
        <span class="sr-only">View Source</span>
      </a>

  </div>

<p>This section describes how to implement an alternative carrier protocol for the
Erlang distribution. The distribution is normally carried by TCP/IP. Here is
explained a method for replacing TCP/IP with another protocol.</p><p>The section is a step-by-step explanation of the <code class="inline">uds_dist</code> example application
(in the Kernel application <code class="inline">examples</code> directory). The <code class="inline">uds_dist</code> application
implements distribution over Unix domain sockets and is written for the Sun
Solaris 2 operating environment. The mechanisms are however general and apply to
any operating system Erlang runs on. The reason the C code is not made portable,
is simply readability.</p><h2 id="introduction" class="section-heading">
  <a href="#introduction" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Introduction</span>
</h2>
<p>To implement a new carrier for the Erlang distribution, the main steps are as
follows.</p><section role="note" class="admonition info"><h4 class="admonition-title info">Note</h4><p>As of ERTS version 10.0 support for distribution controller processes has been
introduced. That is, the traffic over a distribution channel can be managed by
a process instead of only by a port. This makes it possible to implement large
parts of the logic in Erlang code, and you perhaps do not even need a new
driver for the protocol. One example could be Erlang distribution over UDP
using <code class="inline">gen_udp</code> (your Erlang code will of course have to take care of
retransmissions, etc in this example). That is, depending on what you want to
do you perhaps do not need to implement a driver at all and can then skip the
driver related sections below. The <code class="inline">gen_tcp_dist</code> and <code class="inline">erl_uds_dist</code> examples
described in the <a href="alt_dist.html#distribution-module">Distribution Module</a>
section utilize distribution controller processes and can be worth having a
look at if you want to use distribution controller processes.</p></section><h3 id="writing-an-erlang-driver" class="section-heading">
  <a href="#writing-an-erlang-driver" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Writing an Erlang Driver</span>
</h3>
<p>First, the protocol must be available to the Erlang machine, which involves
writing an Erlang driver. A port program cannot be used, an Erlang driver is
required. Erlang drivers can be:</p><ul><li>Statically linked to the emulator, which can be an alternative when using the
open source distribution of Erlang, or</li><li>Dynamically loaded into the Erlang machines address space, which is the only
alternative if a precompiled version of Erlang is to be used</li></ul><p>Writing an Erlang driver is not easy. The driver is written as some callback
functions called by the Erlang emulator when data is sent to the driver, or the
driver has any data available on a file descriptor. As the driver callback
routines execute in the main thread of the Erlang machine, the callback
functions can perform no blocking activity whatsoever. The callbacks are only to
set up file descriptors for waiting and/or read/write available data. All I/O
must be non-blocking. Driver callbacks are however executed in sequence, why a
global state can safely be updated within the routines.</p><h3 id="writing-an-erlang-interface-for-the-driver" class="section-heading">
  <a href="#writing-an-erlang-interface-for-the-driver" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Writing an Erlang Interface for the Driver</span>
</h3>
<p>When the driver is implemented, one would preferably write an Erlang interface
for the driver to be able to test the functionality of the driver separately.
This interface can then be used by the distribution module, which will cover the
details of the protocol from the <code class="inline">net_kernel</code>.</p><p>The easiest path is to mimic the <code class="inline">inet</code> and <code class="inline">inet_tcp</code> interfaces, but not much
functionality in those modules needs to be implemented. In the example
application, only a few of the usual interfaces are implemented, and they are
much simplified.</p><h3 id="writing-a-distribution-module" class="section-heading">
  <a href="#writing-a-distribution-module" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Writing a Distribution Module</span>
</h3>
<p>When the protocol is available to Erlang through a driver and an Erlang
interface module, a distribution module can be written. The distribution module
is a module with well-defined callbacks, much like a <code class="inline">gen_server</code> (there is no
compiler support for checking the callbacks, though). This module implements:</p><ul><li>The details of finding other nodes (that is, talking to <code class="inline">epmd</code> or something
similar)</li><li>Creating a listen port (or similar)</li><li>Connecting to other nodes</li><li>Performing the handshakes/cookie verification</li></ul><p>There is however a utility module, <code class="inline">dist_util</code>, which does most of the hard work
of handling handshakes, cookies, timers, and ticking. Using <code class="inline">dist_util</code> makes
implementing a distribution module much easier and that is done in the example
application.</p><h3 id="creating-boot-scripts" class="section-heading">
  <a href="#creating-boot-scripts" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Creating Boot Scripts</span>
</h3>
<p>The last step is to create boot scripts to make the protocol implementation
available at boot time. The implementation can be debugged by starting the
distribution when all the system is running, but in a real system the
distribution is to start very early, why a boot script and some command-line
parameters are necessary.</p><p>This step also implies that the Erlang code in the interface and distribution
modules is written in such a way that it can be run in the startup phase. In
particular, there can be no calls to the <code class="inline">application</code> module or to any modules
not loaded at boot time. That is, only <code class="inline">Kernel</code>, <code class="inline">STDLIB</code>, and the application
itself can be used.</p><h2 id="distribution-module" class="section-heading">
  <a href="#distribution-module" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Distribution Module</span>
</h2>
<p>The distribution module exposes an API that <code class="inline">net_kernel</code> calls in order to
manage connections to other nodes. The module name should have the suffix
<code class="inline">_dist</code>.</p><p>The module needs to create some kind of listening entity (process or port) and
an acceptor process that accepts incoming connections using the listening
entity. For each connection, the module at least needs to create one connection
supervisor process, which also is responsible for the handshake when setting up
the connection, and a distribution controller (process or port) responsible for
transport of data over the connection. The distribution controller and the
connection supervisor process should be linked together so both of them are
cleaned up when the connection is taken down.</p><p>Note that there need to be exactly one distribution controller per connection. A
process or port can only be distribution controller for one connection. The
registration as distribution controller cannot be undone. It will stick until
the distribution controller terminates. The distribution controller should not
ignore exit signals. It is allowed to trap exits, but it should then voluntarily
terminate when an exit signal is received.</p><p>An example implementation of a distribution module can be found in
<a href="assets/gen_tcp_dist.erl">$ERL_TOP/lib/kernel/examples/gen_tcp_dist/src/gen_tcp_dist.erl</a>.
It implements the distribution over TCP/IP using the <code class="inline">gen_tcp</code> API with
distribution controllers implemented by processes. This instead of using port
distribution controllers as the ordinary TCP/IP distribution uses.</p><p>Another example implementation of a distribution module can be found in
<a href="assets/erl_uds_dist.erl">$ERL_TOP/lib/kernel/examples/erl_uds_dist/src/erl_uds_dist.erl</a>.
It implements the distribution over Unix domain sockets using the <code class="inline">gen_tcp</code> API
with distribution controllers implemented by processes. Compared to the original
<code class="inline">uds_dist</code> example using a port driver written in C, <code class="inline">erl_uds_dist</code> is written
entirely in Erlang.</p><h3 id="exported-callback-functions" class="section-heading">
  <a href="#exported-callback-functions" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Exported Callback Functions</span>
</h3>
<p>The following functions are mandatory:</p><ul><li><pre id="listen"><code class="makeup erlang" translate="no"><span class="nf">listen</span><span class="p" data-group-id="3571848930-1">(</span><span class="n">Name</span><span class="p" data-group-id="3571848930-1">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
</span><span class="err"> </span><span class="err"> </span><span class="p" data-group-id="3571848930-2">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="3571848930-3">{</span><span class="n">Listen</span><span class="p">,</span><span class="w"> </span><span class="n">Address</span><span class="p">,</span><span class="w"> </span><span class="n">Creation</span><span class="p" data-group-id="3571848930-3">}</span><span class="p" data-group-id="3571848930-2">}</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="p" data-group-id="3571848930-4">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="n">Error</span><span class="p" data-group-id="3571848930-4">}</span><span class="w">
</span><span class="nf">listen</span><span class="p" data-group-id="3571848930-5">(</span><span class="n">Name</span><span class="p">,</span><span class="n">Host</span><span class="p" data-group-id="3571848930-5">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
</span><span class="err"> </span><span class="err"> </span><span class="p" data-group-id="3571848930-6">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="3571848930-7">{</span><span class="n">Listen</span><span class="p">,</span><span class="w"> </span><span class="n">Address</span><span class="p">,</span><span class="w"> </span><span class="n">Creation</span><span class="p" data-group-id="3571848930-7">}</span><span class="p" data-group-id="3571848930-6">}</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="p" data-group-id="3571848930-8">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="n">Error</span><span class="p" data-group-id="3571848930-8">}</span></code></pre><p><code class="inline">listen/2</code> is called once in order to listen for incoming connection requests.
The call is made when the distribution is brought up. The argument <code class="inline">Name</code> is
the part of the node name before the <code class="inline">@</code> sign in the full node name. It can be
either an atom or a string. The argument <code class="inline">Host</code> is the part of the node name
after the <code class="inline">@</code> sign in the full node name. It is always a string.</p><p>The return value consists of a <code class="inline">Listen</code> handle (which is later passed to the
<a href="alt_dist.html#accept"><code class="inline">accept/1</code></a> callback), <code class="inline">Address</code> which is a
<code class="inline">#net_address{}</code> record with information about the address for the node (the
<code class="inline">#net_address{}</code> record is defined in <code class="inline">kernel/include/net_address.hrl</code>), and
<code class="inline">Creation</code> which (currently) is an integer <code class="inline">1</code>, <code class="inline">2</code>, or <code class="inline">3</code>.</p><p>If <a href="epmd_cmd.html"><code class="inline">epmd</code></a> is to be used for node discovery, you typically want
to use the <code class="inline">erl_epmd</code> module (part of the <code class="inline">kernel</code> application) in order to
register the listen port with <code class="inline">epmd</code> and retrieve <code class="inline">Creation</code> to use.</p></li><li><pre id="address"><code class="makeup erlang" translate="no"><span class="nf">address</span><span class="p" data-group-id="6844277444-1">(</span><span class="p" data-group-id="6844277444-1">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
</span><span class="err"> </span><span class="err"> </span><span class="n">Address</span></code></pre><p><code class="inline">address/0</code> is called in order to get the <code class="inline">Address</code> part of the
<a href="alt_dist.html#listen"><code class="inline">listen/2</code></a> function without creating a listen socket.
All fields except <code class="inline">address</code> have to be set in the returned record</p><p>Example:</p><pre><code class="makeup erlang" translate="no"><span class="nf">address</span><span class="p" data-group-id="1230109301-1">(</span><span class="p" data-group-id="1230109301-1">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="p" data-group-id="1230109301-2">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Host</span><span class="p" data-group-id="1230109301-2">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">inet</span><span class="p">:</span><span class="nf">gethostname</span><span class="p" data-group-id="1230109301-3">(</span><span class="p" data-group-id="1230109301-3">)</span><span class="p">,</span><span class="w">
    </span><span class="o">#</span><span class="ss">net_address</span><span class="p" data-group-id="1230109301-4">{</span><span class="w"> </span><span class="ss">host</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Host</span><span class="p">,</span><span class="w"> </span><span class="ss">protocol</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ss">tcp</span><span class="p">,</span><span class="w"> </span><span class="ss">family</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ss">inet6</span><span class="w"> </span><span class="p" data-group-id="1230109301-4">}</span><span class="p">.</span></code></pre></li><li><pre id="accept"><code class="makeup erlang" translate="no"><span class="nf">accept</span><span class="p" data-group-id="1851751153-1">(</span><span class="n">Listen</span><span class="p" data-group-id="1851751153-1">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
</span><span class="err"> </span><span class="err"> </span><span class="n">AcceptorPid</span></code></pre><p><code class="inline">accept/1</code> should spawn a process that accepts connections. This process
should preferably execute on <code class="inline">max</code> priority. The process identifier of this
process should be returned.</p><p>The <code class="inline">Listen</code> argument will be the same as the <code class="inline">Listen</code> handle part of the
return value of the <a href="alt_dist.html#listen"><code class="inline">listen/1</code></a> callback above.
<code class="inline">accept/1</code> is called only once when the distribution protocol is started.</p><p>The caller of this function is a representative for <code class="inline">net_kernel</code> (this may or
may not be the process registered as <code class="inline">net_kernel</code>) and is in this document
identified as <code class="inline">Kernel</code>. When a connection has been accepted by the acceptor
process, it needs to inform <code class="inline">Kernel</code> about the accepted connection. This is
done by passing a message on the form:</p><pre><code class="makeup erlang" translate="no"><span class="n">Kernel</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="p" data-group-id="7551280129-1">{</span><span class="ss">accept</span><span class="p">,</span><span class="w"> </span><span class="n">AcceptorPid</span><span class="p">,</span><span class="w"> </span><span class="n">DistController</span><span class="p">,</span><span class="w"> </span><span class="n">Family</span><span class="p">,</span><span class="w"> </span><span class="n">Proto</span><span class="p" data-group-id="7551280129-1">}</span></code></pre><p><code class="inline">DistController</code> is either the process or port identifier of the distribution
controller for the connection. The distribution controller should be created
by the acceptor processes when a new connection is accepted. Its job is to
dispatch traffic on the connection.</p><p><code class="inline">Kernel</code> responds with one of the following messages:</p><ul><li><p><strong><code class="inline">{Kernel, controller, SupervisorPid}</code></strong> - The request was accepted and
<code class="inline">SupervisorPid</code> is the process identifier of the connection supervisor
process (which is created in the
<a href="alt_dist.html#accept_connection"><code class="inline">accept_connection/5</code></a> callback).</p></li><li><p><strong><code class="inline">{Kernel, unsupported_protocol}</code></strong> - The request was rejected. This is a
fatal error. The acceptor process should terminate.</p></li></ul><p>When an accept sequence has been completed the acceptor process is expected to
continue accepting further requests.</p></li><li><pre id="accept_connection"><code class="makeup erlang" translate="no"><span class="nf">accept_connection</span><span class="p" data-group-id="3601410942-1">(</span><span class="n">AcceptorPid</span><span class="p">,</span><span class="w"> </span><span class="n">DistCtrl</span><span class="p">,</span><span class="w"> </span><span class="n">MyNode</span><span class="p">,</span><span class="w"> </span><span class="n">Allowed</span><span class="p">,</span><span class="w"> </span><span class="n">SetupTime</span><span class="p" data-group-id="3601410942-1">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
</span><span class="err"> </span><span class="err"> </span><span class="n">ConnectionSupervisorPid</span></code></pre><p><code class="inline">accept_connection/5</code> should spawn a process that will perform the Erlang
distribution handshake for the connection. If the handshake successfully
completes it should continue to function as a connection supervisor. This
process should preferably execute on <code class="inline">max</code> priority and should be linked to
the caller. The <code class="inline">dist_util:net_ticker_spawn_options()</code> function can be called
to get spawn options suitable for this process which can be passed directly to
<a href="erlang.html#spawn_opt/4"><code class="inline">erlang:spawn_opt/4</code></a>. <code class="inline">dist_util:net_ticker_spawn_options()</code> will by default
return <code class="inline">[link, {priority, max}]</code>, but allows the user to configure more
options using the
<a href="../../apps/kernel/kernel_app.html#net_ticker_spawn_options"><code class="inline">net_ticker_spawn_options</code></a>
kernel parameter. The process identifier of this process should be returned.</p><p>The arguments:</p><ul><li><p><strong><code class="inline">AcceptorPid</code></strong> - Process identifier of the process created by the
<a href="alt_dist.html#accept"><code class="inline">accept/1</code></a> callback.</p></li><li><p><strong><code class="inline">DistCtrl</code></strong> - The identifier of the distribution controller identifier
created by the acceptor process. To be passed along to
<code class="inline">dist_util:handshake_other_started(HsData)</code>.</p></li><li><p><strong><code class="inline">MyNode</code></strong> - Node name of this node. To be passed along to
<code class="inline">dist_util:handshake_other_started(HsData)</code>.</p></li><li><p><strong><code class="inline">Allowed</code></strong> - To be passed along to
<code class="inline">dist_util:handshake_other_started(HsData)</code>.</p></li><li><p><strong><code class="inline">SetupTime</code></strong> - Time used for creating a setup timer by a call to
<code class="inline">dist_util:start_timer(SetupTime)</code>. The timer should be passed along to
<code class="inline">dist_util:handshake_other_started(HsData)</code>.</p></li></ul><p>The created process should provide callbacks and other information needed for
the handshake in a <a href="alt_dist.html#hs_data_record"><code class="inline">#hs_data{}</code></a> record and call
<code class="inline">dist_util:handshake_other_started(HsData)</code> with this record.</p><p><code class="inline">dist_util:handshake_other_started(HsData)</code> will perform the handshake and if
the handshake successfully completes this process will then continue in a
connection supervisor loop as long as the connection is up.</p></li><li><pre id="setup"><code class="makeup erlang" translate="no"><span class="nf">setup</span><span class="p" data-group-id="6163037316-1">(</span><span class="n">Node</span><span class="p">,</span><span class="w"> </span><span class="n">Type</span><span class="p">,</span><span class="w"> </span><span class="n">MyNode</span><span class="p">,</span><span class="w"> </span><span class="n">LongOrShortNames</span><span class="p">,</span><span class="w"> </span><span class="n">SetupTime</span><span class="p" data-group-id="6163037316-1">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
</span><span class="err"> </span><span class="err"> </span><span class="n">ConnectionSupervisorPid</span></code></pre><p><code class="inline">setup/5</code> should spawn a process that connects to <code class="inline">Node</code>. When connection has
been established it should perform the Erlang distribution handshake for the
connection. If the handshake successfully completes it should continue to
function as a connection supervisor. This process should preferably execute on
<code class="inline">max</code> priority and should be linked to the caller. The
<code class="inline">dist_util:net_ticker_spawn_options()</code> function can be called to get spawn
options suitable for this process which can be passed directly to
<a href="erlang.html#spawn_opt/4"><code class="inline">erlang:spawn_opt/4</code></a>. <code class="inline">dist_util:net_ticker_spawn_options()</code> will by default
return <code class="inline">[link, {priority, max}]</code>, but allows the user to configure more
options using the
<a href="../../apps/kernel/kernel_app.html#net_ticker_spawn_options"><code class="inline">net_ticker_spawn_options</code></a>
kernel parameter. The process identifier of this process should be returned.</p><p>The arguments:</p><ul><li><p><strong><code class="inline">Node</code></strong> - Node name of remote node. To be passed along to
<code class="inline">dist_util:handshake_we_started(HsData)</code>.</p></li><li><p><strong><code class="inline">Type</code></strong> - Connection type. To be passed along to
<code class="inline">dist_util:handshake_we_started(HsData)</code>.</p></li><li><p><strong><code class="inline">MyNode</code></strong> - Node name of this node. To be passed along to
<code class="inline">dist_util:handshake_we_started(HsData)</code>.</p></li><li><p><strong><code class="inline">LongOrShortNames</code></strong> - Either the atom <code class="inline">longnames</code> or the atom
<code class="inline">shortnames</code> indicating whether long or short names is used.</p></li><li><p><strong><code class="inline">SetupTime</code></strong> - Time used for creating a setup timer by a call to
<code class="inline">dist_util:start_timer(SetupTime)</code>. The timer should be passed along to
<code class="inline">dist_util:handshake_we_started(HsData)</code>.</p></li></ul><p>The caller of this function is a representative for <code class="inline">net_kernel</code> (this may or
may not be the process registered as <code class="inline">net_kernel</code>) and is in this document
identified as <code class="inline">Kernel</code>.</p><p>This function should, besides spawning the connection supervisor, also create
a distribution controller. The distribution controller is either a process or
a port which is responsible for dispatching traffic.</p><p>The created process should provide callbacks and other information needed for
the handshake in a <a href="alt_dist.html#hs_data_record"><code class="inline">#hs_data{}</code></a> record and call
<code class="inline">dist_util:handshake_we_started(HsData)</code> with this record.</p><p><code class="inline">dist_util:handshake_we_started(HsData)</code> will perform the handshake and the
handshake successfully completes this process will then continue in a
connection supervisor loop as long as the connection is up.</p></li><li><pre id="close"><code class="makeup erlang" translate="no"><span class="nf">close</span><span class="p" data-group-id="8425583246-1">(</span><span class="n">Listen</span><span class="p" data-group-id="8425583246-1">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
</span><span class="err"> </span><span class="err"> </span><span class="nf">void</span><span class="p" data-group-id="8425583246-2">(</span><span class="p" data-group-id="8425583246-2">)</span></code></pre><p>Called in order to close the <code class="inline">Listen</code> handle that originally was passed from
the <a href="alt_dist.html#listen"><code class="inline">listen/1</code></a> callback.</p></li><li><pre id="select"><code class="makeup erlang" translate="no"><span class="nf">select</span><span class="p" data-group-id="7597489612-1">(</span><span class="n">NodeName</span><span class="p" data-group-id="7597489612-1">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
</span><span class="err"> </span><span class="err"> </span><span class="nf">boolean</span><span class="p" data-group-id="7597489612-2">(</span><span class="p" data-group-id="7597489612-2">)</span></code></pre><p>Return <code class="inline">true</code> if the host name part of the <code class="inline">NodeName</code> is valid for use with
this protocol; otherwise, <code class="inline">false</code>.</p></li></ul><p>There are also two optional functions that may be exported:</p><ul><li><pre id="setopts"><code class="makeup erlang" translate="no"><span class="nf">setopts</span><span class="p" data-group-id="6658038316-1">(</span><span class="n">Listen</span><span class="p">,</span><span class="w"> </span><span class="n">Opts</span><span class="p" data-group-id="6658038316-1">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
</span><span class="err"> </span><span class="err"> </span><span class="ss">ok</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="p" data-group-id="6658038316-2">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="n">Error</span><span class="p" data-group-id="6658038316-2">}</span></code></pre><p>The argument <code class="inline">Listen</code> is the handle originally passed from the
<a href="alt_dist.html#listen"><code class="inline">listen/1</code></a> callback. The argument <code class="inline">Opts</code> is a list of
options to set on future connections.</p></li><li><pre id="getopts"><code class="makeup erlang" translate="no"><span class="nf">getopts</span><span class="p" data-group-id="4573591230-1">(</span><span class="n">Listen</span><span class="p">,</span><span class="w"> </span><span class="n">Opts</span><span class="p" data-group-id="4573591230-1">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
</span><span class="err"> </span><span class="err"> </span><span class="p" data-group-id="4573591230-2">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">OptionValues</span><span class="p" data-group-id="4573591230-2">}</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="p" data-group-id="4573591230-3">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="n">Error</span><span class="p" data-group-id="4573591230-3">}</span></code></pre><p>The argument <code class="inline">Listen</code> is the handle originally passed from the
<a href="alt_dist.html#listen"><code class="inline">listen/1</code></a> callback. The argument <code class="inline">Opts</code> is a list of
options to read for future connections.</p></li></ul><p><a href="" id="hs_data_record"></a></p><h3 id="the-hs_data-record" class="section-heading">
  <a href="#the-hs_data-record" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">The #hs_data{} Record</span>
</h3>
<p>The <code class="inline">dist_util:handshake_we_started/1</code> and <code class="inline">dist_util:handshake_other_started/1</code>
functions takes a <code class="inline">#hs_data{}</code> record as argument. There are quite a lot of
fields in this record that you need to set. The record is defined in
<code class="inline">kernel/include/dist_util.hrl</code>. Not documented fields should not be set, i.e.,
should be left as <code class="inline">undefined</code>.</p><p>The following <code class="inline">#hs_data{}</code> record fields need to be set unless otherwise stated:</p><ul><li><p><strong><code class="inline" id="hs_data_kernel_pid">kernel_pid</code></strong> - Process identifier of the <code class="inline">Kernel</code>
process. That is, the process that called either
<a href="alt_dist.html#setup"><code class="inline">setup/5</code></a> or
<a href="alt_dist.html#accept_connection"><code class="inline">accept_connection/5</code></a>.</p></li><li><p><strong><code class="inline" id="hs_data_other_node">other_node</code></strong> - Name of the other node. This field
is only mandatory when this node initiates the connection. That is, when
connection is set up via <a href="alt_dist.html#setup"><code class="inline">setup/5</code></a>.</p></li><li><p><strong><code class="inline" id="hs_data_this_node">this_node</code></strong> - The node name of this node.</p></li><li><p><strong><code class="inline" id="hs_data_socket">socket</code></strong> - The identifier of the distribution
controller.</p></li><li><p><strong><code class="inline" id="hs_data_timer">timer</code></strong> - The timer created using
<code class="inline">dist_util:start_timer/1</code>.</p></li><li><p><strong><code class="inline" id="hs_data_allowed">allowed</code></strong> - Information passed as <code class="inline">Allowed</code> to
<code class="inline">accept_connection/5</code>. This field is only mandatory when the remote node
initiated the connection. That is, when the connection is set up via
<a href="alt_dist.html#accept_connection"><code class="inline">accept_connection/5</code></a>.</p></li><li><p><strong><code class="inline" id="hs_data_f_send">f_send</code></strong> - A fun with the following signature:</p><pre><code class="makeup erlang" translate="no"><span class="nf">fun</span><span class="w"> </span><span class="p" data-group-id="9525910241-1">(</span><span class="n">DistCtrlr</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="9525910241-1">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="ss">ok</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="p" data-group-id="9525910241-2">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="n">Error</span><span class="p" data-group-id="9525910241-2">}</span></code></pre><p>where <code class="inline">DistCtrlr</code> is the identifier of the distribution controller and <code class="inline">Data</code>
is io data to pass to the other side.</p><p>Only used during handshake phase.</p></li><li><p><strong><code class="inline" id="hs_data_f_recv">f_recv</code></strong> - A fun with the following signature:</p><pre><code class="makeup erlang" translate="no"><span class="nf">fun</span><span class="w"> </span><span class="p" data-group-id="6261296343-1">(</span><span class="n">DistCtrlr</span><span class="p">,</span><span class="w"> </span><span class="n">Length</span><span class="p" data-group-id="6261296343-1">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="p" data-group-id="6261296343-2">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Packet</span><span class="p" data-group-id="6261296343-2">}</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="p" data-group-id="6261296343-3">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="n">Reason</span><span class="p" data-group-id="6261296343-3">}</span></code></pre><p>where <code class="inline">DistCtrlr</code> is the identifier of the distribution controller. If
<code class="inline">Length</code> is <code class="inline">0</code>, all available bytes should be returned. If <code class="inline">Length &gt; 0</code>,
exactly <code class="inline">Length</code> bytes should be returned, or an error; possibly discarding
less than <code class="inline">Length</code> bytes of data when the connection is closed from the other
side. It is used for passive receive of data from the other end.</p><p>Only used during handshake phase.</p></li><li><p><strong><code class="inline" id="hs_data_f_setopts_pre_nodeup">f_setopts_pre_nodeup</code></strong> - A fun with the
following signature:</p><pre><code class="makeup erlang" translate="no"><span class="nf">fun</span><span class="w"> </span><span class="p" data-group-id="4986249277-1">(</span><span class="n">DistCtrlr</span><span class="p" data-group-id="4986249277-1">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="ss">ok</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="p" data-group-id="4986249277-2">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="n">Error</span><span class="p" data-group-id="4986249277-2">}</span></code></pre><p>where <code class="inline">DistCtrlr</code> is the identifier of the distribution controller. Called
just before the distribution channel is taken up for normal traffic.</p><p>Only used during handshake phase.</p></li><li><p><strong><code class="inline" id="hs_data_f_setopts_post_nodeup">f_setopts_post_nodeup</code></strong> - A fun with
the following signature:</p><pre><code class="makeup erlang" translate="no"><span class="nf">fun</span><span class="w"> </span><span class="p" data-group-id="5756137908-1">(</span><span class="n">DistCtrlr</span><span class="p" data-group-id="5756137908-1">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="ss">ok</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="p" data-group-id="5756137908-2">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="n">Error</span><span class="p" data-group-id="5756137908-2">}</span></code></pre><p>where <code class="inline">DistCtrlr</code> is the identifier of the distribution controller. Called
just after distribution channel has been taken up for normal traffic.</p><p>Only used during handshake phase.</p></li><li><p><strong><code class="inline" id="hs_data_f_getll">f_getll</code></strong> - A fun with the following signature:</p><pre><code class="makeup erlang" translate="no"><span class="nf">fun</span><span class="w"> </span><span class="p" data-group-id="4141572494-1">(</span><span class="n">DistCtrlr</span><span class="p" data-group-id="4141572494-1">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="n">ID</span></code></pre><p>where <code class="inline">DistCtrlr</code> is the identifier of the distribution controller and <code class="inline">ID</code> is
the identifier of the low level entity that handles the connection (often
<code class="inline">DistCtrlr</code> itself).</p><p>Only used during handshake phase.</p></li><li><p><strong><code class="inline" id="hs_data_f_address">f_address</code></strong> - A fun with the following signature:</p><pre><code class="makeup erlang" translate="no"><span class="nf">fun</span><span class="w"> </span><span class="p" data-group-id="5969084996-1">(</span><span class="n">DistCtrlr</span><span class="p">,</span><span class="w"> </span><span class="n">Node</span><span class="p" data-group-id="5969084996-1">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="n">NetAddress</span></code></pre><p>where <code class="inline">DistCtrlr</code> is the identifier of the distribution controller, <code class="inline">Node</code> is
the node name of the node on the other end, and <code class="inline">NetAddress</code> is a
<code class="inline">#net_address{}</code> record with information about the address for the <code class="inline">Node</code> on
the other end of the connection. The <code class="inline">#net_address{}</code> record is defined in
<code class="inline">kernel/include/net_address.hrl</code>.</p><p>Only used during handshake phase.</p></li><li><p><strong><code class="inline" id="hs_data_mf_tick">mf_tick</code></strong> - A fun with the following signature:</p><pre><code class="makeup erlang" translate="no"><span class="nf">fun</span><span class="w"> </span><span class="p" data-group-id="3480255187-1">(</span><span class="n">DistCtrlr</span><span class="p" data-group-id="3480255187-1">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nf">void</span><span class="p" data-group-id="3480255187-2">(</span><span class="p" data-group-id="3480255187-2">)</span></code></pre><p>where <code class="inline">DistCtrlr</code> is the identifier of the distribution controller. This
function should send information over the connection that is not interpreted
by the other end while increasing the statistics of received packets on the
other end. This is usually implemented by sending an empty packet.</p><section role="note" class="admonition info"><h4 class="admonition-title info">Note</h4><p>It is of vital importance that this operation does not block the caller for
a long time. This since it is called from the connection supervisor.</p></section><p>Used when connection is up.</p></li><li><p><strong><code class="inline" id="hs_data_mf_getstat">mf_getstat</code></strong> - A fun with the following signature:</p><pre><code class="makeup erlang" translate="no"><span class="nf">fun</span><span class="w"> </span><span class="p" data-group-id="2940859926-1">(</span><span class="n">DistCtrlr</span><span class="p" data-group-id="2940859926-1">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="p" data-group-id="2940859926-2">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Received</span><span class="p">,</span><span class="w"> </span><span class="n">Sent</span><span class="p">,</span><span class="w"> </span><span class="n">PendSend</span><span class="p" data-group-id="2940859926-2">}</span></code></pre><p>where <code class="inline">DistCtrlr</code> is the identifier of the distribution controller, <code class="inline">Received</code>
is received packets, <code class="inline">Sent</code> is sent packets, and <code class="inline">PendSend</code> is amount of data
in queue to be sent (typically in bytes, but <code class="inline">dist_util</code> only checks whether
the value is non-zero to know there is data in queue) or a <a href="erlang.html#t:boolean/0"><code class="inline">boolean/0</code></a>
indicating whether there are packets in queue to be sent.</p><section role="note" class="admonition info"><h4 class="admonition-title info">Note</h4><p>It is of vital importance that this operation does not block the caller for
a long time. This since it is called from the connection supervisor.</p></section><p>Used when connection is up.</p></li><li><p><strong><code class="inline" id="hs_data_request_type">request_type</code></strong> - The request <code class="inline">Type</code> as passed to
<a href="alt_dist.html#setup"><code class="inline">setup/5</code></a>. This is only mandatory when the connection has
been initiated by this node. That is, the connection is set up via <code class="inline">setup/5</code>.</p></li><li><p><strong><code class="inline" id="hs_data_mf_setopts">mf_setopts</code></strong> - A fun with the following signature:</p><pre><code class="makeup erlang" translate="no"><span class="nf">fun</span><span class="w"> </span><span class="p" data-group-id="1144131280-1">(</span><span class="n">DistCtrl</span><span class="p">,</span><span class="w"> </span><span class="n">Opts</span><span class="p" data-group-id="1144131280-1">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="ss">ok</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="p" data-group-id="1144131280-2">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="n">Error</span><span class="p" data-group-id="1144131280-2">}</span></code></pre><p>where <code class="inline">DistCtrlr</code> is the identifier of the distribution controller and <code class="inline">Opts</code>
is a list of options to set on the connection.</p><p>This function is optional. Used when connection is up.</p></li><li><p><strong><code class="inline" id="hs_data_mf_getopts">mf_getopts</code></strong> - A fun with the following signature:</p><pre><code class="makeup erlang" translate="no"><span class="nf">fun</span><span class="w"> </span><span class="p" data-group-id="6204646457-1">(</span><span class="n">DistCtrl</span><span class="p">,</span><span class="w"> </span><span class="n">Opts</span><span class="p" data-group-id="6204646457-1">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="p" data-group-id="6204646457-2">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">OptionValues</span><span class="p" data-group-id="6204646457-2">}</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="p" data-group-id="6204646457-3">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="n">Error</span><span class="p" data-group-id="6204646457-3">}</span></code></pre><p>where <code class="inline">DistCtrlr</code> is the identifier of the distribution controller and <code class="inline">Opts</code>
is a list of options to read for the connection.</p><p>This function is optional. Used when connection is up.</p></li><li><p><strong><code class="inline" id="hs_data_f_handshake_complete">f_handshake_complete</code></strong> - A fun with the
following signature:</p><pre><code class="makeup erlang" translate="no"><span class="nf">fun</span><span class="w"> </span><span class="p" data-group-id="7618839463-1">(</span><span class="n">DistCtrlr</span><span class="p">,</span><span class="w"> </span><span class="n">Node</span><span class="p">,</span><span class="w"> </span><span class="n">DHandle</span><span class="p" data-group-id="7618839463-1">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nf">void</span><span class="p" data-group-id="7618839463-2">(</span><span class="p" data-group-id="7618839463-2">)</span></code></pre><p>where <code class="inline">DistCtrlr</code> is the identifier of the distribution controller, <code class="inline">Node</code> is
the node name of the node connected at the other end, and <code class="inline">DHandle</code> is a
distribution handle needed by a distribution controller process when calling
the following BIFs:</p><ul><li><a href="erlang.html#dist_ctrl_get_data/1"><code class="inline">erlang:dist_ctrl_get_data/1</code></a></li><li><a href="erlang.html#dist_ctrl_get_data_notification/1"><code class="inline">erlang:dist_ctrl_get_data_notification/1</code></a></li><li><a href="erlang.html#dist_ctrl_input_handler/2"><code class="inline">erlang:dist_ctrl_input_handler/2</code></a></li><li><a href="erlang.html#dist_ctrl_put_data/2"><code class="inline">erlang:dist_ctrl_put_data/2</code></a></li></ul><p>This function is called when the handshake has completed and the distribution
channel is up. The distribution controller can begin dispatching traffic over
the channel. This function is optional.</p><p>Only used during handshake phase.</p></li><li><p><strong><code class="inline" id="hs_data_add_flags">add_flags</code></strong> -
<a href="erl_dist_protocol.html#dflags">Distribution flags</a> to add to the connection.
Currently all (non obsolete) flags will automatically be enabled.</p><p>This flag field is optional.</p></li><li><p><strong><code class="inline" id="hs_data_reject_flags">reject_flags</code></strong> -
<a href="erl_dist_protocol.html#dflags">Distribution flags</a> to reject. Currently the
following distribution flags can be rejected:</p><ul><li><p><strong><code class="inline">DFLAG_DIST_HDR_ATOM_CACHE</code></strong> - Do not use atom cache over this
connection.</p></li><li><p><strong><code class="inline">DFLAG_FRAGMENTS</code></strong> - Split large distribution messages into multiple
fragments.</p></li></ul><p>This flag field is optional.</p><p>See also <a href="alt_dist.html#distribution-data-delivery">Distribution Data Delivery</a></p></li><li><p><strong><code class="inline" id="hs_data_require_flags">require_flags</code></strong> - Require these
<a href="erl_dist_protocol.html#dflags">distribution flags</a> to be used. The connection
will be aborted during the handshake if the other end does not use them.</p><p>This flag field is optional.</p></li></ul><h3 id="distribution-data-delivery" class="section-heading">
  <a href="#distribution-data-delivery" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Distribution Data Delivery</span>
</h3>
<p>When using the default configuration, the data to pass over a connection needs
to be delivered as is to the node on the receiving end in the <em>exact same
order</em>, with no loss of data what so ever, as sent from the sending node.</p><p>The data delivery order can be relaxed by disabling features that require strict
ordering. This is done by passing the
<a href="erl_dist_protocol.html#dflags">distribution flags</a> returned by
<code class="inline">dist_util:strict_order_flags/0</code> in the
<a href="alt_dist.html#hs_data_reject_flags"><code class="inline">reject_flags</code></a> field of the
<a href="alt_dist.html#hs_data_record"><code class="inline">#hs_data{}</code></a> record used when setting up the
connection. When relaxed ordering is used, only the order of signals with the
same sender/receiver pair has to be preserved. However, note that disabling the
features that require strict ordering may have a negative impact on performance,
throughput, and/or latency.</p><h3 id="enable-your-distribution-module" class="section-heading">
  <a href="#enable-your-distribution-module" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Enable Your Distribution Module</span>
</h3>
<p>For <code class="inline">net_kernel</code> to find out which distribution module to use, the <code class="inline">erl</code>
command-line argument <code class="inline">-proto_dist</code> is used. It is followed by one or more
distribution module names, with suffix &quot;_dist&quot; removed. That is, <code class="inline">gen_tcp_dist</code>
as a distribution module is specified as <code class="inline">-proto_dist gen_tcp</code>.</p><p>If no <code class="inline">epmd</code> (TCP port mapper daemon) is used, also command-line option
<code class="inline">-no_epmd</code> is to be specified, which makes Erlang skip the <code class="inline">epmd</code> startup, both
as an OS process and as an Erlang ditto.</p><h2 id="the-driver" class="section-heading">
  <a href="#the-driver" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">The Driver</span>
</h2>
<section role="note" class="admonition info"><h4 class="admonition-title info">Note</h4><p>This section was written a long time ago. Most of it is still valid, but some
things have changed since then. Some updates have been made to the
documentation of the driver presented here, but more can be done and is
planned for the future. The reader is encouraged to read the
<a href="erl_driver.html"><code class="inline">erl_driver</code></a> and <a href="driver_entry.html"><code class="inline">driver_entry</code></a>
documentation also.</p></section><p>Although Erlang drivers in general can be beyond the scope of this section, a
brief introduction seems to be in place.</p><h3 id="drivers-in-general" class="section-heading">
  <a href="#drivers-in-general" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Drivers in General</span>
</h3>
<p>An Erlang driver is a native code module written in C (or assembler), which
serves as an interface for some special operating system service. This is a
general mechanism that is used throughout the Erlang emulator for all kinds of
I/O. An Erlang driver can be dynamically linked (or loaded) to the Erlang
emulator at runtime by using the <code class="inline">erl_ddll</code> Erlang module. Some of the drivers
in OTP are however statically linked to the runtime system, but that is more an
optimization than a necessity.</p><p>The driver data types and the functions available to the driver writer are
defined in header file <code class="inline">erl_driver.h</code> seated in Erlang's include directory. See
the <a href="erl_driver.html">erl_driver</a> documentation for details of which functions are
available.</p><p>When writing a driver to make a communications protocol available to Erlang, one
should know just about everything worth knowing about that particular protocol.
All operation must be non-blocking and all possible situations are to be
accounted for in the driver. A non-stable driver will affect and/or crash the
whole Erlang runtime system.</p><p>The emulator calls the driver in the following situations:</p><ul><li>When the driver is loaded. This callback must have a special name and inform
the emulator of what callbacks are to be used by returning a pointer to a
<code class="inline">ErlDrvEntry</code> struct, which is to be properly filled in (see below).</li><li>When a port to the driver is opened (by a <code class="inline">open_port</code> call from Erlang). This
routine is to set up internal data structures and return an opaque data entity
of the type <code class="inline">ErlDrvData</code>, which is a data type large enough to hold a pointer.
The pointer returned by this function is the first argument to all other
callbacks concerning this particular port. It is usually called the port
handle. The emulator only stores the handle and does never try to interpret
it, why it can be virtually anything (anything not larger than a pointer that
is) and can point to anything if it is a pointer. Usually this pointer refers
to a structure holding information about the particular port, as it does in
the example.</li><li>When an Erlang process sends data to the port. The data arrives as a buffer of
bytes, the interpretation is not defined, but is up to the implementor. This
callback returns nothing to the caller, answers are sent to the caller as
messages (using a routine called <code class="inline">driver_output</code> available to all drivers).
There is also a way to talk in a synchronous way to drivers, described below.
There can be an additional callback function for handling data that is
fragmented (sent in a deep io-list). That interface gets the data in a form
suitable for Unix <code class="inline">writev</code> rather than in a single buffer. There is no need
for a distribution driver to implement such a callback, so we will not.</li><li>When a file descriptor is signaled for input. This callback is called when the
emulator detects input on a file descriptor that the driver has marked for
monitoring by using the interface <code class="inline">driver_select</code>. The mechanism of driver
select makes it possible to read non-blocking from file descriptors by calling
<code class="inline">driver_select</code> when reading is needed, and then do the reading in this
callback (when reading is possible). The typical scenario is that
<code class="inline">driver_select</code> is called when an Erlang process orders a read operation, and
that this routine sends the answer when data is available on the file
descriptor.</li><li>When a file descriptor is signaled for output. This callback is called in a
similar way as the previous, but when writing to a file descriptor is
possible. The usual scenario is that Erlang orders writing on a file
descriptor and that the driver calls <code class="inline">driver_select</code>. When the descriptor is
ready for output, this callback is called and the driver can try to send the
output. Queuing can be involved in such operations, and there are convenient
queue routines available to the driver writer to use.</li><li>When a port is closed, either by an Erlang process or by the driver calling
one of the <code class="inline">driver_failure_XXX</code> routines. This routine is to clean up
everything connected to one particular port. When other callbacks call a
<code class="inline">driver_failure_XXX</code> routine, this routine is immediately called. The callback
routine issuing the error can make no more use of the data structures for the
port, as this routine surely has freed all associated data and closed all file
descriptors. If the queue utility available to driver writer is used, this
routine is however <em>not</em> called until the queue is empty.</li><li>When an Erlang process calls <a href="erlang.html#port_control/3"><code class="inline">erlang:port_control/3</code></a>, which is a synchronous
interface to drivers. The control interface is used to set driver options,
change states of ports, and so on. This interface is used a lot in the
example.</li><li>When a timer expires. The driver can set timers with the function
<code class="inline">driver_set_timer</code>. When such timers expire, a specific callback function is
called. No timers are used in the example.</li><li>When the whole driver is unloaded. Every resource allocated by the driver is
to be freed.</li></ul><h3 id="the-data-structures-of-the-distribution-driver" class="section-heading">
  <a href="#the-data-structures-of-the-distribution-driver" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">The Data Structures of the Distribution Driver</span>
</h3>
<p>The driver used for Erlang distribution is to implement a reliable, order
maintaining, variable length packet-oriented protocol. All error correction,
resending and such need to be implemented in the driver or by the underlying
communications protocol. If the protocol is stream-oriented (as is the case with
both TCP/IP and our streamed Unix domain sockets), some mechanism for packaging
is needed. We will use the simple method of having a header of four bytes
containing the length of the package in a big-endian 32-bit integer. As Unix
domain sockets only can be used between processes on the same machine, we do not
need to code the integer in some special endianness, but we will do it anyway
because in most situation you need to do it. Unix domain sockets are reliable
and order maintaining, so we do not need to implement resends and such in the
driver.</p><p>We start writing the example Unix domain sockets driver by declaring prototypes
and filling in a static <code class="inline">ErlDrvEntry</code> structure:</p><pre><code class="makeup c" translate="no"><span class="p" data-group-id="3022256022-1">(</span><span class="w"> </span><span class="mi">1</span><span class="p" data-group-id="3022256022-1">)</span><span class="w"> </span><span class="kp">#include</span><span class="w"> </span><span class="o">&lt;</span><span class="n">stdio</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span><span class="w">
</span><span class="p" data-group-id="3022256022-2">(</span><span class="w"> </span><span class="mi">2</span><span class="p" data-group-id="3022256022-2">)</span><span class="w"> </span><span class="kp">#include</span><span class="w"> </span><span class="o">&lt;</span><span class="n">stdlib</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span><span class="w">
</span><span class="p" data-group-id="3022256022-3">(</span><span class="w"> </span><span class="mi">3</span><span class="p" data-group-id="3022256022-3">)</span><span class="w"> </span><span class="kp">#include</span><span class="w"> </span><span class="o">&lt;</span><span class="n">string</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span><span class="w">
</span><span class="p" data-group-id="3022256022-4">(</span><span class="w"> </span><span class="mi">4</span><span class="p" data-group-id="3022256022-4">)</span><span class="w"> </span><span class="kp">#include</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unistd</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span><span class="w">
</span><span class="p" data-group-id="3022256022-5">(</span><span class="w"> </span><span class="mi">5</span><span class="p" data-group-id="3022256022-5">)</span><span class="w"> </span><span class="kp">#include</span><span class="w"> </span><span class="o">&lt;</span><span class="n">errno</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span><span class="w">
</span><span class="p" data-group-id="3022256022-6">(</span><span class="w"> </span><span class="mi">6</span><span class="p" data-group-id="3022256022-6">)</span><span class="w"> </span><span class="kp">#include</span><span class="w"> </span><span class="o">&lt;</span><span class="n">sys</span><span class="o">/</span><span class="n">types</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span><span class="w">
</span><span class="p" data-group-id="3022256022-7">(</span><span class="w"> </span><span class="mi">7</span><span class="p" data-group-id="3022256022-7">)</span><span class="w"> </span><span class="kp">#include</span><span class="w"> </span><span class="o">&lt;</span><span class="n">sys</span><span class="o">/</span><span class="n">stat</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span><span class="w">
</span><span class="p" data-group-id="3022256022-8">(</span><span class="w"> </span><span class="mi">8</span><span class="p" data-group-id="3022256022-8">)</span><span class="w"> </span><span class="kp">#include</span><span class="w"> </span><span class="o">&lt;</span><span class="n">sys</span><span class="o">/</span><span class="n">socket</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span><span class="w">
</span><span class="p" data-group-id="3022256022-9">(</span><span class="w"> </span><span class="mi">9</span><span class="p" data-group-id="3022256022-9">)</span><span class="w"> </span><span class="kp">#include</span><span class="w"> </span><span class="o">&lt;</span><span class="n">sys</span><span class="o">/</span><span class="n">un</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span><span class="w">
</span><span class="p" data-group-id="3022256022-10">(</span><span class="mi">10</span><span class="p" data-group-id="3022256022-10">)</span><span class="w"> </span><span class="kp">#include</span><span class="w"> </span><span class="o">&lt;</span><span class="n">fcntl</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span><span class="w">

</span><span class="p" data-group-id="3022256022-11">(</span><span class="mi">11</span><span class="p" data-group-id="3022256022-11">)</span><span class="w"> </span><span class="kp">#define</span><span class="w"> </span><span class="no">HAVE_UIO_H</span><span class="w">
</span><span class="p" data-group-id="3022256022-12">(</span><span class="mi">12</span><span class="p" data-group-id="3022256022-12">)</span><span class="w"> </span><span class="kp">#include</span><span class="w"> </span><span class="s">&quot;erl_driver.h&quot;</span><span class="w">

</span><span class="p" data-group-id="3022256022-13">(</span><span class="mi">13</span><span class="p" data-group-id="3022256022-13">)</span><span class="w"> </span><span class="cm">/*
(14) ** Interface routines
(15) */</span><span class="w">
</span><span class="p" data-group-id="3022256022-14">(</span><span class="mi">16</span><span class="p" data-group-id="3022256022-14">)</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="no">ErlDrvData</span><span class="w"> </span><span class="nf">uds_start</span><span class="p" data-group-id="3022256022-15">(</span><span class="no">ErlDrvPort</span><span class="w"> </span><span class="n">port</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">buff</span><span class="p" data-group-id="3022256022-15">)</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="3022256022-16">(</span><span class="mi">17</span><span class="p" data-group-id="3022256022-16">)</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="kc">void</span><span class="w"> </span><span class="nf">uds_stop</span><span class="p" data-group-id="3022256022-17">(</span><span class="no">ErlDrvData</span><span class="w"> </span><span class="n">handle</span><span class="p" data-group-id="3022256022-17">)</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="3022256022-18">(</span><span class="mi">18</span><span class="p" data-group-id="3022256022-18">)</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="kc">void</span><span class="w"> </span><span class="nf">uds_command</span><span class="p" data-group-id="3022256022-19">(</span><span class="no">ErlDrvData</span><span class="w"> </span><span class="n">handle</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">buff</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">bufflen</span><span class="p" data-group-id="3022256022-19">)</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="3022256022-20">(</span><span class="mi">19</span><span class="p" data-group-id="3022256022-20">)</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="kc">void</span><span class="w"> </span><span class="nf">uds_input</span><span class="p" data-group-id="3022256022-21">(</span><span class="no">ErlDrvData</span><span class="w"> </span><span class="n">handle</span><span class="p">,</span><span class="w"> </span><span class="no">ErlDrvEvent</span><span class="w"> </span><span class="n">event</span><span class="p" data-group-id="3022256022-21">)</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="3022256022-22">(</span><span class="mi">20</span><span class="p" data-group-id="3022256022-22">)</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="kc">void</span><span class="w"> </span><span class="nf">uds_output</span><span class="p" data-group-id="3022256022-23">(</span><span class="no">ErlDrvData</span><span class="w"> </span><span class="n">handle</span><span class="p">,</span><span class="w"> </span><span class="no">ErlDrvEvent</span><span class="w"> </span><span class="n">event</span><span class="p" data-group-id="3022256022-23">)</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="3022256022-24">(</span><span class="mi">21</span><span class="p" data-group-id="3022256022-24">)</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="kc">void</span><span class="w"> </span><span class="nf">uds_finish</span><span class="p" data-group-id="3022256022-25">(</span><span class="kc">void</span><span class="p" data-group-id="3022256022-25">)</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="3022256022-26">(</span><span class="mi">22</span><span class="p" data-group-id="3022256022-26">)</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">uds_control</span><span class="p" data-group-id="3022256022-27">(</span><span class="no">ErlDrvData</span><span class="w"> </span><span class="n">handle</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">command</span><span class="p">,</span><span class="w">
</span><span class="p" data-group-id="3022256022-28">(</span><span class="mi">23</span><span class="p" data-group-id="3022256022-28">)</span><span class="w">                        </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">count</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="o">*</span><span class="w"> </span><span class="n">res</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">res_size</span><span class="p" data-group-id="3022256022-27">)</span><span class="p">;</span><span class="w">

</span><span class="p" data-group-id="3022256022-29">(</span><span class="mi">24</span><span class="p" data-group-id="3022256022-29">)</span><span class="w"> </span><span class="cm">/* The driver entry */</span><span class="w">
</span><span class="p" data-group-id="3022256022-30">(</span><span class="mi">25</span><span class="p" data-group-id="3022256022-30">)</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="no">ErlDrvEntry</span><span class="w"> </span><span class="n">uds_driver_entry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="3022256022-31">{</span><span class="w">
</span><span class="p" data-group-id="3022256022-32">(</span><span class="mi">26</span><span class="p" data-group-id="3022256022-32">)</span><span class="w">     </span><span class="no">NULL</span><span class="p">,</span><span class="w">                            </span><span class="cm">/* init, N/A */</span><span class="w">
</span><span class="p" data-group-id="3022256022-33">(</span><span class="mi">27</span><span class="p" data-group-id="3022256022-33">)</span><span class="w">     </span><span class="n">uds_start</span><span class="p">,</span><span class="w">                       </span><span class="cm">/* start, called when port is opened */</span><span class="w">
</span><span class="p" data-group-id="3022256022-34">(</span><span class="mi">28</span><span class="p" data-group-id="3022256022-34">)</span><span class="w">     </span><span class="n">uds_stop</span><span class="p">,</span><span class="w">                        </span><span class="cm">/* stop, called when port is closed */</span><span class="w">
</span><span class="p" data-group-id="3022256022-35">(</span><span class="mi">29</span><span class="p" data-group-id="3022256022-35">)</span><span class="w">     </span><span class="n">uds_command</span><span class="p">,</span><span class="w">                     </span><span class="cm">/* output, called when erlang has sent */</span><span class="w">
</span><span class="p" data-group-id="3022256022-36">(</span><span class="mi">30</span><span class="p" data-group-id="3022256022-36">)</span><span class="w">     </span><span class="n">uds_input</span><span class="p">,</span><span class="w">                       </span><span class="cm">/* ready_input, called when input
(31)                                         descriptor ready */</span><span class="w">
</span><span class="p" data-group-id="3022256022-37">(</span><span class="mi">32</span><span class="p" data-group-id="3022256022-37">)</span><span class="w">     </span><span class="n">uds_output</span><span class="p">,</span><span class="w">                      </span><span class="cm">/* ready_output, called when output
(33)                                         descriptor ready */</span><span class="w">
</span><span class="p" data-group-id="3022256022-38">(</span><span class="mi">34</span><span class="p" data-group-id="3022256022-38">)</span><span class="w">     </span><span class="s">&quot;uds_drv&quot;</span><span class="p">,</span><span class="w">                       </span><span class="cm">/* char *driver_name, the argument
(35)                                         to open_port */</span><span class="w">
</span><span class="p" data-group-id="3022256022-39">(</span><span class="mi">36</span><span class="p" data-group-id="3022256022-39">)</span><span class="w">     </span><span class="n">uds_finish</span><span class="p">,</span><span class="w">                      </span><span class="cm">/* finish, called when unloaded */</span><span class="w">
</span><span class="p" data-group-id="3022256022-40">(</span><span class="mi">37</span><span class="p" data-group-id="3022256022-40">)</span><span class="w">     </span><span class="no">NULL</span><span class="p">,</span><span class="w">                            </span><span class="cm">/* void * that is not used (BC) */</span><span class="w">
</span><span class="p" data-group-id="3022256022-41">(</span><span class="mi">38</span><span class="p" data-group-id="3022256022-41">)</span><span class="w">     </span><span class="n">uds_control</span><span class="p">,</span><span class="w">                     </span><span class="cm">/* control, port_control callback */</span><span class="w">
</span><span class="p" data-group-id="3022256022-42">(</span><span class="mi">39</span><span class="p" data-group-id="3022256022-42">)</span><span class="w">     </span><span class="no">NULL</span><span class="p">,</span><span class="w">                            </span><span class="cm">/* timeout, called on timeouts */</span><span class="w">
</span><span class="p" data-group-id="3022256022-43">(</span><span class="mi">40</span><span class="p" data-group-id="3022256022-43">)</span><span class="w">     </span><span class="no">NULL</span><span class="p">,</span><span class="w">                            </span><span class="cm">/* outputv, vector output interface */</span><span class="w">
</span><span class="p" data-group-id="3022256022-44">(</span><span class="mi">41</span><span class="p" data-group-id="3022256022-44">)</span><span class="w">     </span><span class="no">NULL</span><span class="p">,</span><span class="w">                            </span><span class="cm">/* ready_async callback */</span><span class="w">
</span><span class="p" data-group-id="3022256022-45">(</span><span class="mi">42</span><span class="p" data-group-id="3022256022-45">)</span><span class="w">     </span><span class="no">NULL</span><span class="p">,</span><span class="w">                            </span><span class="cm">/* flush callback */</span><span class="w">
</span><span class="p" data-group-id="3022256022-46">(</span><span class="mi">43</span><span class="p" data-group-id="3022256022-46">)</span><span class="w">     </span><span class="no">NULL</span><span class="p">,</span><span class="w">                            </span><span class="cm">/* call callback */</span><span class="w">
</span><span class="p" data-group-id="3022256022-47">(</span><span class="mi">44</span><span class="p" data-group-id="3022256022-47">)</span><span class="w">     </span><span class="no">NULL</span><span class="p">,</span><span class="w">                            </span><span class="cm">/* event callback */</span><span class="w">
</span><span class="p" data-group-id="3022256022-48">(</span><span class="mi">45</span><span class="p" data-group-id="3022256022-48">)</span><span class="w">     </span><span class="no">ERL_DRV_EXTENDED_MARKER</span><span class="p">,</span><span class="w">         </span><span class="cm">/* Extended driver interface marker */</span><span class="w">
</span><span class="p" data-group-id="3022256022-49">(</span><span class="mi">46</span><span class="p" data-group-id="3022256022-49">)</span><span class="w">     </span><span class="no">ERL_DRV_EXTENDED_MAJOR_VERSION</span><span class="p">,</span><span class="w">  </span><span class="cm">/* Major version number */</span><span class="w">
</span><span class="p" data-group-id="3022256022-50">(</span><span class="mi">47</span><span class="p" data-group-id="3022256022-50">)</span><span class="w">     </span><span class="no">ERL_DRV_EXTENDED_MINOR_VERSION</span><span class="p">,</span><span class="w">  </span><span class="cm">/* Minor version number */</span><span class="w">
</span><span class="p" data-group-id="3022256022-51">(</span><span class="mi">48</span><span class="p" data-group-id="3022256022-51">)</span><span class="w">     </span><span class="no">ERL_DRV_FLAG_SOFT_BUSY</span><span class="p">,</span><span class="w">          </span><span class="cm">/* Driver flags. Soft busy flag is
(49)                                         required for distribution drivers */</span><span class="w">
</span><span class="p" data-group-id="3022256022-52">(</span><span class="mi">50</span><span class="p" data-group-id="3022256022-52">)</span><span class="w">     </span><span class="no">NULL</span><span class="p">,</span><span class="w">                            </span><span class="cm">/* Reserved for internal use */</span><span class="w">
</span><span class="p" data-group-id="3022256022-53">(</span><span class="mi">51</span><span class="p" data-group-id="3022256022-53">)</span><span class="w">     </span><span class="no">NULL</span><span class="p">,</span><span class="w">                            </span><span class="cm">/* process_exit callback */</span><span class="w">
</span><span class="p" data-group-id="3022256022-54">(</span><span class="mi">52</span><span class="p" data-group-id="3022256022-54">)</span><span class="w">     </span><span class="no">NULL</span><span class="w">                             </span><span class="cm">/* stop_select callback */</span><span class="w">
</span><span class="p" data-group-id="3022256022-55">(</span><span class="mi">53</span><span class="p" data-group-id="3022256022-55">)</span><span class="w"> </span><span class="p" data-group-id="3022256022-31">}</span><span class="p">;</span></code></pre><p>On line 1-10 the OS headers needed for the driver are included. As this driver
is written for Solaris, we know that the header <code class="inline">uio.h</code> exists. So the
preprocessor variable <code class="inline">HAVE_UIO_H</code> can be defined before <code class="inline">erl_driver.h</code> is
included on line 12. The definition of <code class="inline">HAVE_UIO_H</code> will make the I/O vectors
used in Erlang's driver queues to correspond to the operating systems ditto,
which is very convenient.</p><p>On line 16-23 the different callback functions are declared (&quot;forward
declarations&quot;).</p><p>The driver structure is similar for statically linked-in drivers and dynamically
loaded. However, some of the fields are to be left empty (that is, initialized
to NULL) in the different types of drivers. The first field (the <code class="inline">init</code> function
pointer) is always left blank in a dynamically loaded driver, see line 26.
<code class="inline">NULL</code> on line 37 is always to be there, the field is no longer used and is
retained for backward compatibility. No timers are used in this driver, why no
callback for timers is needed. The <code class="inline">outputv</code> field (line 40) can be used to
implement an interface similar to Unix <code class="inline">writev</code> for output. The Erlang runtime
system could previously not use <code class="inline">outputv</code> for the distribution, but it can as
from ERTS 5.7.2. As this driver was written before ERTS 5.7.2 it does not use
the <code class="inline">outputv</code> callback. Using the <code class="inline">outputv</code> callback is preferred, as it reduces
copying of data. (We will however use scatter/gather I/O internally in the
driver.)</p><p>As from ERTS 5.5.3 the driver interface was extended with version control and
the possibility to pass capability information. Capability flags are present on
line 48. As from ERTS 5.7.4 flag
<a href="driver_entry.html#driver_flags"><code class="inline">ERL_DRV_FLAG_SOFT_BUSY</code></a> is required for drivers
that are to be used by the distribution. The soft busy flag implies that the
driver can handle calls to the <code class="inline">output</code> and <code class="inline">outputv</code> callbacks although it has
marked itself as busy. This has always been a requirement on drivers used by the
distribution, but no capability information has been available about this
previously. For more information, see
<a href="erl_driver.html#set_busy_port"><code class="inline">erl_driver:set_busy_port()</code></a>).</p><p>This driver was written before the runtime system had SMP support. The driver
will still function in the runtime system with SMP support, but performance will
suffer from lock contention on the driver lock used for the driver. This can be
alleviated by reviewing and perhaps rewriting the code so that each instance of
the driver safely can execute in parallel. When instances safely can execute in
parallel, it is safe to enable instance-specific locking on the driver. This is
done by passing <a href="driver_entry.html#driver_flags"><code class="inline">ERL_DRV_FLAG_USE_PORT_LOCKING</code></a>
as a driver flag. This is left as an exercise for the reader.</p><p>Thus, the defined callbacks are as follows:</p><ul><li><p><strong><code class="inline">uds_start</code></strong> - Must initiate data for a port. We do not create any sockets
here, only initialize data structures.</p></li><li><p><strong><code class="inline">uds_stop</code></strong> - Called when a port is closed.</p></li><li><p><strong><code class="inline">uds_command</code></strong> - Handles messages from Erlang. The messages can either be
plain data to be sent or more subtle instructions to the driver. This function
is here mostly for data pumping.</p></li><li><p><strong><code class="inline">uds_input</code></strong> - Called when there is something to read from a socket.</p></li><li><p><strong><code class="inline">uds_output</code></strong> - Called when it is possible to write to a socket.</p></li><li><p><strong><code class="inline">uds_finish</code></strong> - Called when the driver is unloaded. A distribution driver
will never be unloaded, but we include this for completeness. To be able to
clean up after oneself is always a good thing.</p></li><li><p><strong><code class="inline">uds_control</code></strong> - The <a href="erlang.html#port_control/3"><code class="inline">erlang:port_control/3</code></a> callback, which is used a lot
in this implementation.</p></li></ul><p>The ports implemented by this driver operate in two major modes, named <code class="inline">command</code>
and <code class="inline">data</code>. In <code class="inline">command</code> mode, only passive reading and writing (like
<code class="inline">gen_tcp:recv</code>/<code class="inline">gen_tcp:send</code>) can be done. The port is in this mode during the
distribution handshake. When the connection is up, the port is switched to
<code class="inline">data</code> mode and all data is immediately read and passed further to the Erlang
emulator. In <code class="inline">data</code> mode, no data arriving to <code class="inline">uds_command</code> is interpreted, only
packaged and sent out on the socket. The <code class="inline">uds_control</code> callback does the
switching between those two modes.</p><p>While <code class="inline">net_kernel</code> informs different subsystems that the connection is coming
up, the port is to accept data to send. However, the port should not receive any
data, to avoid that data arrives from another node before every kernel subsystem
is prepared to handle it. A third mode, named <code class="inline">intermediate</code>, is used for this
intermediate stage.</p><p>An enum is defined for the different types of ports:</p><pre><code class="makeup c" translate="no"><span class="p" data-group-id="7776389364-1">(</span><span class="w"> </span><span class="mi">1</span><span class="p" data-group-id="7776389364-1">)</span><span class="w"> </span><span class="k">typedef</span><span class="w"> </span><span class="k">enum</span><span class="w"> </span><span class="p" data-group-id="7776389364-2">{</span><span class="w">
</span><span class="p" data-group-id="7776389364-3">(</span><span class="w"> </span><span class="mi">2</span><span class="p" data-group-id="7776389364-3">)</span><span class="w">     </span><span class="n">portTypeUnknown</span><span class="p">,</span><span class="w">      </span><span class="cm">/* An uninitialized port */</span><span class="w">
</span><span class="p" data-group-id="7776389364-4">(</span><span class="w"> </span><span class="mi">3</span><span class="p" data-group-id="7776389364-4">)</span><span class="w">     </span><span class="n">portTypeListener</span><span class="p">,</span><span class="w">     </span><span class="cm">/* A listening port/socket */</span><span class="w">
</span><span class="p" data-group-id="7776389364-5">(</span><span class="w"> </span><span class="mi">4</span><span class="p" data-group-id="7776389364-5">)</span><span class="w">     </span><span class="n">portTypeAcceptor</span><span class="p">,</span><span class="w">     </span><span class="cm">/* An intermediate stage when accepting
( 5)                              on a listen port */</span><span class="w">
</span><span class="p" data-group-id="7776389364-6">(</span><span class="w"> </span><span class="mi">6</span><span class="p" data-group-id="7776389364-6">)</span><span class="w">     </span><span class="n">portTypeConnector</span><span class="p">,</span><span class="w">    </span><span class="cm">/* An intermediate stage when connecting */</span><span class="w">
</span><span class="p" data-group-id="7776389364-7">(</span><span class="w"> </span><span class="mi">7</span><span class="p" data-group-id="7776389364-7">)</span><span class="w">     </span><span class="n">portTypeCommand</span><span class="p">,</span><span class="w">      </span><span class="cm">/* A connected open port in command mode */</span><span class="w">
</span><span class="p" data-group-id="7776389364-8">(</span><span class="w"> </span><span class="mi">8</span><span class="p" data-group-id="7776389364-8">)</span><span class="w">     </span><span class="n">portTypeIntermediate</span><span class="p">,</span><span class="w"> </span><span class="cm">/* A connected open port in special
( 9)                              half active mode */</span><span class="w">
</span><span class="p" data-group-id="7776389364-9">(</span><span class="mi">10</span><span class="p" data-group-id="7776389364-9">)</span><span class="w">     </span><span class="n">portTypeData</span><span class="w">          </span><span class="cm">/* A connected open port in data mode */</span><span class="w">
</span><span class="p" data-group-id="7776389364-10">(</span><span class="mi">11</span><span class="p" data-group-id="7776389364-10">)</span><span class="w"> </span><span class="p" data-group-id="7776389364-2">}</span><span class="w"> </span><span class="no">PortType</span><span class="p">;</span></code></pre><p>The different types are as follows:</p><ul><li><p><strong><code class="inline">portTypeUnknown</code></strong> - The type a port has when it is opened, but not bound
to any file descriptor.</p></li><li><p><strong><code class="inline">portTypeListener</code></strong> - A port that is connected to a listen socket. This
port does not do much, no data pumping is done on this socket, but read data
is available when one is trying to do an accept on the port.</p></li><li><p><strong><code class="inline">portTypeAcceptor</code></strong> - This port is to represent the result of an accept
operation. It is created when one wants to accept from a listen socket, and it
is converted to a <code class="inline">portTypeCommand</code> when the accept succeeds.</p></li><li><p><strong><code class="inline">portTypeConnector</code></strong> - Very similar to <code class="inline">portTypeAcceptor</code>, an intermediate
stage between the request for a connect operation and that the socket is
connected to an accepting ditto in the other end. When the sockets are
connected, the port switches type to <code class="inline">portTypeCommand</code>.</p></li><li><p><strong><code class="inline">portTypeCommand</code></strong> - A connected socket (or accepted socket) in <code class="inline">command</code>
mode mentioned earlier.</p></li><li><p><strong><code class="inline">portTypeIntermediate</code></strong> - The intermediate stage for a connected socket.
There is to be no processing of input for this socket.</p></li><li><p><strong><code class="inline">portTypeData</code></strong> - The mode where data is pumped through the port and the
<code class="inline">uds_command</code> routine regards every call as a call where sending is wanted. In
this mode, all input available is read and sent to Erlang when it arrives on
the socket, much like in the active mode of a <code class="inline">gen_tcp</code> socket.</p></li></ul><p>We study the state that is needed for the ports. Notice that not all fields are
used for all types of ports. Some space could be saved by using unions, but that
would clutter the code with multiple indirections, so here is used one struct
for all types of ports, for readability:</p><pre><code class="makeup c" translate="no"><span class="p" data-group-id="5300943142-1">(</span><span class="w"> </span><span class="mi">1</span><span class="p" data-group-id="5300943142-1">)</span><span class="w"> </span><span class="k">typedef</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="no">Byte</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="5300943142-2">(</span><span class="w"> </span><span class="mi">2</span><span class="p" data-group-id="5300943142-2">)</span><span class="w"> </span><span class="k">typedef</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="no">Word</span><span class="p">;</span><span class="w">

</span><span class="p" data-group-id="5300943142-3">(</span><span class="w"> </span><span class="mi">3</span><span class="p" data-group-id="5300943142-3">)</span><span class="w"> </span><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="n">uds_data</span><span class="w"> </span><span class="p" data-group-id="5300943142-4">{</span><span class="w">
</span><span class="p" data-group-id="5300943142-5">(</span><span class="w"> </span><span class="mi">4</span><span class="p" data-group-id="5300943142-5">)</span><span class="w">     </span><span class="kt">int</span><span class="w"> </span><span class="n">fd</span><span class="p">;</span><span class="w">                   </span><span class="cm">/* File descriptor */</span><span class="w">
</span><span class="p" data-group-id="5300943142-6">(</span><span class="w"> </span><span class="mi">5</span><span class="p" data-group-id="5300943142-6">)</span><span class="w">     </span><span class="no">ErlDrvPort</span><span class="w"> </span><span class="n">port</span><span class="p">;</span><span class="w">          </span><span class="cm">/* The port identifier */</span><span class="w">
</span><span class="p" data-group-id="5300943142-7">(</span><span class="w"> </span><span class="mi">6</span><span class="p" data-group-id="5300943142-7">)</span><span class="w">     </span><span class="kt">int</span><span class="w"> </span><span class="n">lockfd</span><span class="p">;</span><span class="w">               </span><span class="cm">/* The file descriptor for a lock file in
( 7)                                  case of listen sockets */</span><span class="w">
</span><span class="p" data-group-id="5300943142-8">(</span><span class="w"> </span><span class="mi">8</span><span class="p" data-group-id="5300943142-8">)</span><span class="w">     </span><span class="no">Byte</span><span class="w"> </span><span class="n">creation</span><span class="p">;</span><span class="w">            </span><span class="cm">/* The creation serial derived from the
( 9)                                  lock file */</span><span class="w">
</span><span class="p" data-group-id="5300943142-9">(</span><span class="mi">10</span><span class="p" data-group-id="5300943142-9">)</span><span class="w">     </span><span class="no">PortType</span><span class="w"> </span><span class="n">type</span><span class="p">;</span><span class="w">            </span><span class="cm">/* Type of port */</span><span class="w">
</span><span class="p" data-group-id="5300943142-10">(</span><span class="mi">11</span><span class="p" data-group-id="5300943142-10">)</span><span class="w">     </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">name</span><span class="p">;</span><span class="w">               </span><span class="cm">/* Short name of socket for unlink */</span><span class="w">
</span><span class="p" data-group-id="5300943142-11">(</span><span class="mi">12</span><span class="p" data-group-id="5300943142-11">)</span><span class="w">     </span><span class="no">Word</span><span class="w"> </span><span class="n">sent</span><span class="p">;</span><span class="w">                </span><span class="cm">/* Bytes sent */</span><span class="w">
</span><span class="p" data-group-id="5300943142-12">(</span><span class="mi">13</span><span class="p" data-group-id="5300943142-12">)</span><span class="w">     </span><span class="no">Word</span><span class="w"> </span><span class="n">received</span><span class="p">;</span><span class="w">            </span><span class="cm">/* Bytes received */</span><span class="w">
</span><span class="p" data-group-id="5300943142-13">(</span><span class="mi">14</span><span class="p" data-group-id="5300943142-13">)</span><span class="w">     </span><span class="k">struct</span><span class="w"> </span><span class="n">uds_data</span><span class="w"> </span><span class="o">*</span><span class="n">partner</span><span class="p">;</span><span class="w"> </span><span class="cm">/* The partner in an accept/listen pair */</span><span class="w">
</span><span class="p" data-group-id="5300943142-14">(</span><span class="mi">15</span><span class="p" data-group-id="5300943142-14">)</span><span class="w">     </span><span class="k">struct</span><span class="w"> </span><span class="n">uds_data</span><span class="w"> </span><span class="o">*</span><span class="n">next</span><span class="p">;</span><span class="w">    </span><span class="cm">/* Next structure in list */</span><span class="w">
</span><span class="p" data-group-id="5300943142-15">(</span><span class="mi">16</span><span class="p" data-group-id="5300943142-15">)</span><span class="w">     </span><span class="cm">/* The input buffer and its data */</span><span class="w">
</span><span class="p" data-group-id="5300943142-16">(</span><span class="mi">17</span><span class="p" data-group-id="5300943142-16">)</span><span class="w">     </span><span class="kt">int</span><span class="w"> </span><span class="n">buffer_size</span><span class="p">;</span><span class="w">          </span><span class="cm">/* The allocated size of the input buffer */</span><span class="w">
</span><span class="p" data-group-id="5300943142-17">(</span><span class="mi">18</span><span class="p" data-group-id="5300943142-17">)</span><span class="w">     </span><span class="kt">int</span><span class="w"> </span><span class="n">buffer_pos</span><span class="p">;</span><span class="w">           </span><span class="cm">/* Current position in input buffer */</span><span class="w">
</span><span class="p" data-group-id="5300943142-18">(</span><span class="mi">19</span><span class="p" data-group-id="5300943142-18">)</span><span class="w">     </span><span class="kt">int</span><span class="w"> </span><span class="n">header_pos</span><span class="p">;</span><span class="w">           </span><span class="cm">/* Where the current header is in the
(20)                                  input buffer */</span><span class="w">
</span><span class="p" data-group-id="5300943142-19">(</span><span class="mi">21</span><span class="p" data-group-id="5300943142-19">)</span><span class="w">     </span><span class="no">Byte</span><span class="w"> </span><span class="o">*</span><span class="n">buffer</span><span class="p">;</span><span class="w">             </span><span class="cm">/* The actual input buffer */</span><span class="w">
</span><span class="p" data-group-id="5300943142-20">(</span><span class="mi">22</span><span class="p" data-group-id="5300943142-20">)</span><span class="w"> </span><span class="p" data-group-id="5300943142-4">}</span><span class="w"> </span><span class="no">UdsData</span><span class="p">;</span></code></pre><p>This structure is used for all types of ports although some fields are useless
for some types. The least memory consuming solution would be to arrange this
structure as a union of structures. However, the multiple indirections in the
code to access a field in such a structure would clutter the code too much for
an example.</p><p>The fields in the structure are as follows:</p><ul><li><p><strong><code class="inline">fd</code></strong> - The file descriptor of the socket associated with the port.</p></li><li><p><strong><code class="inline">port</code></strong> - The port identifier for the port that this structure corresponds
to. It is needed for most <code class="inline">driver_XXX</code> calls from the driver back to the
emulator.</p></li><li><p><strong><code class="inline">lockfd</code></strong> - If the socket is a listen socket, we use a separate (regular)
file for two purposes:</p><ul><li><p>We want a locking mechanism that gives no race conditions, to be sure if
another Erlang node uses the listen socket name we require or if the file is
only left there from a previous (crashed) session.</p></li><li><p>We store the <code class="inline">creation</code> serial number in the file. The <code class="inline">creation</code> is a
number that is to change between different instances of different Erlang
emulators with the same name, so that process identifiers from one emulator
do not become valid when sent to a new emulator with the same distribution
name. The creation can be from 0 through 3 (two bits) and is stored in every
process identifier sent to another node.</p><p>In a system with TCP-based distribution, this data is kept in the <em>Erlang
port mapper daemon</em> (<code class="inline">epmd</code>), which is contacted when a distributed node
starts. The lock file and a convention for the UDS listen socket's name
remove the need for <code class="inline">epmd</code> when using this distribution module. UDS is
always restricted to one host, why avoiding a port mapper is easy.</p></li></ul></li><li><p><strong><code class="inline">creation</code></strong> - The creation number for a listen socket, which is calculated
as (the value found in the lock-file + 1) rem 4. This creation value is also
written back into the lock file, so that the next invocation of the emulator
finds our value in the file.</p></li><li><p><strong><code class="inline">type</code></strong> - The current type/state of the port, which can be one of the
values declared above.</p></li><li><p><strong><code class="inline">name</code></strong> - The name of the socket file (the path prefix removed), which
allows for deletion (<code class="inline">unlink</code>) when the socket is closed.</p></li><li><p><strong><code class="inline">sent</code></strong> - How many bytes that have been sent over the socket. This can
wrap, but that is no problem for the distribution, as the Erlang distribution
is only interested in if this value has changed. (The Erlang <code class="inline">net_kernel</code>
<code class="inline">ticker</code> uses this value by calling the driver to fetch it, which is done
through the <a href="erlang.html#port_control/3"><code class="inline">erlang:port_control/3</code></a> routine.)</p></li><li><p><strong><code class="inline">received</code></strong> - How many bytes that are read (received) from the socket, used
in similar ways as <code class="inline">sent</code>.</p></li><li><p><strong><code class="inline">partner</code></strong> - A pointer to another port structure, which is either the
listen port from which this port is accepting a connection or conversely. The
&quot;partner relation&quot; is always bidirectional.</p></li><li><p><strong><code class="inline">next</code></strong> - Pointer to next structure in a linked list of all port
structures. This list is used when accepting connections and when the driver
is unloaded.</p></li><li><p><strong><code class="inline">buffer_size</code>, <code class="inline">buffer_pos</code>, <code class="inline">header_pos</code>, <code class="inline">buffer</code></strong> - Data for input
buffering. For details about the input buffering, see the source code in
directory <code class="inline">kernel/examples</code>. That certainly goes beyond the scope of this
section.</p></li></ul><h3 id="selected-parts-of-the-distribution-driver-implementation" class="section-heading">
  <a href="#selected-parts-of-the-distribution-driver-implementation" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Selected Parts of the Distribution Driver Implementation</span>
</h3>
<p>The implementation of the distribution driver is not completely covered here,
details about buffering and other things unrelated to driver writing are not
explained. Likewise are some peculiarities of the UDS protocol not explained in
detail. The chosen protocol is not important.</p><p>Prototypes for the driver callback routines can be found in the <code class="inline">erl_driver.h</code>
header file.</p><p>The driver initialization routine is (usually) declared with a macro to make the
driver easier to port between different operating systems (and flavors of
systems). This is the only routine that must have a well-defined name. All other
callbacks are reached through the driver structure. The macro to use is named
<code class="inline">DRIVER_INIT</code> and takes the driver name as parameter:</p><pre><code class="makeup c" translate="no"><span class="p" data-group-id="0276833342-1">(</span><span class="mi">1</span><span class="p" data-group-id="0276833342-1">)</span><span class="w"> </span><span class="cm">/* Beginning of linked list of ports */</span><span class="w">
</span><span class="p" data-group-id="0276833342-2">(</span><span class="mi">2</span><span class="p" data-group-id="0276833342-2">)</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="no">UdsData</span><span class="w"> </span><span class="o">*</span><span class="n">first_data</span><span class="p">;</span><span class="w">

</span><span class="p" data-group-id="0276833342-3">(</span><span class="mi">3</span><span class="p" data-group-id="0276833342-3">)</span><span class="w"> </span><span class="no">DRIVER_INIT</span><span class="p" data-group-id="0276833342-4">(</span><span class="n">uds_drv</span><span class="p" data-group-id="0276833342-4">)</span><span class="w">
</span><span class="p" data-group-id="0276833342-5">(</span><span class="mi">4</span><span class="p" data-group-id="0276833342-5">)</span><span class="w"> </span><span class="p" data-group-id="0276833342-6">{</span><span class="w">
</span><span class="p" data-group-id="0276833342-7">(</span><span class="mi">5</span><span class="p" data-group-id="0276833342-7">)</span><span class="w">     </span><span class="n">first_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">NULL</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="0276833342-8">(</span><span class="mi">6</span><span class="p" data-group-id="0276833342-8">)</span><span class="w">     </span><span class="k">return</span><span class="w"> </span><span class="o">&amp;</span><span class="n">uds_driver_entry</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="0276833342-9">(</span><span class="mi">7</span><span class="p" data-group-id="0276833342-9">)</span><span class="w"> </span><span class="p" data-group-id="0276833342-6">}</span></code></pre><p>The routine initializes the single global data structure and returns a pointer
to the driver entry. The routine is called when <code class="inline">erl_ddll:load_driver</code> is called
from Erlang.</p><p>The <code class="inline">uds_start</code> routine is called when a port is opened from Erlang. In this
case, we only allocate a structure and initialize it. Creating the actual socket
is left to the <code class="inline">uds_command</code> routine.</p><pre><code class="makeup c" translate="no"><span class="p" data-group-id="0419981918-1">(</span><span class="w"> </span><span class="mi">1</span><span class="p" data-group-id="0419981918-1">)</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="no">ErlDrvData</span><span class="w"> </span><span class="nf">uds_start</span><span class="p" data-group-id="0419981918-2">(</span><span class="no">ErlDrvPort</span><span class="w"> </span><span class="n">port</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">buff</span><span class="p" data-group-id="0419981918-2">)</span><span class="w">
</span><span class="p" data-group-id="0419981918-3">(</span><span class="w"> </span><span class="mi">2</span><span class="p" data-group-id="0419981918-3">)</span><span class="w"> </span><span class="p" data-group-id="0419981918-4">{</span><span class="w">
</span><span class="p" data-group-id="0419981918-5">(</span><span class="w"> </span><span class="mi">3</span><span class="p" data-group-id="0419981918-5">)</span><span class="w">     </span><span class="no">UdsData</span><span class="w"> </span><span class="o">*</span><span class="n">ud</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="0419981918-6">(</span><span class="w"> </span><span class="mi">4</span><span class="p" data-group-id="0419981918-6">)</span><span class="w">
</span><span class="p" data-group-id="0419981918-7">(</span><span class="w"> </span><span class="mi">5</span><span class="p" data-group-id="0419981918-7">)</span><span class="w">     </span><span class="n">ud</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">ALLOC</span><span class="p" data-group-id="0419981918-8">(</span><span class="nf">sizeof</span><span class="p" data-group-id="0419981918-9">(</span><span class="no">UdsData</span><span class="p" data-group-id="0419981918-9">)</span><span class="p" data-group-id="0419981918-8">)</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="0419981918-10">(</span><span class="w"> </span><span class="mi">6</span><span class="p" data-group-id="0419981918-10">)</span><span class="w">     </span><span class="n">ud</span><span class="o">-&gt;</span><span class="n">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="0419981918-11">(</span><span class="w"> </span><span class="mi">7</span><span class="p" data-group-id="0419981918-11">)</span><span class="w">     </span><span class="n">ud</span><span class="o">-&gt;</span><span class="n">lockfd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="0419981918-12">(</span><span class="w"> </span><span class="mi">8</span><span class="p" data-group-id="0419981918-12">)</span><span class="w">     </span><span class="n">ud</span><span class="o">-&gt;</span><span class="n">creation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="0419981918-13">(</span><span class="w"> </span><span class="mi">9</span><span class="p" data-group-id="0419981918-13">)</span><span class="w">     </span><span class="n">ud</span><span class="o">-&gt;</span><span class="n">port</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">port</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="0419981918-14">(</span><span class="mi">10</span><span class="p" data-group-id="0419981918-14">)</span><span class="w">     </span><span class="n">ud</span><span class="o">-&gt;</span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">portTypeUnknown</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="0419981918-15">(</span><span class="mi">11</span><span class="p" data-group-id="0419981918-15">)</span><span class="w">     </span><span class="n">ud</span><span class="o">-&gt;</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">NULL</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="0419981918-16">(</span><span class="mi">12</span><span class="p" data-group-id="0419981918-16">)</span><span class="w">     </span><span class="n">ud</span><span class="o">-&gt;</span><span class="n">buffer_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="0419981918-17">(</span><span class="mi">13</span><span class="p" data-group-id="0419981918-17">)</span><span class="w">     </span><span class="n">ud</span><span class="o">-&gt;</span><span class="n">buffer_pos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="0419981918-18">(</span><span class="mi">14</span><span class="p" data-group-id="0419981918-18">)</span><span class="w">     </span><span class="n">ud</span><span class="o">-&gt;</span><span class="n">header_pos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="0419981918-19">(</span><span class="mi">15</span><span class="p" data-group-id="0419981918-19">)</span><span class="w">     </span><span class="n">ud</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">NULL</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="0419981918-20">(</span><span class="mi">16</span><span class="p" data-group-id="0419981918-20">)</span><span class="w">     </span><span class="n">ud</span><span class="o">-&gt;</span><span class="n">sent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="0419981918-21">(</span><span class="mi">17</span><span class="p" data-group-id="0419981918-21">)</span><span class="w">     </span><span class="n">ud</span><span class="o">-&gt;</span><span class="n">received</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="0419981918-22">(</span><span class="mi">18</span><span class="p" data-group-id="0419981918-22">)</span><span class="w">     </span><span class="n">ud</span><span class="o">-&gt;</span><span class="n">partner</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">NULL</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="0419981918-23">(</span><span class="mi">19</span><span class="p" data-group-id="0419981918-23">)</span><span class="w">     </span><span class="n">ud</span><span class="o">-&gt;</span><span class="n">next</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">first_data</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="0419981918-24">(</span><span class="mi">20</span><span class="p" data-group-id="0419981918-24">)</span><span class="w">     </span><span class="n">first_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ud</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="0419981918-25">(</span><span class="mi">21</span><span class="p" data-group-id="0419981918-25">)</span><span class="w">
</span><span class="p" data-group-id="0419981918-26">(</span><span class="mi">22</span><span class="p" data-group-id="0419981918-26">)</span><span class="w">     </span><span class="nf">return</span><span class="p" data-group-id="0419981918-27">(</span><span class="p" data-group-id="0419981918-28">(</span><span class="no">ErlDrvData</span><span class="p" data-group-id="0419981918-28">)</span><span class="w"> </span><span class="n">ud</span><span class="p" data-group-id="0419981918-27">)</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="0419981918-29">(</span><span class="mi">23</span><span class="p" data-group-id="0419981918-29">)</span><span class="w"> </span><span class="p" data-group-id="0419981918-4">}</span></code></pre><p>Every data item is initialized, so that no problems arise when a newly created
port is closed (without there being any corresponding socket). This routine is
called when <a href="erlang.html#open_port/2"><code class="inline">open_port({spawn, &quot;uds_drv&quot;},[])</code></a> is called from
Erlang.</p><p>The <code class="inline">uds_command</code> routine is the routine called when an Erlang process sends
data to the port. This routine handles all asynchronous commands when the port
is in <code class="inline">command</code> mode and the sending of all data when the port is in <code class="inline">data</code>
mode:</p><pre><code class="makeup c" translate="no"><span class="p" data-group-id="3611821910-1">(</span><span class="w"> </span><span class="mi">1</span><span class="p" data-group-id="3611821910-1">)</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="kc">void</span><span class="w"> </span><span class="nf">uds_command</span><span class="p" data-group-id="3611821910-2">(</span><span class="no">ErlDrvData</span><span class="w"> </span><span class="n">handle</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">buff</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">bufflen</span><span class="p" data-group-id="3611821910-2">)</span><span class="w">
</span><span class="p" data-group-id="3611821910-3">(</span><span class="w"> </span><span class="mi">2</span><span class="p" data-group-id="3611821910-3">)</span><span class="w"> </span><span class="p" data-group-id="3611821910-4">{</span><span class="w">
</span><span class="p" data-group-id="3611821910-5">(</span><span class="w"> </span><span class="mi">3</span><span class="p" data-group-id="3611821910-5">)</span><span class="w">     </span><span class="no">UdsData</span><span class="w"> </span><span class="o">*</span><span class="n">ud</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="3611821910-6">(</span><span class="no">UdsData</span><span class="w"> </span><span class="o">*</span><span class="p" data-group-id="3611821910-6">)</span><span class="w"> </span><span class="n">handle</span><span class="p">;</span><span class="w">

</span><span class="p" data-group-id="3611821910-7">(</span><span class="w"> </span><span class="mi">4</span><span class="p" data-group-id="3611821910-7">)</span><span class="w">     </span><span class="k">if</span><span class="w"> </span><span class="p" data-group-id="3611821910-8">(</span><span class="n">ud</span><span class="o">-&gt;</span><span class="n">type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">portTypeData</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">ud</span><span class="o">-&gt;</span><span class="n">type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">portTypeIntermediate</span><span class="p" data-group-id="3611821910-8">)</span><span class="w"> </span><span class="p" data-group-id="3611821910-9">{</span><span class="w">
</span><span class="p" data-group-id="3611821910-10">(</span><span class="w"> </span><span class="mi">5</span><span class="p" data-group-id="3611821910-10">)</span><span class="w">         </span><span class="no">DEBUGF</span><span class="p" data-group-id="3611821910-11">(</span><span class="p" data-group-id="3611821910-12">(</span><span class="s">&quot;Passive do_send %d&quot;</span><span class="p">,</span><span class="n">bufflen</span><span class="p" data-group-id="3611821910-12">)</span><span class="p" data-group-id="3611821910-11">)</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="3611821910-13">(</span><span class="w"> </span><span class="mi">6</span><span class="p" data-group-id="3611821910-13">)</span><span class="w">         </span><span class="nf">do_send</span><span class="p" data-group-id="3611821910-14">(</span><span class="n">ud</span><span class="p">,</span><span class="w"> </span><span class="n">buff</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">bufflen</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p" data-group-id="3611821910-14">)</span><span class="p">;</span><span class="w"> </span><span class="cm">/* XXX */</span><span class="w">
</span><span class="p" data-group-id="3611821910-15">(</span><span class="w"> </span><span class="mi">7</span><span class="p" data-group-id="3611821910-15">)</span><span class="w">         </span><span class="k">return</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="3611821910-16">(</span><span class="w"> </span><span class="mi">8</span><span class="p" data-group-id="3611821910-16">)</span><span class="w">     </span><span class="p" data-group-id="3611821910-9">}</span><span class="w">
</span><span class="p" data-group-id="3611821910-17">(</span><span class="w"> </span><span class="mi">9</span><span class="p" data-group-id="3611821910-17">)</span><span class="w">     </span><span class="k">if</span><span class="w"> </span><span class="p" data-group-id="3611821910-18">(</span><span class="n">bufflen</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p" data-group-id="3611821910-18">)</span><span class="w"> </span><span class="p" data-group-id="3611821910-19">{</span><span class="w">
</span><span class="p" data-group-id="3611821910-20">(</span><span class="mi">10</span><span class="p" data-group-id="3611821910-20">)</span><span class="w">         </span><span class="k">return</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="3611821910-21">(</span><span class="mi">11</span><span class="p" data-group-id="3611821910-21">)</span><span class="w">     </span><span class="p" data-group-id="3611821910-19">}</span><span class="w">
</span><span class="p" data-group-id="3611821910-22">(</span><span class="mi">12</span><span class="p" data-group-id="3611821910-22">)</span><span class="w">     </span><span class="k">switch</span><span class="w"> </span><span class="p" data-group-id="3611821910-23">(</span><span class="o">*</span><span class="n">buff</span><span class="p" data-group-id="3611821910-23">)</span><span class="w"> </span><span class="p" data-group-id="3611821910-24">{</span><span class="w">
</span><span class="p" data-group-id="3611821910-25">(</span><span class="mi">13</span><span class="p" data-group-id="3611821910-25">)</span><span class="w">     </span><span class="k">case</span><span class="w"> </span><span class="ss">&#39;L&#39;</span><span class="p">:</span><span class="w">
</span><span class="p" data-group-id="3611821910-26">(</span><span class="mi">14</span><span class="p" data-group-id="3611821910-26">)</span><span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p" data-group-id="3611821910-27">(</span><span class="n">ud</span><span class="o">-&gt;</span><span class="n">type</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">portTypeUnknown</span><span class="p" data-group-id="3611821910-27">)</span><span class="w"> </span><span class="p" data-group-id="3611821910-28">{</span><span class="w">
</span><span class="p" data-group-id="3611821910-29">(</span><span class="mi">15</span><span class="p" data-group-id="3611821910-29">)</span><span class="w">             </span><span class="nf">driver_failure_posix</span><span class="p" data-group-id="3611821910-30">(</span><span class="n">ud</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span><span class="w"> </span><span class="no">ENOTSUP</span><span class="p" data-group-id="3611821910-30">)</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="3611821910-31">(</span><span class="mi">16</span><span class="p" data-group-id="3611821910-31">)</span><span class="w">             </span><span class="k">return</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="3611821910-32">(</span><span class="mi">17</span><span class="p" data-group-id="3611821910-32">)</span><span class="w">         </span><span class="p" data-group-id="3611821910-28">}</span><span class="w">
</span><span class="p" data-group-id="3611821910-33">(</span><span class="mi">18</span><span class="p" data-group-id="3611821910-33">)</span><span class="w">         </span><span class="nf">uds_command_listen</span><span class="p" data-group-id="3611821910-34">(</span><span class="n">ud</span><span class="p">,</span><span class="n">buff</span><span class="p">,</span><span class="n">bufflen</span><span class="p" data-group-id="3611821910-34">)</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="3611821910-35">(</span><span class="mi">19</span><span class="p" data-group-id="3611821910-35">)</span><span class="w">         </span><span class="k">return</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="3611821910-36">(</span><span class="mi">20</span><span class="p" data-group-id="3611821910-36">)</span><span class="w">     </span><span class="k">case</span><span class="w"> </span><span class="ss">&#39;A&#39;</span><span class="p">:</span><span class="w">
</span><span class="p" data-group-id="3611821910-37">(</span><span class="mi">21</span><span class="p" data-group-id="3611821910-37">)</span><span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p" data-group-id="3611821910-38">(</span><span class="n">ud</span><span class="o">-&gt;</span><span class="n">type</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">portTypeUnknown</span><span class="p" data-group-id="3611821910-38">)</span><span class="w"> </span><span class="p" data-group-id="3611821910-39">{</span><span class="w">
</span><span class="p" data-group-id="3611821910-40">(</span><span class="mi">22</span><span class="p" data-group-id="3611821910-40">)</span><span class="w">             </span><span class="nf">driver_failure_posix</span><span class="p" data-group-id="3611821910-41">(</span><span class="n">ud</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span><span class="w"> </span><span class="no">ENOTSUP</span><span class="p" data-group-id="3611821910-41">)</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="3611821910-42">(</span><span class="mi">23</span><span class="p" data-group-id="3611821910-42">)</span><span class="w">             </span><span class="k">return</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="3611821910-43">(</span><span class="mi">24</span><span class="p" data-group-id="3611821910-43">)</span><span class="w">         </span><span class="p" data-group-id="3611821910-39">}</span><span class="w">
</span><span class="p" data-group-id="3611821910-44">(</span><span class="mi">25</span><span class="p" data-group-id="3611821910-44">)</span><span class="w">         </span><span class="nf">uds_command_accept</span><span class="p" data-group-id="3611821910-45">(</span><span class="n">ud</span><span class="p">,</span><span class="n">buff</span><span class="p">,</span><span class="n">bufflen</span><span class="p" data-group-id="3611821910-45">)</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="3611821910-46">(</span><span class="mi">26</span><span class="p" data-group-id="3611821910-46">)</span><span class="w">         </span><span class="k">return</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="3611821910-47">(</span><span class="mi">27</span><span class="p" data-group-id="3611821910-47">)</span><span class="w">     </span><span class="k">case</span><span class="w"> </span><span class="ss">&#39;C&#39;</span><span class="p">:</span><span class="w">
</span><span class="p" data-group-id="3611821910-48">(</span><span class="mi">28</span><span class="p" data-group-id="3611821910-48">)</span><span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p" data-group-id="3611821910-49">(</span><span class="n">ud</span><span class="o">-&gt;</span><span class="n">type</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">portTypeUnknown</span><span class="p" data-group-id="3611821910-49">)</span><span class="w"> </span><span class="p" data-group-id="3611821910-50">{</span><span class="w">
</span><span class="p" data-group-id="3611821910-51">(</span><span class="mi">29</span><span class="p" data-group-id="3611821910-51">)</span><span class="w">             </span><span class="nf">driver_failure_posix</span><span class="p" data-group-id="3611821910-52">(</span><span class="n">ud</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span><span class="w"> </span><span class="no">ENOTSUP</span><span class="p" data-group-id="3611821910-52">)</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="3611821910-53">(</span><span class="mi">30</span><span class="p" data-group-id="3611821910-53">)</span><span class="w">             </span><span class="k">return</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="3611821910-54">(</span><span class="mi">31</span><span class="p" data-group-id="3611821910-54">)</span><span class="w">         </span><span class="p" data-group-id="3611821910-50">}</span><span class="w">
</span><span class="p" data-group-id="3611821910-55">(</span><span class="mi">32</span><span class="p" data-group-id="3611821910-55">)</span><span class="w">         </span><span class="nf">uds_command_connect</span><span class="p" data-group-id="3611821910-56">(</span><span class="n">ud</span><span class="p">,</span><span class="n">buff</span><span class="p">,</span><span class="n">bufflen</span><span class="p" data-group-id="3611821910-56">)</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="3611821910-57">(</span><span class="mi">33</span><span class="p" data-group-id="3611821910-57">)</span><span class="w">         </span><span class="k">return</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="3611821910-58">(</span><span class="mi">34</span><span class="p" data-group-id="3611821910-58">)</span><span class="w">     </span><span class="k">case</span><span class="w"> </span><span class="ss">&#39;S&#39;</span><span class="p">:</span><span class="w">
</span><span class="p" data-group-id="3611821910-59">(</span><span class="mi">35</span><span class="p" data-group-id="3611821910-59">)</span><span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p" data-group-id="3611821910-60">(</span><span class="n">ud</span><span class="o">-&gt;</span><span class="n">type</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">portTypeCommand</span><span class="p" data-group-id="3611821910-60">)</span><span class="w"> </span><span class="p" data-group-id="3611821910-61">{</span><span class="w">
</span><span class="p" data-group-id="3611821910-62">(</span><span class="mi">36</span><span class="p" data-group-id="3611821910-62">)</span><span class="w">             </span><span class="nf">driver_failure_posix</span><span class="p" data-group-id="3611821910-63">(</span><span class="n">ud</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span><span class="w"> </span><span class="no">ENOTSUP</span><span class="p" data-group-id="3611821910-63">)</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="3611821910-64">(</span><span class="mi">37</span><span class="p" data-group-id="3611821910-64">)</span><span class="w">             </span><span class="k">return</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="3611821910-65">(</span><span class="mi">38</span><span class="p" data-group-id="3611821910-65">)</span><span class="w">         </span><span class="p" data-group-id="3611821910-61">}</span><span class="w">
</span><span class="p" data-group-id="3611821910-66">(</span><span class="mi">39</span><span class="p" data-group-id="3611821910-66">)</span><span class="w">         </span><span class="nf">do_send</span><span class="p" data-group-id="3611821910-67">(</span><span class="n">ud</span><span class="p">,</span><span class="w"> </span><span class="n">buff</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">bufflen</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p" data-group-id="3611821910-67">)</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="3611821910-68">(</span><span class="mi">40</span><span class="p" data-group-id="3611821910-68">)</span><span class="w">         </span><span class="k">return</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="3611821910-69">(</span><span class="mi">41</span><span class="p" data-group-id="3611821910-69">)</span><span class="w">     </span><span class="k">case</span><span class="w"> </span><span class="ss">&#39;R&#39;</span><span class="p">:</span><span class="w">
</span><span class="p" data-group-id="3611821910-70">(</span><span class="mi">42</span><span class="p" data-group-id="3611821910-70">)</span><span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p" data-group-id="3611821910-71">(</span><span class="n">ud</span><span class="o">-&gt;</span><span class="n">type</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">portTypeCommand</span><span class="p" data-group-id="3611821910-71">)</span><span class="w"> </span><span class="p" data-group-id="3611821910-72">{</span><span class="w">
</span><span class="p" data-group-id="3611821910-73">(</span><span class="mi">43</span><span class="p" data-group-id="3611821910-73">)</span><span class="w">             </span><span class="nf">driver_failure_posix</span><span class="p" data-group-id="3611821910-74">(</span><span class="n">ud</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span><span class="w"> </span><span class="no">ENOTSUP</span><span class="p" data-group-id="3611821910-74">)</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="3611821910-75">(</span><span class="mi">44</span><span class="p" data-group-id="3611821910-75">)</span><span class="w">             </span><span class="k">return</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="3611821910-76">(</span><span class="mi">45</span><span class="p" data-group-id="3611821910-76">)</span><span class="w">         </span><span class="p" data-group-id="3611821910-72">}</span><span class="w">
</span><span class="p" data-group-id="3611821910-77">(</span><span class="mi">46</span><span class="p" data-group-id="3611821910-77">)</span><span class="w">         </span><span class="nf">do_recv</span><span class="p" data-group-id="3611821910-78">(</span><span class="n">ud</span><span class="p" data-group-id="3611821910-78">)</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="3611821910-79">(</span><span class="mi">47</span><span class="p" data-group-id="3611821910-79">)</span><span class="w">         </span><span class="k">return</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="3611821910-80">(</span><span class="mi">48</span><span class="p" data-group-id="3611821910-80">)</span><span class="w">     </span><span class="ss">default</span><span class="p">:</span><span class="w">
</span><span class="p" data-group-id="3611821910-81">(</span><span class="mi">49</span><span class="p" data-group-id="3611821910-81">)</span><span class="w">         </span><span class="k">return</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="3611821910-82">(</span><span class="mi">50</span><span class="p" data-group-id="3611821910-82">)</span><span class="w">     </span><span class="p" data-group-id="3611821910-24">}</span><span class="w">
</span><span class="p" data-group-id="3611821910-83">(</span><span class="mi">51</span><span class="p" data-group-id="3611821910-83">)</span><span class="w"> </span><span class="p" data-group-id="3611821910-4">}</span></code></pre><p>The command routine takes three parameters; the handle returned for the port by
<code class="inline">uds_start</code>, which is a pointer to the internal port structure, the data buffer,
and the length of the data buffer. The buffer is the data sent from Erlang (a
list of bytes) converted to an C array (of bytes).</p><p>If Erlang sends, for example, the list <code class="inline">[$a,$b,$c]</code> to the port, the <code class="inline">bufflen</code>
variable is <code class="inline">3</code> and the <code class="inline">buff</code> variable contains <code class="inline">{'a','b','c'}</code> (no <code class="inline">NULL</code>
termination). Usually the first byte is used as an opcode, which is the case in
this driver too (at least when the port is in <code class="inline">command</code> mode). The opcodes are
defined as follows:</p><ul><li><p><strong><code class="inline">'L'&lt;socket name&gt;</code></strong> - Creates and listens on socket with the specified
name.</p></li><li><p><strong><code class="inline">'A'&lt;listen number as 32-bit big-endian&gt;</code></strong> - Accepts from the listen socket
identified by the specified identification number. The identification number
is retrieved with the <code class="inline">uds_control</code> routine.</p></li><li><p><strong><code class="inline">'C'&lt;socket name&gt;</code></strong> - Connects to the socket named &lt;socket name&gt;.</p></li><li><p><strong><code class="inline">'S'&lt;data&gt;</code></strong> - Sends the data &lt;data&gt; on the connected/accepted socket (in
<code class="inline">command</code> mode). The sending is acknowledged when the data has left this
process.</p></li><li><p><strong><code class="inline">'R'</code></strong> - Receives one packet of data.</p></li></ul><p>&quot;One packet of data&quot; in command <code class="inline">'R'</code> can be explained as follows. This driver
always sends data packaged with a 4 byte header containing a big-endian 32-bit
integer that represents the length of the data in the packet. There is no need
for different packet sizes or some kind of streamed mode, as this driver is for
the distribution only. Why is the header word coded explicitly in big-endian
when a UDS socket is local to the host? It is good practice when writing a
distribution driver, as distribution in practice usually crosses the host
boundaries.</p><p>On line 4-8 is handled the case where the port is in <code class="inline">data</code> mode or
<code class="inline">intermediate</code> mode and the remaining routine handles the different commands.
The routine uses the <code class="inline">driver_failure_posix()</code> routine to report errors (see, for
example, line 15). Notice that the failure routines make a call to the
<code class="inline">uds_stop</code> routine, which will remove the internal port data. The handle (and
the casted handle <code class="inline">ud</code>) is therefore <em>invalid pointers</em> after a <code class="inline">driver_failure</code>
call and we should <em>return immediately</em>. The runtime system will send exit
signals to all linked processes.</p><p>The <code class="inline">uds_input</code> routine is called when data is available on a file descriptor
previously passed to the <code class="inline">driver_select</code> routine. This occurs typically when a
read command is issued and no data is available. The <code class="inline">do_recv</code> routine is as
follows:</p><pre><code class="makeup c" translate="no"><span class="p" data-group-id="7973696237-1">(</span><span class="w"> </span><span class="mi">1</span><span class="p" data-group-id="7973696237-1">)</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="kc">void</span><span class="w"> </span><span class="nf">do_recv</span><span class="p" data-group-id="7973696237-2">(</span><span class="no">UdsData</span><span class="w"> </span><span class="o">*</span><span class="n">ud</span><span class="p" data-group-id="7973696237-2">)</span><span class="w">
</span><span class="p" data-group-id="7973696237-3">(</span><span class="w"> </span><span class="mi">2</span><span class="p" data-group-id="7973696237-3">)</span><span class="w"> </span><span class="p" data-group-id="7973696237-4">{</span><span class="w">
</span><span class="p" data-group-id="7973696237-5">(</span><span class="w"> </span><span class="mi">3</span><span class="p" data-group-id="7973696237-5">)</span><span class="w">     </span><span class="kt">int</span><span class="w"> </span><span class="n">res</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="7973696237-6">(</span><span class="w"> </span><span class="mi">4</span><span class="p" data-group-id="7973696237-6">)</span><span class="w">     </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">ibuf</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="7973696237-7">(</span><span class="w"> </span><span class="mi">5</span><span class="p" data-group-id="7973696237-7">)</span><span class="w">     </span><span class="nf">for</span><span class="p" data-group-id="7973696237-8">(</span><span class="p">;</span><span class="p">;</span><span class="p" data-group-id="7973696237-8">)</span><span class="w"> </span><span class="p" data-group-id="7973696237-9">{</span><span class="w">
</span><span class="p" data-group-id="7973696237-10">(</span><span class="w"> </span><span class="mi">6</span><span class="p" data-group-id="7973696237-10">)</span><span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p" data-group-id="7973696237-11">(</span><span class="p" data-group-id="7973696237-12">(</span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">buffered_read_package</span><span class="p" data-group-id="7973696237-13">(</span><span class="n">ud</span><span class="p">,</span><span class="o">&amp;</span><span class="n">ibuf</span><span class="p" data-group-id="7973696237-13">)</span><span class="p" data-group-id="7973696237-12">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p" data-group-id="7973696237-11">)</span><span class="w"> </span><span class="p" data-group-id="7973696237-14">{</span><span class="w">
</span><span class="p" data-group-id="7973696237-15">(</span><span class="w"> </span><span class="mi">7</span><span class="p" data-group-id="7973696237-15">)</span><span class="w">             </span><span class="k">if</span><span class="w"> </span><span class="p" data-group-id="7973696237-16">(</span><span class="n">res</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="no">NORMAL_READ_FAILURE</span><span class="p" data-group-id="7973696237-16">)</span><span class="w"> </span><span class="p" data-group-id="7973696237-17">{</span><span class="w">
</span><span class="p" data-group-id="7973696237-18">(</span><span class="w"> </span><span class="mi">8</span><span class="p" data-group-id="7973696237-18">)</span><span class="w">                 </span><span class="nf">driver_select</span><span class="p" data-group-id="7973696237-19">(</span><span class="n">ud</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="7973696237-20">(</span><span class="no">ErlDrvEvent</span><span class="p" data-group-id="7973696237-20">)</span><span class="w"> </span><span class="n">ud</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="no">DO_READ</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p" data-group-id="7973696237-19">)</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="7973696237-21">(</span><span class="w"> </span><span class="mi">9</span><span class="p" data-group-id="7973696237-21">)</span><span class="w">             </span><span class="p" data-group-id="7973696237-17">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p" data-group-id="7973696237-22">{</span><span class="w">
</span><span class="p" data-group-id="7973696237-23">(</span><span class="mi">10</span><span class="p" data-group-id="7973696237-23">)</span><span class="w">                 </span><span class="nf">driver_failure_eof</span><span class="p" data-group-id="7973696237-24">(</span><span class="n">ud</span><span class="o">-&gt;</span><span class="n">port</span><span class="p" data-group-id="7973696237-24">)</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="7973696237-25">(</span><span class="mi">11</span><span class="p" data-group-id="7973696237-25">)</span><span class="w">             </span><span class="p" data-group-id="7973696237-22">}</span><span class="w">
</span><span class="p" data-group-id="7973696237-26">(</span><span class="mi">12</span><span class="p" data-group-id="7973696237-26">)</span><span class="w">             </span><span class="k">return</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="7973696237-27">(</span><span class="mi">13</span><span class="p" data-group-id="7973696237-27">)</span><span class="w">         </span><span class="p" data-group-id="7973696237-14">}</span><span class="w">
</span><span class="p" data-group-id="7973696237-28">(</span><span class="mi">14</span><span class="p" data-group-id="7973696237-28">)</span><span class="w">         </span><span class="cm">/* Got a package */</span><span class="w">
</span><span class="p" data-group-id="7973696237-29">(</span><span class="mi">15</span><span class="p" data-group-id="7973696237-29">)</span><span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p" data-group-id="7973696237-30">(</span><span class="n">ud</span><span class="o">-&gt;</span><span class="n">type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">portTypeCommand</span><span class="p" data-group-id="7973696237-30">)</span><span class="w"> </span><span class="p" data-group-id="7973696237-31">{</span><span class="w">
</span><span class="p" data-group-id="7973696237-32">(</span><span class="mi">16</span><span class="p" data-group-id="7973696237-32">)</span><span class="w">             </span><span class="n">ibuf</span><span class="p" data-group-id="7973696237-33">[</span><span class="o">-</span><span class="mi">1</span><span class="p" data-group-id="7973696237-33">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">&#39;</span><span class="no">R</span><span class="err">&#39;</span><span class="p">;</span><span class="w"> </span><span class="cm">/* There is always room for a single byte
(17)                                opcode before the actual buffer
(18)                                (where the packet header was) */</span><span class="w">
</span><span class="p" data-group-id="7973696237-34">(</span><span class="mi">19</span><span class="p" data-group-id="7973696237-34">)</span><span class="w">             </span><span class="nf">driver_output</span><span class="p" data-group-id="7973696237-35">(</span><span class="n">ud</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span><span class="n">ibuf</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p" data-group-id="7973696237-35">)</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="7973696237-36">(</span><span class="mi">20</span><span class="p" data-group-id="7973696237-36">)</span><span class="w">             </span><span class="nf">driver_select</span><span class="p" data-group-id="7973696237-37">(</span><span class="n">ud</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="7973696237-38">(</span><span class="no">ErlDrvEvent</span><span class="p" data-group-id="7973696237-38">)</span><span class="w"> </span><span class="n">ud</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="no">DO_READ</span><span class="p">,</span><span class="mi">0</span><span class="p" data-group-id="7973696237-37">)</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="7973696237-39">(</span><span class="mi">21</span><span class="p" data-group-id="7973696237-39">)</span><span class="w">             </span><span class="k">return</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="7973696237-40">(</span><span class="mi">22</span><span class="p" data-group-id="7973696237-40">)</span><span class="w">         </span><span class="p" data-group-id="7973696237-31">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p" data-group-id="7973696237-41">{</span><span class="w">
</span><span class="p" data-group-id="7973696237-42">(</span><span class="mi">23</span><span class="p" data-group-id="7973696237-42">)</span><span class="w">             </span><span class="n">ibuf</span><span class="p" data-group-id="7973696237-43">[</span><span class="o">-</span><span class="mi">1</span><span class="p" data-group-id="7973696237-43">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">DIST_MAGIC_RECV_TAG</span><span class="p">;</span><span class="w"> </span><span class="cm">/* XXX */</span><span class="w">
</span><span class="p" data-group-id="7973696237-44">(</span><span class="mi">24</span><span class="p" data-group-id="7973696237-44">)</span><span class="w">             </span><span class="nf">driver_output</span><span class="p" data-group-id="7973696237-45">(</span><span class="n">ud</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span><span class="n">ibuf</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p" data-group-id="7973696237-45">)</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="7973696237-46">(</span><span class="mi">25</span><span class="p" data-group-id="7973696237-46">)</span><span class="w">             </span><span class="nf">driver_select</span><span class="p" data-group-id="7973696237-47">(</span><span class="n">ud</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="7973696237-48">(</span><span class="no">ErlDrvEvent</span><span class="p" data-group-id="7973696237-48">)</span><span class="w"> </span><span class="n">ud</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="no">DO_READ</span><span class="p">,</span><span class="mi">1</span><span class="p" data-group-id="7973696237-47">)</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="7973696237-49">(</span><span class="mi">26</span><span class="p" data-group-id="7973696237-49">)</span><span class="w">         </span><span class="p" data-group-id="7973696237-41">}</span><span class="w">
</span><span class="p" data-group-id="7973696237-50">(</span><span class="mi">27</span><span class="p" data-group-id="7973696237-50">)</span><span class="w">     </span><span class="p" data-group-id="7973696237-9">}</span><span class="w">
</span><span class="p" data-group-id="7973696237-51">(</span><span class="mi">28</span><span class="p" data-group-id="7973696237-51">)</span><span class="w"> </span><span class="p" data-group-id="7973696237-4">}</span></code></pre><p>The routine tries to read data until a packet is read or the
<code class="inline">buffered_read_package</code> routine returns a <code class="inline">NORMAL_READ_FAILURE</code> (an internally
defined constant for the module, which means that the read operation resulted in
an <code class="inline">EWOULDBLOCK</code>). If the port is in <code class="inline">command</code> mode, the reading stops when one
package is read. If the port is in <code class="inline">data</code> mode, the reading continues until the
socket buffer is empty (read failure). If no more data can be read and more is
wanted (which is always the case when the socket is in <code class="inline">data</code> mode),
<code class="inline">driver_select</code> is called to make the <code class="inline">uds_input</code> callback be called when more
data is available for reading.</p><p>When the port is in <code class="inline">data</code> mode, all data is sent to Erlang in a format that
suits the distribution. In fact, the raw data will never reach any Erlang
process, but will be translated/interpreted by the emulator itself and then
delivered in the correct format to the correct processes. In the current
emulator version, received data is to be tagged with a single byte of 100. That
is what the macro <code class="inline">DIST_MAGIC_RECV_TAG</code> is defined to. The tagging of data in
the distribution can be changed in the future.</p><p>The <code class="inline">uds_input</code> routine handles other input events (like non-blocking <code class="inline">accept</code>),
but most importantly handle data arriving at the socket by calling <code class="inline">do_recv</code>:</p><pre><code class="makeup c" translate="no"><span class="p" data-group-id="8496865859-1">(</span><span class="w"> </span><span class="mi">1</span><span class="p" data-group-id="8496865859-1">)</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="kc">void</span><span class="w"> </span><span class="nf">uds_input</span><span class="p" data-group-id="8496865859-2">(</span><span class="no">ErlDrvData</span><span class="w"> </span><span class="n">handle</span><span class="p">,</span><span class="w"> </span><span class="no">ErlDrvEvent</span><span class="w"> </span><span class="n">event</span><span class="p" data-group-id="8496865859-2">)</span><span class="w">
</span><span class="p" data-group-id="8496865859-3">(</span><span class="w"> </span><span class="mi">2</span><span class="p" data-group-id="8496865859-3">)</span><span class="w"> </span><span class="p" data-group-id="8496865859-4">{</span><span class="w">
</span><span class="p" data-group-id="8496865859-5">(</span><span class="w"> </span><span class="mi">3</span><span class="p" data-group-id="8496865859-5">)</span><span class="w">     </span><span class="no">UdsData</span><span class="w"> </span><span class="o">*</span><span class="n">ud</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="8496865859-6">(</span><span class="no">UdsData</span><span class="w"> </span><span class="o">*</span><span class="p" data-group-id="8496865859-6">)</span><span class="w"> </span><span class="n">handle</span><span class="p">;</span><span class="w">

</span><span class="p" data-group-id="8496865859-7">(</span><span class="w"> </span><span class="mi">4</span><span class="p" data-group-id="8496865859-7">)</span><span class="w">     </span><span class="k">if</span><span class="w"> </span><span class="p" data-group-id="8496865859-8">(</span><span class="n">ud</span><span class="o">-&gt;</span><span class="n">type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">portTypeListener</span><span class="p" data-group-id="8496865859-8">)</span><span class="w"> </span><span class="p" data-group-id="8496865859-9">{</span><span class="w">
</span><span class="p" data-group-id="8496865859-10">(</span><span class="w"> </span><span class="mi">5</span><span class="p" data-group-id="8496865859-10">)</span><span class="w">         </span><span class="no">UdsData</span><span class="w"> </span><span class="o">*</span><span class="n">ad</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ud</span><span class="o">-&gt;</span><span class="n">partner</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="8496865859-11">(</span><span class="w"> </span><span class="mi">6</span><span class="p" data-group-id="8496865859-11">)</span><span class="w">         </span><span class="k">struct</span><span class="w"> </span><span class="n">sockaddr_un</span><span class="w"> </span><span class="n">peer</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="8496865859-12">(</span><span class="w"> </span><span class="mi">7</span><span class="p" data-group-id="8496865859-12">)</span><span class="w">         </span><span class="kt">int</span><span class="w"> </span><span class="n">pl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">sizeof</span><span class="p" data-group-id="8496865859-13">(</span><span class="k">struct</span><span class="w"> </span><span class="n">sockaddr_un</span><span class="p" data-group-id="8496865859-13">)</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="8496865859-14">(</span><span class="w"> </span><span class="mi">8</span><span class="p" data-group-id="8496865859-14">)</span><span class="w">         </span><span class="kt">int</span><span class="w"> </span><span class="n">fd</span><span class="p">;</span><span class="w">

</span><span class="p" data-group-id="8496865859-15">(</span><span class="w"> </span><span class="mi">9</span><span class="p" data-group-id="8496865859-15">)</span><span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p" data-group-id="8496865859-16">(</span><span class="p" data-group-id="8496865859-17">(</span><span class="n">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">accept</span><span class="p" data-group-id="8496865859-18">(</span><span class="n">ud</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="8496865859-19">(</span><span class="k">struct</span><span class="w"> </span><span class="n">sockaddr</span><span class="w"> </span><span class="o">*</span><span class="p" data-group-id="8496865859-19">)</span><span class="w"> </span><span class="o">&amp;</span><span class="n">peer</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pl</span><span class="p" data-group-id="8496865859-18">)</span><span class="p" data-group-id="8496865859-17">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p" data-group-id="8496865859-16">)</span><span class="w"> </span><span class="p" data-group-id="8496865859-20">{</span><span class="w">
</span><span class="p" data-group-id="8496865859-21">(</span><span class="mi">10</span><span class="p" data-group-id="8496865859-21">)</span><span class="w">             </span><span class="k">if</span><span class="w"> </span><span class="p" data-group-id="8496865859-22">(</span><span class="n">errno</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="no">EWOULDBLOCK</span><span class="p" data-group-id="8496865859-22">)</span><span class="w"> </span><span class="p" data-group-id="8496865859-23">{</span><span class="w">
</span><span class="p" data-group-id="8496865859-24">(</span><span class="mi">11</span><span class="p" data-group-id="8496865859-24">)</span><span class="w">                 </span><span class="nf">driver_failure_posix</span><span class="p" data-group-id="8496865859-25">(</span><span class="n">ud</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span><span class="w"> </span><span class="n">errno</span><span class="p" data-group-id="8496865859-25">)</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="8496865859-26">(</span><span class="mi">12</span><span class="p" data-group-id="8496865859-26">)</span><span class="w">                 </span><span class="k">return</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="8496865859-27">(</span><span class="mi">13</span><span class="p" data-group-id="8496865859-27">)</span><span class="w">             </span><span class="p" data-group-id="8496865859-23">}</span><span class="w">
</span><span class="p" data-group-id="8496865859-28">(</span><span class="mi">14</span><span class="p" data-group-id="8496865859-28">)</span><span class="w">             </span><span class="k">return</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="8496865859-29">(</span><span class="mi">15</span><span class="p" data-group-id="8496865859-29">)</span><span class="w">         </span><span class="p" data-group-id="8496865859-20">}</span><span class="w">
</span><span class="p" data-group-id="8496865859-30">(</span><span class="mi">16</span><span class="p" data-group-id="8496865859-30">)</span><span class="w">         </span><span class="no">SET_NONBLOCKING</span><span class="p" data-group-id="8496865859-31">(</span><span class="n">fd</span><span class="p" data-group-id="8496865859-31">)</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="8496865859-32">(</span><span class="mi">17</span><span class="p" data-group-id="8496865859-32">)</span><span class="w">         </span><span class="n">ad</span><span class="o">-&gt;</span><span class="n">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fd</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="8496865859-33">(</span><span class="mi">18</span><span class="p" data-group-id="8496865859-33">)</span><span class="w">         </span><span class="n">ad</span><span class="o">-&gt;</span><span class="n">partner</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">NULL</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="8496865859-34">(</span><span class="mi">19</span><span class="p" data-group-id="8496865859-34">)</span><span class="w">         </span><span class="n">ad</span><span class="o">-&gt;</span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">portTypeCommand</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="8496865859-35">(</span><span class="mi">20</span><span class="p" data-group-id="8496865859-35">)</span><span class="w">         </span><span class="n">ud</span><span class="o">-&gt;</span><span class="n">partner</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">NULL</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="8496865859-36">(</span><span class="mi">21</span><span class="p" data-group-id="8496865859-36">)</span><span class="w">         </span><span class="nf">driver_select</span><span class="p" data-group-id="8496865859-37">(</span><span class="n">ud</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="8496865859-38">(</span><span class="no">ErlDrvEvent</span><span class="p" data-group-id="8496865859-38">)</span><span class="w"> </span><span class="n">ud</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="no">DO_READ</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p" data-group-id="8496865859-37">)</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="8496865859-39">(</span><span class="mi">22</span><span class="p" data-group-id="8496865859-39">)</span><span class="w">         </span><span class="nf">driver_output</span><span class="p" data-group-id="8496865859-40">(</span><span class="n">ad</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Aok&quot;</span><span class="p">,</span><span class="mi">3</span><span class="p" data-group-id="8496865859-40">)</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="8496865859-41">(</span><span class="mi">23</span><span class="p" data-group-id="8496865859-41">)</span><span class="w">         </span><span class="k">return</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="8496865859-42">(</span><span class="mi">24</span><span class="p" data-group-id="8496865859-42">)</span><span class="w">     </span><span class="p" data-group-id="8496865859-9">}</span><span class="w">
</span><span class="p" data-group-id="8496865859-43">(</span><span class="mi">25</span><span class="p" data-group-id="8496865859-43">)</span><span class="w">     </span><span class="nf">do_recv</span><span class="p" data-group-id="8496865859-44">(</span><span class="n">ud</span><span class="p" data-group-id="8496865859-44">)</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="8496865859-45">(</span><span class="mi">26</span><span class="p" data-group-id="8496865859-45">)</span><span class="w"> </span><span class="p" data-group-id="8496865859-4">}</span></code></pre><p>The important line is the last line in the function: the <code class="inline">do_read</code> routine is
called to handle new input. The remaining function handles input on a listen
socket, which means that it is to be possible to do an accept on the socket,
which is also recognized as a read event.</p><p>The output mechanisms are similar to the input. The <code class="inline">do_send</code> routine is as
follows:</p><pre><code class="makeup c" translate="no"><span class="p" data-group-id="9832337780-1">(</span><span class="w"> </span><span class="mi">1</span><span class="p" data-group-id="9832337780-1">)</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="kc">void</span><span class="w"> </span><span class="nf">do_send</span><span class="p" data-group-id="9832337780-2">(</span><span class="no">UdsData</span><span class="w"> </span><span class="o">*</span><span class="n">ud</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">buff</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">bufflen</span><span class="p" data-group-id="9832337780-2">)</span><span class="w">
</span><span class="p" data-group-id="9832337780-3">(</span><span class="w"> </span><span class="mi">2</span><span class="p" data-group-id="9832337780-3">)</span><span class="w"> </span><span class="p" data-group-id="9832337780-4">{</span><span class="w">
</span><span class="p" data-group-id="9832337780-5">(</span><span class="w"> </span><span class="mi">3</span><span class="p" data-group-id="9832337780-5">)</span><span class="w">     </span><span class="kt">char</span><span class="w"> </span><span class="n">header</span><span class="p" data-group-id="9832337780-6">[</span><span class="mi">4</span><span class="p" data-group-id="9832337780-6">]</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="9832337780-7">(</span><span class="w"> </span><span class="mi">4</span><span class="p" data-group-id="9832337780-7">)</span><span class="w">     </span><span class="kt">int</span><span class="w"> </span><span class="n">written</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="9832337780-8">(</span><span class="w"> </span><span class="mi">5</span><span class="p" data-group-id="9832337780-8">)</span><span class="w">     </span><span class="no">SysIOVec</span><span class="w"> </span><span class="n">iov</span><span class="p" data-group-id="9832337780-9">[</span><span class="mi">2</span><span class="p" data-group-id="9832337780-9">]</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="9832337780-10">(</span><span class="w"> </span><span class="mi">6</span><span class="p" data-group-id="9832337780-10">)</span><span class="w">     </span><span class="no">ErlIOVec</span><span class="w"> </span><span class="n">eio</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="9832337780-11">(</span><span class="w"> </span><span class="mi">7</span><span class="p" data-group-id="9832337780-11">)</span><span class="w">     </span><span class="no">ErlDrvBinary</span><span class="w"> </span><span class="o">*</span><span class="n">binv</span><span class="p" data-group-id="9832337780-12">[</span><span class="p" data-group-id="9832337780-12">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="9832337780-13">{</span><span class="no">NULL</span><span class="p">,</span><span class="no">NULL</span><span class="p" data-group-id="9832337780-13">}</span><span class="p">;</span><span class="w">

</span><span class="p" data-group-id="9832337780-14">(</span><span class="w"> </span><span class="mi">8</span><span class="p" data-group-id="9832337780-14">)</span><span class="w">     </span><span class="nf">put_packet_length</span><span class="p" data-group-id="9832337780-15">(</span><span class="n">header</span><span class="p">,</span><span class="w"> </span><span class="n">bufflen</span><span class="p" data-group-id="9832337780-15">)</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="9832337780-16">(</span><span class="w"> </span><span class="mi">9</span><span class="p" data-group-id="9832337780-16">)</span><span class="w">     </span><span class="n">iov</span><span class="p" data-group-id="9832337780-17">[</span><span class="mi">0</span><span class="p" data-group-id="9832337780-17">]</span><span class="p">.</span><span class="n">iov_base</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="9832337780-18">(</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p" data-group-id="9832337780-18">)</span><span class="w"> </span><span class="n">header</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="9832337780-19">(</span><span class="mi">10</span><span class="p" data-group-id="9832337780-19">)</span><span class="w">     </span><span class="n">iov</span><span class="p" data-group-id="9832337780-20">[</span><span class="mi">0</span><span class="p" data-group-id="9832337780-20">]</span><span class="p">.</span><span class="n">iov_len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="9832337780-21">(</span><span class="mi">11</span><span class="p" data-group-id="9832337780-21">)</span><span class="w">     </span><span class="n">iov</span><span class="p" data-group-id="9832337780-22">[</span><span class="mi">1</span><span class="p" data-group-id="9832337780-22">]</span><span class="p">.</span><span class="n">iov_base</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">buff</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="9832337780-23">(</span><span class="mi">12</span><span class="p" data-group-id="9832337780-23">)</span><span class="w">     </span><span class="n">iov</span><span class="p" data-group-id="9832337780-24">[</span><span class="mi">1</span><span class="p" data-group-id="9832337780-24">]</span><span class="p">.</span><span class="n">iov_len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bufflen</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="9832337780-25">(</span><span class="mi">13</span><span class="p" data-group-id="9832337780-25">)</span><span class="w">     </span><span class="n">eio</span><span class="p">.</span><span class="n">iov</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iov</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="9832337780-26">(</span><span class="mi">14</span><span class="p" data-group-id="9832337780-26">)</span><span class="w">     </span><span class="n">eio</span><span class="p">.</span><span class="n">binv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">binv</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="9832337780-27">(</span><span class="mi">15</span><span class="p" data-group-id="9832337780-27">)</span><span class="w">     </span><span class="n">eio</span><span class="p">.</span><span class="n">vsize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="9832337780-28">(</span><span class="mi">16</span><span class="p" data-group-id="9832337780-28">)</span><span class="w">     </span><span class="n">eio</span><span class="p">.</span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bufflen</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="9832337780-29">(</span><span class="mi">17</span><span class="p" data-group-id="9832337780-29">)</span><span class="w">     </span><span class="n">written</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="9832337780-30">(</span><span class="mi">18</span><span class="p" data-group-id="9832337780-30">)</span><span class="w">     </span><span class="k">if</span><span class="w"> </span><span class="p" data-group-id="9832337780-31">(</span><span class="nf">driver_sizeq</span><span class="p" data-group-id="9832337780-32">(</span><span class="n">ud</span><span class="o">-&gt;</span><span class="n">port</span><span class="p" data-group-id="9832337780-32">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p" data-group-id="9832337780-31">)</span><span class="w"> </span><span class="p" data-group-id="9832337780-33">{</span><span class="w">
</span><span class="p" data-group-id="9832337780-34">(</span><span class="mi">19</span><span class="p" data-group-id="9832337780-34">)</span><span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p" data-group-id="9832337780-35">(</span><span class="p" data-group-id="9832337780-36">(</span><span class="n">written</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">writev</span><span class="p" data-group-id="9832337780-37">(</span><span class="n">ud</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="n">iov</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p" data-group-id="9832337780-37">)</span><span class="p" data-group-id="9832337780-36">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">eio</span><span class="p">.</span><span class="n">size</span><span class="p" data-group-id="9832337780-35">)</span><span class="w"> </span><span class="p" data-group-id="9832337780-38">{</span><span class="w">
</span><span class="p" data-group-id="9832337780-39">(</span><span class="mi">20</span><span class="p" data-group-id="9832337780-39">)</span><span class="w">             </span><span class="n">ud</span><span class="o">-&gt;</span><span class="n">sent</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">written</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="9832337780-40">(</span><span class="mi">21</span><span class="p" data-group-id="9832337780-40">)</span><span class="w">             </span><span class="k">if</span><span class="w"> </span><span class="p" data-group-id="9832337780-41">(</span><span class="n">ud</span><span class="o">-&gt;</span><span class="n">type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">portTypeCommand</span><span class="p" data-group-id="9832337780-41">)</span><span class="w"> </span><span class="p" data-group-id="9832337780-42">{</span><span class="w">
</span><span class="p" data-group-id="9832337780-43">(</span><span class="mi">22</span><span class="p" data-group-id="9832337780-43">)</span><span class="w">                 </span><span class="nf">driver_output</span><span class="p" data-group-id="9832337780-44">(</span><span class="n">ud</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Sok&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p" data-group-id="9832337780-44">)</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="9832337780-45">(</span><span class="mi">23</span><span class="p" data-group-id="9832337780-45">)</span><span class="w">             </span><span class="p" data-group-id="9832337780-42">}</span><span class="w">
</span><span class="p" data-group-id="9832337780-46">(</span><span class="mi">24</span><span class="p" data-group-id="9832337780-46">)</span><span class="w">             </span><span class="k">return</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="9832337780-47">(</span><span class="mi">25</span><span class="p" data-group-id="9832337780-47">)</span><span class="w">         </span><span class="p" data-group-id="9832337780-38">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p" data-group-id="9832337780-48">(</span><span class="n">written</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p" data-group-id="9832337780-48">)</span><span class="w"> </span><span class="p" data-group-id="9832337780-49">{</span><span class="w">
</span><span class="p" data-group-id="9832337780-50">(</span><span class="mi">26</span><span class="p" data-group-id="9832337780-50">)</span><span class="w">             </span><span class="k">if</span><span class="w"> </span><span class="p" data-group-id="9832337780-51">(</span><span class="n">errno</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="no">EWOULDBLOCK</span><span class="p" data-group-id="9832337780-51">)</span><span class="w"> </span><span class="p" data-group-id="9832337780-52">{</span><span class="w">
</span><span class="p" data-group-id="9832337780-53">(</span><span class="mi">27</span><span class="p" data-group-id="9832337780-53">)</span><span class="w">                 </span><span class="nf">driver_failure_eof</span><span class="p" data-group-id="9832337780-54">(</span><span class="n">ud</span><span class="o">-&gt;</span><span class="n">port</span><span class="p" data-group-id="9832337780-54">)</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="9832337780-55">(</span><span class="mi">28</span><span class="p" data-group-id="9832337780-55">)</span><span class="w">                 </span><span class="k">return</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="9832337780-56">(</span><span class="mi">29</span><span class="p" data-group-id="9832337780-56">)</span><span class="w">             </span><span class="p" data-group-id="9832337780-52">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p" data-group-id="9832337780-57">{</span><span class="w">
</span><span class="p" data-group-id="9832337780-58">(</span><span class="mi">30</span><span class="p" data-group-id="9832337780-58">)</span><span class="w">                 </span><span class="n">written</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="9832337780-59">(</span><span class="mi">31</span><span class="p" data-group-id="9832337780-59">)</span><span class="w">             </span><span class="p" data-group-id="9832337780-57">}</span><span class="w">
</span><span class="p" data-group-id="9832337780-60">(</span><span class="mi">32</span><span class="p" data-group-id="9832337780-60">)</span><span class="w">         </span><span class="p" data-group-id="9832337780-49">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p" data-group-id="9832337780-61">{</span><span class="w">
</span><span class="p" data-group-id="9832337780-62">(</span><span class="mi">33</span><span class="p" data-group-id="9832337780-62">)</span><span class="w">             </span><span class="n">ud</span><span class="o">-&gt;</span><span class="n">sent</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">written</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="9832337780-63">(</span><span class="mi">34</span><span class="p" data-group-id="9832337780-63">)</span><span class="w">         </span><span class="p" data-group-id="9832337780-61">}</span><span class="w">
</span><span class="p" data-group-id="9832337780-64">(</span><span class="mi">35</span><span class="p" data-group-id="9832337780-64">)</span><span class="w">         </span><span class="cm">/* Enqueue remaining */</span><span class="w">
</span><span class="p" data-group-id="9832337780-65">(</span><span class="mi">36</span><span class="p" data-group-id="9832337780-65">)</span><span class="w">     </span><span class="p" data-group-id="9832337780-33">}</span><span class="w">
</span><span class="p" data-group-id="9832337780-66">(</span><span class="mi">37</span><span class="p" data-group-id="9832337780-66">)</span><span class="w">     </span><span class="nf">driver_enqv</span><span class="p" data-group-id="9832337780-67">(</span><span class="n">ud</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">eio</span><span class="p">,</span><span class="w"> </span><span class="n">written</span><span class="p" data-group-id="9832337780-67">)</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="9832337780-68">(</span><span class="mi">38</span><span class="p" data-group-id="9832337780-68">)</span><span class="w">     </span><span class="nf">send_out_queue</span><span class="p" data-group-id="9832337780-69">(</span><span class="n">ud</span><span class="p" data-group-id="9832337780-69">)</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="9832337780-70">(</span><span class="mi">39</span><span class="p" data-group-id="9832337780-70">)</span><span class="w"> </span><span class="p" data-group-id="9832337780-4">}</span></code></pre><p>This driver uses the <code class="inline">writev</code> system call to send data onto the socket. A
combination of <code class="inline">writev</code> and the driver output queues is very convenient. An
<code class="inline">ErlIOVec</code> structure contains a <code class="inline">SysIOVec</code> (which is equivalent to the
<code class="inline">struct iovec</code> structure defined in <code class="inline">uio.h</code>. The <code class="inline">ErlIOVec</code> also contains an
array of <code class="inline">ErlDrvBinary</code> pointers, of the same length as the number of buffers in
the I/O vector itself. One can use this to allocate the binaries for the queue
&quot;manually&quot; in the driver, but here the binary array is filled with <code class="inline">NULL</code> values
(line 7). The runtime system then allocates its own buffers when <code class="inline">driver_enqv</code>
is called (line 37).</p><p>The routine builds an I/O vector containing the header bytes and the buffer (the
opcode has been removed and the buffer length decreased by the output routine).
If the queue is empty, we write the data directly to the socket (or at least try
to). If any data is left, it is stored in the queue and then we try to send the
queue (line 38). An acknowledgement is sent when the message is delivered
completely (line 22). The <code class="inline">send_out_queue</code> sends acknowledgements if the sending
is completed there. If the port is in <code class="inline">command</code> mode, the Erlang code serializes
the send operations so that only one packet can be waiting for delivery at a
time. Therefore the acknowledgement can be sent whenever the queue is empty.</p><p>The <code class="inline">send_out_queue</code> routine is as follows:</p><pre><code class="makeup c" translate="no"><span class="p" data-group-id="9422728573-1">(</span><span class="w"> </span><span class="mi">1</span><span class="p" data-group-id="9422728573-1">)</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">send_out_queue</span><span class="p" data-group-id="9422728573-2">(</span><span class="no">UdsData</span><span class="w"> </span><span class="o">*</span><span class="n">ud</span><span class="p" data-group-id="9422728573-2">)</span><span class="w">
</span><span class="p" data-group-id="9422728573-3">(</span><span class="w"> </span><span class="mi">2</span><span class="p" data-group-id="9422728573-3">)</span><span class="w"> </span><span class="p" data-group-id="9422728573-4">{</span><span class="w">
</span><span class="p" data-group-id="9422728573-5">(</span><span class="w"> </span><span class="mi">3</span><span class="p" data-group-id="9422728573-5">)</span><span class="w">     </span><span class="nf">for</span><span class="p" data-group-id="9422728573-6">(</span><span class="p">;</span><span class="p">;</span><span class="p" data-group-id="9422728573-6">)</span><span class="w"> </span><span class="p" data-group-id="9422728573-7">{</span><span class="w">
</span><span class="p" data-group-id="9422728573-8">(</span><span class="w"> </span><span class="mi">4</span><span class="p" data-group-id="9422728573-8">)</span><span class="w">         </span><span class="kt">int</span><span class="w"> </span><span class="n">vlen</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="9422728573-9">(</span><span class="w"> </span><span class="mi">5</span><span class="p" data-group-id="9422728573-9">)</span><span class="w">         </span><span class="no">SysIOVec</span><span class="w"> </span><span class="o">*</span><span class="n">tmp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">driver_peekq</span><span class="p" data-group-id="9422728573-10">(</span><span class="n">ud</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">vlen</span><span class="p" data-group-id="9422728573-10">)</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="9422728573-11">(</span><span class="w"> </span><span class="mi">6</span><span class="p" data-group-id="9422728573-11">)</span><span class="w">         </span><span class="kt">int</span><span class="w"> </span><span class="n">wrote</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="9422728573-12">(</span><span class="w"> </span><span class="mi">7</span><span class="p" data-group-id="9422728573-12">)</span><span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p" data-group-id="9422728573-13">(</span><span class="n">tmp</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="no">NULL</span><span class="p" data-group-id="9422728573-13">)</span><span class="w"> </span><span class="p" data-group-id="9422728573-14">{</span><span class="w">
</span><span class="p" data-group-id="9422728573-15">(</span><span class="w"> </span><span class="mi">8</span><span class="p" data-group-id="9422728573-15">)</span><span class="w">             </span><span class="nf">driver_select</span><span class="p" data-group-id="9422728573-16">(</span><span class="n">ud</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9422728573-17">(</span><span class="no">ErlDrvEvent</span><span class="p" data-group-id="9422728573-17">)</span><span class="w"> </span><span class="n">ud</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="no">DO_WRITE</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p" data-group-id="9422728573-16">)</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="9422728573-18">(</span><span class="w"> </span><span class="mi">9</span><span class="p" data-group-id="9422728573-18">)</span><span class="w">             </span><span class="k">if</span><span class="w"> </span><span class="p" data-group-id="9422728573-19">(</span><span class="n">ud</span><span class="o">-&gt;</span><span class="n">type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">portTypeCommand</span><span class="p" data-group-id="9422728573-19">)</span><span class="w"> </span><span class="p" data-group-id="9422728573-20">{</span><span class="w">
</span><span class="p" data-group-id="9422728573-21">(</span><span class="mi">10</span><span class="p" data-group-id="9422728573-21">)</span><span class="w">                 </span><span class="nf">driver_output</span><span class="p" data-group-id="9422728573-22">(</span><span class="n">ud</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Sok&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p" data-group-id="9422728573-22">)</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="9422728573-23">(</span><span class="mi">11</span><span class="p" data-group-id="9422728573-23">)</span><span class="w">             </span><span class="p" data-group-id="9422728573-20">}</span><span class="w">
</span><span class="p" data-group-id="9422728573-24">(</span><span class="mi">12</span><span class="p" data-group-id="9422728573-24">)</span><span class="w">             </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="9422728573-25">(</span><span class="mi">13</span><span class="p" data-group-id="9422728573-25">)</span><span class="w">         </span><span class="p" data-group-id="9422728573-14">}</span><span class="w">
</span><span class="p" data-group-id="9422728573-26">(</span><span class="mi">14</span><span class="p" data-group-id="9422728573-26">)</span><span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p" data-group-id="9422728573-27">(</span><span class="n">vlen</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="no">IO_VECTOR_MAX</span><span class="p" data-group-id="9422728573-27">)</span><span class="w"> </span><span class="p" data-group-id="9422728573-28">{</span><span class="w">
</span><span class="p" data-group-id="9422728573-29">(</span><span class="mi">15</span><span class="p" data-group-id="9422728573-29">)</span><span class="w">             </span><span class="n">vlen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">IO_VECTOR_MAX</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="9422728573-30">(</span><span class="mi">16</span><span class="p" data-group-id="9422728573-30">)</span><span class="w">         </span><span class="p" data-group-id="9422728573-28">}</span><span class="w">
</span><span class="p" data-group-id="9422728573-31">(</span><span class="mi">17</span><span class="p" data-group-id="9422728573-31">)</span><span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p" data-group-id="9422728573-32">(</span><span class="p" data-group-id="9422728573-33">(</span><span class="n">wrote</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">writev</span><span class="p" data-group-id="9422728573-34">(</span><span class="n">ud</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="n">tmp</span><span class="p">,</span><span class="w"> </span><span class="n">vlen</span><span class="p" data-group-id="9422728573-34">)</span><span class="p" data-group-id="9422728573-33">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p" data-group-id="9422728573-32">)</span><span class="w"> </span><span class="p" data-group-id="9422728573-35">{</span><span class="w">
</span><span class="p" data-group-id="9422728573-36">(</span><span class="mi">18</span><span class="p" data-group-id="9422728573-36">)</span><span class="w">             </span><span class="k">if</span><span class="w"> </span><span class="p" data-group-id="9422728573-37">(</span><span class="n">errno</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="no">EWOULDBLOCK</span><span class="p" data-group-id="9422728573-37">)</span><span class="w"> </span><span class="p" data-group-id="9422728573-38">{</span><span class="w">
</span><span class="p" data-group-id="9422728573-39">(</span><span class="mi">19</span><span class="p" data-group-id="9422728573-39">)</span><span class="w">                 </span><span class="nf">driver_select</span><span class="p" data-group-id="9422728573-40">(</span><span class="n">ud</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9422728573-41">(</span><span class="no">ErlDrvEvent</span><span class="p" data-group-id="9422728573-41">)</span><span class="w"> </span><span class="n">ud</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">,</span><span class="w">
</span><span class="p" data-group-id="9422728573-42">(</span><span class="mi">20</span><span class="p" data-group-id="9422728573-42">)</span><span class="w">                               </span><span class="no">DO_WRITE</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p" data-group-id="9422728573-40">)</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="9422728573-43">(</span><span class="mi">21</span><span class="p" data-group-id="9422728573-43">)</span><span class="w">                 </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="9422728573-44">(</span><span class="mi">22</span><span class="p" data-group-id="9422728573-44">)</span><span class="w">             </span><span class="p" data-group-id="9422728573-38">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p" data-group-id="9422728573-45">{</span><span class="w">
</span><span class="p" data-group-id="9422728573-46">(</span><span class="mi">23</span><span class="p" data-group-id="9422728573-46">)</span><span class="w">                 </span><span class="nf">driver_failure_eof</span><span class="p" data-group-id="9422728573-47">(</span><span class="n">ud</span><span class="o">-&gt;</span><span class="n">port</span><span class="p" data-group-id="9422728573-47">)</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="9422728573-48">(</span><span class="mi">24</span><span class="p" data-group-id="9422728573-48">)</span><span class="w">                 </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="9422728573-49">(</span><span class="mi">25</span><span class="p" data-group-id="9422728573-49">)</span><span class="w">             </span><span class="p" data-group-id="9422728573-45">}</span><span class="w">
</span><span class="p" data-group-id="9422728573-50">(</span><span class="mi">26</span><span class="p" data-group-id="9422728573-50">)</span><span class="w">         </span><span class="p" data-group-id="9422728573-35">}</span><span class="w">
</span><span class="p" data-group-id="9422728573-51">(</span><span class="mi">27</span><span class="p" data-group-id="9422728573-51">)</span><span class="w">         </span><span class="nf">driver_deq</span><span class="p" data-group-id="9422728573-52">(</span><span class="n">ud</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span><span class="w"> </span><span class="n">wrote</span><span class="p" data-group-id="9422728573-52">)</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="9422728573-53">(</span><span class="mi">28</span><span class="p" data-group-id="9422728573-53">)</span><span class="w">         </span><span class="n">ud</span><span class="o">-&gt;</span><span class="n">sent</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">wrote</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="9422728573-54">(</span><span class="mi">29</span><span class="p" data-group-id="9422728573-54">)</span><span class="w">     </span><span class="p" data-group-id="9422728573-7">}</span><span class="w">
</span><span class="p" data-group-id="9422728573-55">(</span><span class="mi">30</span><span class="p" data-group-id="9422728573-55">)</span><span class="w"> </span><span class="p" data-group-id="9422728573-4">}</span></code></pre><p>We simply pick out an I/O vector from the queue (which is the whole queue as a
<code class="inline">SysIOVec</code>). If the I/O vector is too long (<code class="inline">IO_VECTOR_MAX</code> is defined to 16),
the vector length is decreased (line 15), otherwise the <code class="inline">writev</code> call (line 17)
fails. Writing is tried and anything written is dequeued (line 27). If the write
fails with <code class="inline">EWOULDBLOCK</code> (notice that all sockets are in non-blocking mode),
<code class="inline">driver_select</code> is called to make the <code class="inline">uds_output</code> routine be called when there
is space to write again.</p><p>We continue trying to write until the queue is empty or the writing blocks.</p><p>The routine above is called from the <code class="inline">uds_output</code> routine:</p><pre><code class="makeup c" translate="no"><span class="p" data-group-id="1928680458-1">(</span><span class="w"> </span><span class="mi">1</span><span class="p" data-group-id="1928680458-1">)</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="kc">void</span><span class="w"> </span><span class="nf">uds_output</span><span class="p" data-group-id="1928680458-2">(</span><span class="no">ErlDrvData</span><span class="w"> </span><span class="n">handle</span><span class="p">,</span><span class="w"> </span><span class="no">ErlDrvEvent</span><span class="w"> </span><span class="n">event</span><span class="p" data-group-id="1928680458-2">)</span><span class="w">
</span><span class="p" data-group-id="1928680458-3">(</span><span class="w"> </span><span class="mi">2</span><span class="p" data-group-id="1928680458-3">)</span><span class="w"> </span><span class="p" data-group-id="1928680458-4">{</span><span class="w">
</span><span class="p" data-group-id="1928680458-5">(</span><span class="w"> </span><span class="mi">3</span><span class="p" data-group-id="1928680458-5">)</span><span class="w">    </span><span class="no">UdsData</span><span class="w"> </span><span class="o">*</span><span class="n">ud</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="1928680458-6">(</span><span class="no">UdsData</span><span class="w"> </span><span class="o">*</span><span class="p" data-group-id="1928680458-6">)</span><span class="w"> </span><span class="n">handle</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="1928680458-7">(</span><span class="w"> </span><span class="mi">4</span><span class="p" data-group-id="1928680458-7">)</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p" data-group-id="1928680458-8">(</span><span class="n">ud</span><span class="o">-&gt;</span><span class="n">type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">portTypeConnector</span><span class="p" data-group-id="1928680458-8">)</span><span class="w"> </span><span class="p" data-group-id="1928680458-9">{</span><span class="w">
</span><span class="p" data-group-id="1928680458-10">(</span><span class="w"> </span><span class="mi">5</span><span class="p" data-group-id="1928680458-10">)</span><span class="w">        </span><span class="n">ud</span><span class="o">-&gt;</span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">portTypeCommand</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="1928680458-11">(</span><span class="w"> </span><span class="mi">6</span><span class="p" data-group-id="1928680458-11">)</span><span class="w">        </span><span class="nf">driver_select</span><span class="p" data-group-id="1928680458-12">(</span><span class="n">ud</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="1928680458-13">(</span><span class="no">ErlDrvEvent</span><span class="p" data-group-id="1928680458-13">)</span><span class="w"> </span><span class="n">ud</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="no">DO_WRITE</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p" data-group-id="1928680458-12">)</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="1928680458-14">(</span><span class="w"> </span><span class="mi">7</span><span class="p" data-group-id="1928680458-14">)</span><span class="w">        </span><span class="nf">driver_output</span><span class="p" data-group-id="1928680458-15">(</span><span class="n">ud</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Cok&quot;</span><span class="p">,</span><span class="mi">3</span><span class="p" data-group-id="1928680458-15">)</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="1928680458-16">(</span><span class="w"> </span><span class="mi">8</span><span class="p" data-group-id="1928680458-16">)</span><span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="1928680458-17">(</span><span class="w"> </span><span class="mi">9</span><span class="p" data-group-id="1928680458-17">)</span><span class="w">    </span><span class="p" data-group-id="1928680458-9">}</span><span class="w">
</span><span class="p" data-group-id="1928680458-18">(</span><span class="mi">10</span><span class="p" data-group-id="1928680458-18">)</span><span class="w">    </span><span class="nf">send_out_queue</span><span class="p" data-group-id="1928680458-19">(</span><span class="n">ud</span><span class="p" data-group-id="1928680458-19">)</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="1928680458-20">(</span><span class="mi">11</span><span class="p" data-group-id="1928680458-20">)</span><span class="w"> </span><span class="p" data-group-id="1928680458-4">}</span></code></pre><p>The routine is simple: it first handles the fact that the output select will
concern a socket in the business of connecting (and the connecting blocked). If
the socket is in a connected state, it simply sends the output queue. This
routine is called when it is possible to write to a socket where we have an
output queue, so there is no question what to do.</p><p>The driver implements a control interface, which is a synchronous interface
called when Erlang calls <a href="erlang.html#port_control/3"><code class="inline">erlang:port_control/3</code></a>. Only this interface can
control the driver when it is in <code class="inline">data</code> mode. It can be called with the
following opcodes:</p><ul><li><p><strong><code class="inline">'C'</code></strong> - Sets port in <code class="inline">command</code> mode.</p></li><li><p><strong><code class="inline">'I'</code></strong> - Sets port in <code class="inline">intermediate</code> mode.</p></li><li><p><strong><code class="inline">'D'</code></strong> - Sets port in <code class="inline">data</code> mode.</p></li><li><p><strong><code class="inline">'N'</code></strong> - Gets identification number for listen port. This identification
number is used in an accept command to the driver. It is returned as a
big-endian 32-bit integer, which is the file identifier for the listen socket.</p></li><li><p><strong><code class="inline">'S'</code></strong> - Gets statistics, which is the number of bytes received, the number
of bytes sent, and the number of bytes pending in the output queue. This data
is used when the distribution checks that a connection is alive (ticking). The
statistics is returned as three 32-bit big-endian integers.</p></li><li><p><strong><code class="inline">'T'</code></strong> - Sends a tick message, which is a packet of length 0. Ticking is
done when the port is in <code class="inline">data</code> mode, so the command for sending data cannot
be used (besides it ignores zero length packages in <code class="inline">command</code> mode). This is
used by the ticker to send dummy data when no other traffic is present.</p><p><em>Note:</em> It is important that the interface for sending ticks is not blocking.
This implementation uses <a href="erlang.html#port_control/3"><code class="inline">erlang:port_control/3</code></a>, which does not block the
caller. If <code class="inline">erlang:port_command</code> is used, use <a href="erlang.html#port_command/3"><code class="inline">erlang:port_command/3</code></a> and pass
<code class="inline">[force]</code> as option list; otherwise the caller can be blocked indefinitely on
a busy port and prevent the system from taking down a connection that is not
functioning.</p></li><li><p><strong><code class="inline">'R'</code></strong> - Gets creation number of a listen socket, which is used to dig out
the number stored in the lock file to differentiate between invocations of
Erlang nodes with the same name.</p></li></ul><p>The control interface gets a buffer to return its value in, but is free to
allocate its own buffer if the provided one is too small. The <code class="inline">uds_control</code> code
is as follows:</p><pre><code class="makeup c" translate="no"><span class="p" data-group-id="1311255755-1">(</span><span class="w"> </span><span class="mi">1</span><span class="p" data-group-id="1311255755-1">)</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">uds_control</span><span class="p" data-group-id="1311255755-2">(</span><span class="no">ErlDrvData</span><span class="w"> </span><span class="n">handle</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">command</span><span class="p">,</span><span class="w">
</span><span class="p" data-group-id="1311255755-3">(</span><span class="w"> </span><span class="mi">2</span><span class="p" data-group-id="1311255755-3">)</span><span class="w">                        </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">count</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="o">*</span><span class="w"> </span><span class="n">res</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">res_size</span><span class="p" data-group-id="1311255755-2">)</span><span class="w">
</span><span class="p" data-group-id="1311255755-4">(</span><span class="w"> </span><span class="mi">3</span><span class="p" data-group-id="1311255755-4">)</span><span class="w"> </span><span class="p" data-group-id="1311255755-5">{</span><span class="w">
</span><span class="p" data-group-id="1311255755-6">(</span><span class="w"> </span><span class="mi">4</span><span class="p" data-group-id="1311255755-6">)</span><span class="w"> </span><span class="cm">/* Local macro to ensure large enough buffer. */</span><span class="w">
</span><span class="p" data-group-id="1311255755-7">(</span><span class="w"> </span><span class="mi">5</span><span class="p" data-group-id="1311255755-7">)</span><span class="w"> </span><span class="kp">#define</span><span class="w"> </span><span class="no">ENSURE</span><span class="p" data-group-id="1311255755-8">(</span><span class="no">N</span><span class="p" data-group-id="1311255755-8">)</span><span class="w">                               </span><span class="err">\</span><span class="w">
</span><span class="p" data-group-id="1311255755-9">(</span><span class="w"> </span><span class="mi">6</span><span class="p" data-group-id="1311255755-9">)</span><span class="w">    </span><span class="k">do</span><span class="w"> </span><span class="p" data-group-id="1311255755-10">{</span><span class="w">                                         </span><span class="err">\</span><span class="w">
</span><span class="p" data-group-id="1311255755-11">(</span><span class="w"> </span><span class="mi">7</span><span class="p" data-group-id="1311255755-11">)</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p" data-group-id="1311255755-12">(</span><span class="n">res_size</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="no">N</span><span class="p" data-group-id="1311255755-12">)</span><span class="w"> </span><span class="p" data-group-id="1311255755-13">{</span><span class="w">                      </span><span class="err">\</span><span class="w">
</span><span class="p" data-group-id="1311255755-14">(</span><span class="w"> </span><span class="mi">8</span><span class="p" data-group-id="1311255755-14">)</span><span class="w">            </span><span class="o">*</span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">ALLOC</span><span class="p" data-group-id="1311255755-15">(</span><span class="no">N</span><span class="p" data-group-id="1311255755-15">)</span><span class="p">;</span><span class="w">                     </span><span class="err">\</span><span class="w">
</span><span class="p" data-group-id="1311255755-16">(</span><span class="w"> </span><span class="mi">9</span><span class="p" data-group-id="1311255755-16">)</span><span class="w">        </span><span class="p" data-group-id="1311255755-13">}</span><span class="w">                                        </span><span class="err">\</span><span class="w">
</span><span class="p" data-group-id="1311255755-17">(</span><span class="mi">10</span><span class="p" data-group-id="1311255755-17">)</span><span class="w">    </span><span class="p" data-group-id="1311255755-10">}</span><span class="w"> </span><span class="nf">while</span><span class="p" data-group-id="1311255755-18">(</span><span class="mi">0</span><span class="p" data-group-id="1311255755-18">)</span><span class="w">

</span><span class="p" data-group-id="1311255755-19">(</span><span class="mi">11</span><span class="p" data-group-id="1311255755-19">)</span><span class="w">    </span><span class="no">UdsData</span><span class="w"> </span><span class="o">*</span><span class="n">ud</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="1311255755-20">(</span><span class="no">UdsData</span><span class="w"> </span><span class="o">*</span><span class="p" data-group-id="1311255755-20">)</span><span class="w"> </span><span class="n">handle</span><span class="p">;</span><span class="w">

</span><span class="p" data-group-id="1311255755-21">(</span><span class="mi">12</span><span class="p" data-group-id="1311255755-21">)</span><span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p" data-group-id="1311255755-22">(</span><span class="n">command</span><span class="p" data-group-id="1311255755-22">)</span><span class="w"> </span><span class="p" data-group-id="1311255755-23">{</span><span class="w">
</span><span class="p" data-group-id="1311255755-24">(</span><span class="mi">13</span><span class="p" data-group-id="1311255755-24">)</span><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="ss">&#39;S&#39;</span><span class="p">:</span><span class="w">
</span><span class="p" data-group-id="1311255755-25">(</span><span class="mi">14</span><span class="p" data-group-id="1311255755-25">)</span><span class="w">        </span><span class="p" data-group-id="1311255755-26">{</span><span class="w">
</span><span class="p" data-group-id="1311255755-27">(</span><span class="mi">15</span><span class="p" data-group-id="1311255755-27">)</span><span class="w">            </span><span class="no">ENSURE</span><span class="p" data-group-id="1311255755-28">(</span><span class="mi">13</span><span class="p" data-group-id="1311255755-28">)</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="1311255755-29">(</span><span class="mi">16</span><span class="p" data-group-id="1311255755-29">)</span><span class="w">            </span><span class="o">*</span><span class="o">*</span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="1311255755-30">(</span><span class="mi">17</span><span class="p" data-group-id="1311255755-30">)</span><span class="w">            </span><span class="nf">put_packet_length</span><span class="p" data-group-id="1311255755-31">(</span><span class="p" data-group-id="1311255755-32">(</span><span class="o">*</span><span class="n">res</span><span class="p" data-group-id="1311255755-32">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">ud</span><span class="o">-&gt;</span><span class="n">received</span><span class="p" data-group-id="1311255755-31">)</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="1311255755-33">(</span><span class="mi">18</span><span class="p" data-group-id="1311255755-33">)</span><span class="w">            </span><span class="nf">put_packet_length</span><span class="p" data-group-id="1311255755-34">(</span><span class="p" data-group-id="1311255755-35">(</span><span class="o">*</span><span class="n">res</span><span class="p" data-group-id="1311255755-35">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="n">ud</span><span class="o">-&gt;</span><span class="n">sent</span><span class="p" data-group-id="1311255755-34">)</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="1311255755-36">(</span><span class="mi">19</span><span class="p" data-group-id="1311255755-36">)</span><span class="w">            </span><span class="nf">put_packet_length</span><span class="p" data-group-id="1311255755-37">(</span><span class="p" data-group-id="1311255755-38">(</span><span class="o">*</span><span class="n">res</span><span class="p" data-group-id="1311255755-38">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">9</span><span class="p">,</span><span class="w"> </span><span class="nf">driver_sizeq</span><span class="p" data-group-id="1311255755-39">(</span><span class="n">ud</span><span class="o">-&gt;</span><span class="n">port</span><span class="p" data-group-id="1311255755-39">)</span><span class="p" data-group-id="1311255755-37">)</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="1311255755-40">(</span><span class="mi">20</span><span class="p" data-group-id="1311255755-40">)</span><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="mi">13</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="1311255755-41">(</span><span class="mi">21</span><span class="p" data-group-id="1311255755-41">)</span><span class="w">        </span><span class="p" data-group-id="1311255755-26">}</span><span class="w">
</span><span class="p" data-group-id="1311255755-42">(</span><span class="mi">22</span><span class="p" data-group-id="1311255755-42">)</span><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="ss">&#39;C&#39;</span><span class="p">:</span><span class="w">
</span><span class="p" data-group-id="1311255755-43">(</span><span class="mi">23</span><span class="p" data-group-id="1311255755-43">)</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p" data-group-id="1311255755-44">(</span><span class="n">ud</span><span class="o">-&gt;</span><span class="n">type</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">portTypeCommand</span><span class="p" data-group-id="1311255755-44">)</span><span class="w"> </span><span class="p" data-group-id="1311255755-45">{</span><span class="w">
</span><span class="p" data-group-id="1311255755-46">(</span><span class="mi">24</span><span class="p" data-group-id="1311255755-46">)</span><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nf">report_control_error</span><span class="p" data-group-id="1311255755-47">(</span><span class="n">res</span><span class="p">,</span><span class="w"> </span><span class="n">res_size</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;einval&quot;</span><span class="p" data-group-id="1311255755-47">)</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="1311255755-48">(</span><span class="mi">25</span><span class="p" data-group-id="1311255755-48">)</span><span class="w">        </span><span class="p" data-group-id="1311255755-45">}</span><span class="w">
</span><span class="p" data-group-id="1311255755-49">(</span><span class="mi">26</span><span class="p" data-group-id="1311255755-49">)</span><span class="w">        </span><span class="n">ud</span><span class="o">-&gt;</span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">portTypeCommand</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="1311255755-50">(</span><span class="mi">27</span><span class="p" data-group-id="1311255755-50">)</span><span class="w">        </span><span class="nf">driver_select</span><span class="p" data-group-id="1311255755-51">(</span><span class="n">ud</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="1311255755-52">(</span><span class="no">ErlDrvEvent</span><span class="p" data-group-id="1311255755-52">)</span><span class="w"> </span><span class="n">ud</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="no">DO_READ</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p" data-group-id="1311255755-51">)</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="1311255755-53">(</span><span class="mi">28</span><span class="p" data-group-id="1311255755-53">)</span><span class="w">        </span><span class="no">ENSURE</span><span class="p" data-group-id="1311255755-54">(</span><span class="mi">1</span><span class="p" data-group-id="1311255755-54">)</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="1311255755-55">(</span><span class="mi">29</span><span class="p" data-group-id="1311255755-55">)</span><span class="w">        </span><span class="o">*</span><span class="o">*</span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="1311255755-56">(</span><span class="mi">30</span><span class="p" data-group-id="1311255755-56">)</span><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="1311255755-57">(</span><span class="mi">31</span><span class="p" data-group-id="1311255755-57">)</span><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="ss">&#39;I&#39;</span><span class="p">:</span><span class="w">
</span><span class="p" data-group-id="1311255755-58">(</span><span class="mi">32</span><span class="p" data-group-id="1311255755-58">)</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p" data-group-id="1311255755-59">(</span><span class="n">ud</span><span class="o">-&gt;</span><span class="n">type</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">portTypeCommand</span><span class="p" data-group-id="1311255755-59">)</span><span class="w"> </span><span class="p" data-group-id="1311255755-60">{</span><span class="w">
</span><span class="p" data-group-id="1311255755-61">(</span><span class="mi">33</span><span class="p" data-group-id="1311255755-61">)</span><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nf">report_control_error</span><span class="p" data-group-id="1311255755-62">(</span><span class="n">res</span><span class="p">,</span><span class="w"> </span><span class="n">res_size</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;einval&quot;</span><span class="p" data-group-id="1311255755-62">)</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="1311255755-63">(</span><span class="mi">34</span><span class="p" data-group-id="1311255755-63">)</span><span class="w">        </span><span class="p" data-group-id="1311255755-60">}</span><span class="w">
</span><span class="p" data-group-id="1311255755-64">(</span><span class="mi">35</span><span class="p" data-group-id="1311255755-64">)</span><span class="w">        </span><span class="n">ud</span><span class="o">-&gt;</span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">portTypeIntermediate</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="1311255755-65">(</span><span class="mi">36</span><span class="p" data-group-id="1311255755-65">)</span><span class="w">        </span><span class="nf">driver_select</span><span class="p" data-group-id="1311255755-66">(</span><span class="n">ud</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="1311255755-67">(</span><span class="no">ErlDrvEvent</span><span class="p" data-group-id="1311255755-67">)</span><span class="w"> </span><span class="n">ud</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="no">DO_READ</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p" data-group-id="1311255755-66">)</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="1311255755-68">(</span><span class="mi">37</span><span class="p" data-group-id="1311255755-68">)</span><span class="w">        </span><span class="no">ENSURE</span><span class="p" data-group-id="1311255755-69">(</span><span class="mi">1</span><span class="p" data-group-id="1311255755-69">)</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="1311255755-70">(</span><span class="mi">38</span><span class="p" data-group-id="1311255755-70">)</span><span class="w">        </span><span class="o">*</span><span class="o">*</span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="1311255755-71">(</span><span class="mi">39</span><span class="p" data-group-id="1311255755-71">)</span><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="1311255755-72">(</span><span class="mi">40</span><span class="p" data-group-id="1311255755-72">)</span><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="ss">&#39;D&#39;</span><span class="p">:</span><span class="w">
</span><span class="p" data-group-id="1311255755-73">(</span><span class="mi">41</span><span class="p" data-group-id="1311255755-73">)</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p" data-group-id="1311255755-74">(</span><span class="n">ud</span><span class="o">-&gt;</span><span class="n">type</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">portTypeCommand</span><span class="p" data-group-id="1311255755-74">)</span><span class="w"> </span><span class="p" data-group-id="1311255755-75">{</span><span class="w">
</span><span class="p" data-group-id="1311255755-76">(</span><span class="mi">42</span><span class="p" data-group-id="1311255755-76">)</span><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nf">report_control_error</span><span class="p" data-group-id="1311255755-77">(</span><span class="n">res</span><span class="p">,</span><span class="w"> </span><span class="n">res_size</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;einval&quot;</span><span class="p" data-group-id="1311255755-77">)</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="1311255755-78">(</span><span class="mi">43</span><span class="p" data-group-id="1311255755-78">)</span><span class="w">        </span><span class="p" data-group-id="1311255755-75">}</span><span class="w">
</span><span class="p" data-group-id="1311255755-79">(</span><span class="mi">44</span><span class="p" data-group-id="1311255755-79">)</span><span class="w">        </span><span class="n">ud</span><span class="o">-&gt;</span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">portTypeData</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="1311255755-80">(</span><span class="mi">45</span><span class="p" data-group-id="1311255755-80">)</span><span class="w">        </span><span class="nf">do_recv</span><span class="p" data-group-id="1311255755-81">(</span><span class="n">ud</span><span class="p" data-group-id="1311255755-81">)</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="1311255755-82">(</span><span class="mi">46</span><span class="p" data-group-id="1311255755-82">)</span><span class="w">        </span><span class="no">ENSURE</span><span class="p" data-group-id="1311255755-83">(</span><span class="mi">1</span><span class="p" data-group-id="1311255755-83">)</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="1311255755-84">(</span><span class="mi">47</span><span class="p" data-group-id="1311255755-84">)</span><span class="w">        </span><span class="o">*</span><span class="o">*</span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="1311255755-85">(</span><span class="mi">48</span><span class="p" data-group-id="1311255755-85">)</span><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="1311255755-86">(</span><span class="mi">49</span><span class="p" data-group-id="1311255755-86">)</span><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="ss">&#39;N&#39;</span><span class="p">:</span><span class="w">
</span><span class="p" data-group-id="1311255755-87">(</span><span class="mi">50</span><span class="p" data-group-id="1311255755-87">)</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p" data-group-id="1311255755-88">(</span><span class="n">ud</span><span class="o">-&gt;</span><span class="n">type</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">portTypeListener</span><span class="p" data-group-id="1311255755-88">)</span><span class="w"> </span><span class="p" data-group-id="1311255755-89">{</span><span class="w">
</span><span class="p" data-group-id="1311255755-90">(</span><span class="mi">51</span><span class="p" data-group-id="1311255755-90">)</span><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nf">report_control_error</span><span class="p" data-group-id="1311255755-91">(</span><span class="n">res</span><span class="p">,</span><span class="w"> </span><span class="n">res_size</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;einval&quot;</span><span class="p" data-group-id="1311255755-91">)</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="1311255755-92">(</span><span class="mi">52</span><span class="p" data-group-id="1311255755-92">)</span><span class="w">        </span><span class="p" data-group-id="1311255755-89">}</span><span class="w">
</span><span class="p" data-group-id="1311255755-93">(</span><span class="mi">53</span><span class="p" data-group-id="1311255755-93">)</span><span class="w">        </span><span class="no">ENSURE</span><span class="p" data-group-id="1311255755-94">(</span><span class="mi">5</span><span class="p" data-group-id="1311255755-94">)</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="1311255755-95">(</span><span class="mi">54</span><span class="p" data-group-id="1311255755-95">)</span><span class="w">        </span><span class="p" data-group-id="1311255755-96">(</span><span class="o">*</span><span class="n">res</span><span class="p" data-group-id="1311255755-96">)</span><span class="p" data-group-id="1311255755-97">[</span><span class="mi">0</span><span class="p" data-group-id="1311255755-97">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="1311255755-98">(</span><span class="mi">55</span><span class="p" data-group-id="1311255755-98">)</span><span class="w">        </span><span class="nf">put_packet_length</span><span class="p" data-group-id="1311255755-99">(</span><span class="p" data-group-id="1311255755-100">(</span><span class="o">*</span><span class="n">res</span><span class="p" data-group-id="1311255755-100">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">ud</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p" data-group-id="1311255755-99">)</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="1311255755-101">(</span><span class="mi">56</span><span class="p" data-group-id="1311255755-101">)</span><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="1311255755-102">(</span><span class="mi">57</span><span class="p" data-group-id="1311255755-102">)</span><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="ss">&#39;T&#39;</span><span class="p">:</span><span class="w"> </span><span class="cm">/* tick */</span><span class="w">
</span><span class="p" data-group-id="1311255755-103">(</span><span class="mi">58</span><span class="p" data-group-id="1311255755-103">)</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p" data-group-id="1311255755-104">(</span><span class="n">ud</span><span class="o">-&gt;</span><span class="n">type</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">portTypeData</span><span class="p" data-group-id="1311255755-104">)</span><span class="w"> </span><span class="p" data-group-id="1311255755-105">{</span><span class="w">
</span><span class="p" data-group-id="1311255755-106">(</span><span class="mi">59</span><span class="p" data-group-id="1311255755-106">)</span><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nf">report_control_error</span><span class="p" data-group-id="1311255755-107">(</span><span class="n">res</span><span class="p">,</span><span class="w"> </span><span class="n">res_size</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;einval&quot;</span><span class="p" data-group-id="1311255755-107">)</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="1311255755-108">(</span><span class="mi">60</span><span class="p" data-group-id="1311255755-108">)</span><span class="w">        </span><span class="p" data-group-id="1311255755-105">}</span><span class="w">
</span><span class="p" data-group-id="1311255755-109">(</span><span class="mi">61</span><span class="p" data-group-id="1311255755-109">)</span><span class="w">        </span><span class="nf">do_send</span><span class="p" data-group-id="1311255755-110">(</span><span class="n">ud</span><span class="p">,</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p" data-group-id="1311255755-110">)</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="1311255755-111">(</span><span class="mi">62</span><span class="p" data-group-id="1311255755-111">)</span><span class="w">        </span><span class="no">ENSURE</span><span class="p" data-group-id="1311255755-112">(</span><span class="mi">1</span><span class="p" data-group-id="1311255755-112">)</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="1311255755-113">(</span><span class="mi">63</span><span class="p" data-group-id="1311255755-113">)</span><span class="w">        </span><span class="o">*</span><span class="o">*</span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="1311255755-114">(</span><span class="mi">64</span><span class="p" data-group-id="1311255755-114">)</span><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="1311255755-115">(</span><span class="mi">65</span><span class="p" data-group-id="1311255755-115">)</span><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="ss">&#39;R&#39;</span><span class="p">:</span><span class="w">
</span><span class="p" data-group-id="1311255755-116">(</span><span class="mi">66</span><span class="p" data-group-id="1311255755-116">)</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p" data-group-id="1311255755-117">(</span><span class="n">ud</span><span class="o">-&gt;</span><span class="n">type</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">portTypeListener</span><span class="p" data-group-id="1311255755-117">)</span><span class="w"> </span><span class="p" data-group-id="1311255755-118">{</span><span class="w">
</span><span class="p" data-group-id="1311255755-119">(</span><span class="mi">67</span><span class="p" data-group-id="1311255755-119">)</span><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nf">report_control_error</span><span class="p" data-group-id="1311255755-120">(</span><span class="n">res</span><span class="p">,</span><span class="w"> </span><span class="n">res_size</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;einval&quot;</span><span class="p" data-group-id="1311255755-120">)</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="1311255755-121">(</span><span class="mi">68</span><span class="p" data-group-id="1311255755-121">)</span><span class="w">        </span><span class="p" data-group-id="1311255755-118">}</span><span class="w">
</span><span class="p" data-group-id="1311255755-122">(</span><span class="mi">69</span><span class="p" data-group-id="1311255755-122">)</span><span class="w">        </span><span class="no">ENSURE</span><span class="p" data-group-id="1311255755-123">(</span><span class="mi">2</span><span class="p" data-group-id="1311255755-123">)</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="1311255755-124">(</span><span class="mi">70</span><span class="p" data-group-id="1311255755-124">)</span><span class="w">        </span><span class="p" data-group-id="1311255755-125">(</span><span class="o">*</span><span class="n">res</span><span class="p" data-group-id="1311255755-125">)</span><span class="p" data-group-id="1311255755-126">[</span><span class="mi">0</span><span class="p" data-group-id="1311255755-126">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="1311255755-127">(</span><span class="mi">71</span><span class="p" data-group-id="1311255755-127">)</span><span class="w">        </span><span class="p" data-group-id="1311255755-128">(</span><span class="o">*</span><span class="n">res</span><span class="p" data-group-id="1311255755-128">)</span><span class="p" data-group-id="1311255755-129">[</span><span class="mi">1</span><span class="p" data-group-id="1311255755-129">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ud</span><span class="o">-&gt;</span><span class="n">creation</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="1311255755-130">(</span><span class="mi">72</span><span class="p" data-group-id="1311255755-130">)</span><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="1311255755-131">(</span><span class="mi">73</span><span class="p" data-group-id="1311255755-131">)</span><span class="w">    </span><span class="ss">default</span><span class="p">:</span><span class="w">
</span><span class="p" data-group-id="1311255755-132">(</span><span class="mi">74</span><span class="p" data-group-id="1311255755-132">)</span><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nf">report_control_error</span><span class="p" data-group-id="1311255755-133">(</span><span class="n">res</span><span class="p">,</span><span class="w"> </span><span class="n">res_size</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;einval&quot;</span><span class="p" data-group-id="1311255755-133">)</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="1311255755-134">(</span><span class="mi">75</span><span class="p" data-group-id="1311255755-134">)</span><span class="w">    </span><span class="p" data-group-id="1311255755-23">}</span><span class="w">
</span><span class="p" data-group-id="1311255755-135">(</span><span class="mi">76</span><span class="p" data-group-id="1311255755-135">)</span><span class="w"> </span><span class="kp">#undef</span><span class="w"> </span><span class="no">ENSURE</span><span class="w">
</span><span class="p" data-group-id="1311255755-136">(</span><span class="mi">77</span><span class="p" data-group-id="1311255755-136">)</span><span class="w"> </span><span class="p" data-group-id="1311255755-5">}</span></code></pre><p>The macro <code class="inline">ENSURE</code> (line 5-10) is used to ensure that the buffer is large enough
for the answer. We switch on the command and take actions. We always have read
select active on a port in <code class="inline">data</code> mode (achieved by calling <code class="inline">do_recv</code> on line
45), but we turn off read selection in <code class="inline">intermediate</code> and <code class="inline">command</code> modes (line
27 and 36).</p><p>The rest of the driver is more or less UDS-specific and not of general interest.</p><h2 id="putting-it-all-together" class="section-heading">
  <a href="#putting-it-all-together" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Putting It All Together</span>
</h2>
<p>To test the distribution, the <a href="../../apps/kernel/net_kernel.html#start/1"><code class="inline">net_kernel:start/1</code></a> function can be used. It is
useful, as it starts the distribution on a running system, where
tracing/debugging can be performed. The <a href="../../apps/kernel/net_kernel.html#start/1"><code class="inline">net_kernel:start/1</code></a> routine takes a
list as its single argument. The list first element in the list is to be the
node name (without the &quot;@hostname&quot;) as an atom. The second (and last) element is
to be one of the atoms <code class="inline">shortnames</code> or <code class="inline">longnames</code>. In the example case,
<code class="inline">shortnames</code> is preferred.</p><p>For <code class="inline">net_kernel</code> to find out which distribution module to use, command-line
argument <code class="inline">-proto_dist</code> is used. It is followed by one or more distribution
module names, with suffix &quot;_dist&quot; removed, that is, <code class="inline">uds_dist</code> as a
distribution module is specified as <code class="inline">-proto_dist uds</code>.</p><p>If no <code class="inline">epmd</code> (TCP port mapper daemon) is used, also command-line option
<code class="inline">-no_epmd</code> is to be specified, which makes Erlang skip the <code class="inline">epmd</code> startup, both
as an OS process and as an Erlang ditto.</p><p>The path to the directory where the distribution modules reside must be known at
boot. This can be achieved either by specifying <code class="inline">-pa &lt;path&gt;</code> on the command line
or by building a boot script containing the applications used for your
distribution protocol. (In the <code class="inline">uds_dist</code> protocol, only the <code class="inline">uds_dist</code>
application needs to be added to the script.)</p><p>The distribution starts at boot if all the above is specified and an
<code class="inline">-sname &lt;name&gt;</code> flag is present at the command line.</p><p><em>Example 1:</em></p><pre><code class="text">$ erl -pa $ERL_TOP/lib/kernel/examples/uds_dist/ebin -proto_dist uds -no_epmd
Erlang (BEAM) emulator version 5.0

Eshell V5.0  (abort with ^G)
1&gt; net_kernel:start([bing,shortnames]).
{ok,&lt;0.30.0&gt;}
(bing@hador)2&gt;</code></pre><p><em>Example 2:</em></p><pre><code class="text">$ erl -pa $ERL_TOP/lib/kernel/examples/uds_dist/ebin -proto_dist uds \
      -no_epmd -sname bong
Erlang (BEAM) emulator version 5.0

Eshell V5.0  (abort with ^G)
(bong@hador)1&gt;</code></pre><p>The <code class="inline">ERL_FLAGS</code> environment variable can be used to store the complicated
parameters in:</p><pre><code class="text">$ ERL_FLAGS=-pa $ERL_TOP/lib/kernel/examples/uds_dist/ebin \
      -proto_dist uds -no_epmd
$ export ERL_FLAGS
$ erl -sname bang
Erlang (BEAM) emulator version 5.0

Eshell V5.0  (abort with ^G)
(bang@hador)1&gt;</code></pre><p><code class="inline">ERL_FLAGS</code> should not include the node name.</p>
</div>

<div class="bottom-actions" id="bottom-actions">
  <div class="bottom-actions-item">

      <a href="crash_dump.html" class="bottom-actions-button" rel="prev">
        <span class="subheader">
          ← Previous Page
        </span>
        <span class="title">
How to Interpret the Erlang Crash Dumps
        </span>
      </a>

  </div>
  <div class="bottom-actions-item">

      <a href="alt_disco.html" class="bottom-actions-button" rel="next">
        <span class="subheader">
          Next Page →
        </span>
        <span class="title">
How to Implement an Alternative Node Discovery for Erlang Distribution
        </span>
      </a>

  </div>
</div>
    <footer class="footer">
      <p>

        <span class="line">
          <button class="a-main footer-button display-quick-switch" title="Search HexDocs packages">
            Search HexDocs
          </button>

        </span>
      </p>

      <p class="built-using">
        Built using
        <a href="https://github.com/elixir-lang/ex_doc" title="ExDoc" target="_blank" rel="help noopener" translate="no">ExDoc</a> (v0.37.3) for the

          <a href="https://erlang.org" title="Erlang" target="_blank" translate="no">Erlang programming language</a>

      </p>
<p>Copyright © 1996-2025 <a href="https://www.ericsson.com">Ericsson AB</a></p>
    </footer>
  </div>
</main>
</div>
  <script defer src="https://cdn.jsdelivr.net/npm/mermaid@11.4.1/dist/mermaid.min.js"></script>
  <script>
  let initialized = false;

  window.addEventListener("exdoc:loaded", () => {
      if (!initialized) {
      mermaid.initialize({
          startOnLoad: false,
          theme: document.body.className.includes("dark") ? "dark" : "default"
      });
      initialized = true;
      }

      let id = 0;
      for (const codeEl of document.querySelectorAll("pre code.mermaid")) {
      const preEl = codeEl.parentElement;
      const graphDefinition = codeEl.textContent;
      const graphEl = document.createElement("div");
      const graphId = "mermaid-graph-" + id++;
      mermaid.render(graphId, graphDefinition).then(({svg, bindFunctions}) => {
          graphEl.innerHTML = svg;
          bindFunctions?.(graphEl);
          preEl.insertAdjacentElement("afterend", graphEl);
          preEl.remove();
      });
      }
  });
  </script>

  </body>
</html>
