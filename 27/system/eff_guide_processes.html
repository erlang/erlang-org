<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="ExDoc v0.37.3">
    <meta name="project" content="Erlang System Documentation v27.3.4.1">


<meta name="exdoc:full-text-search-url" content="/doc/search.html?v=27&q=">
<meta name="major-vsn" content="27">
<link rel="canonical" href="https://www.erlang.org/docs/27/system/eff_guide_processes.html" />
<meta name="exdoc:autocomplete" content="off">
    <title>Processes — Erlang System Documentation v27.3.4.1</title>

    <link rel="stylesheet" href="dist/html-erlang-FDBURIED.css" />

    <script defer src="dist/sidebar_items-4A143270.js"></script>
    <script defer src="docs_config.js"></script>
    <script defer src="dist/html-ALU6OERS.js"></script>

  </head>
  <body>
    <script>(()=>{var t="ex_doc:settings",e="dark";var o="dark",s="light";var E="sidebar_state",n="closed";var r="sidebar_width";var a="sidebar-open";var i=new URLSearchParams(window.location.search),S=i.get("theme")||JSON.parse(localStorage.getItem(t)||"{}").theme;(S===o||S!==s&&window.matchMedia("(prefers-color-scheme: dark)").matches)&&document.body.classList.add(e);var d=sessionStorage.getItem(E),A=d!==n&&!window.matchMedia(`screen and (max-width: ${768}px)`).matches;document.body.classList.toggle(a,A);var c=sessionStorage.getItem(r);c&&document.body.style.setProperty("--sidebarWidth",`${c}px`);var p=/(Macintosh|iPhone|iPad|iPod)/.test(window.navigator.userAgent);document.documentElement.classList.toggle("apple-os",p);})();
</script>

<div class="body-wrapper">

<button id="sidebar-menu" class="sidebar-button sidebar-toggle" aria-label="toggle sidebar" aria-controls="sidebar">
  <i class="ri-menu-line ri-lg" title="Collapse/expand sidebar"></i>
</button>

<nav id="sidebar" class="sidebar">

  <div class="sidebar-header">
    <div class="sidebar-projectInfo">

        <a href="../index.html" class="sidebar-projectImage">
          <img src="assets/logo.png" alt="Erlang System Documentation" />
        </a>

      <div>
        <a href="../index.html" class="sidebar-projectName" translate="no">
Erlang System Documentation
        </a>
        <div class="sidebar-projectVersion" translate="no">
          v27.3.4.1
        </div>
      </div>
    </div>
    <ul id="sidebar-list-nav" class="sidebar-list-nav" role="tablist" data-extras=""></ul>
  </div>
</nav>

<output role="status" id="toast"></output>

<main class="content page-extra" id="main" data-type="extras">
  <div id="content" class="content-inner">
    <div class="top-search">
      <div class="search-settings">
        <form class="search-bar" action="search.html">
          <label class="search-label">
            <span class="sr-only">Search documentation of Erlang System Documentation</span>
            <input name="q" type="text" class="search-input" placeholder="Press / to search" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" />
          </label>
          <button type="submit" class="search-button" aria-label="Submit Search" tabindex="-1">
            <i class="ri-search-2-line ri-lg" aria-hidden="true"></i>
          </button>
          <button type="button" tabindex="-1" class="search-close-button" aria-hidden="true">
            <i class="ri-close-line ri-lg" title="Cancel search"></i>
          </button>
        </form>
        <div class="autocomplete">
        </div>
        <button class="icon-settings display-settings">
          <i class="ri-settings-3-line"></i>
          <span class="sr-only">Settings</span>
        </button>
      </div>
    </div>

<div id="top-content">
  <div class="heading-with-actions top-heading">
    <h1>Processes</h1>


      <a href="https://github.com/garazdawi/otp/blob/OTP-27.3.4.1/system/doc/efficiency_guide/eff_guide_processes.md#L1" title="View Source" class="icon-action" rel="help">
        <i class="ri-code-s-slash-line" aria-hidden="true"></i>
        <span class="sr-only">View Source</span>
      </a>

  </div>

<h2 id="creating-an-erlang-process" class="section-heading">
  <a href="#creating-an-erlang-process" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Creating an Erlang Process</span>
</h2>
<p>An Erlang process is lightweight compared to threads and processes in operating
systems.</p><p>A newly spawned Erlang process uses 327 words of memory. The size can be found
as follows:</p><pre><code class="makeup erlang" translate="no"><span class="n">Erlang</span><span class="o">/</span><span class="n">OTP</span><span class="w"> </span><span class="mi">27</span><span class="w"> </span><span class="p" data-group-id="6139440087-1">[</span><span class="ss">erts</span><span class="o">-</span><span class="mf">14.2</span><span class="p">.</span><span class="mi">3</span><span class="p" data-group-id="6139440087-1">]</span><span class="w"> </span><span class="p" data-group-id="6139440087-2">[</span><span class="mi">64</span><span class="o">-</span><span class="ss">bit</span><span class="p" data-group-id="6139440087-2">]</span><span class="w"> </span><span class="p" data-group-id="6139440087-3">[</span><span class="nc">smp</span><span class="p">:</span><span class="mi">8</span><span class="p">:</span><span class="mi">8</span><span class="p" data-group-id="6139440087-3">]</span><span class="w"> </span><span class="p" data-group-id="6139440087-4">[</span><span class="nc">ds</span><span class="p">:</span><span class="mi">8</span><span class="p">:</span><span class="mi">8</span><span class="p">:</span><span class="mi">10</span><span class="p" data-group-id="6139440087-4">]</span><span class="w"> </span><span class="p" data-group-id="6139440087-5">[</span><span class="ss">async</span><span class="o">-</span><span class="nc">threads</span><span class="p">:</span><span class="mi">1</span><span class="p" data-group-id="6139440087-5">]</span><span class="w"> </span><span class="p" data-group-id="6139440087-6">[</span><span class="ss">jit</span><span class="p" data-group-id="6139440087-6">]</span><span class="w">

</span><span class="n">Eshell</span><span class="w"> </span><span class="n">V14</span><span class="p">.</span><span class="mf">2.3</span><span class="w"> </span><span class="p" data-group-id="6139440087-7">(</span><span class="ss">press</span><span class="w"> </span><span class="n">Ctrl</span><span class="o">+</span><span class="n">G</span><span class="w"> </span><span class="ss">to</span><span class="w"> </span><span class="ss">abort</span><span class="p">,</span><span class="w"> </span><span class="ss">type</span><span class="w"> </span><span class="nf">help</span><span class="p" data-group-id="6139440087-8">(</span><span class="p" data-group-id="6139440087-8">)</span><span class="p">.</span><span class="w"> </span><span class="ss">for</span><span class="w"> </span><span class="ss">help</span><span class="p" data-group-id="6139440087-7">)</span><span class="gp unselectable">
1&gt; </span><span class="n">Fun</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">fun</span><span class="p" data-group-id="6139440087-9">(</span><span class="p" data-group-id="6139440087-9">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="k">receive</span><span class="w"> </span><span class="k">after</span><span class="w"> </span><span class="ss">infinity</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="ss">ok</span><span class="w"> </span><span class="k">end</span><span class="w"> </span><span class="k">end</span><span class="p">.</span><span class="w">
</span><span class="p">#</span><span class="n">Fun</span><span class="o">&lt;</span><span class="ss">erl_eval</span><span class="p">.</span><span class="mf">43.39164016</span><span class="o">&gt;</span><span class="gp unselectable">
2&gt; </span><span class="p" data-group-id="6139440087-10">{</span><span class="p">_</span><span class="p">,</span><span class="n">Bytes</span><span class="p" data-group-id="6139440087-10">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">process_info</span><span class="p" data-group-id="6139440087-11">(</span><span class="nf">spawn</span><span class="p" data-group-id="6139440087-12">(</span><span class="n">Fun</span><span class="p" data-group-id="6139440087-12">)</span><span class="p">,</span><span class="w"> </span><span class="nb">memory</span><span class="p" data-group-id="6139440087-11">)</span><span class="p">.</span><span class="w">
</span><span class="p" data-group-id="6139440087-13">{</span><span class="nb">memory</span><span class="p">,</span><span class="mi">2616</span><span class="p" data-group-id="6139440087-13">}</span><span class="gp unselectable">
3&gt; </span><span class="n">Bytes</span><span class="w"> </span><span class="ow">div</span><span class="w"> </span><span class="nc">erlang</span><span class="p">:</span><span class="nf">system_info</span><span class="p" data-group-id="6139440087-14">(</span><span class="ss">wordsize</span><span class="p" data-group-id="6139440087-14">)</span><span class="p">.</span><span class="w">
</span><span class="mi">327</span></code></pre><p>The size includes 233 words for the heap area (which includes the stack). The
garbage collector increases the heap as needed.</p><p>The main (outer) loop for a process <em>must</em> be tail-recursive. Otherwise, the
stack grows until the process terminates.</p><p><strong>DO NOT</strong></p><pre><code class="makeup erlang" translate="no"><span class="nf">loop</span><span class="p" data-group-id="0381272913-1">(</span><span class="p" data-group-id="0381272913-1">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
  </span><span class="k">receive</span><span class="w">
     </span><span class="p" data-group-id="0381272913-2">{</span><span class="ss">sys</span><span class="p">,</span><span class="w"> </span><span class="n">Msg</span><span class="p" data-group-id="0381272913-2">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
         </span><span class="nf">handle_sys_msg</span><span class="p" data-group-id="0381272913-3">(</span><span class="n">Msg</span><span class="p" data-group-id="0381272913-3">)</span><span class="p">,</span><span class="w">
         </span><span class="nf">loop</span><span class="p" data-group-id="0381272913-4">(</span><span class="p" data-group-id="0381272913-4">)</span><span class="p">;</span><span class="w">
     </span><span class="p" data-group-id="0381272913-5">{</span><span class="n">From</span><span class="p">,</span><span class="w"> </span><span class="n">Msg</span><span class="p" data-group-id="0381272913-5">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
          </span><span class="n">Reply</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">handle_msg</span><span class="p" data-group-id="0381272913-6">(</span><span class="n">Msg</span><span class="p" data-group-id="0381272913-6">)</span><span class="p">,</span><span class="w">
          </span><span class="n">From</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="n">Reply</span><span class="p">,</span><span class="w">
          </span><span class="nf">loop</span><span class="p" data-group-id="0381272913-7">(</span><span class="p" data-group-id="0381272913-7">)</span><span class="w">
  </span><span class="k">end</span><span class="p">,</span><span class="w">
  </span><span class="nc">io</span><span class="p">:</span><span class="nf">format</span><span class="p" data-group-id="0381272913-8">(</span><span class="s">&quot;Message is processed</span><span class="si">~n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="0381272913-9">[</span><span class="p" data-group-id="0381272913-9">]</span><span class="p" data-group-id="0381272913-8">)</span><span class="p">.</span></code></pre><p>The call to <a href="../apps/stdlib/io.html#format/2"><code class="inline">io:format/2</code></a> will never be executed, but a return address will
still be pushed to the stack each time <code class="inline">loop/0</code> is called recursively. The
correct tail-recursive version of the function looks as follows:</p><p><strong>DO</strong></p><pre><code class="makeup erlang" translate="no"><span class="nf">loop</span><span class="p" data-group-id="2159946201-1">(</span><span class="p" data-group-id="2159946201-1">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
   </span><span class="k">receive</span><span class="w">
      </span><span class="p" data-group-id="2159946201-2">{</span><span class="ss">sys</span><span class="p">,</span><span class="w"> </span><span class="n">Msg</span><span class="p" data-group-id="2159946201-2">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
         </span><span class="nf">handle_sys_msg</span><span class="p" data-group-id="2159946201-3">(</span><span class="n">Msg</span><span class="p" data-group-id="2159946201-3">)</span><span class="p">,</span><span class="w">
         </span><span class="nf">loop</span><span class="p" data-group-id="2159946201-4">(</span><span class="p" data-group-id="2159946201-4">)</span><span class="p">;</span><span class="w">
      </span><span class="p" data-group-id="2159946201-5">{</span><span class="n">From</span><span class="p">,</span><span class="w"> </span><span class="n">Msg</span><span class="p" data-group-id="2159946201-5">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
         </span><span class="n">Reply</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">handle_msg</span><span class="p" data-group-id="2159946201-6">(</span><span class="n">Msg</span><span class="p" data-group-id="2159946201-6">)</span><span class="p">,</span><span class="w">
         </span><span class="n">From</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="n">Reply</span><span class="p">,</span><span class="w">
         </span><span class="nf">loop</span><span class="p" data-group-id="2159946201-7">(</span><span class="p" data-group-id="2159946201-7">)</span><span class="w">
 </span><span class="k">end</span><span class="p">.</span></code></pre><h3 id="initial-heap-size" class="section-heading">
  <a href="#initial-heap-size" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Initial Heap Size</span>
</h3>
<p>The default initial heap size of 233 words is quite conservative to support
Erlang systems with hundreds of thousands or even millions of processes. The
garbage collector grows and shrinks the heap as needed.</p><p>In a system that use comparatively few processes, performance <em>might</em> be
improved by increasing the minimum heap size using either the <code class="inline">+h</code> option for
<a href="../apps/erts/erl_cmd.html">erl</a> or on a process-per-process basis using the
<code class="inline">min_heap_size</code> option for <a href="../apps/erts/erlang.html#spawn_opt/4">spawn_opt/4</a>.</p><p>The gain is twofold:</p><ul><li>Although the garbage collector grows the heap, it grows it step-by-step, which
is more costly than directly establishing a larger heap when the process is
spawned.</li><li>The garbage collector can also shrink the heap if it is much larger than the
amount of data stored on it; setting the minimum heap size prevents that.</li></ul><section role="note" class="admonition warning"><h4 class="admonition-title warning">Warning</h4><p>The runtime system probably uses more memory, and because garbage collections occur
less frequently, huge binaries can be kept much longer.</p><p>This optimization is not to be attempted without proper measurements.</p></section><p>In systems with many processes, computation tasks that run for a short time can
be spawned off into a new process with a higher minimum heap size. When the
process is done, it sends the result of the computation to another process and
terminates. If the minimum heap size is calculated properly, the process might
not have to do any garbage collections at all.</p><h2 id="sending-messages" class="section-heading">
  <a href="#sending-messages" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Sending Messages</span>
</h2>
<p>All data in messages sent between Erlang processes is copied, except for
<a href="binaryhandling.html#refc_binary">refc binaries</a> and
<a href="eff_guide_processes.html#literal-pool">literals</a> on the same Erlang node.</p><p>When a message is sent to a process on another Erlang node, it is
first encoded to the <a href="../apps/erts/erl_ext_dist.html">Erlang External Format</a>
before being sent through a TCP/IP socket. The receiving Erlang node
decodes the message and distributes it to the correct process.</p><h2 id="receiving-messages" class="section-heading">
  <a href="#receiving-messages" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Receiving messages</span>
</h2>
<p>The cost of receiving messages depends on how complicated the <code class="inline">receive</code>
expression is. A simple expression that matches any message is very cheap
because it retrieves the first message in the message queue:</p><p><strong>DO</strong></p><pre><code class="makeup erlang" translate="no"><span class="k">receive</span><span class="w">
    </span><span class="n">Message</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nf">handle_msg</span><span class="p" data-group-id="0220858631-1">(</span><span class="n">Message</span><span class="p" data-group-id="0220858631-1">)</span><span class="w">
</span><span class="k">end</span><span class="p">.</span></code></pre><p>However, this is not always convenient: we can receive a message that we do not
know how to handle at this point, so it is common to only match the messages we
expect:</p><pre><code class="makeup erlang" translate="no"><span class="k">receive</span><span class="w">
    </span><span class="p" data-group-id="7819509591-1">{</span><span class="n">Tag</span><span class="p">,</span><span class="w"> </span><span class="n">Message</span><span class="p" data-group-id="7819509591-1">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nf">handle_msg</span><span class="p" data-group-id="7819509591-2">(</span><span class="n">Message</span><span class="p" data-group-id="7819509591-2">)</span><span class="w">
</span><span class="k">end</span><span class="p">.</span></code></pre><p>While this is convenient it means that the entire message queue must be searched
until it finds a matching message. This is very expensive for processes with
long message queues, so there is an optimization for the common case of
sending a request and waiting for a response shortly after:</p><p><strong>DO</strong></p><pre><code class="makeup erlang" translate="no"><span class="n">MRef</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">monitor</span><span class="p" data-group-id="5877790165-1">(</span><span class="ss">process</span><span class="p">,</span><span class="w"> </span><span class="n">Process</span><span class="p" data-group-id="5877790165-1">)</span><span class="p">,</span><span class="w">
</span><span class="n">Process</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="p" data-group-id="5877790165-2">{</span><span class="nf">self</span><span class="p" data-group-id="5877790165-3">(</span><span class="p" data-group-id="5877790165-3">)</span><span class="p">,</span><span class="w"> </span><span class="n">MRef</span><span class="p">,</span><span class="w"> </span><span class="n">Request</span><span class="p" data-group-id="5877790165-2">}</span><span class="p">,</span><span class="w">
</span><span class="k">receive</span><span class="w">
    </span><span class="p" data-group-id="5877790165-4">{</span><span class="n">MRef</span><span class="p">,</span><span class="w"> </span><span class="n">Reply</span><span class="p" data-group-id="5877790165-4">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
        </span><span class="nc">erlang</span><span class="p">:</span><span class="nf">demonitor</span><span class="p" data-group-id="5877790165-5">(</span><span class="n">MRef</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="5877790165-6">[</span><span class="ss">flush</span><span class="p" data-group-id="5877790165-6">]</span><span class="p" data-group-id="5877790165-5">)</span><span class="p">,</span><span class="w">
        </span><span class="nf">handle_reply</span><span class="p" data-group-id="5877790165-7">(</span><span class="n">Reply</span><span class="p" data-group-id="5877790165-7">)</span><span class="p">;</span><span class="w">
    </span><span class="p" data-group-id="5877790165-8">{</span><span class="ss">&#39;DOWN&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">MRef</span><span class="p">,</span><span class="w"> </span><span class="p">_</span><span class="p">,</span><span class="w"> </span><span class="p">_</span><span class="p">,</span><span class="w"> </span><span class="n">Reason</span><span class="p" data-group-id="5877790165-8">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
        </span><span class="nf">handle_error</span><span class="p" data-group-id="5877790165-9">(</span><span class="n">Reason</span><span class="p" data-group-id="5877790165-9">)</span><span class="w">
</span><span class="k">end</span><span class="p">.</span></code></pre><p>Since the compiler knows that the reference created by
<a href="../apps/erts/erlang.html#monitor/2"><code class="inline">monitor/2</code></a> cannot exist before the call (since it is a globally
unique identifier), and that the <code class="inline">receive</code> only matches messages that contain
said reference, it will tell the emulator to search only the messages that
arrived after the call to <a href="../apps/erts/erlang.html#monitor/2"><code class="inline">monitor/2</code></a>.</p><p>The above is a simple example where one is but guaranteed that the optimization
will take, but what about more complicated code?</p><p><a href="" id="recv_opt_info"></a></p><h3 id="option-recv_opt_info" class="section-heading">
  <a href="#option-recv_opt_info" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Option recv_opt_info</span>
</h3>
<p>Use the <code class="inline">recv_opt_info</code> option to have the compiler print information about
receive optimizations. It can be given either to the compiler or <code class="inline">erlc</code>:</p><pre><code class="makeup erlang" translate="no"><span class="ss">erlc</span><span class="w"> </span><span class="o">+</span><span class="ss">recv_opt_info</span><span class="w"> </span><span class="n">Mod</span><span class="p">.</span><span class="ss">erl</span></code></pre><p>or passed through an environment variable:</p><pre><code class="makeup erlang" translate="no"><span class="ss">export</span><span class="w"> </span><span class="n">ERL_COMPILER_OPTIONS</span><span class="o">=</span><span class="ss">recv_opt_info</span></code></pre><p>Notice that <code class="inline">recv_opt_info</code> is not meant to be a permanent option added to your
<code class="inline">Makefile</code>s, because all messages that it generates cannot be eliminated.
Therefore, passing the option through the environment is in most cases the most
practical approach.</p><p>The warnings look as follows:</p><pre><code class="makeup erlang" translate="no"><span class="ss">efficiency_guide</span><span class="p">.</span><span class="nc">erl</span><span class="p">:</span><span class="mi">194</span><span class="p">:</span><span class="w"> </span><span class="n">Warning</span><span class="p">:</span><span class="w"> </span><span class="n">INFO</span><span class="p">:</span><span class="w"> </span><span class="k">receive</span><span class="w"> </span><span class="ss">matches</span><span class="w"> </span><span class="ss">any</span><span class="w"> </span><span class="ss">message</span><span class="p">,</span><span class="w"> </span><span class="ss">this</span><span class="w"> </span><span class="ss">is</span><span class="w"> </span><span class="ss">always</span><span class="w"> </span><span class="ss">fast</span><span class="w">
</span><span class="ss">efficiency_guide</span><span class="p">.</span><span class="nc">erl</span><span class="p">:</span><span class="mi">200</span><span class="p">:</span><span class="w"> </span><span class="n">Warning</span><span class="p">:</span><span class="w"> </span><span class="n">NOT</span><span class="w"> </span><span class="n">OPTIMIZED</span><span class="p">:</span><span class="w"> </span><span class="ss">all</span><span class="w"> </span><span class="ss">clauses</span><span class="w"> </span><span class="ss">do</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="ss">match</span><span class="w"> </span><span class="ss">a</span><span class="w"> </span><span class="ss">suitable</span><span class="w"> </span><span class="ss">reference</span><span class="w">
</span><span class="ss">efficiency_guide</span><span class="p">.</span><span class="nc">erl</span><span class="p">:</span><span class="mi">206</span><span class="p">:</span><span class="w"> </span><span class="n">Warning</span><span class="p">:</span><span class="w"> </span><span class="n">OPTIMIZED</span><span class="p">:</span><span class="w"> </span><span class="ss">reference</span><span class="w"> </span><span class="ss">used</span><span class="w"> </span><span class="ss">to</span><span class="w"> </span><span class="ss">mark</span><span class="w"> </span><span class="ss">a</span><span class="w"> </span><span class="ss">message</span><span class="w"> </span><span class="ss">queue</span><span class="w"> </span><span class="ss">position</span><span class="w">
</span><span class="ss">efficiency_guide</span><span class="p">.</span><span class="nc">erl</span><span class="p">:</span><span class="mi">208</span><span class="p">:</span><span class="w"> </span><span class="n">Warning</span><span class="p">:</span><span class="w"> </span><span class="n">OPTIMIZED</span><span class="p">:</span><span class="w"> </span><span class="ss">all</span><span class="w"> </span><span class="ss">clauses</span><span class="w"> </span><span class="ss">match</span><span class="w"> </span><span class="ss">reference</span><span class="w"> </span><span class="ss">created</span><span class="w"> </span><span class="ss">by</span><span class="w"> </span><span class="nb">monitor</span><span class="p">/</span><span class="mi">2</span><span class="w"> </span><span class="ss">at</span><span class="w"> </span><span class="ss">efficiency_guide</span><span class="p">.</span><span class="nc">erl</span><span class="p">:</span><span class="mi">206</span><span class="w">
</span><span class="ss">efficiency_guide</span><span class="p">.</span><span class="nc">erl</span><span class="p">:</span><span class="mi">219</span><span class="p">:</span><span class="w"> </span><span class="n">Warning</span><span class="p">:</span><span class="w"> </span><span class="n">INFO</span><span class="p">:</span><span class="w"> </span><span class="ss">passing</span><span class="w"> </span><span class="ss">reference</span><span class="w"> </span><span class="ss">created</span><span class="w"> </span><span class="ss">by</span><span class="w"> </span><span class="ss">make_ref</span><span class="p">/</span><span class="mi">0</span><span class="w"> </span><span class="ss">at</span><span class="w"> </span><span class="ss">efficiency_guide</span><span class="p">.</span><span class="nc">erl</span><span class="p">:</span><span class="mi">218</span><span class="w">
</span><span class="ss">efficiency_guide</span><span class="p">.</span><span class="nc">erl</span><span class="p">:</span><span class="mi">222</span><span class="p">:</span><span class="w"> </span><span class="n">Warning</span><span class="p">:</span><span class="w"> </span><span class="n">OPTIMIZED</span><span class="p">:</span><span class="w"> </span><span class="ss">all</span><span class="w"> </span><span class="ss">clauses</span><span class="w"> </span><span class="ss">match</span><span class="w"> </span><span class="ss">reference</span><span class="w"> </span><span class="ss">in</span><span class="w"> </span><span class="ss">function</span><span class="w"> </span><span class="ss">parameter</span><span class="w"> </span><span class="mi">1</span></code></pre><p>To make it clearer exactly what code the warnings refer to, the warnings in the
following examples are inserted as comments after the clause they refer to, for
example:</p><pre><code class="makeup erlang" translate="no"><span class="c1">%% DO</span><span class="w">
</span><span class="nf">simple_receive</span><span class="p" data-group-id="1131674372-1">(</span><span class="p" data-group-id="1131674372-1">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
</span><span class="c1">%% efficiency_guide.erl:194: Warning: INFO: not a selective receive, this is always fast</span><span class="w">
</span><span class="k">receive</span><span class="w">
    </span><span class="n">Message</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nf">handle_msg</span><span class="p" data-group-id="1131674372-2">(</span><span class="n">Message</span><span class="p" data-group-id="1131674372-2">)</span><span class="w">
</span><span class="k">end</span><span class="p">.</span><span class="w">

</span><span class="c1">%% DO NOT, unless Tag is known to be a suitable reference: see</span><span class="w">
</span><span class="c1">%% cross_function_receive/0 further down.</span><span class="w">
</span><span class="nf">selective_receive</span><span class="p" data-group-id="1131674372-3">(</span><span class="n">Tag</span><span class="p">,</span><span class="w"> </span><span class="n">Message</span><span class="p" data-group-id="1131674372-3">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
</span><span class="c1">%% efficiency_guide.erl:200: Warning: NOT OPTIMIZED: all clauses do not match a suitable reference</span><span class="w">
</span><span class="k">receive</span><span class="w">
    </span><span class="p" data-group-id="1131674372-4">{</span><span class="n">Tag</span><span class="p">,</span><span class="w"> </span><span class="n">Message</span><span class="p" data-group-id="1131674372-4">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nf">handle_msg</span><span class="p" data-group-id="1131674372-5">(</span><span class="n">Message</span><span class="p" data-group-id="1131674372-5">)</span><span class="w">
</span><span class="k">end</span><span class="p">.</span><span class="w">

</span><span class="c1">%% DO</span><span class="w">
</span><span class="nf">optimized_receive</span><span class="p" data-group-id="1131674372-6">(</span><span class="n">Process</span><span class="p">,</span><span class="w"> </span><span class="n">Request</span><span class="p" data-group-id="1131674372-6">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
</span><span class="c1">%% efficiency_guide.erl:206: Warning: OPTIMIZED: reference used to mark a message queue position</span><span class="w">
    </span><span class="n">MRef</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">monitor</span><span class="p" data-group-id="1131674372-7">(</span><span class="ss">process</span><span class="p">,</span><span class="w"> </span><span class="n">Process</span><span class="p" data-group-id="1131674372-7">)</span><span class="p">,</span><span class="w">
    </span><span class="n">Process</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="p" data-group-id="1131674372-8">{</span><span class="nf">self</span><span class="p" data-group-id="1131674372-9">(</span><span class="p" data-group-id="1131674372-9">)</span><span class="p">,</span><span class="w"> </span><span class="n">MRef</span><span class="p">,</span><span class="w"> </span><span class="n">Request</span><span class="p" data-group-id="1131674372-8">}</span><span class="p">,</span><span class="w">
    </span><span class="c1">%% efficiency_guide.erl:208: Warning: OPTIMIZED: matches reference created by monitor/2 at efficiency_guide.erl:206</span><span class="w">
    </span><span class="k">receive</span><span class="w">
        </span><span class="p" data-group-id="1131674372-10">{</span><span class="n">MRef</span><span class="p">,</span><span class="w"> </span><span class="n">Reply</span><span class="p" data-group-id="1131674372-10">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
        </span><span class="nc">erlang</span><span class="p">:</span><span class="nf">demonitor</span><span class="p" data-group-id="1131674372-11">(</span><span class="n">MRef</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="1131674372-12">[</span><span class="ss">flush</span><span class="p" data-group-id="1131674372-12">]</span><span class="p" data-group-id="1131674372-11">)</span><span class="p">,</span><span class="w">
        </span><span class="nf">handle_reply</span><span class="p" data-group-id="1131674372-13">(</span><span class="n">Reply</span><span class="p" data-group-id="1131674372-13">)</span><span class="p">;</span><span class="w">
    </span><span class="p" data-group-id="1131674372-14">{</span><span class="ss">&#39;DOWN&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">MRef</span><span class="p">,</span><span class="w"> </span><span class="p">_</span><span class="p">,</span><span class="w"> </span><span class="p">_</span><span class="p">,</span><span class="w"> </span><span class="n">Reason</span><span class="p" data-group-id="1131674372-14">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="nf">handle_error</span><span class="p" data-group-id="1131674372-15">(</span><span class="n">Reason</span><span class="p" data-group-id="1131674372-15">)</span><span class="w">
    </span><span class="k">end</span><span class="p">.</span><span class="w">

</span><span class="c1">%% DO</span><span class="w">
</span><span class="nf">cross_function_receive</span><span class="p" data-group-id="1131674372-16">(</span><span class="p" data-group-id="1131674372-16">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="c1">%% efficiency_guide.erl:218: Warning: OPTIMIZED: reference used to mark a message queue position</span><span class="w">
    </span><span class="n">Ref</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">make_ref</span><span class="p" data-group-id="1131674372-17">(</span><span class="p" data-group-id="1131674372-17">)</span><span class="p">,</span><span class="w">
    </span><span class="c1">%% efficiency_guide.erl:219: Warning: INFO: passing reference created by make_ref/0 at efficiency_guide.erl:218</span><span class="w">
    </span><span class="nf">cross_function_receive</span><span class="p" data-group-id="1131674372-18">(</span><span class="n">Ref</span><span class="p" data-group-id="1131674372-18">)</span><span class="p">.</span><span class="w">

</span><span class="nf">cross_function_receive</span><span class="p" data-group-id="1131674372-19">(</span><span class="n">Ref</span><span class="p" data-group-id="1131674372-19">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="c1">%% efficiency_guide.erl:222: Warning: OPTIMIZED: all clauses match reference in function parameter 1</span><span class="w">
    </span><span class="k">receive</span><span class="w">
        </span><span class="p" data-group-id="1131674372-20">{</span><span class="n">Ref</span><span class="p">,</span><span class="w"> </span><span class="n">Message</span><span class="p" data-group-id="1131674372-20">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nf">handle_msg</span><span class="p" data-group-id="1131674372-21">(</span><span class="n">Message</span><span class="p" data-group-id="1131674372-21">)</span><span class="w">
    </span><span class="k">end</span><span class="p">.</span></code></pre><h2 id="literal-pool" class="section-heading">
  <a href="#literal-pool" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Literal Pool</span>
</h2>
<p>Constant Erlang terms (hereafter called <em>literals</em>) are kept in <em>literal pools</em>;
each loaded module has its own pool. The following function does not build the
tuple every time it is called (only to have it discarded the next time the
garbage collector was run), but the tuple is located in the module's literal
pool:</p><p><strong>DO</strong></p><pre><code class="makeup erlang" translate="no"><span class="nf">days_in_month</span><span class="p" data-group-id="1155086271-1">(</span><span class="n">M</span><span class="p" data-group-id="1155086271-1">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="nf">element</span><span class="p" data-group-id="1155086271-2">(</span><span class="n">M</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="1155086271-3">{</span><span class="mi">31</span><span class="p">,</span><span class="mi">28</span><span class="p">,</span><span class="mi">31</span><span class="p">,</span><span class="mi">30</span><span class="p">,</span><span class="mi">31</span><span class="p">,</span><span class="mi">30</span><span class="p">,</span><span class="mi">31</span><span class="p">,</span><span class="mi">31</span><span class="p">,</span><span class="mi">30</span><span class="p">,</span><span class="mi">31</span><span class="p">,</span><span class="mi">30</span><span class="p">,</span><span class="mi">31</span><span class="p" data-group-id="1155086271-3">}</span><span class="p" data-group-id="1155086271-2">)</span><span class="p">.</span></code></pre><p>If a literal, or a term that contains a literal, is inserted into an Ets table,
it is <em>copied</em>. The reason is that the module containing the literal can be
unloaded in the future.</p><p>When a literal is sent to another process, it is <em>not</em> copied. When a module
holding a literal is unloaded, the literal will be copied to the heap of all
processes that hold references to that literal.</p><p>There also exists a global literal pool that is managed by the
<a href="../apps/erts/persistent_term.html"><code class="inline">persistent_term</code></a> module.</p><p>By default, 1 GB of virtual address space is reserved for all literal pools (in
BEAM code and persistent terms). The amount of virtual address space reserved
for literals can be changed by using the
<a href="../apps/erts/erts_alloc.html#MIscs"><code class="inline">+MIscs option</code></a> when starting the emulator.</p><p>Here is an example how the reserved virtual address space for literals can be
raised to 2 GB (2048 MB):</p><pre><code class="text">erl +MIscs 2048</code></pre><h2 id="loss-of-sharing" class="section-heading">
  <a href="#loss-of-sharing" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Loss of Sharing</span>
</h2>
<p>An Erlang term can have shared subterms. Here is a simple example:</p><pre><code class="makeup erlang" translate="no"><span class="p" data-group-id="8219275020-1">{</span><span class="n">SubTerm</span><span class="p">,</span><span class="w"> </span><span class="n">SubTerm</span><span class="p" data-group-id="8219275020-1">}</span></code></pre><p>Shared subterms are <em>not</em> preserved in the following cases:</p><ul><li>When a term is sent to another process</li><li>When a term is passed as the initial process arguments in the <code class="inline">spawn</code> call</li><li>When a term is stored in an Ets table</li></ul><p>That is an optimization. Most applications do not send messages with shared
subterms.</p><p>The following example shows how a shared subterm can be created:</p><pre><code class="makeup erlang" translate="no"><span class="nf">kilo_byte</span><span class="p" data-group-id="0571492831-1">(</span><span class="p" data-group-id="0571492831-1">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="nf">kilo_byte</span><span class="p" data-group-id="0571492831-2">(</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="0571492831-3">[</span><span class="mi">42</span><span class="p" data-group-id="0571492831-3">]</span><span class="p" data-group-id="0571492831-2">)</span><span class="p">.</span><span class="w">

</span><span class="nf">kilo_byte</span><span class="p" data-group-id="0571492831-4">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">Acc</span><span class="p" data-group-id="0571492831-4">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="n">Acc</span><span class="p">;</span><span class="w">
</span><span class="nf">kilo_byte</span><span class="p" data-group-id="0571492831-5">(</span><span class="n">N</span><span class="p">,</span><span class="w"> </span><span class="n">Acc</span><span class="p" data-group-id="0571492831-5">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="nf">kilo_byte</span><span class="p" data-group-id="0571492831-6">(</span><span class="n">N</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="0571492831-7">[</span><span class="n">Acc</span><span class="p">|</span><span class="n">Acc</span><span class="p" data-group-id="0571492831-7">]</span><span class="p" data-group-id="0571492831-6">)</span><span class="p">.</span></code></pre><p><code class="inline">kilo_byte/1</code> creates a deep list. If <a href="../apps/erts/erlang.html#list_to_binary/1"><code class="inline">list_to_binary/1</code></a>
is called, the deep list can be converted to a binary of 1024 bytes:</p><pre><code class="text">1&gt; byte_size(list_to_binary(efficiency_guide:kilo_byte())).
1024</code></pre><p>Using the <code class="inline">erts_debug:size/1</code> BIF, it can be seen that the deep list only
requires 22 words of heap space:</p><pre><code class="makeup erlang" translate="no"><span class="gp unselectable">2&gt; </span><span class="nc">erts_debug</span><span class="p">:</span><span class="nf">size</span><span class="p" data-group-id="8144210464-1">(</span><span class="nc">efficiency_guide</span><span class="p">:</span><span class="nf">kilo_byte</span><span class="p" data-group-id="8144210464-2">(</span><span class="p" data-group-id="8144210464-2">)</span><span class="p" data-group-id="8144210464-1">)</span><span class="p">.</span><span class="w">
</span><span class="mi">22</span></code></pre><p>Using the <code class="inline">erts_debug:flat_size/1</code> BIF, the size of the deep list can be
calculated if sharing is ignored. It becomes the size of the list when it has
been sent to another process or stored in an Ets table:</p><pre><code class="makeup erlang" translate="no"><span class="gp unselectable">3&gt; </span><span class="nc">erts_debug</span><span class="p">:</span><span class="nf">flat_size</span><span class="p" data-group-id="4181623007-1">(</span><span class="nc">efficiency_guide</span><span class="p">:</span><span class="nf">kilo_byte</span><span class="p" data-group-id="4181623007-2">(</span><span class="p" data-group-id="4181623007-2">)</span><span class="p" data-group-id="4181623007-1">)</span><span class="p">.</span><span class="w">
</span><span class="mi">4094</span></code></pre><p>It can be verified that sharing will be lost if the data is inserted into an Ets
table:</p><pre><code class="makeup erlang" translate="no"><span class="gp unselectable">4&gt; </span><span class="n">T</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">ets</span><span class="p">:</span><span class="nf">new</span><span class="p" data-group-id="8529313669-1">(</span><span class="ss">tab</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="8529313669-2">[</span><span class="p" data-group-id="8529313669-2">]</span><span class="p" data-group-id="8529313669-1">)</span><span class="p">.</span><span class="w">
</span><span class="p">#</span><span class="n">Ref</span><span class="o">&lt;</span><span class="mf">0.1662103692</span><span class="p">.</span><span class="mf">2407923716.214181</span><span class="o">&gt;</span><span class="gp unselectable">
5&gt; </span><span class="nc">ets</span><span class="p">:</span><span class="nf">insert</span><span class="p" data-group-id="8529313669-3">(</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="8529313669-4">{</span><span class="ss">key</span><span class="p">,</span><span class="nc">efficiency_guide</span><span class="p">:</span><span class="nf">kilo_byte</span><span class="p" data-group-id="8529313669-5">(</span><span class="p" data-group-id="8529313669-5">)</span><span class="p" data-group-id="8529313669-4">}</span><span class="p" data-group-id="8529313669-3">)</span><span class="p">.</span><span class="w">
</span><span class="ss">true</span><span class="gp unselectable">
6&gt; </span><span class="nc">erts_debug</span><span class="p">:</span><span class="nf">size</span><span class="p" data-group-id="8529313669-6">(</span><span class="nf">element</span><span class="p" data-group-id="8529313669-7">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="nf">hd</span><span class="p" data-group-id="8529313669-8">(</span><span class="nc">ets</span><span class="p">:</span><span class="nf">lookup</span><span class="p" data-group-id="8529313669-9">(</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="ss">key</span><span class="p" data-group-id="8529313669-9">)</span><span class="p" data-group-id="8529313669-8">)</span><span class="p" data-group-id="8529313669-7">)</span><span class="p" data-group-id="8529313669-6">)</span><span class="p">.</span><span class="w">
</span><span class="mi">4094</span><span class="gp unselectable">
7&gt; </span><span class="nc">erts_debug</span><span class="p">:</span><span class="nf">flat_size</span><span class="p" data-group-id="8529313669-10">(</span><span class="nf">element</span><span class="p" data-group-id="8529313669-11">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="nf">hd</span><span class="p" data-group-id="8529313669-12">(</span><span class="nc">ets</span><span class="p">:</span><span class="nf">lookup</span><span class="p" data-group-id="8529313669-13">(</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="ss">key</span><span class="p" data-group-id="8529313669-13">)</span><span class="p" data-group-id="8529313669-12">)</span><span class="p" data-group-id="8529313669-11">)</span><span class="p" data-group-id="8529313669-10">)</span><span class="p">.</span><span class="w">
</span><span class="mi">4094</span></code></pre><p>When the data has passed through an Ets table, <code class="inline">erts_debug:size/1</code> and
<code class="inline">erts_debug:flat_size/1</code> return the same value. Sharing has been lost.</p><p>It is possible to build an <em>experimental</em> variant of the runtime system that
will preserve sharing when copying terms by giving the
<code class="inline">--enable-sharing-preserving</code> option to the <code class="inline">configure</code> script.</p><h2 id="smp-run-time-system" class="section-heading">
  <a href="#smp-run-time-system" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">SMP Run-Time System</span>
</h2>
<p>The Erlang run-time system takes advantage of a multi-core or
multi-CPU computer by running several Erlang scheduler threads
(typically, the same number of threads as the number of cores).</p><p>To gain performance from a multi-core computer, your application <em>must have more
than one runnable Erlang process</em> most of the time. Otherwise, the Erlang
emulator can still only run one Erlang process at the time.</p><p>Benchmarks that appear to be concurrent are often sequential.  For
example, the <a href="https://github.com/erlang/otp/blob/f164034e6fdab3316ae23c5d5bbaef258dd6d12c/erts/emulator/test/estone_SUITE.erl">EStone
benchmark</a>
is entirely sequential. So is the most common implementation of the
&quot;ring benchmark&quot;; usually one process is active, while the others wait
in a <code class="inline">receive</code> statement.</p>
</div>

<div class="bottom-actions" id="bottom-actions">
  <div class="bottom-actions-item">

      <a href="tablesdatabases.html" class="bottom-actions-button" rel="prev">
        <span class="subheader">
          ← Previous Page
        </span>
        <span class="title">
Tables and Databases
        </span>
      </a>

  </div>
  <div class="bottom-actions-item">

      <a href="drivers.html" class="bottom-actions-button" rel="next">
        <span class="subheader">
          Next Page →
        </span>
        <span class="title">
Drivers
        </span>
      </a>

  </div>
</div>
    <footer class="footer">
      <p>

        <span class="line">
          <button class="a-main footer-button display-quick-switch" title="Search HexDocs packages">
            Search HexDocs
          </button>

            <a href="Erlang System Documentation.epub" title="ePub version">
              Download ePub version
            </a>

        </span>
      </p>

      <p class="built-using">
        Built using
        <a href="https://github.com/elixir-lang/ex_doc" title="ExDoc" target="_blank" rel="help noopener" translate="no">ExDoc</a> (v0.37.3) for the

          <a href="https://erlang.org" title="Erlang" target="_blank" translate="no">Erlang programming language</a>

      </p>
<p>Copyright © 1996-2025 <a href="https://www.ericsson.com">Ericsson AB</a></p>
    </footer>
  </div>
</main>
</div>
  <script defer src="https://cdn.jsdelivr.net/npm/mermaid@11.4.1/dist/mermaid.min.js"></script>
  <script>
  let initialized = false;

  window.addEventListener("exdoc:loaded", () => {
      if (!initialized) {
      mermaid.initialize({
          startOnLoad: false,
          theme: document.body.className.includes("dark") ? "dark" : "default"
      });
      initialized = true;
      }

      let id = 0;
      for (const codeEl of document.querySelectorAll("pre code.mermaid")) {
      const preEl = codeEl.parentElement;
      const graphDefinition = codeEl.textContent;
      const graphEl = document.createElement("div");
      const graphId = "mermaid-graph-" + id++;
      mermaid.render(graphId, graphDefinition).then(({svg, bindFunctions}) => {
          graphEl.innerHTML = svg;
          bindFunctions?.(graphEl);
          preEl.insertAdjacentElement("afterend", graphEl);
          preEl.remove();
      });
      }
  });
  </script>

  </body>
</html>
