<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html xmlns:erl="http://erlang.org" xmlns:fn="http://www.w3.org/2005/02/xpath-functions">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<link rel="stylesheet" href="../../otp_doc.css" type="text/css">
<title>Erlang -- Trace Tool Builder</title>
</head>
<body>
<div id="container">
<script id="js" type="text/javascript" language="JavaScript" src="../../js/flipmenu/flipmenu.js"></script><script id="js2" type="text/javascript" src="../../js/erlresolvelinks.js"></script><script language="JavaScript" type="text/javascript">
            <!--
              function getWinHeight() {
                var myHeight = 0;
                if( typeof( window.innerHeight ) == 'number' ) {
                  //Non-IE
                  myHeight = window.innerHeight;
                } else if( document.documentElement && ( document.documentElement.clientWidth ||
                                                         document.documentElement.clientHeight ) ) {
                  //IE 6+ in 'standards compliant mode'
                  myHeight = document.documentElement.clientHeight;
                } else if( document.body && ( document.body.clientWidth || document.body.clientHeight ) ) {
                  //IE 4 compatible
                  myHeight = document.body.clientHeight;
                }
                return myHeight;
              }

              function setscrollpos() {
                var objf=document.getElementById('loadscrollpos');
                 document.getElementById("leftnav").scrollTop = objf.offsetTop - getWinHeight()/2;
              }

              function addEvent(obj, evType, fn){
                if (obj.addEventListener){
                obj.addEventListener(evType, fn, true);
                return true;
              } else if (obj.attachEvent){
                var r = obj.attachEvent("on"+evType, fn);
                return r;
              } else {
                return false;
              }
             }

             addEvent(window, 'load', setscrollpos);

             //--></script><div id="leftnav"><div class="innertube">
<div class="erlang-logo-wrapper"><a href="../../index.html"><img alt="Erlang Logo" src="../../erlang-logo.png" class="erlang-logo"></a></div>
<p class="section-title">Observer</p>
<p class="section-subtitle">User's Guide</p>
<p class="section-version">Version 2.9</p>
<ul class="panel-sections">
<li><a href="users_guide.html">User's Guide</a></li>
<li><a href="index.html">Reference Manual</a></li>
<li><a href="release_notes.html">Release Notes</a></li>
<li><a href="observer.pdf">PDF</a></li>
<li><a href="../../index.html">Top</a></li>
</ul>
<ul class="expand-collapse-items">
<li><a href="javascript:openAllFlips()">Expand All</a></li>
<li><a href="javascript:closeAllFlips()">Contract All</a></li>
</ul>
<h3>Chapters</h3>
<ul class="flipMenu" imagePath="../../js/flipmenu">
<li id="no" title="Introduction" expanded="false">Introduction<ul>
<li><a href="introduction_ug.html">
              Top of chapter
            </a></li>
<li title="Scope"><a href="introduction_ug.html#scope">Scope</a></li>
<li title="Prerequisites"><a href="introduction_ug.html#prerequisites">Prerequisites</a></li>
</ul>
</li>
<li id="no" title="Observer" expanded="false">Observer<ul>
<li><a href="observer_ug.html">
              Top of chapter
            </a></li>
<li title="Introduction"><a href="observer_ug.html#introduction">Introduction</a></li>
<li title="Getting Started"><a href="observer_ug.html#getting-started">Getting Started</a></li>
<li title="System Tab"><a href="observer_ug.html#system-tab">System Tab</a></li>
<li title="Load Charts Tab"><a href="observer_ug.html#load-charts-tab">Load Charts Tab</a></li>
<li title="Memory Allocators Tab"><a href="observer_ug.html#memory-allocators-tab">Memory Allocators Tab</a></li>
<li title="Applications Tab"><a href="observer_ug.html#applications-tab">Applications Tab</a></li>
<li title="Processes Tab"><a href="observer_ug.html#processes-tab">Processes Tab</a></li>
<li title="Ports Tab"><a href="observer_ug.html#ports-tab">Ports Tab</a></li>
<li title="Table Viewer Tab"><a href="observer_ug.html#table-viewer-tab">Table Viewer Tab</a></li>
<li title="Trace Overview Tab"><a href="observer_ug.html#trace-overview-tab">Trace Overview Tab</a></li>
</ul>
</li>
<li id="loadscrollpos" title="Trace Tool Builder" expanded="true">Trace Tool Builder<ul>
<li><a href="ttb_ug.html">
              Top of chapter
            </a></li>
<li title="Introduction"><a href="ttb_ug.html#introduction">Introduction</a></li>
<li title="Getting Started"><a href="ttb_ug.html#getting-started">Getting Started</a></li>
<li title="Running Trace Tool Builder against Remote Node"><a href="ttb_ug.html#running-trace-tool-builder-against-remote-node">Running Trace Tool Builder against Remote Node</a></li>
<li title="More Tracing Options"><a href="ttb_ug.html#more-tracing-options">More Tracing Options</a></li>
<li title="Trace Information and File .ti"><a href="ttb_ug.html#trace-information-and-file-.ti">Trace Information and File .ti</a></li>
<li title="Wrap Logs"><a href="ttb_ug.html#wrap-logs">Wrap Logs</a></li>
<li title="Formatting"><a href="ttb_ug.html#formatting">Formatting</a></li>
<li title="Automatically Collect and Format Logs from All Nodes"><a href="ttb_ug.html#automatically-collect-and-format-logs-from-all-nodes">Automatically Collect and Format Logs from All Nodes</a></li>
<li title="History and Configuration Files"><a href="ttb_ug.html#history-and-configuration-files">History and Configuration Files</a></li>
<li title="Sequential Tracing"><a href="ttb_ug.html#sequential-tracing">Sequential Tracing</a></li>
<li title="Multipurpose Trace Tool"><a href="ttb_ug.html#multipurpose-trace-tool">Multipurpose Trace Tool</a></li>
</ul>
</li>
<li id="no" title="Erlang Top" expanded="false">Erlang Top<ul>
<li><a href="etop_ug.html">
              Top of chapter
            </a></li>
<li title="Introduction"><a href="etop_ug.html#introduction">Introduction</a></li>
<li title="Getting Started"><a href="etop_ug.html#getting-started">Getting Started</a></li>
<li title="Output"><a href="etop_ug.html#output">Output</a></li>
<li title="Configuration"><a href="etop_ug.html#configuration">Configuration</a></li>
<li title="Print to File"><a href="etop_ug.html#print-to-file">Print to File</a></li>
<li title="Stop"><a href="etop_ug.html#stop">Stop</a></li>
</ul>
</li>
<li id="no" title="Crashdump Viewer" expanded="false">Crashdump Viewer<ul>
<li><a href="crashdump_ug.html">
              Top of chapter
            </a></li>
<li title="Introduction"><a href="crashdump_ug.html#introduction">Introduction</a></li>
<li title="Getting Started"><a href="crashdump_ug.html#getting-started">Getting Started</a></li>
<li title="GUI"><a href="crashdump_ug.html#gui">GUI</a></li>
<li title="Tab Content"><a href="crashdump_ug.html#tab-content">Tab Content</a></li>
<li title="General Tab"><a href="crashdump_ug.html#general-tab">General Tab</a></li>
<li title="Processes Tab"><a href="crashdump_ug.html#processes-tab">Processes Tab</a></li>
<li title="Ports Tab"><a href="crashdump_ug.html#ports-tab">Ports Tab</a></li>
<li title="ETS Tables Tab"><a href="crashdump_ug.html#ets-tables-tab">ETS Tables Tab</a></li>
<li title="Timers Tab"><a href="crashdump_ug.html#timers-tab">Timers Tab</a></li>
<li title="Schedulers Tab"><a href="crashdump_ug.html#schedulers-tab">Schedulers Tab</a></li>
<li title="Funs Tab"><a href="crashdump_ug.html#funs-tab">Funs Tab</a></li>
<li title="Atoms Tab"><a href="crashdump_ug.html#atoms-tab">Atoms Tab</a></li>
<li title="Nodes Tab"><a href="crashdump_ug.html#nodes-tab">Nodes Tab</a></li>
<li title="Modules Tab"><a href="crashdump_ug.html#modules-tab">Modules Tab</a></li>
<li title="Memory Tab"><a href="crashdump_ug.html#memory-tab">Memory Tab</a></li>
<li title="Internal Tables Tab"><a href="crashdump_ug.html#internal-tables-tab">Internal Tables Tab</a></li>
</ul>
</li>
</ul>
</div></div>
<div id="content">
<div class="innertube">
<h1>3 Trace Tool Builder</h1>
  

  <h3><span onMouseOver="document.getElementById('ghlink-introduction-idm333').style.visibility = 'visible';" onMouseOut="document.getElementById('ghlink-introduction-idm333').style.visibility = 'hidden';"><span id="ghlink-introduction-idm333" class="ghlink"><a href="https://github.com/erlang/otp/edit/maint/lib/observer/doc/src/ttb_ug.xml#L33" title="Found an issue with the documentation? Fix it by clicking here!"><span class="pencil"></span></a></span><a class="title_link" name="introduction" href="#introduction">3.1 
          Introduction</a></span></h3>
    
    <p>Trace Tool Builder is a base for building trace tools for
      single node or distributed Erlang systems. It requires the
      Runtime_Tools application to be available on the traced
      node.
      </p>
    <p>The following are the main features of Trace Tool Builder:</p>
    <ul>
      <li>Start tracing to file ports on many nodes with one
       function call.</li>
      <li>Write more information to a trace information file,
       which is read during formatting.</li>
      <li>Restore previous configuration by maintaining a
       history buffer and handling configuration files.</li>
      <li>Provide some simple support for sequential tracing.</li>
      <li>Format binary trace logs and merge logs from
       multiple nodes.</li>
    </ul>
    <p>The intention of Trace Tool Builder is to serve
      as a base for tailor-made trace tools, but it can also be used directly
      from the Erlang shell (it can mimic <span class="code">dbg</span> behaviour while
      still providing useful additions, such as match specification shortcuts).
      Trace Tool Builder only allows the use of file port tracer, so to use 
      other types of trace clients it is better to use <span class="code">dbg</span> directly.</p>
  

  <h3><span onMouseOver="document.getElementById('ghlink-getting-started-idm346').style.visibility = 'visible';" onMouseOut="document.getElementById('ghlink-getting-started-idm346').style.visibility = 'hidden';"><span id="ghlink-getting-started-idm346" class="ghlink"><a href="https://github.com/erlang/otp/edit/maint/lib/observer/doc/src/ttb_ug.xml#L60" title="Found an issue with the documentation? Fix it by clicking here!"><span class="pencil"></span></a></span><a class="title_link" name="getting-started" href="#getting-started">3.2 
          Getting Started</a></span></h3>
    
    <p>Module <span class="code">ttb</span> is the interface to all functions in
      Trace Tool Builder.</p>
      <p>To get started, the least you need to do is to
      start a tracer with 
      <span class="bold_code bc-15"><a href="../../man/ttb.html#tracer-0"><span class="code">ttb:tracer/0,1,2</span></a></span>, 
      and set the required
      trace flags on the processes you want to trace with 
      <span class="bold_code bc-15"><a href="../../man/ttb.html#p-2"><span class="code">ttb:p/2</span></a></span>.</p>
      <p>When the tracing is completed, stop the tracer with 
      <span class="bold_code bc-15"><a href="../../man/ttb.html#stop-0"><span class="code">ttb:stop/0,1</span></a></span> 
      and format the trace log with 
      <span class="bold_code bc-15"><a href="../../man/ttb.html#format-1"><span class="code">ttb:format/1,2</span></a></span> 
      (if there is anything to format).
      </p>
      <p><strong>Useful functions:</strong></p>
      <dl>
       <dt><strong><span class="code">ttb:tracer/0,1,2</span></strong></dt>
       <dd><p>Opens a trace port on each node to be traced. By default, 
       trace messages are written to binary files on remote nodes (the 
       binary trace log).</p></dd>
       <dt><strong><span class="code">ttb:p/2</span></strong></dt>
       <dd><p>Specifies the processes to be traced. Trace flags specified 
       in this call specify what to trace on each process. This function can be 
       called many times if you like different trace flags to be set on different 
       processes.</p></dd>
       <dt><strong><span class="code">ttb:tp/2,3,4</span> or <span class="code">ttb:tpl/2,3,4</span></strong></dt>
       <dd><p>If you want to trace function calls (that is, if you have
      trace flag <span class="code">call</span> set on any process), you must
      also set trace patterns on the required function(s) with
      <span class="bold_code bc-15"><a href="../../man/ttb.html#-0"><span class="code">ttb:tp/2,3,4</span></a></span> or 
      <span class="bold_code bc-15"><a href="../../man/ttb.html#-0"><span class="code">ttb:tpl/2,3,4</span></a></span>.
      A function is only traced 
      if it has a trace pattern. The trace pattern specifies how to trace the
      function by using match specifications. Match specifications are
      described in the 
      <span class="bold_code bc-18"><a href="../../apps/erts/users_guide.html">ERTS User's Guide</a></span>.</p></dd>
       <dt><strong><span class="code">ttb:stop/0,1</span></strong></dt>
       <dd><p>Stops tracing on all nodes, deletes all trace patterns, and 
       flushes the trace port buffer.</p></dd>
       <dt><strong><span class="code">ttb:format/1/2</span></strong></dt>
       <dd>
<p>Translates the binary trace logs into something readable. 
       By default, <span class="code">ttb</span> presents each trace message as a line of text, 
       but you can also write your own handler to make more complex interpretations 
       of the trace information. A trace log can also be presented graphically 
       with application Event Tracer (ET).</p>
       <p>If option <span class="code">format</span> is specified to <span class="code">ttb:stop/1</span>, the formatting 
       is automatically done when stopping <span class="code">ttb</span>.</p>
</dd>
     </dl>
  
    <h4><span onMouseOver="document.getElementById('ghlink-tracing-local-node-from-erlang-shell-idm395').style.visibility = 'visible';" onMouseOut="document.getElementById('ghlink-tracing-local-node-from-erlang-shell-idm395').style.visibility = 'hidden';"><span id="ghlink-tracing-local-node-from-erlang-shell-idm395" class="ghlink"><a href="https://github.com/erlang/otp/edit/maint/lib/observer/doc/src/ttb_ug.xml#L111" title="Found an issue with the documentation? Fix it by clicking here!"><span class="pencil"></span></a></span><a class="title_link" name="tracing-local-node-from-erlang-shell" href="#tracing-local-node-from-erlang-shell">Tracing Local Node from Erlang Shell</a></span></h4>
      
      <p>The following small module is used in the subsequent example:</p>
      <div class="example"><pre>-module(m).
-export([f/0]).
f() -&gt;
   receive 
      From when is_pid(From) -&gt;
         Now = erlang:now(),
         From ! {self(),Now}
   end.      </pre></div>
      <p>The following example shows the basic use of <span class="code">ttb</span> from
        the Erlang shell. Default options are used both for starting the
        tracer and for formatting (the custom fetch directory is however provided).
        This gives a trace log named <span class="code">Node-ttb</span> in the newly created
        directory, where <span class="code">Node</span> is the node name. The
        default handler prints the formatted trace messages in the
        shell:</p>
      <div class="example"><pre>
(tiger@durin)47&gt; %% First I spawn a process running my test function
(tiger@durin)47&gt; <span class="bold_code bc-12">Pid = spawn(m,f,[]).</span>
&lt;0.125.0&gt;
(tiger@durin)48&gt; 
(tiger@durin)48&gt; %% Then I start a tracer...
(tiger@durin)48&gt; <span class="bold_code bc-12">ttb:tracer().</span>
{ok,[tiger@durin]}
(tiger@durin)49&gt; 
(tiger@durin)49&gt; %% and activate the new process for tracing
(tiger@durin)49&gt; %% function calls and sent messages.
(tiger@durin)49&gt; <span class="bold_code bc-12">ttb:p(Pid,[call,send]).</span>
{ok,[{&lt;0.125.0&gt;,[{matched,tiger@durin,1}]}]}
(tiger@durin)50&gt; 
(tiger@durin)50&gt; %% Here I set a trace pattern on erlang:now/0
(tiger@durin)50&gt; %% The trace pattern is a simple match spec
(tiger@durin)50&gt; %% indicating that the return value should be
(tiger@durin)50&gt; %% traced. Refer to the reference_manual for
(tiger@durin)50&gt; %% the full list of match spec shortcuts
(tiger@durin)50&gt; %% available.
(tiger@durin)51&gt; <span class="bold_code bc-12">ttb:tp(erlang,now,return).</span>
{ok,[{matched,tiger@durin,1},{saved,1}]}
(tiger@durin)52&gt; 
(tiger@durin)52&gt; %% I run my test (i.e. send a message to
(tiger@durin)52&gt; %% my new process)
(tiger@durin)52&gt; <span class="bold_code bc-12">Pid ! self().</span>
&lt;0.72.0&gt;
(tiger@durin)53&gt; 
(tiger@durin)53&gt; %% And then I have to stop ttb in order to flush
(tiger@durin)53&gt; %% the trace port buffer
(tiger@durin)53&gt; <span class="bold_code bc-12">ttb:stop([return, {fetch_dir, "fetch"}]).</span>
{stopped, "fetch"}
(tiger@durin)54&gt; 
(tiger@durin)54&gt; %% Finally I format my trace log
(tiger@durin)54&gt; <span class="bold_code bc-12">ttb:format("fetch").</span>
({&lt;0.125.0&gt;,{m,f,0},tiger@durin}) call erlang:now()
({&lt;0.125.0&gt;,{m,f,0},tiger@durin}) returned from erlang:now/0 -&gt;
{1031,133451,667611}
({&lt;0.125.0&gt;,{m,f,0},tiger@durin}) &lt;0.72.0&gt; !
{&lt;0.125.0&gt;,{1031,133451,667611}}
ok</pre></div>
    

    <h4><span onMouseOver="document.getElementById('ghlink-build-your-own-tool-idm411').style.visibility = 'visible';" onMouseOut="document.getElementById('ghlink-build-your-own-tool-idm411').style.visibility = 'hidden';"><span id="ghlink-build-your-own-tool-idm411" class="ghlink"><a href="https://github.com/erlang/otp/edit/maint/lib/observer/doc/src/ttb_ug.xml#L173" title="Found an issue with the documentation? Fix it by clicking here!"><span class="pencil"></span></a></span><a class="title_link" name="build-your-own-tool" href="#build-your-own-tool">Build Your Own Tool</a></span></h4>
      
      <p>The following example shows a simple tool for "debug tracing",
        that is, tracing of function calls with return values:</p>
      <div class="example"><pre>-module(mydebug).
-export([start/0,trc/1,stop/0,format/1]).
-export([print/4]).
%% Include ms_transform.hrl so that I can use dbg:fun2ms/2 to
%% generate match specifications.
-include_lib("stdlib/include/ms_transform.hrl").
%%% -------------Tool API-------------
%%% ----------------------------------
%%% Star the "mydebug" tool
start() -&gt;
    %% The options specify that the binary log shall be named
    %% &lt;Node&gt;-debug_log and that the print/4 function in this
    %% module shall be used as format handler
    ttb:tracer(all,[{file,"debug_log"},{handler,{{?MODULE,print},0}}]),
    %% All processes (existing and new) shall trace function calls
    %% We want trace messages to be sorted upon format, which requires
    %% timestamp flag. The flag is however enabled by default in ttb.
    ttb:p(all,call).

%%% Set trace pattern on function(s)
trc(M) when is_atom(M) -&gt;
    trc({M,'_','_'});
trc({M,F}) when is_atom(M), is_atom(F) -&gt;
    trc({M,F,'_'});
trc({M,F,_A}=MFA) when is_atom(M), is_atom(F) -&gt;
    %% This match spec shortcut specifies that return values shall
    %% be traced.
    MatchSpec = dbg:fun2ms(fun(_) -&gt; return_trace() end),
    ttb:tpl(MFA,MatchSpec).

%%% Format a binary trace log
format(Dir) -&gt;
    ttb:format(Dir).

%%% Stop the "mydebug" tool
stop() -&gt;
    ttb:stop(return).

%%% --------Internal functions--------
%%% ----------------------------------
%%% Format handler
print(_Out,end_of_trace,_TI,N) -&gt;
    N;
print(Out,Trace,_TI,N) -&gt;
    do_print(Out,Trace,N),
    N+1.

do_print(Out,{trace_ts,P,call,{M,F,A},Ts},N) -&gt;
    io:format(Out,
              "~w: ~w, ~w:~n"
              "Call      : ~w:~w/~w~n"
              "Arguments :~p~n~n",
              [N,Ts,P,M,F,length(A),A]);
do_print(Out,{trace_ts,P,return_from,{M,F,A},R,Ts},N) -&gt;
    io:format(Out,
              "~w: ~w, ~w:~n"
              "Return from  : ~w:~w/~w~n"
              "Return value :~p~n~n",
              [N,Ts,P,M,F,A,R]).      </pre></div>
      <p>To distinguish trace logs produced with this tool from other
        logs, option <span class="code">file</span> is used in 
	<span class="bold_code bc-15"><a href="../../man/ttb.html#tracer-2"><span class="code">tracer/2</span></a></span>. The
        logs are therefore fetched to a directory named
        <span class="code">ttb_upload_debug_log-YYYYMMDD-HHMMSS</span>
      </p>
      <p>By using option <span class="code">handler</span> when starting the tracer,
        the information about how to format the file is stored in the
        trace information file (<span class="code">.ti</span>). This is not necessary, as
        it can be specified when formatting instead. However, It can
        be useful if you, for example, want to format trace logs automatically 
	using option <span class="code">format</span> in <span class="code">ttb:stop/1</span>. Also, you do not need 
	any knowledge of the content of a binary log to format it the way it 
	is intended. If option <span class="code">handler</span> is specified both when starting 
	the tracer and when formatting, the one specified when formatting is used.
        </p>
      <p>Trace flag <span class="code">call</span> is set on all processes. This
        means that any function activated with command <span class="code">trc/1</span>
        is traced on all existing and new processes.
        </p>
    
  

  <h3><span onMouseOver="document.getElementById('ghlink-running-trace-tool-builder-against-remote-node-idm429').style.visibility = 'visible';" onMouseOut="document.getElementById('ghlink-running-trace-tool-builder-against-remote-node-idm429').style.visibility = 'hidden';"><span id="ghlink-running-trace-tool-builder-against-remote-node-idm429" class="ghlink"><a href="https://github.com/erlang/otp/edit/maint/lib/observer/doc/src/ttb_ug.xml#L260" title="Found an issue with the documentation? Fix it by clicking here!"><span class="pencil"></span></a></span><a class="title_link" name="running-trace-tool-builder-against-remote-node" href="#running-trace-tool-builder-against-remote-node">3.3 
          Running Trace Tool Builder against Remote Node</a></span></h3>
    
    <p>The Observer application might not always be available on the
      node to be traced (in the following called the "traced
      node"). However, Trace Tool Builder can still be run from
      another node (in the following called the "trace control node") as
      long as the following is fulfilled:
      </p>
    <ul>
      <li>The Observer application is available on the trace control node.</li>
      <li>The Runtime_Tools application is available on both the
       trace control node and the traced node.</li>
    </ul>
    <p>If Trace Tool Builder is to be used against a remote node,
      it is highly recommended to start the trace control node as
      <strong>hidden</strong>. This way it can connect to the traced node
      without being "seen" by it, that is, if the <span class="code">nodes()</span>
      BIF is called on the traced node, the trace control node does not
      show. To start a hidden node, add option <span class="code">-hidden</span> to the
      <span class="code">erl</span> command, for example:</p>
    <div class="example"><pre>
% <span class="bold_code bc-12">erl -sname trace_control -hidden</span></pre></div>

    <h4><span onMouseOver="document.getElementById('ghlink-diskless-node-idm442').style.visibility = 'visible';" onMouseOut="document.getElementById('ghlink-diskless-node-idm442').style.visibility = 'hidden';"><span id="ghlink-diskless-node-idm442" class="ghlink"><a href="https://github.com/erlang/otp/edit/maint/lib/observer/doc/src/ttb_ug.xml#L283" title="Found an issue with the documentation? Fix it by clicking here!"><span class="pencil"></span></a></span><a class="title_link" name="diskless-node" href="#diskless-node">Diskless Node</a></span></h4>
      
      <p>If the traced node is diskless, <span class="code">ttb</span> must be started from
        a trace control node with disk access, and option <span class="code">file</span>
        must be specified to function <span class="code">tracer/2</span> with value
        <span class="code">{local, File}</span>, for example:</p>
      <div class="example"><pre>
(trace_control@durin)1&gt; <span class="bold_code bc-12">ttb:tracer(mynode@diskless,
                                   {file,{local,{wrap,"mytrace"}}}).</span>
{ok,[mynode@diskless]}</pre></div>
    
  

  <h3><span onMouseOver="document.getElementById('ghlink-more-tracing-options-idm451').style.visibility = 'visible';" onMouseOut="document.getElementById('ghlink-more-tracing-options-idm451').style.visibility = 'hidden';"><span id="ghlink-more-tracing-options-idm451" class="ghlink"><a href="https://github.com/erlang/otp/edit/maint/lib/observer/doc/src/ttb_ug.xml#L296" title="Found an issue with the documentation? Fix it by clicking here!"><span class="pencil"></span></a></span><a class="title_link" name="more-tracing-options" href="#more-tracing-options">3.4 
          More Tracing Options</a></span></h3>
    
    <p>When setting up a trace, the following features can also be activated:</p>
      <ul>
        <li>Time-constrained tracing</li>
        <li>Overload protection</li>
        <li>Autoresume</li>
	<li>
<span class="code">dbg</span> mode</li>
      </ul>
      <h4><span onMouseOver="document.getElementById('ghlink-time-constrained-tracing-idm460').style.visibility = 'visible';" onMouseOut="document.getElementById('ghlink-time-constrained-tracing-idm460').style.visibility = 'hidden';"><span id="ghlink-time-constrained-tracing-idm460" class="ghlink"><a href="https://github.com/erlang/otp/edit/maint/lib/observer/doc/src/ttb_ug.xml#L305" title="Found an issue with the documentation? Fix it by clicking here!"><span class="pencil"></span></a></span><a class="title_link" name="time-constrained-tracing" href="#time-constrained-tracing">Time-Constrained Tracing</a></span></h4>
        
        <p>It can sometimes be helpful to enable trace for a
          specified period of time (for example, to monitor a system for 24 hours
          or half a second). This can be done with option
          <span class="code">{timer, TimerSpec}</span>. If <span class="code">TimerSpec</span> has the
          form of <span class="code">MSec</span>, the trace is stopped after <span class="code">MSec</span>
          milliseconds using 
	  <span class="bold_code bc-15"><a href="../../man/ttb.html#stop-0"><span class="code">ttb:stop/0</span></a></span>. If more 
	  options are provided (<span class="code">TimerSpec = {MSec, Opts}</span>), 
	  <span class="bold_code bc-15"><a href="../../man/ttb.html#stop-1"><span class="code">ttb:stop/1</span></a></span>
          is called instead with <span class="code">Opts</span> as argument.</p>
	  <p>The timer is started with 
	  <span class="bold_code bc-15"><a href="../../man/ttb.html#p-2"><span class="code">ttb:p/2</span></a></span>, so any trace patterns 
	  must be set up in advance. 
	  <span class="bold_code bc-15"><a href="../../man/ttb.html#start_trace-4"><span class="code">ttb:start_trace/4</span></a></span>
          always sets up all patterns before invoking <span class="code">ttb:p/2</span>.</p>
          <p>The following example shows how to set up a trace that is
          automatically stopped and formatted after 5 seconds:
        </p>
<div class="example"><pre>
(tiger@durin)1&gt; <span class="bold_code bc-12">ttb:start_trace([node()],
                                [{erlang, now,[]}],
                                {all, call},
                                [{timer, {5000, format}}]).</span></pre></div>
	<div class="note">
<div class="label">Note</div>
<div class="content"><p><p>Because of network and processing delays, the period
          of tracing is approximate.</p></p></div>
</div>

        
        <h4><span onMouseOver="document.getElementById('ghlink-overload-protection-idm484').style.visibility = 'visible';" onMouseOut="document.getElementById('ghlink-overload-protection-idm484').style.visibility = 'hidden';"><span id="ghlink-overload-protection-idm484" class="ghlink"><a href="https://github.com/erlang/otp/edit/maint/lib/observer/doc/src/ttb_ug.xml#L333" title="Found an issue with the documentation? Fix it by clicking here!"><span class="pencil"></span></a></span><a class="title_link" name="overload-protection" href="#overload-protection">Overload Protection</a></span></h4>
          
          <p>When tracing live systems, always take special care to not
            overload a node with too heavy tracing. <span class="code">ttb</span> provides
            option <span class="code">overload</span> to address this problem.</p>
          <p><span class="code">{overload, MSec, Module, Function}</span> instructs the <span class="code">ttb</span> back end
            (a part of the <span class="bold_code bc-18"><a href="../../apps/runtime_tools/index.html">Runtime_Tools</a></span>
            application) to perform overload check every <span class="code">MSec</span> millisecond.
            If the check (named <span class="code">Module:Function(check)</span>) returns
            <span class="code">true</span>, tracing is disabled on the selected node.</p>
          <p>Overload protection activated on one node does not
            affect other nodes, where the tracing continues as normal.
            <span class="code">ttb:stop/0,1</span> fetches data from all clients, including everything
            collected before the activation of overload protection.</p>

	  <div class="note">
<div class="label">Note</div>
<div class="content"><p><p>
            It is not allowed to change trace details 
	    (with <span class="code">ttb:p</span> and <span class="code">ttb:tp/tpl...</span>) once overload 
	    protection is activated in one of the traced nodes. This is to 
	    avoid trace setup being inconsistent between nodes.</p></p></div>
</div>

          <p><span class="code">Module:Function</span> provided with option <span class="code">overload</span> must
            handle three calls: <span class="code">init</span>, <span class="code">check</span>, and <span class="code">stop</span>. <span class="code">init</span>
            and <span class="code">stop</span> allow some setup and teardown required by
            the check. An overload check module can look as follows:
          </p>
<div class="example"><pre>-module(overload).
-export([check/1]).

check(init) -&gt;
    Pid = sophisticated_module:start(),
    put(pid, Pid);
check(check) -&gt;
    get(pid) ! is_overloaded,
    receive
        Reply -&gt;
            Reply
    after 5000 -&gt;
            true
    end;
check(stop) -&gt;
    get(pid) ! stop.</pre></div>
    <div class="note">
<div class="label">Note</div>
<div class="content"><p><p>
            <span class="code">check</span> is always called by the same process, so <span class="code">put</span> and
            <span class="code">get</span> are possible.</p></p></div>
</div>
        
        <h4><span onMouseOver="document.getElementById('ghlink-autoresume-idm516').style.visibility = 'visible';" onMouseOut="document.getElementById('ghlink-autoresume-idm516').style.visibility = 'hidden';"><span id="ghlink-autoresume-idm516" class="ghlink"><a href="https://github.com/erlang/otp/edit/maint/lib/observer/doc/src/ttb_ug.xml#L379" title="Found an issue with the documentation? Fix it by clicking here!"><span class="pencil"></span></a></span><a class="title_link" name="autoresume" href="#autoresume">Autoresume</a></span></h4>
          
          <p>A node can crash (probably a buggy one, hence traced).
	    Use <span class="code">resume</span> to resume tracing on the node automatically 
	    when it gets back. The failing node then tries to reconnect
            to trace control node when <span class="code">Runtime_Tools</span> is started.
            This implies that <span class="code">Runtime_Tools</span> must be included in
            the startup chain of other nodes (if not, you can still
            resume tracing by starting <span class="code">Runtime_Tools</span> manually,
            that is, by an RPC call).</p>
          <p>To not lose the data that the failing node stored
            up to the point of crash, the control node tries to fetch
            it before restarting trace. This must occur within the allowed
            time frame, otherwise it is aborted (default is 10 seconds, but it
	    can be changed with <span class="code">{resume, MSec}</span>). The data fetched 
	    this way is then merged with all other traces.</p>
          <p>The autostart feature requires more data to be stored on
            traced nodes. By default, the data is stored automatically
            to the file named "ttb_autostart.bin" in the currect working directory
	    (cwd) of the traced node.
            Users can change this behaviour (that is, on diskless
            nodes) by specifying their own module to handle autostart data
            storage and retrieval (<span class="code">ttb_autostart_module</span>
            environment variable of <span class="code">runtime_tools</span>). For information 
	    about the API, see module
	    <span class="bold_code bc-19"><a href="../../man/ttb.html"><span class="code">ttb</span></a></span>. 
	    The following example shows the default handler:</p>
          <div class="example"><pre>-module(ttb_autostart).
-export([read_config/0,
         write_config/1,
         delete_config/0]).

-define(AUTOSTART_FILENAME, "ttb_autostart.bin").

delete_config() -&gt;
    file:delete(?AUTOSTART_FILENAME).

read_config() -&gt;
    case file:read_file(?AUTOSTART_FILENAME) of
        {ok, Data} -&gt; {ok, binary_to_term(Data)};
        Error      -&gt; Error
    end.

write_config(Data) -&gt;
    file:write_file(?AUTOSTART_FILENAME, term_to_binary(Data)).</pre></div>

         <div class="note">
<div class="label">Note</div>
<div class="content"><p><p>Remember that file trace ports buffer the data
            by default. If the node crashes, trace messages are not
            flushed to the binary log. If the risk of failure is
            high, it can be a good idea to flush the buffers every 
	    now and then automatically. Passing <span class="code">{flush, MSec}</span>
            as an option of <span class="code">ttb:tracer/2</span> flushes all buffers
            every <span class="code">MSec</span> millisecond.</p></p></div>
</div>
        
        <h4><span onMouseOver="document.getElementById('ghlink-dbg-mode-idm536').style.visibility = 'visible';" onMouseOut="document.getElementById('ghlink-dbg-mode-idm536').style.visibility = 'hidden';"><span id="ghlink-dbg-mode-idm536" class="ghlink"><a href="https://github.com/erlang/otp/edit/maint/lib/observer/doc/src/ttb_ug.xml#L434" title="Found an issue with the documentation? Fix it by clicking here!"><span class="pencil"></span></a></span><a class="title_link" name="dbg-mode" href="#dbg-mode">dbg Mode</a></span></h4>
          
          <p>Option <span class="code">{shell, ShellType}</span> allows making <span class="code">ttb</span>
            operation similar to 
            <span class="bold_code bc-18"><a href="../../man/dbg.html"><span class="code">dbg</span></a></span>.
	    Using <span class="code">{shell, true}</span>
            displays all trace messages in the shell before storing them.
            <span class="code">{shell, only}</span> additionally disables message storage
            (making the tool to behave exactly like <span class="code">dbg</span>). This is 
	    allowed only with IP trace ports (<span class="code">{trace, {local, File}}</span>).
          </p>
          <p>Command <span class="code">ttb:tracer(dbg)</span> is a shortcut for the pure
	  <span class="code">dbg</span> mode (<span class="code">{shell, only}</span>).</p>
        
  

  <h3>
<a name="trace_info"></a><span onMouseOver="document.getElementById('ghlink-trace-information-and-file-.ti-idm551').style.visibility = 'visible';" onMouseOut="document.getElementById('ghlink-trace-information-and-file-.ti-idm551').style.visibility = 'hidden';"><span id="ghlink-trace-information-and-file-.ti-idm551" class="ghlink"><a href="https://github.com/erlang/otp/edit/maint/lib/observer/doc/src/ttb_ug.xml#L450" title="Found an issue with the documentation? Fix it by clicking here!"><span class="pencil"></span></a></span><a class="title_link" name="trace-information-and-file-.ti" href="#trace-information-and-file-.ti">3.5 
          Trace Information and File .ti</a></span>
</h3>
    
    
    <p>In addition to the trace log file(s), a file with extension
      <span class="code">.ti</span> is created when Trace Tool Builder is started. This
      is the trace information file. It is a binary file, which
      contains the process information, trace flags used, the name of
      the node to which it belongs, and all information written with
      function 
      <span class="bold_code bc-15"><a href="../../man/ttb.html#write_trace_info-2"><span class="code">ttb:write_trace_info/2</span></a></span>. 
      <span class="code">.ti</span> files are always fetched with other logs when the trace is stopped.
    </p>
    <p>Except for the process information, everything in the trace
      information file is passed on to the handler function when
      formatting. Parameter <span class="code">TI</span> is a list of
      <span class="code">{Key,ValueList}</span> tuples. The keys <span class="code">flags</span>,
      <span class="code">handler</span>, <span class="code">file</span>, and <span class="code">node</span> are used for
      information written directly by <span class="code">ttb</span>.
      </p>
    <p>Information to the trace information file by
      can be added by calling 
      <span class="bold_code bc-15"><a href="../../man/ttb.html#write_trace_info-2"><span class="code">ttb:write_trace_info/2</span></a></span>. 
      Notice that <span class="code">ValueList</span>
      always is a list, and if you call <span class="code">write_trace_info/2</span>
      many times with the same <span class="code">Key</span>, the <span class="code">ValueList</span> is
      extended with a new value each time.
      </p>
      <p><strong>Example:</strong></p>
    <p><span class="code">ttb:write_trace_info(mykey,1)</span> gives the entry
      <span class="code">{mykey,[1]}</span> in <span class="code">TI</span>. Another call,
      <span class="code">ttb:write_trace_info(mykey,2)</span>, changes this entry to
      <span class="code">{mykey,[1,2]}</span>.
      </p>
  

  <h3><span onMouseOver="document.getElementById('ghlink-wrap-logs-idm582').style.visibility = 'visible';" onMouseOut="document.getElementById('ghlink-wrap-logs-idm582').style.visibility = 'hidden';"><span id="ghlink-wrap-logs-idm582" class="ghlink"><a href="https://github.com/erlang/otp/edit/maint/lib/observer/doc/src/ttb_ug.xml#L485" title="Found an issue with the documentation? Fix it by clicking here!"><span class="pencil"></span></a></span><a class="title_link" name="wrap-logs" href="#wrap-logs">3.6 
          Wrap Logs</a></span></h3>
    
    <p>If you want to limit the size of the trace logs, you can use
      wrap logs. This works almost like a circular buffer. You can
      specify the maximum number of binary logs and the maximum size of
      each log. <span class="code">ttb</span> then creates a new binary log each time a log
      reaches the maximum size. When the maximum number of logs are
      reached, the oldest log is deleted before a new one is created.
    </p>
    <div class="note">
<div class="label">Note</div>
<div class="content"><p><p>The overall size of data generated by <span class="code">ttb</span> can be greater
      than the wrap specification suggests. If a traced node restarts
      and autoresume is enabled, the old wrap log is always stored and
      a new one is created.
    </p></p></div>
</div>
    <p>Wrap logs can be formatted one by one or all at once. See
      <span class="bold_code bc-17"><a href="#format">Formatting</a></span>.
      </p>
  

  <h3>
<a name="format"></a><span onMouseOver="document.getElementById('ghlink-formatting-idm591').style.visibility = 'visible';" onMouseOut="document.getElementById('ghlink-formatting-idm591').style.visibility = 'hidden';"><span id="ghlink-formatting-idm591" class="ghlink"><a href="https://github.com/erlang/otp/edit/maint/lib/observer/doc/src/ttb_ug.xml#L504" title="Found an issue with the documentation? Fix it by clicking here!"><span class="pencil"></span></a></span><a class="title_link" name="formatting" href="#formatting">3.7 
          Formatting</a></span>
</h3>
    
    
    <p>Formatting can be done automatically when stopping <span class="code">ttb</span>
      (see section
      <span class="bold_code bc-17"><a href="#fetch_format">Automatically Collect and Format Logs from All Nodes</a></span>), or explicitly by calling function
      <span class="code">ttb:format/1,2</span>.
      </p>
    <p>Formatting means to read a binary log and present it in a
      readable format. You can use the default format handler in
      <span class="code">ttb</span> to present each trace message as a line of text, or
      write your own handler to make more complex interpretations of the
      trace information. You can also use application ET to
      present the trace log graphically (see section
      <span class="bold_code bc-17"><a href="#et_viewer">Presenting Trace Logs with Event Tracer</a></span>).
      </p>
    <p>The first argument to <span class="code">ttb:format/1,2</span> specifies which
      binary log(s) to format. This is usually the name of a directory
      that <span class="code">ttb</span> created during log fetch. Unless option 
      <span class="code">disable_sort</span> is provided, the logs from different files 
      are always sorted according to time-stamp in traces.
      </p>
    <p>The second argument to <span class="code">ttb:format/2</span> is a list of
      options as follows:
      </p>
      <dl>
       <dt><strong><span class="code">out</span></strong></dt>
       <dd><p>Specifies the destination to write the formatted text. 
       Default destination is <span class="code">standard_io</span>, but a filename can 
       also be specified.</p></dd>
       <dt><strong><span class="code">handler</span></strong></dt>
       <dd><p>Specifies the format handler to use. If this option is 
       not specified, option <span class="code">handler</span> that is specified when starting
      the tracer is used. If option <span class="code">handler</span> is not specified
      when starting the tracer either, a default handler is used, which
      prints each trace message as a text line.</p></dd>
       <dt><strong><span class="code">disable_sort</span></strong></dt>
       <dd><p>Indicates that the logs are not to be merged according to
      time-stamp, but processed one file after another (this can be
      a bit faster).</p></dd>
     </dl>
    <p>A format handler is a fun taking four arguments. This fun is
      called for each trace message in the binary log(s). A simple
      example that only prints each trace message can be as follows:</p>
    <div class="example"><pre>fun(Fd, Trace, _TraceInfo, State) -&gt;
   io:format(Fd, "Trace: ~p~n", [Trace]),
   State
end.    </pre></div>
    <p>Here, <span class="code">Fd</span> is the file descriptor for the destination file, or
      the atom <span class="code">standard_io</span>. <span class="code">_TraceInfo</span> contains information
      from the trace information file (see section
      <span class="bold_code bc-17"><a href="#trace_info">Trace Information and File .ti</a></span>). <span class="code">State</span> is a state variable for the format
      handler fun. The initial value of variable <span class="code">State</span> is
      specified with the handler option, for example:</p>
    <div class="example"><pre>ttb:format("tiger@durin-ttb", [{handler, {{Mod,Fun}, initial_state}}])
                                                     ^^^^^^^^^^^^^    </pre></div>
    <p>Another format handler can be used to calculate the time spent by
      the garbage collector:</p>
    <div class="example"><pre>fun(_Fd,{trace_ts,P,gc_start,_Info,StartTs},_TraceInfo,State) -&gt;
      [{P,StartTs}|State];
   (Fd,{trace_ts,P,gc_end,_Info,EndTs},_TraceInfo,State) -&gt;
      {value,{P,StartTs}} = lists:keysearch(P,1,State),
      Time = diff(StartTs,EndTs),
      io:format("GC in process ~w: ~w milliseconds~n", [P,Time]),
      State -- [{P,StartTs}]
end    </pre></div>
    <p>A more refined version of this format handler is function
      <span class="code">handle_gc/4</span> in module <span class="code">multitrace.erl</span>
      included in directory <span class="code">src</span> of the Observer application.
      </p>
    <p>The trace message is passed as the second argument (<span class="code">Trace</span>).
      The possible values of <span class="code">Trace</span> are the following:</p>
      <ul>
        <li>All trace messages described in 
	<span class="bold_code bc-13"><a href="../../man/erlang.html#trace-3"><span class="code">erlang:trace/3</span></a></span>
        </li>
        <li>
<span class="code">{drop, N}</span> if IP tracer is used (see 
	<span class="bold_code bc-13"><a href="../../man/dbg.html#trace_port-2"><span class="code">dbg:trace_port/2</span></a></span>)
        </li>
        <li>
<span class="code">end_of_trace</span> received once when all trace messages are
          processed</li>
      </ul>
    <p>By giving the format handler 
    <span class="bold_code bc-15"><a href="../../man/ttb.html#get_et_handler-0"><span class="code">ttb:get_et_handler()</span></a></span>, 
    you can have the trace
      log presented graphically with <span class="code">et_viewer</span> in the ET
      application (see section
      <span class="bold_code bc-17"><a href="#et_viewer">Presenting Trace Logs with Event Tracer</a></span>).
    </p>
    <p>You can always decide not to format the whole trace data contained
      in the fetch directory, but analyze single files instead. To do so, 
      a single file (or list of files) must be passed as the first argument 
      to <span class="code">format/1,2</span>.</p>
    <p>Wrap logs can be formatted one by one or all at once. To
      format one of the wrap logs in a set, specify the exact file name. 
      To format the whole set of wrap logs, specify the name with <span class="code">*</span>
      instead of the wrap count.
      </p>
      <p><strong>Example:</strong></p>
    <p>Start tracing:</p>
    <div class="example"><pre>
(tiger@durin)1&gt; <span class="bold_code bc-12">ttb:tracer(node(),{file,{wrap,"trace"}}).</span>
{ok,[tiger@durin]}
(tiger@durin)2&gt; <span class="bold_code bc-12">ttb:p(...)</span>
...</pre></div>
    <p>This gives a set of binary logs, for example:</p>
    <div class="example"><pre>tiger@durin-trace.0.wrp
tiger@durin-trace.1.wrp
tiger@durin-trace.2.wrp
...    </pre></div>
    <p>Format the whole set of logs:</p>
    <div class="example"><pre>
1&gt; <span class="bold_code bc-12">ttb:format("tiger@durin-trace.*.wrp").</span>
....
ok
2&gt;    </pre></div>
    <p>Format only the first log:</p>
    <div class="example"><pre>
1&gt; <span class="bold_code bc-12">ttb:format("tiger@durin-trace.0.wrp").</span>
....
ok
2&gt;    </pre></div>
    <p>To merge all wrap logs from two nodes:</p>
    <div class="example"><pre>
1&gt; <span class="bold_code bc-12">ttb:format(["tiger@durin-trace.*.wrp","lion@durin-trace.*.wrp"]).</span>
....
ok
2&gt;    </pre></div>

    <h4>
<a name="et_viewer"></a><span onMouseOver="document.getElementById('ghlink-presenting-trace-logs-with-event-tracer-idm678').style.visibility = 'visible';" onMouseOut="document.getElementById('ghlink-presenting-trace-logs-with-event-tracer-idm678').style.visibility = 'hidden';"><span id="ghlink-presenting-trace-logs-with-event-tracer-idm678" class="ghlink"><a href="https://github.com/erlang/otp/edit/maint/lib/observer/doc/src/ttb_ug.xml#L637" title="Found an issue with the documentation? Fix it by clicking here!"><span class="pencil"></span></a></span><a class="title_link" name="presenting-trace-logs-with-event-tracer" href="#presenting-trace-logs-with-event-tracer">Presenting Trace Logs with Event Tracer</a></span>
</h4>
      
      
      <p>For detailed information about the Event Tracer, see the
      <span class="bold_code bc-18"><a href="../../apps/et/users_guide.html">ET</a></span> application.
        </p>
      <p>By giving the format handler 
        <span class="bold_code bc-15"><a href="../../man/ttb.html#get_et_handler-0"><span class="code">ttb:get_et_handler()</span></a></span>, 
        you can have the trace log presented graphically with 
	<span class="code">et_viewer</span> in the ET application.
	<span class="code">ttb</span> provides filters that can be selected from the 
	menu <strong>Filter</strong> in the <span class="code">et_viewer</span> window. The filters 
	are names according to the type of actors they present 
	(that is, what each vertical line in the sequence diagram represents). 
	Interaction between actors is shown as red arrows between two 
	vertical lines, and activities within an actor are shown as 
	blue text to the right of the actors line.
        </p>
      <p>The <span class="code">processes</span> filter is the only filter showing all 
        trace messages from a trace log. Each vertical line in
        the sequence diagram represents a process. Erlang messages,
        spawn, and link/unlink are typical interactions between
        processes. Function calls, scheduling, and garbage collection, 
	are typical activities within a process. <span class="code">processes</span> is 
	the default filter.
        </p>
      <p>The remaining filters only show function calls and
        function returns. All other trace message are discarded. To get
        the most out of these filters, <span class="code">et_viewer</span> must know
        the caller of each function and the time of return. This can be
        obtained using both the <span class="code">call</span> and <span class="code">return_to</span>
        flags when tracing. Notice that flag <span class="code">return_to</span> only
        works with local call trace, that is, when trace patterns are set
        with <span class="code">ttb:tpl</span>.
        </p>
      <p>The same result can be obtained by using the flag <span class="code">call</span>
        only and setting a match specification on local or
        global function calls as follows:</p>
      <div class="example"><pre>
1&gt; <span class="bold_code bc-12">dbg:fun2ms(fun(_) -&gt; return_trace(),message(caller()) end).</span>
[{'_',[],[{return_trace},{message,{caller}}]}]</pre></div>
      <p>This must however be done with care, as function
        <span class="code">{return_trace}</span> in the match specification
        destroys tail recursiveness.
        </p>
      <p>The <span class="code">modules</span> filter shows each module as a vertical
        line in the sequence diagram. External function calls/returns
        are shown as interactions between modules, and internal function
        calls/returns are shown as activities within a module.
        </p>
      <p>The <span class="code">functions</span> filter shows each function as a vertical
        line in the sequence diagram. A function calling itself is shown
        as an activity within a function, and all other function calls
        are shown as interactions between functions.
        </p>
      <p>The <span class="code">mods_and_procs</span> and <span class="code">funcs_and_procs</span> filters
        are equivalent to the <span class="code">modules</span> and <span class="code">functions</span>
        filters respectively, except that each module or function can
        have many vertical lines, one for each process it resides on.
        </p>
      <p>In the following example, modules <span class="code">foo</span> and <span class="code">bar</span> are used:</p>
      <div class="example"><pre>-module(foo).
-export([start/0,go/0]).

start() -&gt;
    spawn(?MODULE, go, []).

go() -&gt;
    receive
        stop -&gt;
            ok;
        go -&gt;
            bar:f1(),
            go()
    end.</pre></div>

<div class="example"><pre>-module(bar).
-export([f1/0,f3/0]).
f1() -&gt;
    f2(),
    ok.
f2() -&gt;
    spawn(?MODULE,f3,[]).
f3() -&gt;
    ok.</pre></div>

      <p>Setting up the trace:</p>
<div class="example"><pre>
(tiger@durin)1&gt; %%First we retrieve the Pid to limit traced processes set
(tiger@durin)1&gt; <span class="bold_code bc-12">Pid = foo:start().</span>
(tiger@durin)2&gt; %%Now we set up tracing
(tiger@durin)2&gt; <span class="bold_code bc-12">ttb:tracer().</span>
(tiger@durin)3&gt; <span class="bold_code bc-12">ttb:p(Pid, [call, return_to, procs, set_on_spawn]).</span>
(tiger@durin)4&gt; <span class="bold_code bc-12">ttb:tpl(bar, []).</span>
(tiger@durin)5&gt; %%Invoke our test function and see output with et viewer
(tiger@durin)5&gt; <span class="bold_code bc-12">Pid ! go.</span>
(tiger@durin)6&gt; <span class="bold_code bc-12">ttb:stop({format, {handler, ttb:get_et_handler()}}).</span></pre></div>

      <p>This renders a result similar to the following:
        </p>
      <div class="doc-image-wrapper">
<img alt="IMAGE MISSING" src="et_processes.gif" class="doc-image">
        <p class="doc-image-caption">Figure
        3.1:
         
        Filter: "processes"</p>
      </div>
      <p></p>
      <div class="doc-image-wrapper">
<img alt="IMAGE MISSING" src="et_modsprocs.gif" class="doc-image">
        <p class="doc-image-caption">Figure
        3.2:
         
        Filter: "mods_and_procs"</p>
      </div>

      <p>Notice that function 
      <span class="bold_code bc-15"><a href="../../man/ttb.html#start_trace-4"><span class="code">ttb:start_trace/4</span></a></span> 
      can be used as help as follows:</p>
<div class="example"><pre>
(tiger@durin)1&gt; <span class="bold_code bc-12">Pid = foo:start().</span>
(tiger@durin)2&gt; <span class="bold_code bc-12">ttb:start_trace([node()],
                                [{bar,[]}],
                                {Pid, [call, return_to, procs, set_on_spawn]}
                                {handler, ttb:get_et_handler()}).</span>
(tiger@durin)3&gt; <span class="bold_code bc-12">Pid ! go.</span>
(tiger@durin)4&gt; <span class="bold_code bc-12">ttb:stop(format).</span></pre></div>

    
  

  <h3>
<a name="fetch_format"></a><span onMouseOver="document.getElementById('ghlink-automatically-collect-and-format-logs-from-all-nodes-idm741').style.visibility = 'visible';" onMouseOut="document.getElementById('ghlink-automatically-collect-and-format-logs-from-all-nodes-idm741').style.visibility = 'hidden';"><span id="ghlink-automatically-collect-and-format-logs-from-all-nodes-idm741" class="ghlink"><a href="https://github.com/erlang/otp/edit/maint/lib/observer/doc/src/ttb_ug.xml#L762" title="Found an issue with the documentation? Fix it by clicking here!"><span class="pencil"></span></a></span><a class="title_link" name="automatically-collect-and-format-logs-from-all-nodes" href="#automatically-collect-and-format-logs-from-all-nodes">3.8 
          Automatically Collect and Format Logs from All Nodes</a></span>
</h3>
    
    
    <p>By default,

    <span class="bold_code bc-15"><a href="../../man/ttb.html#stop-1"><span class="code">ttb:stop/1</span></a></span> fetches trace logs 
      and trace information files from all nodes. The logs are stored in a
      new directory named <span class="code">ttb_upload-Filename-Timestamp</span> under the 
      working directory of the trace control node. Fetching can be disabled 
      by providing option <span class="code">nofetch</span> to <span class="code">ttb:stop/1</span>. The user can
      specify a fetch directory by passing option <span class="code">{fetch_dir, Dir}</span>.
      </p>
    <p>If option <span class="code">format</span> is specified to <span class="code">ttb:stop/1</span>, the
      trace logs are automatically formatted after tracing is
      stopped.
    </p>
  

  <h3><span onMouseOver="document.getElementById('ghlink-history-and-configuration-files-idm754').style.visibility = 'visible';" onMouseOut="document.getElementById('ghlink-history-and-configuration-files-idm754').style.visibility = 'hidden';"><span id="ghlink-history-and-configuration-files-idm754" class="ghlink"><a href="https://github.com/erlang/otp/edit/maint/lib/observer/doc/src/ttb_ug.xml#L780" title="Found an issue with the documentation? Fix it by clicking here!"><span class="pencil"></span></a></span><a class="title_link" name="history-and-configuration-files" href="#history-and-configuration-files">3.9 
          History and Configuration Files</a></span></h3>
    
    <p>For the tracing functionality,
      <span class="bold_code bc-18"><a href="../../man/dbg.html"><span class="code">dbg</span></a></span>
      can be used instead
      of <span class="code">ttb</span> for setting trace flags on processes and trace
      patterns for call trace, that is, the functions 
      <span class="code">p</span>, <span class="code">tp</span>, <span class="code">tpl</span>, <span class="code">ctp</span>, <span class="code">ctpl</span>, and <span class="code">ctpg</span>. Only the
      following two things are added by <span class="code">ttb</span> for these functions:</p>
      <ul>
        <li>All calls are stored in the history buffer and can be
          recalled and stored in a configuration file. This makes it
          easy to set up the same trace environment, for example, if you 
	  want to compare two test runs. It also reduces the amount of
          typing when using <span class="code">ttb</span> from the Erlang shell.</li>
        <li>Shortcuts are provided for the most common match
          specifications (to not force you to use
          <span class="bold_code bc-13"><a href="../../man/dbg.html#fun2ms-1"><span class="code">dbg:fun2ms</span></a></span> 
	  continually).</li>
      </ul>
    <p>Use 
      <span class="bold_code bc-15"><a href="../../man/ttb.html#list_history-0"><span class="code">ttb:list_history/0</span></a></span> 
      to see the content of the history buffer and 
      <span class="bold_code bc-15"><a href="../../man/ttb.html#run_history-1"><span class="code">ttb:run_history/1</span></a></span>
      to re-execute one of the entries.
      </p>
    <p>The main purpose of the history buffer is the possibility to
      create configuration files. Any function stored in the history
      buffer can be written to a configuration file and used for
      creating a specific configuration at any time with a single
      function call.
      </p>
    <p>A configuration file is created or extended with
      <span class="bold_code bc-15"><a href="../../man/ttb.html#write_config-2"><span class="code">ttb:write_config/2,3</span></a></span>. 
      Configuration files are binary files
      and can therefore only be read and written with functions provided
      by <span class="code">ttb</span>.
      </p>
    <p>The complete content of the history buffer can be written to a
      configuration file by calling
      <span class="code">ttb:write_config(ConfigFile,all)</span>. Selected entries from 
      the history can be written by calling
      <span class="code">ttb:write_config(ConfigFile,NumList)</span>, where
      <span class="code">NumList</span> is a list of integers pointing out the history
      entries to write. Moreover, the history buffer is always dumped
      to <span class="code">ttb_last_config</span> when <span class="code">ttb:stop/0,1</span> is called.
      </p>
    <p>User-defined entries can also be written to a configuration file 
      by calling function
      <span class="code">ttb:write_config(ConfigFile,ConfigList)</span>, where
      <span class="code">ConfigList</span> is a list of <span class="code">{Module,Function,Args}</span>.
      </p>
    <p>Any existing file <span class="code">ConfigFile</span> is deleted and a new file
      is created when <span class="code">write_config/2</span> is called. Option
      <span class="code">append</span> can be used to add something at the end
      of an existing configuration file, for example,
      <span class="code">ttb:write_config(ConfigFile,What,[append])</span>.
      </p>

      <p><strong>Example:</strong></p>
      <p>See the content of the history buffer:</p>
      <div class="example"><pre>
(tiger@durin)191&gt; <span class="bold_code bc-12">ttb:tracer().</span>
{ok,[tiger@durin]}
(tiger@durin)192&gt; <span class="bold_code bc-12">ttb:p(self(),[garbage_collection,call]).</span>
{ok,{[&lt;0.1244.0&gt;],[garbage_collection,call]}}
(tiger@durin)193&gt; <span class="bold_code bc-12">ttb:tp(ets,new,2,[]).</span>
{ok,[{matched,1}]}
(tiger@durin)194&gt; <span class="bold_code bc-12">ttb:list_history().</span>
[{1,{ttb,tracer,[tiger@durin,[]]}},
 {2,{ttb,p,[&lt;0.1244.0&gt;,[garbage_collection,call]]}},
 {3,{ttb,tp,[ets,new,2,[]]}}]</pre></div>
      <p>Execute an entry from the history buffer:</p>
      <div class="example"><pre>
(tiger@durin)195&gt; <span class="bold_code bc-12">ttb:ctp(ets,new,2).</span>
{ok,[{matched,1}]}
(tiger@durin)196&gt; <span class="bold_code bc-12">ttb:list_history().</span>
[{1,{ttb,tracer,[tiger@durin,[]]}},
 {2,{ttb,p,[&lt;0.1244.0&gt;,[garbage_collection,call]]}},
 {3,{ttb,tp,[ets,new,2,[]]}},
 {4,{ttb,ctp,[ets,new,2]}}]
(tiger@durin)197&gt; <span class="bold_code bc-12">ttb:run_history(3).</span>
ttb:tp(ets,new,2,[]) -&gt;
{ok,[{matched,1}]}</pre></div>
      <p>Write the content of the history buffer to a configuration
        file:</p>
      <div class="example"><pre>
(tiger@durin)198&gt; <span class="bold_code bc-12">ttb:write_config("myconfig",all).</span>
ok
(tiger@durin)199&gt; <span class="bold_code bc-12">ttb:list_config("myconfig").</span>
[{1,{ttb,tracer,[tiger@durin,[]]}},
 {2,{ttb,p,[&lt;0.1244.0&gt;,[garbage_collection,call]]}},
 {3,{ttb,tp,[ets,new,2,[]]}},
 {4,{ttb,ctp,[ets,new,2]}},
 {5,{ttb,tp,[ets,new,2,[]]}}]</pre></div>
      <p>Extend an existing configuration:</p>
      <div class="example"><pre>
(tiger@durin)200&gt; <span class="bold_code bc-12">ttb:write_config("myconfig",[{ttb,tp,[ets,delete,1,[]]}],
[append]).</span>
ok
(tiger@durin)201&gt; <span class="bold_code bc-12">ttb:list_config("myconfig").</span>
[{1,{ttb,tracer,[tiger@durin,[]]}},
 {2,{ttb,p,[&lt;0.1244.0&gt;,[garbage_collection,call]]}},
 {3,{ttb,tp,[ets,new,2,[]]}},
 {4,{ttb,ctp,[ets,new,2]}},
 {5,{ttb,tp,[ets,new,2,[]]}},
 {6,{ttb,tp,[ets,delete,1,[]]}}]</pre></div>
      <p>Go back to a previous configuration after stopping Trace Tool
        Builder:</p>
      <div class="example"><pre>
(tiger@durin)202&gt; <span class="bold_code bc-12">ttb:stop().</span>
ok
(tiger@durin)203&gt; <span class="bold_code bc-12">ttb:run_config("myconfig").</span>
ttb:tracer(tiger@durin,[]) -&gt;
{ok,[tiger@durin]}

ttb:p(&lt;0.1244.0&gt;,[garbage_collection,call]) -&gt;
{ok,{[&lt;0.1244.0&gt;],[garbage_collection,call]}}

ttb:tp(ets,new,2,[]) -&gt;
{ok,[{matched,1}]}

ttb:ctp(ets,new,2) -&gt;
{ok,[{matched,1}]}

ttb:tp(ets,new,2,[]) -&gt;
{ok,[{matched,1}]}

ttb:tp(ets,delete,1,[]) -&gt;
{ok,[{matched,1}]}

ok</pre></div>
      <p>Write selected entries from the history buffer to a
        configuration file:</p>
      <div class="example"><pre>
(tiger@durin)204&gt; <span class="bold_code bc-12">ttb:list_history().</span>
[{1,{ttb,tracer,[tiger@durin,[]]}},
 {2,{ttb,p,[&lt;0.1244.0&gt;,[garbage_collection,call]]}},
 {3,{ttb,tp,[ets,new,2,[]]}},
 {4,{ttb,ctp,[ets,new,2]}},
 {5,{ttb,tp,[ets,new,2,[]]}},
 {6,{ttb,tp,[ets,delete,1,[]]}}]
(tiger@durin)205&gt; <span class="bold_code bc-12">ttb:write_config("myconfig",[1,2,3,6]).</span>
ok
(tiger@durin)206&gt; <span class="bold_code bc-12">ttb:list_config("myconfig").</span>
[{1,{ttb,tracer,[tiger@durin,[]]}},
 {2,{ttb,p,[&lt;0.1244.0&gt;,[garbage_collection,call]]}},
 {3,{ttb,tp,[ets,new,2,[]]}},
 {4,{ttb,tp,[ets,delete,1,[]]}}]
(tiger@durin)207&gt;</pre></div>
  

  <h3><span onMouseOver="document.getElementById('ghlink-sequential-tracing-idm828').style.visibility = 'visible';" onMouseOut="document.getElementById('ghlink-sequential-tracing-idm828').style.visibility = 'hidden';"><span id="ghlink-sequential-tracing-idm828" class="ghlink"><a href="https://github.com/erlang/otp/edit/maint/lib/observer/doc/src/ttb_ug.xml#L932" title="Found an issue with the documentation? Fix it by clicking here!"><span class="pencil"></span></a></span><a class="title_link" name="sequential-tracing" href="#sequential-tracing">3.10 
          Sequential Tracing</a></span></h3>
    
    <p>To learn what sequential tracing is and how it can be used,
      see the Reference Manual for
      <span class="bold_code bc-18"><a href="../../man/seq_trace.html"><span class="code">seq_trace</span></a></span>.
      </p>
    <p>The support for sequential tracing provided by Trace Tool
      Builder includes the following:</p>
    <ul>
      <li>Initiation of the system tracer. This is automatically
       done when a trace port is started with 
      <span class="bold_code bc-15"><a href="../../man/ttb.html#tracer-0"><span class="code">ttb:tracer/0,1,2</span></a></span>.</li>
      <li>Creation of match specifications that activates
       sequential tracing.</li>
    </ul>
    <p>Starting sequential tracing requires that a tracer is
      started with function <span class="code">ttb:tracer/0,1,2</span>. Sequential
      tracing can then be started in either of the following ways:
      </p>
      <ul>
	<li>Through a trigger function with a match specification 
	created with 
	<span class="bold_code bc-15"><a href="../../man/ttb.html#seq_trigger_ms-0"><span class="code">ttb:seq_trigger_ms/0,1</span></a></span>.</li>
	<li>Directly by using module
	<span class="bold_code bc-18"><a href="../../man/seq_trace.html"><span class="code">seq_trace</span></a></span>.</li>
      </ul>

      <p><strong>Example 1:</strong></p>
      <p>In the following example, function
        <span class="code">dbg:get_tracer/0</span> is used as trigger for sequential
        tracing:</p>
      <div class="example"><pre>
(tiger@durin)110&gt; <span class="bold_code bc-12">ttb:tracer().</span>
{ok,[tiger@durin]}
(tiger@durin)111&gt; <span class="bold_code bc-12">ttb:p(self(),call).</span>
{ok,{[&lt;0.158.0&gt;],[call]}}
(tiger@durin)112&gt; <span class="bold_code bc-12">ttb:tp(dbg,get_tracer,0,ttb:seq_trigger_ms(send)).</span>
{ok,[{matched,1},{saved,1}]}
(tiger@durin)113&gt; <span class="bold_code bc-12">dbg:get_tracer(), seq_trace:reset_trace().</span>
true
(tiger@durin)114&gt; <span class="bold_code bc-12">ttb:stop(format).</span>
({&lt;0.158.0&gt;,{shell,evaluator,3},tiger@durin}) call dbg:get_tracer()
SeqTrace [0]: ({&lt;0.158.0&gt;,{shell,evaluator,3},tiger@durin})
{&lt;0.237.0&gt;,dbg,tiger@durin} ! {&lt;0.158.0&gt;,{get_tracer,tiger@durin}}
[Serial: {0,1}]
SeqTrace [0]: ({&lt;0.237.0&gt;,dbg,tiger@durin})
{&lt;0.158.0&gt;,{shell,evaluator,3},tiger@durin} ! {dbg,{ok,#Port&lt;0.222&gt;}}
[Serial: {1,2}]
ok
(tiger@durin)116&gt;</pre></div>
      <p><strong>Example 2:</strong></p>
      <p>Starting sequential tracing with a trigger is more
        useful if the trigger function is not called directly from the
        shell, but rather implicitly within a larger system. When
        calling a function from the shell, it is simpler to start
        sequential tracing directly, for example, as follows:</p>
      <div class="example"><pre>
(tiger@durin)116&gt; <span class="bold_code bc-12">ttb:tracer().</span>
{ok,[tiger@durin]}
(tiger@durin)117&gt; <span class="bold_code bc-12">seq_trace:set_token(send,true), dbg:get_tracer(),
seq_trace:reset_trace().</span>
true
(tiger@durin)118&gt; <span class="bold_code bc-12">ttb:stop(format).</span>
SeqTrace [0]: ({&lt;0.158.0&gt;,{shell,evaluator,3},tiger@durin})
{&lt;0.246.0&gt;,dbg,tiger@durin} ! {&lt;0.158.0&gt;,{get_tracer,tiger@durin}}
[Serial: {0,1}]
SeqTrace [0]: ({&lt;0.246.0&gt;,dbg,tiger@durin})
{&lt;0.158.0&gt;,{shell,evaluator,3},tiger@durin} ! {dbg,{ok,#Port&lt;0.229&gt;}}
[Serial: {1,2}]
ok
(tiger@durin)120&gt;</pre></div>
      <p>In both previous examples, <span class="code">seq_trace:reset_trace/0</span>
        resets the trace token immediately after the traced function
        to avoid many trace messages because of the printouts in
        the Erlang shell.
        </p>
      <p>All functions in module <span class="code">seq_trace</span>, except
        <span class="code">set_system_tracer/1</span>, can be used after the trace port
        is started with <span class="code">ttb:tracer/0,1,2</span>.
        </p>
  

  <h3><span onMouseOver="document.getElementById('ghlink-multipurpose-trace-tool-idm871').style.visibility = 'visible';" onMouseOut="document.getElementById('ghlink-multipurpose-trace-tool-idm871').style.visibility = 'hidden';"><span id="ghlink-multipurpose-trace-tool-idm871" class="ghlink"><a href="https://github.com/erlang/otp/edit/maint/lib/observer/doc/src/ttb_ug.xml#L1014" title="Found an issue with the documentation? Fix it by clicking here!"><span class="pencil"></span></a></span><a class="title_link" name="multipurpose-trace-tool" href="#multipurpose-trace-tool">3.11 
          Multipurpose Trace Tool</a></span></h3>
    
    <p>Module <span class="code">multitrace</span> in
      directory <span class="code">src</span> of the Observer application provides a
      small tool with three possible trace settings. The trace messages
      are written to binary files, which can be formatted with
      function <span class="code">multitrace:format/1,2</span>:
      </p>
    <dl>
      <dt><strong><span class="code">multitrace:debug(What)</span></strong></dt>
      <dd><p>Start calltrace on all processes and trace the specified
       function(s). The format handler used is
      <span class="code">multitrace:handle_debug/4</span> that prints each call and
       returns. <span class="code">What</span> must be an item or a list of items to trace,
       specified on the format <span class="code">{Module,Function,Arity}</span>,
      <span class="code">{Module,Function}</span>, or only <span class="code">Module</span>.</p></dd>
      <dt><strong><span class="code">multitrace:gc(Procs)</span></strong></dt>
      <dd><p>Trace garbage collection on the specified process(es). The
       format handler used is <span class="code">multitrace:handle_gc/4</span> that
       prints start, stop, and the time spent for each garbage collection.</p></dd>
      <dt><strong><span class="code">multitrace:schedule(Procs)</span></strong></dt>
      <dd><p>Trace in-scheduling and out-scheduling on the specified process(es). 
       The format handler used is <span class="code">multitrace:handle_schedule/4</span> that
       prints each in-scheduling and out-scheduling with process, time-stamp, and
       current function. It also prints the total time each traced
       process was scheduled in.</p></dd>
    </dl>
  
</div>
<div class="footer">
<hr>
<p>Copyright © 2002-2021 Ericsson AB. All Rights Reserved.</p>
</div>
</div>
</div>
<script type="text/javascript">window.__otpTopDocDir = '../../js/';</script><script type="text/javascript" src="../../js/highlight.js"></script>
</body>
</html>
