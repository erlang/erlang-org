<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html xmlns:fn="http://www.w3.org/2005/02/xpath-functions">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<link rel="stylesheet" href="../otp_doc.css" type="text/css">
<title>Erlang -- gen_event Behaviour</title>
</head>
<body bgcolor="white" text="#000000" link="#0000ff" vlink="#ff00ff" alink="#ff0000"><div id="container">
<script id="js" type="text/javascript" language="JavaScript" src="../js/flipmenu/flipmenu.js"></script><script id="js2" type="text/javascript" src="../js/erlresolvelinks.js"></script><script language="JavaScript" type="text/javascript">
            <!--
              function getWinHeight() {
                var myHeight = 0;
                if( typeof( window.innerHeight ) == 'number' ) {
                  //Non-IE
                  myHeight = window.innerHeight;
                } else if( document.documentElement && ( document.documentElement.clientWidth ||
                                                         document.documentElement.clientHeight ) ) {
                  //IE 6+ in 'standards compliant mode'
                  myHeight = document.documentElement.clientHeight;
                } else if( document.body && ( document.body.clientWidth || document.body.clientHeight ) ) {
                  //IE 4 compatible
                  myHeight = document.body.clientHeight;
                }
                return myHeight;
              }

              function setscrollpos() {
                var objf=document.getElementById('loadscrollpos');
                 document.getElementById("leftnav").scrollTop = objf.offsetTop - getWinHeight()/2;
              }

              function addEvent(obj, evType, fn){
                if (obj.addEventListener){
                obj.addEventListener(evType, fn, true);
                return true;
              } else if (obj.attachEvent){
                var r = obj.attachEvent("on"+evType, fn);
                return r;
              } else {
                return false;
              }
             }

             addEvent(window, 'load', setscrollpos);

             //--></script><div id="leftnav"><div class="innertube">
<img alt="Erlang logo" src="../erlang-logo.png"><br><small><a href="users_guide.html">User's Guide</a><br><a href="../pdf/otp-system-documentation.pdf">PDF</a><br><a href="../index.html">Top</a></small><p><strong>OTP Design Principles</strong><br><strong>User's Guide</strong><br><small>Version 7.3</small></p>
<br><a href="javascript:openAllFlips()">Expand All</a><br><a href="javascript:closeAllFlips()">Contract All</a><p><small><strong>Chapters</strong></small></p>
<ul class="flipMenu" imagePath="../js/flipmenu">
<li id="no" title="Overview" expanded="false">Overview<ul>
<li><a href="des_princ.html">
              Top of chapter
            </a></li>
<li title="Supervision Trees"><a href="des_princ.html#id64367">Supervision Trees</a></li>
<li title="Behaviours"><a href="des_princ.html#id59018">Behaviours</a></li>
<li title="Applications"><a href="des_princ.html#id62708">Applications</a></li>
<li title="Releases"><a href="des_princ.html#id67826">Releases</a></li>
<li title="Release Handling"><a href="des_princ.html#id60992">Release Handling</a></li>
</ul>
</li>
<li id="no" title="gen_server Behaviour" expanded="false">gen_server Behaviour<ul>
<li><a href="gen_server_concepts.html">
              Top of chapter
            </a></li>
<li title="Client-Server Principles"><a href="gen_server_concepts.html#id60348">Client-Server Principles</a></li>
<li title="Example"><a href="gen_server_concepts.html#id58953">Example</a></li>
<li title="Starting a Gen_Server"><a href="gen_server_concepts.html#id60326">Starting a Gen_Server</a></li>
<li title="Synchronous Requests - Call"><a href="gen_server_concepts.html#id67860">Synchronous Requests - Call</a></li>
<li title="Asynchronous Requests - Cast"><a href="gen_server_concepts.html#id68094">Asynchronous Requests - Cast</a></li>
<li title="Stopping"><a href="gen_server_concepts.html#id67742">Stopping</a></li>
<li title="Handling Other Messages"><a href="gen_server_concepts.html#id63566">Handling Other Messages</a></li>
</ul>
</li>
<li id="no" title="gen_fsm Behaviour" expanded="false">gen_fsm Behaviour<ul>
<li><a href="fsm.html">
              Top of chapter
            </a></li>
<li title="Finite-State Machines"><a href="fsm.html#id70273">Finite-State Machines</a></li>
<li title="Example"><a href="fsm.html#id69827">Example</a></li>
<li title="Starting gen_fsm"><a href="fsm.html#id69875">Starting gen_fsm</a></li>
<li title="Notifying about Events"><a href="fsm.html#id68709">Notifying about Events</a></li>
<li title="Time-Outs"><a href="fsm.html#id68805">Time-Outs</a></li>
<li title="All State Events"><a href="fsm.html#id68846">All State Events</a></li>
<li title="Stopping"><a href="fsm.html#id68881">Stopping</a></li>
<li title="Handling Other Messages"><a href="fsm.html#id68997">Handling Other Messages</a></li>
</ul>
</li>
<li id="loadscrollpos" title="gen_event Behaviour" expanded="true">gen_event Behaviour<ul>
<li><a href="events.html">
              Top of chapter
            </a></li>
<li title="Event Handling Principles"><a href="events.html#id69105">Event Handling Principles</a></li>
<li title="Example"><a href="events.html#id69156">Example</a></li>
<li title="Starting an Event Manager"><a href="events.html#id69197">Starting an Event Manager</a></li>
<li title="Adding an Event Handler"><a href="events.html#id69255">Adding an Event Handler</a></li>
<li title="Notifying about Events"><a href="events.html#id69340">Notifying about Events</a></li>
<li title="Deleting an Event Handler"><a href="events.html#id69411">Deleting an Event Handler</a></li>
<li title="Stopping"><a href="events.html#id69490">Stopping</a></li>
<li title="Handling Other Messages"><a href="events.html#id69544">Handling Other Messages</a></li>
</ul>
</li>
<li id="no" title="Supervisor Behaviour" expanded="false">Supervisor Behaviour<ul>
<li><a href="sup_princ.html">
              Top of chapter
            </a></li>
<li title="Supervision Principles"><a href="sup_princ.html#id69652">Supervision Principles</a></li>
<li title="Example"><a href="sup_princ.html#id69676">Example</a></li>
<li title="Supervisor Flags"><a href="sup_princ.html#id73161">Supervisor Flags</a></li>
<li title="Restart Strategy"><a href="sup_princ.html#id73232">Restart Strategy</a></li>
<li title="Maximum Restart Intensity"><a href="sup_princ.html#id73357">Maximum Restart Intensity</a></li>
<li title="Child Specification"><a href="sup_princ.html#id73434">Child Specification</a></li>
<li title="Starting a Supervisor"><a href="sup_princ.html#id73869">Starting a Supervisor</a></li>
<li title="Adding a Child Process"><a href="sup_princ.html#id73986">Adding a Child Process</a></li>
<li title="Stopping a Child Process"><a href="sup_princ.html#id74030">Stopping a Child Process</a></li>
<li title="Simplified one_for_one Supervisors"><a href="sup_princ.html#id74088">Simplified one_for_one Supervisors</a></li>
<li title="Stopping"><a href="sup_princ.html#id74216">Stopping</a></li>
</ul>
</li>
<li id="no" title="sys and proc_lib" expanded="false">sys and proc_lib<ul>
<li><a href="spec_proc.html">
              Top of chapter
            </a></li>
<li title="Simple Debugging"><a href="spec_proc.html#id74314">Simple Debugging</a></li>
<li title="Special Processes"><a href="spec_proc.html#id74399">Special Processes</a></li>
<li title="User-Defined Behaviours"><a href="spec_proc.html#id75026">User-Defined Behaviours</a></li>
</ul>
</li>
<li id="no" title="Applications" expanded="false">Applications<ul>
<li><a href="applications.html">
              Top of chapter
            </a></li>
<li title="Application Concept"><a href="applications.html#id75291">Application Concept</a></li>
<li title="Application Callback Module"><a href="applications.html#id75358">Application Callback Module</a></li>
<li title="Application Resource File"><a href="applications.html#id75484">Application Resource File</a></li>
<li title="Directory Structure"><a href="applications.html#id75737">Directory Structure</a></li>
<li title="Application Controller"><a href="applications.html#id75831">Application Controller</a></li>
<li title="Loading and Unloading Applications"><a href="applications.html#id75864">Loading and Unloading Applications</a></li>
<li title="Starting and Stopping Applications"><a href="applications.html#id75926">Starting and Stopping Applications</a></li>
<li title="Configuring an Application"><a href="applications.html#id76014">Configuring an Application</a></li>
<li title="Application Start Types"><a href="applications.html#id76222">Application Start Types</a></li>
</ul>
</li>
<li id="no" title="Included Applications" expanded="false">Included Applications<ul>
<li><a href="included_applications.html">
              Top of chapter
            </a></li>
<li title="Introduction"><a href="included_applications.html#id76366">Introduction</a></li>
<li title="Specifying Included Applications"><a href="included_applications.html#id76431">Specifying Included Applications</a></li>
<li title="Synchronizing Processes during Startup"><a href="included_applications.html#id76457">Synchronizing Processes during Startup</a></li>
</ul>
</li>
<li id="no" title="Distributed Applications" expanded="false">Distributed Applications<ul>
<li><a href="distributed_applications.html">
              Top of chapter
            </a></li>
<li title="Introduction"><a href="distributed_applications.html#id76691">Introduction</a></li>
<li title="Specifying Distributed Applications"><a href="distributed_applications.html#id76727">Specifying Distributed Applications</a></li>
<li title="Starting and Stopping Distributed Applications"><a href="distributed_applications.html#id76924">Starting and Stopping Distributed Applications</a></li>
<li title="Failover"><a href="distributed_applications.html#id77030">Failover</a></li>
<li title="Takeover"><a href="distributed_applications.html#id77177">Takeover</a></li>
</ul>
</li>
<li id="no" title="Releases" expanded="false">Releases<ul>
<li><a href="release_structure.html">
              Top of chapter
            </a></li>
<li title="Release Concept"><a href="release_structure.html#id77382">Release Concept</a></li>
<li title="Release Resource File"><a href="release_structure.html#id77434">Release Resource File</a></li>
<li title="Generating Boot Scripts"><a href="release_structure.html#id77577">Generating Boot Scripts</a></li>
<li title="Creating a Release Package"><a href="release_structure.html#id77684">Creating a Release Package</a></li>
<li title="Directory Structure"><a href="release_structure.html#id77850">Directory Structure</a></li>
</ul>
</li>
<li id="no" title="Release Handling" expanded="false">Release Handling<ul>
<li><a href="release_handling.html">
              Top of chapter
            </a></li>
<li title="Release Handling Principles"><a href="release_handling.html#id78094">Release Handling Principles</a></li>
<li title="Requirements"><a href="release_handling.html#id78350">Requirements</a></li>
<li title="Distributed Systems"><a href="release_handling.html#id78439">Distributed Systems</a></li>
<li title="Release Handling Instructions"><a href="release_handling.html#id78465">Release Handling Instructions</a></li>
<li title="Application Upgrade File"><a href="release_handling.html#id79028">Application Upgrade File</a></li>
<li title="Release Upgrade File"><a href="release_handling.html#id79224">Release Upgrade File</a></li>
<li title="Installing a Release"><a href="release_handling.html#id79382">Installing a Release</a></li>
<li title="Updating Application Specifications"><a href="release_handling.html#id79883">Updating Application Specifications</a></li>
</ul>
</li>
<li id="no" title="Appup Cookbook" expanded="false">Appup Cookbook<ul>
<li><a href="appup_cookbook.html">
              Top of chapter
            </a></li>
<li title="Changing a Functional Module"><a href="appup_cookbook.html#id80083">Changing a Functional Module</a></li>
<li title="Changing a Residence Module"><a href="appup_cookbook.html#id80102">Changing a Residence Module</a></li>
<li title="Changing a Callback Module"><a href="appup_cookbook.html#id80140">Changing a Callback Module</a></li>
<li title="Changing Internal State"><a href="appup_cookbook.html#id80194">Changing Internal State</a></li>
<li title="Module Dependencies"><a href="appup_cookbook.html#id80338">Module Dependencies</a></li>
<li title="Changing Code for a Special Process"><a href="appup_cookbook.html#id80513">Changing Code for a Special Process</a></li>
<li title="Changing a Supervisor"><a href="appup_cookbook.html#id80695">Changing a Supervisor</a></li>
<li title="Adding or Deleting a Module"><a href="appup_cookbook.html#id80952">Adding or Deleting a Module</a></li>
<li title="Starting or Terminating a Process"><a href="appup_cookbook.html#id80980">Starting or Terminating a Process</a></li>
<li title="Adding or Removing an Application"><a href="appup_cookbook.html#id80998">Adding or Removing an Application</a></li>
<li title="Restarting an Application"><a href="appup_cookbook.html#id81029">Restarting an Application</a></li>
<li title="Changing an Application Specification"><a href="appup_cookbook.html#id81074">Changing an Application Specification</a></li>
<li title="Changing Application Configuration"><a href="appup_cookbook.html#id81097">Changing Application Configuration</a></li>
<li title="Changing Included Applications"><a href="appup_cookbook.html#id81125">Changing Included Applications</a></li>
<li title="Changing Non-Erlang Code"><a href="appup_cookbook.html#id81387">Changing Non-Erlang Code</a></li>
<li title="Emulator Restart and Upgrade"><a href="appup_cookbook.html#id81485">Emulator Restart and Upgrade</a></li>
<li title="Emulator Upgrade From Pre OTP R15"><a href="appup_cookbook.html#id81570">Emulator Upgrade From Pre OTP R15</a></li>
</ul>
</li>
</ul>
</div></div>
<div id="content">
<div class="innertube">
<h1>4 gen_event Behaviour</h1>
  
  <a name="gen_event"></a>
  <p>This section is to be read with the <span class="code">gen_event(3)</span> manual
  page in STDLIB, where all interface functions and callback
  functions are described in detail.</p>

  <h3><a name="id69105">4.1 
        Event Handling Principles</a></h3>
    
    <p>In OTP, an <strong>event manager</strong> is a named object to which
      events can be sent. An <strong>event</strong> can be, for example,
      an error, an alarm, or some information that is to be logged.</p>
    <p>In the event manager, zero, one, or many <strong>event handlers</strong>
      are installed. When the event manager is notified
      about an event, the event is processed by all the installed
      event handlers. For example, an event manager for handling errors
      can by default have a handler installed, which writes error
      messages to the terminal. If the error messages during a certain
      period is to be saved to a file as well, the user adds another
      event handler that does this. When logging to the file is no
      longer necessary, this event handler is deleted.</p>
    <p>An event manager is implemented as a process and each event
      handler is implemented as a callback module.</p>
    <p>The event manager essentially maintains a list of
      <span class="code">{Module, State}</span> pairs, where each <span class="code">Module</span> is an
      event handler, and <span class="code">State</span> is the internal state of that
      event handler.</p>
  

  <h3><a name="id69156">4.2 
        Example</a></h3>
    
    <p>The callback module for the event handler writing error messages
      to the terminal can look as follows:</p>
    <div class="example"><pre>
-module(terminal_logger).
-behaviour(gen_event).

-export([init/1, handle_event/2, terminate/2]).

init(_Args) -&gt;
    {ok, []}.

handle_event(ErrorMsg, State) -&gt;
    io:format("***Error*** ~p~n", [ErrorMsg]),
    {ok, State}.

terminate(_Args, _State) -&gt;
    ok.</pre></div>
    <p>The callback module for the event handler writing error messages
      to a file can look as follows:</p>
    <div class="example"><pre>
-module(file_logger).
-behaviour(gen_event).

-export([init/1, handle_event/2, terminate/2]).

init(File) -&gt;
    {ok, Fd} = file:open(File, read),
    {ok, Fd}.

handle_event(ErrorMsg, Fd) -&gt;
    io:format(Fd, "***Error*** ~p~n", [ErrorMsg]),
    {ok, Fd}.

terminate(_Args, Fd) -&gt;
    file:close(Fd).</pre></div>
    <p>The code is explained in the next sections.</p>
  

  <h3><a name="id69197">4.3 
        Starting an Event Manager</a></h3>
    <a name="mgr"></a>
    
    <p>To start an event manager for handling errors, as described in
      the previous example, call the following function:</p>
    <div class="example"><pre>
gen_event:start_link({local, error_man})</pre></div>
    <p>This function spawns and links to a new process, an event
      manager.</p>
    <p>The argument, <span class="code">{local, error_man}</span> specifies the name. The
    event manager is then locally registered as <span class="code">error_man</span>.</p>
    <p>If the name is omitted, the event manager is not registered.
      Instead its pid must be used. The name can also be given
      as <span class="code">{global, Name}</span>, in which case the event manager is
      registered using <span class="code">global:register_name/2</span>.</p>
    <p><span class="code">gen_event:start_link</span> must be used if the event manager is
      part of a supervision tree, that is, started by a supervisor.
      There is another function, <span class="code">gen_event:start</span>, to start a
      standalone event manager, that is, an event manager that is not
      part of a supervision tree.</p>
  

  <h3><a name="id69255">4.4 
        Adding an Event Handler</a></h3>
    
    <p>The following example shows how to start an event manager and
    add an event handler to it by using the shell:</p>
    <div class="example"><pre>
1&gt; <span class="bold_code">gen_event:start({local, error_man}).</span>
{ok,&lt;0.31.0&gt;}
2&gt; <span class="bold_code">gen_event:add_handler(error_man, terminal_logger, []).</span>
ok</pre></div>
    <p>This function sends a message to the event manager registered as
      <span class="code">error_man</span>, telling it to add the event handler
      <span class="code">terminal_logger</span>. The event manager calls the callback
      function <span class="code">terminal_logger:init([])</span>, where the argument
      <span class="code">[]</span> is the third argument to <span class="code">add_handler</span>. <span class="code">init</span>
      is expected to return <span class="code">{ok, State}</span>, where <span class="code">State</span> is
      the internal state of the event handler.</p>
    <div class="example"><pre>
init(_Args) -&gt;
    {ok, []}.</pre></div>
    <p>Here, <span class="code">init</span> does not need any input data and ignores its
      argument. For <span class="code">terminal_logger</span>, the internal state is
      not used. For <span class="code">file_logger</span>, the internal state is used
      to save the open file descriptor.</p>
    <div class="example"><pre>
init(File) -&gt;
    {ok, Fd} = file:open(File, read),
    {ok, Fd}.</pre></div>
  

  <h3><a name="id69340">4.5 
        Notifying about Events</a></h3>
    
    <div class="example"><pre>
3&gt; <span class="bold_code">gen_event:notify(error_man, no_reply).</span>
***Error*** no_reply
ok</pre></div>
    <p><span class="code">error_man</span> is the name of the event manager and
      <span class="code">no_reply</span> is the event.</p>
    <p>The event is made into a message and sent to the event manager.
      When the event is received, the event manager calls
      <span class="code">handle_event(Event, State)</span> for each installed event
      handler, in the same order as they were added. The function is
      expected to return a tuple <span class="code">{ok,State1}</span>, where
      <span class="code">State1</span> is a new value for the state of the event handler.</p>
    <p>In <span class="code">terminal_logger</span>:</p>
    <div class="example"><pre>
handle_event(ErrorMsg, State) -&gt;
    io:format("***Error*** ~p~n", [ErrorMsg]),
    {ok, State}.</pre></div>
    <p>In <span class="code">file_logger</span>:</p>
    <div class="example"><pre>
handle_event(ErrorMsg, Fd) -&gt;
    io:format(Fd, "***Error*** ~p~n", [ErrorMsg]),
    {ok, Fd}.</pre></div>
  

  <h3><a name="id69411">4.6 
        Deleting an Event Handler</a></h3>
    
    <div class="example"><pre>
4&gt; <span class="bold_code">gen_event:delete_handler(error_man, terminal_logger, []).</span>
ok</pre></div>
    <p>This function sends a message to the event manager registered as
      <span class="code">error_man</span>, telling it to delete the event handler
      <span class="code">terminal_logger</span>. The event manager calls the callback
      function <span class="code">terminal_logger:terminate([], State)</span>, where
      the argument <span class="code">[]</span> is the third argument to <span class="code">delete_handler</span>.
      <span class="code">terminate</span> is to be the opposite of <span class="code">init</span> and do any
      necessary cleaning up. Its return value is ignored.</p>
    <p>For <span class="code">terminal_logger</span>, no cleaning up is necessary:</p>
    <div class="example"><pre>
terminate(_Args, _State) -&gt;
    ok.</pre></div>
    <p>For <span class="code">file_logger</span>, the file descriptor opened in <span class="code">init</span>
    must be closed:</p>
    <div class="example"><pre>
terminate(_Args, Fd) -&gt;
    file:close(Fd).</pre></div>
  

  <h3><a name="id69490">4.7 
        Stopping</a></h3>
    
    <p>When an event manager is stopped, it gives each of
      the installed event handlers the chance to clean up by calling
      <span class="code">terminate/2</span>, the same way as when deleting a handler.</p>

    <h4>In a Supervision Tree</h4>
      
      <p>If the event manager is part of a supervision tree, no stop
        function is needed. The event manager is automatically
        terminated by its supervisor. Exactly how this is done is
        defined by a
        <span class="bold_code"><a href="sup_princ.html#shutdown">shutdown strategy</a></span>
        set in the supervisor.</p>
    

    <h4>Standalone Event Managers</h4>
      
      <p>An event manager can also be stopped by calling:</p>
      <div class="example"><pre>
&gt; <span class="bold_code">gen_event:stop(error_man).</span>
ok</pre></div>
    
  
  <h3><a name="id69544">4.8 
        Handling Other Messages</a></h3>
    
    <p>If the <span class="code">gen_event</span> is to be able to receive other messages
      than events, the callback function
      <span class="code">handle_info(Info, StateName, StateData)</span>
      must be implemented to handle them. Examples of other
      messages are exit messages, if the <span class="code">gen_event</span> is linked to
      other processes (than the supervisor) and trapping exit signals.</p>
    <div class="example"><pre>
handle_info({'EXIT', Pid, Reason}, State) -&gt;
    ..code to handle exits here..
    {ok, NewState}.</pre></div>
    <p>The <span class="code">code_change</span> method must also be implemented.</p>
    <div class="example"><pre>
code_change(OldVsn, State, Extra) -&gt;
    ..code to convert state (and more) during code change
    {ok, NewState}</pre></div>
  
</div>
<div class="footer">
<hr>
<p>Copyright © 1997-2016 Ericsson AB. All Rights Reserved.</p>
</div>
</div>
</div></body>
</html>
